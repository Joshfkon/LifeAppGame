<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>The Fertility Equation | Interactive Policy Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1a1a;
      --paper: #f8f6f1;
      --paper-dark: #e8e4db;
      --accent: #8b0000;
      --success: #2d5016;
      --muted: #666;
      --rule: #ccc;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Source Serif 4', Georgia, serif;
      background: var(--paper);
      color: var(--ink);
      line-height: 1.6;
      font-size: 16px;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--ink);
      color: var(--paper);
      padding: 16px 20px;
      flex-shrink: 0;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .header-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .tfr-compact {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tfr-number-large {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      transition: color 0.3s ease;
    }

    .tfr-number-large.at-replacement { color: #7cb342; }
    .tfr-number-large.below { color: #ffb74d; }
    .tfr-number-large.critical { color: #ef5350; }

    .tfr-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: right;
    }

    .tfr-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: 0.6;
    }

    .tfr-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.1);
    }

    .tfr-progress {
      height: 6px;
      background: rgba(255,255,255,0.1);
      position: relative;
      margin-bottom: 12px;
    }

    .tfr-progress-fill {
      height: 100%;
      background: var(--paper);
      transition: width 0.3s ease, background 0.3s ease;
    }

    .tfr-progress-fill.at-replacement { background: #7cb342; }

    .tfr-progress-marker {
      position: absolute;
      top: -4px;
      bottom: -4px;
      width: 2px;
      background: var(--accent);
      left: 70%;
    }

    .tfr-progress-marker::after {
      content: '2.1';
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: var(--accent);
    }

    .fiscal-strip {
      display: flex;
      gap: 16px;
      justify-content: space-between;
    }

    .fiscal-item { text-align: center; flex: 1; }

    .fiscal-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: 0.5;
    }

    .fiscal-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      font-weight: 500;
    }

    .fiscal-value.positive { color: #7cb342; }
    .fiscal-value.negative { color: #ef5350; }

    .fiscal-sublabel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      margin-top: 2px;
    }

    .fiscal-sublabel.positive { color: #7cb342; }
    .fiscal-sublabel.negative { color: #ef5350; }

    .gdp-projection {
      border-left: 1px solid rgba(255,255,255,0.2);
      padding-left: 12px;
      position: relative;
    }

    .gdp-clickable {
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .gdp-clickable:hover {
      color: #ffb74d;
    }

    .gdp-clickable::after {
      content: ' ‚ìò';
      font-size: 10px;
      opacity: 0.6;
    }

    .gdp-methodology {
      display: none;
      position: absolute;
      bottom: calc(100% + 12px);
      right: 0;
      width: 300px;
      background: var(--paper);
      color: var(--ink);
      border: 1px solid var(--ink);
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .gdp-methodology.visible {
      display: block;
    }

    .gdp-breakdown {
      background: var(--paper-dark);
      padding: 10px 12px;
      margin: 10px 0;
      border-left: 3px solid var(--success);
    }

    .gdp-breakdown-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--success);
      margin-bottom: 8px;
    }

    .gdp-breakdown-row {
      display: flex;
      justify-content: space-between;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 3px 0;
    }

    .gdp-breakdown-row span:first-child {
      color: var(--muted);
    }

    .gdp-breakdown-row.tax-drag-row span:last-child {
      color: var(--accent);
    }

    .gdp-breakdown-row.fiscal-row span:last-child {
      color: var(--success);
    }

    .gdp-breakdown-row.pop-row span:last-child {
      color: var(--success);
    }

    .gdp-breakdown-row.interaction-row {
      font-size: 11px;
      opacity: 0.7;
    }

    .gdp-breakdown-row.interaction-row span:last-child {
      color: var(--muted);
    }

    .gdp-breakdown-row.total-row {
      border-top: 1px solid var(--rule);
      margin-top: 4px;
      padding-top: 6px;
      font-weight: 500;
    }

    .gdp-breakdown-row.total-row span:first-child {
      color: var(--ink);
    }

    @media (max-width: 400px) {
      .gdp-methodology {
        width: 280px;
        right: -10px;
      }
    }

    .penalties {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .penalty-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--paper);
      border-radius: 4px;
    }

    .penalty-badge.inflation { background: var(--accent); }
    .penalty-badge.growth { background: #5d4037; }

    .penalty-badge {
      position: relative;
      cursor: pointer;
    }

    .penalty-tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      padding: 12px 14px;
      background: var(--ink);
      color: var(--paper);
      font-size: 12px;
      line-height: 1.5;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .penalty-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: var(--ink);
    }

    .penalty-badge:hover .penalty-tooltip,
    .penalty-badge:focus .penalty-tooltip {
      display: block;
    }

    .penalty-tooltip strong {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: #ffb74d;
    }

    .penalty-tooltip p {
      margin: 0 0 8px 0;
    }

    .penalty-tooltip p:last-child {
      margin-bottom: 0;
    }

    .penalty-tooltip em {
      font-size: 10px;
      opacity: 0.7;
    }

    @media (max-width: 500px) {
      .penalty-tooltip {
        width: 240px;
        left: 0;
        transform: translateX(0);
      }
      .penalty-tooltip::after {
        left: 20px;
        transform: none;
      }
    }

    /* Flippable Penalty Badges */
    .penalty-badge-container {
      display: none;
      position: relative;
    }

    .penalty-badge-container.visible {
      display: block;
    }

    .penalty-badge {
      cursor: pointer;
    }

    .flip-hint {
      font-size: 11px;
      opacity: 0.7;
      margin-left: 4px;
      transition: opacity 0.2s ease;
    }

    .penalty-badge:hover .flip-hint {
      opacity: 1;
    }

    .penalty-badge:hover {
      filter: brightness(1.1);
    }

    .penalty-methodology {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      width: 320px;
      background: var(--paper);
      color: var(--ink);
      border: 1px solid var(--ink);
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .penalty-methodology.visible {
      display: block;
    }

    .penalty-methodology-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--ink);
      color: var(--paper);
    }

    .penalty-methodology-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #ffb74d;
    }

    .penalty-back-button {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      background: none;
      border: 1px solid rgba(255,255,255,0.3);
      color: var(--paper);
      padding: 4px 8px;
      cursor: pointer;
    }

    .penalty-back-button:hover {
      background: rgba(255,255,255,0.1);
    }

    .penalty-methodology-content {
      padding: 12px;
      font-size: 12px;
      line-height: 1.5;
      color: var(--ink);
    }

    .penalty-methodology-content p {
      margin: 0 0 10px 0;
    }

    .penalty-methodology-content p:last-child {
      margin-bottom: 0;
    }

    .penalty-math-table {
      width: 100%;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      margin: 8px 0;
      border-collapse: collapse;
    }

    .penalty-math-table td {
      padding: 4px 8px;
      border-bottom: 1px solid var(--rule);
    }

    .penalty-math-table td:first-child {
      color: var(--muted);
    }

    /* Deficit Warning Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-content {
      background: var(--paper);
      max-width: 340px;
      width: 100%;
      padding: 0;
      box-shadow: 0 8px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: var(--accent);
      color: var(--paper);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-icon {
      font-size: 20px;
    }

    .modal-header h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-body {
      padding: 16px;
      font-size: 0.85rem;
      line-height: 1.5;
      color: var(--ink);
    }

    .modal-body p {
      margin: 0 0 12px 0;
    }

    .modal-math {
      background: var(--paper-dark);
      padding: 10px 12px;
      margin: 12px 0;
      border-left: 3px solid var(--accent);
    }

    .modal-math-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .modal-tier {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--ink);
      margin: 4px 0;
    }

    .modal-tier span {
      color: var(--muted);
      display: inline-block;
      width: 80px;
    }

    .modal-sources {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px !important;
    }

    .modal-assumption {
      font-size: 0.8rem;
      color: var(--muted);
      font-style: italic;
      margin-bottom: 0 !important;
    }

    .modal-close-btn {
      display: block;
      width: calc(100% - 32px);
      margin: 0 16px 16px 16px;
      padding: 10px;
      background: var(--ink);
      color: var(--paper);
      border: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
    }

    .modal-close-btn:hover {
      background: var(--accent);
    }

    @media (max-width: 400px) {
      .penalty-methodology {
        width: 280px;
        left: -20px;
      }
    }

    /* Floating Share Button */
    .floating-share-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--ink);
      color: var(--paper);
      border: none;
      padding: 12px 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
      transition: all 0.2s ease;
    }

    .floating-share-btn:hover {
      background: var(--accent);
      transform: translateY(-2px);
    }

    .floating-share-btn span {
      font-size: 16px;
    }

    /* Share Modal Styles */
    .share-modal-content {
      max-width: 380px;
    }

    .share-header {
      background: linear-gradient(135deg, var(--ink) 0%, #2a2a2a 100%);
    }

    .share-type-description {
      font-size: 1rem;
      font-style: italic;
      color: var(--muted);
      text-align: center;
      padding: 0 0 16px 0;
      border-bottom: 1px solid var(--rule);
      margin-bottom: 16px;
    }

    .share-results {
      background: var(--paper-dark);
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .share-result-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
    }

    .share-result-label {
      color: var(--muted);
    }

    .share-result-value {
      font-weight: 600;
    }

    .share-policies {
      margin-bottom: 16px;
    }

    .share-policies-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .share-policies-list {
      font-size: 0.85rem;
      line-height: 1.6;
      max-height: 120px;
      overflow-y: auto;
    }

    .share-policy-item {
      display: inline-block;
      background: var(--paper-dark);
      padding: 2px 8px;
      margin: 2px 4px 2px 0;
      font-size: 11px;
    }

    .share-policy-item.fertility { border-left: 2px solid var(--ink); }
    .share-policy-item.entitlement { border-left: 2px solid var(--success); }
    .share-policy-item.tax { border-left: 2px solid #5d4037; }
    .share-policy-item.illiberal { border-left: 2px solid var(--accent); }

    .share-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .share-btn {
      flex: 1;
      padding: 12px;
      border: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .share-btn-x {
      background: #000;
      color: #fff;
    }

    .share-btn-x:hover {
      background: #333;
    }

    .share-btn-copy {
      background: var(--paper-dark);
      color: var(--ink);
      border: 1px solid var(--rule);
    }

    .share-btn-copy:hover {
      background: var(--ink);
      color: var(--paper);
    }

    .share-copied {
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--success);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .share-copied.visible {
      opacity: 1;
    }

    @media (max-width: 400px) {
      .floating-share-btn {
        bottom: 12px;
        left: 12px;
        padding: 10px 16px;
        font-size: 11px;
      }
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: var(--paper-dark);
      border-bottom: 1px solid var(--rule);
      flex-shrink: 0;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 12px;
      background: none;
      border: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: var(--ink);
      background: var(--paper);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--ink);
    }

    .tab-btn .tab-count {
      display: inline-block;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      text-align: center;
      background: var(--ink);
      color: var(--paper);
      border-radius: 9px;
      font-size: 9px;
      margin-left: 6px;
    }

    .tab-btn.active .tab-count { background: var(--accent); }

    /* Tab Content */
    .tab-container {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .tab-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      padding: 20px;
      -webkit-overflow-scrolling: touch;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease;
    }

    .tab-panel.active {
      opacity: 1;
      visibility: visible;
    }

    /* Card Flip Container */
    .card-container {
      perspective: 1000px;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
      transition: z-index 0s 0.3s;
    }

    .card-container.flipped {
      z-index: 100;
      transition: z-index 0s 0s;
    }

    .card-flipper {
      position: relative;
      transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-container.flipped .card-flipper {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .card-front {
      position: relative;
    }

    .card-back {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      transform: rotateY(180deg);
      overflow: hidden;
    }

    /* Policy Cards */
    .policy-card {
      border: 1px solid var(--rule);
      padding: 16px;
      background: var(--paper);
      transition: all 0.2s ease;
    }

    .policy-card.enabled {
      border-color: var(--ink);
      background: white;
    }

    .policy-card.illiberal { border-left: 4px solid var(--accent); }
    .policy-card.tax-card { border-left: 4px solid #5d4037; }
    .policy-card.entitlement-card { border-left: 4px solid var(--success); }
    .methodology-card.tax-methodology { border-left: 4px solid #5d4037; }

    /* Effective Impact Display */
    .effective-impact {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px dashed var(--rule);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
    }

    .effective-impact.hidden {
      display: none;
    }

    .effective-label {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 9px;
      letter-spacing: 0.5px;
    }

    .effective-value {
      font-weight: 600;
      font-size: 13px;
      color: var(--success);
    }

    .effective-value.negative {
      color: var(--accent);
    }

    .effective-breakdown {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.5;
    }

    .threshold-row {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--paper-dark);
    }

    .threshold-row.hidden { display: none; }

    .policy-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 12px;
    }

    .policy-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.3;
      cursor: pointer;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .policy-title:hover {
      color: var(--accent);
    }

    .policy-title::after {
      content: '‚ìò';
      font-size: 0.7rem;
      opacity: 0.4;
      transition: opacity 0.2s ease;
    }

    .policy-title:hover::after {
      opacity: 1;
    }

    .policy-stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .policy-stat {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 2px 8px;
      background: var(--paper-dark);
    }

    .policy-stat.tfr { color: var(--success); }
    .policy-stat.cost { color: var(--muted); }
    .policy-stat.drag { color: #5d4037; background: rgba(93,64,55,0.1); }

    .policy-description {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .toggle input { opacity: 0; width: 0; height: 0; }

    .toggle-track {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--paper-dark);
      border: 1px solid var(--rule);
      transition: all 0.3s ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      background: var(--muted);
      transition: all 0.3s ease;
    }

    .toggle input:checked + .toggle-track {
      background: var(--ink);
      border-color: var(--ink);
    }

    .toggle input:checked + .toggle-track .toggle-thumb {
      transform: translateX(20px);
      background: var(--paper);
    }

    .toggle-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .slider-row {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--paper-dark);
    }

    .slider-row.hidden { display: none; }

    .slider-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .slider-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .slider-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 500;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: var(--paper-dark);
      border: 1px solid var(--rule);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--ink);
      cursor: pointer;
    }

    /* Card Back Styles */
    .methodology-card {
      border: 1px solid var(--ink);
      padding: 16px;
      background: white;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      max-height: 100%;
      overflow-y: auto;
    }

    .methodology-card.illiberal { border-left: 4px solid var(--accent); }

    .methodology-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--rule);
    }

    .methodology-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .back-button {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      background: none;
      border: 1px solid var(--rule);
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .back-button:hover {
      background: var(--ink);
      color: var(--paper);
      border-color: var(--ink);
    }

    .methodology-section {
      margin-bottom: 12px;
    }

    .methodology-section:last-child {
      margin-bottom: 0;
    }

    .methodology-section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .methodology-content {
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--ink);
    }

    .methodology-content em {
      color: var(--muted);
      font-style: normal;
    }

    .source-cite {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      background: var(--paper-dark);
      padding: 2px 6px;
      margin-right: 4px;
      white-space: nowrap;
    }

    .elasticity-table {
      width: 100%;
      font-size: 0.75rem;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .elasticity-table th, .elasticity-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid var(--paper-dark);
    }

    .elasticity-table th {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: normal;
    }

    .confidence-badge {
      display: inline-block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      padding: 2px 6px;
      text-transform: uppercase;
    }

    .confidence-badge.high { background: #e8f5e9; color: #2d5016; }
    .confidence-badge.medium { background: #fff8e1; color: #8b6914; }
    .confidence-badge.low { background: #ffebee; color: #8b0000; }

    .section-header {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--rule);
    }

    .section-intro {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .subsection { margin-top: 24px; }

    .subsection-header {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .subsection-header::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--rule);
    }

    .callout {
      padding: 12px 16px;
      margin-bottom: 16px;
      border-left: 3px solid var(--accent);
      background: linear-gradient(90deg, rgba(139,0,0,0.05) 0%, var(--paper) 100%);
      font-size: 0.85rem;
    }

    .callout-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .historical-note {
      font-size: 0.8rem;
      font-style: italic;
      color: var(--muted);
      padding: 10px 12px;
      background: var(--paper-dark);
      margin-top: 10px;
    }

    .params-card {
      border: 1px solid var(--rule);
      padding: 16px;
      margin-bottom: 12px;
      background: var(--paper);
    }

    .params-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .params-description {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 6px;
    }

    @media (max-width: 400px) {
      .tfr-number-large { font-size: 2rem; }
      .fiscal-strip { gap: 8px; }
      .fiscal-value { font-size: 0.85rem; }
    }

    /* Splash Page */
    .splash-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--ink);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .splash-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .splash-content {
      max-width: 540px;
      width: 100%;
      color: var(--paper);
    }

    .splash-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .splash-icon {
      font-size: 48px;
      margin-bottom: 16px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .splash-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 2.25rem;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 16px;
    }

    .splash-title em {
      color: var(--accent);
      font-style: italic;
      background: var(--paper);
      padding: 0 8px;
    }

    .splash-subtitle {
      font-size: 1.15rem;
      color: rgba(248, 246, 241, 0.85);
      line-height: 1.6;
    }

    .splash-challenge {
      display: flex;
      justify-content: center;
      margin-bottom: 28px;
    }

    .splash-goal-centered {
      background: rgba(255,255,255,0.08);
      padding: 20px 48px;
      text-align: center;
    }

    .splash-goal, .splash-constraint {
      flex: 1;
      background: rgba(255,255,255,0.08);
      padding: 16px;
      text-align: center;
    }

    .splash-goal-label, .splash-constraint-label {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(248, 246, 241, 0.5);
      margin-bottom: 6px;
    }

    .splash-goal-value {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--success);
      background: #e8f5e9;
      padding: 2px 8px;
    }

    .splash-constraint-value {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent);
      background: #ffebee;
      padding: 2px 8px;
    }

    .splash-caveats {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      margin-bottom: 28px;
      border-left: 3px solid rgba(248, 246, 241, 0.3);
    }

    .splash-caveats-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(248, 246, 241, 0.7);
      margin-bottom: 14px;
    }

    .splash-caveats-list {
      list-style: none;
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(248, 246, 241, 0.85);
    }

    .splash-caveats-list li {
      margin-bottom: 12px;
      padding-left: 18px;
      position: relative;
    }

    .splash-caveats-list li:before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: rgba(248, 246, 241, 0.4);
    }

    .splash-caveats-list li:last-child {
      margin-bottom: 0;
    }

    .splash-caveats-list strong {
      color: var(--paper);
    }

    .splash-footer {
      text-align: center;
    }

    .splash-start-btn {
      background: var(--paper);
      color: var(--ink);
      border: none;
      padding: 16px 48px;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      margin-bottom: 16px;
    }

    .splash-start-btn:hover {
      background: var(--accent);
      color: var(--paper);
      transform: scale(1.02);
    }

    .splash-arrow {
      transition: transform 0.2s ease;
    }

    .splash-start-btn:hover .splash-arrow {
      transform: translateX(4px);
    }

    .splash-credits {
      font-size: 0.85rem;
      color: rgba(248, 246, 241, 0.6);
      line-height: 1.6;
    }

    @media (max-width: 500px) {
      .splash-title { font-size: 1.75rem; }
      .splash-subtitle { font-size: 1rem; }
      .splash-challenge { flex-direction: column; gap: 12px; }
      .splash-goal-value, .splash-constraint-value { font-size: 1.1rem; }
      .splash-caveats { padding: 16px; }
      .splash-caveats-list { font-size: 0.9rem; }
      .splash-start-btn { padding: 14px 36px; font-size: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Splash Page -->
  <div class="splash-overlay" id="splash-overlay">
    <div class="splash-content">
      <div class="splash-header">
        <div class="splash-icon">üë∂</div>
        <h1 class="splash-title">Can <em>YOU</em> Solve the Fertility Crisis?</h1>
        <p class="splash-subtitle">America's fertility rate has fallen to 1.62‚Äîfar below the 2.1 needed for population replacement. You're the policy czar. Fix it.</p>
      </div>

      <div class="splash-challenge">
        <div class="splash-goal-centered">
          <span class="splash-goal-label">Your Mission</span>
          <span class="splash-goal-value">Reach TFR 2.1</span>
        </div>
      </div>

      <div class="splash-caveats">
        <div class="splash-caveats-title">‚ö†Ô∏è Before You Begin</div>
        <ul class="splash-caveats-list">
          <li><strong>This is a thought experiment, not a forecast.</strong> Fertility behavior is notoriously hard to predict.</li>
          <li><strong>Estimates borrow from international studies</strong> (Nordic countries, Hungary, etc.) that may not transfer to the US context.</li>
          <li><strong>Policy interactions are uncertain.</strong> We discount stacked effects, but the true interaction could be larger or smaller.</li>
          <li><strong>Implementation matters enormously.</strong> The same policy can succeed or fail based on execution.</li>
          <li><strong>Culture eats policy for breakfast.</strong> No spending package can fully override deep shifts in preferences about family size.</li>
        </ul>
      </div>

      <div class="splash-footer">
        <button class="splash-start-btn" id="splash-start-btn">
          <span>Start Building</span>
          <span class="splash-arrow">‚Üí</span>
        </button>
        <p class="splash-credits">Built for exploration and debate, not prediction.<br>Click any policy title to see methodology and sources.</p>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <span class="header-title">Fertility Policy Simulator</span>
      <div class="tfr-compact">
        <div class="tfr-meta">
          <span class="tfr-label">Projected TFR</span>
          <span class="tfr-status" id="tfr-status">BELOW REPLACEMENT</span>
        </div>
        <span class="tfr-number-large" id="tfr-number">1.62</span>
      </div>
    </div>

    <div class="tfr-progress">
      <div class="tfr-progress-fill" id="tfr-progress"></div>
      <div class="tfr-progress-marker"></div>
    </div>

    <div class="fiscal-strip">
      <div class="fiscal-item">
        <div class="fiscal-label">Policy Spend</div>
        <div class="fiscal-value" id="total-spending">$0B</div>
      </div>
      <div class="fiscal-item">
        <div class="fiscal-label">Offsets</div>
        <div class="fiscal-value positive" id="total-offsets">$0B</div>
      </div>
      <div class="fiscal-item">
        <div class="fiscal-label">Policy Net</div>
        <div class="fiscal-value" id="net-impact">$0B</div>
      </div>
      <div class="fiscal-item" style="border-left: 1px solid rgba(255,255,255,0.2); padding-left: 12px;">
        <div class="fiscal-label">Total Deficit</div>
        <div class="fiscal-value negative" id="total-deficit">$1,900B</div>
        <div class="fiscal-sublabel" id="deficit-breakdown" style="font-size: 9px; opacity: 0.7;">CBO baseline</div>
      </div>
      <div class="fiscal-item gdp-projection" id="gdp-container">
        <div class="fiscal-label">GDP 2075</div>
        <div class="fiscal-value gdp-clickable" id="gdp-projection">$75T</div>
        <div class="fiscal-sublabel" id="gdp-change"></div>
        <div class="gdp-methodology" id="gdp-methodology">
          <div class="penalty-methodology-header">
            <span class="penalty-methodology-title">GDP 2075 Projection</span>
            <button class="penalty-back-button gdp-back-button">‚Üê Back</button>
          </div>
          <div class="penalty-methodology-content">
            <p><strong>Baseline:</strong> $28T (2024) ‚Üí $75T (2075) at 2% real growth</p>
            <div class="gdp-breakdown">
              <div class="gdp-breakdown-title">Your Policy Impact</div>
              <div class="gdp-breakdown-row">
                <span>Baseline GDP 2075</span>
                <span id="gdp-baseline-val">$75T</span>
              </div>
              <div class="gdp-breakdown-row fiscal-row">
                <span>Fiscal effect</span>
                <span id="gdp-fiscal-val">+$0T</span>
              </div>
              <div class="gdp-breakdown-row tax-drag-row">
                <span>Tax drag effect</span>
                <span id="gdp-tax-drag-val">‚àí$0T</span>
              </div>
              <div class="gdp-breakdown-row" id="gdp-inflation-row" style="display: none;">
                <span>Inflation drag</span>
                <span id="gdp-inflation-val" style="color: #c62828;">‚àí$0T</span>
              </div>
              <div class="gdp-breakdown-row pop-row">
                <span>Population effect</span>
                <span id="gdp-pop-val">+$0T</span>
              </div>
              <div class="gdp-breakdown-row interaction-row">
                <span>Interaction</span>
                <span id="gdp-interaction-val">$0T</span>
              </div>
              <div class="gdp-breakdown-row total-row">
                <span>Projected GDP</span>
                <span id="gdp-total-val">$75T</span>
              </div>
            </div>
            <p><strong>Fiscal effect:</strong> Entitlement reform reduces debt burden (+growth); deficits crowd out investment (‚àígrowth). ~0.03% annual boost per $100B savings.</p>
            <p><strong>Tax drag:</strong> Each 0.01 TFR drag ‚âà 0.1% lower annual growth, compounded over 50 years.</p>
            <p><strong>Inflation drag:</strong> Persistent inflation from fiscal dominance reduces growth through investment uncertainty, menu costs, and capital misallocation. ~0.05-0.2% lower annual growth per 1pp inflation.</p>
            <p><strong>Population:</strong> Higher TFR ‚Üí larger workforce. Each +1.0 TFR ‚âà +0.5% annual growth (phases in year 20-30).</p>
            <p style="font-size: 10px; color: #666;"><strong>Sources:</strong> CBO long-term projections; Maestas et al. (2016); Elmendorf & Sheiner (2017); Fischer (1993), Barro (1995), Bruno & Easterly (1998) on inflation-growth.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="penalties">
      <div class="penalty-badge-container" id="inflation-container">
        <div class="penalty-badge inflation" id="penalty-inflation">
          <span>‚ö†</span>
          <span>Inflation: <span id="inflation-penalty-val">-0.00</span> TFR</span>
          <span class="flip-hint">‚ìò</span>
        </div>
        <div class="penalty-methodology" id="inflation-methodology">
          <div class="penalty-methodology-header">
            <span class="penalty-methodology-title">Deficit ‚Üí Inflation ‚Üí Fertility</span>
            <button class="penalty-back-button">‚Üê Back</button>
          </div>
          <div class="penalty-methodology-content">
            <p><strong>Two-stage elasticity chain:</strong></p>
            
            <p style="margin-top: 8px;"><strong>Stage 1: Deficit ‚Üí Inflation</strong></p>
            <table class="penalty-math-table">
              <tr><td>Central estimate</td><td>0.30% inflation per 1% GDP</td></tr>
              <tr><td>With slack</td><td>0.15-0.20% per 1% GDP</td></tr>
              <tr><td>Near full employment</td><td>0.25-0.40% per 1% GDP</td></tr>
              <tr><td>Supply constrained</td><td>0.50-1.0% per 1% GDP</td></tr>
            </table>
            <p style="font-size: 10px; color: #666; margin-top: 4px;">
              <em>Sources: SF Fed (Jord√† 2022), NY Fed (di Giovanni 2023), Bernanke-Blanchard (2023)</em>
            </p>
            
            <p style="margin-top: 10px;"><strong>Stage 2: Inflation ‚Üí TFR</strong></p>
            <table class="penalty-math-table">
              <tr><td>Direct effect</td><td>‚àí0.3 to ‚àí0.4% TFR per 1% CPI</td></tr>
              <tr><td>Uncertainty channel</td><td>‚àí0.2 to ‚àí0.3% additional</td></tr>
              <tr><td>Total short-run</td><td>‚àí0.5 to ‚àí0.8% per 1% inflation</td></tr>
            </table>
            <p style="font-size: 10px; color: #666; margin-top: 4px;">
              <em>Sources: Pacific Islands panel (2021), Comolli (2017), Adsera & Menendez (2011)</em>
            </p>
            
            <p style="margin-top: 10px; color: #8b0000;"><strong>‚ö† Fiscal Dominance Multipliers</strong></p>
            <p style="font-size: 11px;">At high deficit/GDP, central banks lose ability to fight inflation. Elasticity multipliers increase nonlinearly, and <strong>above 8% deficit/GDP the model switches to TOTAL deficit</strong> (not just incremental) because markets price in full unsustainability:</p>
            <table class="penalty-math-table">
              <tr style="background: #e8f5e9;"><td>&lt;6% deficit/GDP</td><td>1.0√ó (incremental)</td></tr>
              <tr style="background: #fff3e0;"><td>6-8% deficit/GDP</td><td>1.0-1.75√ó (incremental)</td></tr>
              <tr style="background: #ffebee;"><td>8-10% deficit/GDP</td><td>1.75-3.5√ó (TOTAL deficit)</td></tr>
              <tr style="background: #ffcdd2;"><td>&gt;10% deficit/GDP</td><td>3.5-6.0√ó (TOTAL, FTPL regime)</td></tr>
            </table>
            <p style="font-size: 10px; color: #666; margin-top: 4px;">
              <em>Sources: Cochrane/Leeper/Sims (FTPL): ~1:1 under dominance; Sargent & Wallace (1981) "unpleasant monetarist arithmetic"; BIS Papers No. 65; Boston Fed (2025)</em>
            </p>
            
            <p style="margin-top: 10px;"><strong>Current calculation:</strong></p>
            <div id="inflation-calc-breakdown" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; background: #f5f5f5; padding: 8px; margin-top: 4px;">
              $0B deficit ‚Üí 0.0% GDP ‚Üí 0.0pp inflation ‚Üí ‚àí0.00 TFR
            </div>
            <div id="fiscal-stress-indicator" style="font-family: 'JetBrains Mono', monospace; font-size: 10px; margin-top: 4px; padding: 4px 8px; background: #e8f5e9; display: none;">
              Fiscal stress: Normal (1.0√ó multiplier)
            </div>
          </div>
        </div>
      </div>
      <div class="penalty-badge-container" id="growth-container">
        <div class="penalty-badge growth" id="penalty-growth">
          <span>üìâ</span>
          <span>Growth Drag: <span id="growth-penalty-val">-0.00</span> TFR</span>
          <span class="flip-hint">‚ìò</span>
        </div>
        <div class="penalty-methodology" id="growth-methodology">
          <div class="penalty-methodology-header">
            <span class="penalty-methodology-title">Tax ‚Üí Growth Drag ‚Üí Fertility</span>
            <button class="penalty-back-button">‚Üê Back</button>
          </div>
          <div class="penalty-methodology-content">
            <p><strong>Mechanism:</strong> Distortionary taxes reduce growth through labor supply effects, reduced investment, and capital misallocation. Lower growth = lower wages and higher uncertainty.</p>
            <p><strong>Elasticity:</strong></p>
            <table class="penalty-math-table">
              <tr><td>1% GDP reduction</td><td>~0.005 TFR reduction</td></tr>
              <tr><td>0.01 TFR drag</td><td>‚âà 0.1% annual GDP drag</td></tr>
            </table>
            <p><strong>Sources:</strong> Becker (1960) income-fertility; Keane (2011) labor supply meta-analysis; CBO tax/GDP estimates; Romer & Romer (2010) tax multipliers.</p>
            <p><strong>Note:</strong> Entitlement reform has no growth drag‚Äîit's a transfer, not a distortion.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Deficit Warning Modal -->
    <div class="modal-overlay" id="deficit-modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-icon">‚ö†Ô∏è</span>
          <h3>Deficit ‚Üí Inflation ‚Üí Fertility</h3>
        </div>
        <div class="modal-body">
          <p>Unfunded spending under tight labor markets creates inflationary pressure that hurts young families through higher housing, childcare, and food costs.</p>
          
          <div class="modal-math">
            <div class="modal-math-title">Empirical Elasticity Chain</div>
            <div class="modal-tier"><span>Deficit ‚Üí Inflation:</span> 0.30% per 1% GDP*</div>
            <div class="modal-tier"><span>Inflation ‚Üí TFR:</span> ‚àí0.5 to ‚àí0.8% per 1%</div>
            <div class="modal-tier"><span>Combined:</span> ~0.01 TFR per $500B deficit</div>
          </div>
          
          <p class="modal-sources"><strong>Sources:</strong></p>
          <p class="modal-sources" style="font-size: 10px;">
            <em>Deficit‚ÜíInflation:</em> SF Fed (Jord√† 2022), NY Fed (di Giovanni 2023), Bernanke-Blanchard NBER (2023)<br>
            <em>Inflation‚ÜíTFR:</em> Pacific Islands panel (2021), Comolli (2017), Adsera & Menendez (2011)
          </p>
          
          <p class="modal-assumption"><strong>*Note:</strong> Elasticity varies by economic slack. Near full employment assumed. Adjust in Model Parameters to simulate different conditions.</p>
        </div>
        <button class="modal-close-btn" id="close-deficit-modal">Got it</button>
      </div>
    </div>
    
    <!-- Fiscal Crisis Warning Modal -->
    <div class="modal-overlay" id="fiscal-crisis-modal">
      <div class="modal-content" style="border-left: 4px solid #c62828;">
        <div class="modal-header" style="background: #ffebee;">
          <span class="modal-icon">üö®</span>
          <h3 style="color: #c62828;">Fiscal Dominance Warning</h3>
        </div>
        <div class="modal-body">
          <p><strong>Your policy package pushes total deficit above 8% of GDP.</strong></p>
          
          <p>At this level, the US enters "fiscal dominance" territory where the Federal Reserve loses its ability to control inflation through interest rate policy. Rate hikes sufficient to fight inflation would explode debt service costs, forcing either:</p>
          
          <ul style="margin: 12px 0; padding-left: 20px; font-size: 13px;">
            <li>Fiscal austerity severe enough to crash the economy, or</li>
            <li>Monetization of the deficit, creating the inflation you're trying to fight</li>
          </ul>
          
          <div class="modal-math" style="background: #ffebee; border-color: #c62828;">
            <div class="modal-math-title" style="color: #c62828;">Nonlinear Multipliers Kick In</div>
            <div class="modal-tier"><span>8-10% deficit/GDP:</span> 1.5-2.5√ó inflation elasticity</div>
            <div class="modal-tier"><span>&gt;10% deficit/GDP:</span> 2.5-4.0√ó (approaching FTPL 1:1)</div>
          </div>
          
          <p class="modal-sources"><strong>Why this matters for fertility:</strong></p>
          <p style="font-size: 12px;">Unanchored inflation expectations create uncertainty that delays family formation. Turkey's TFR collapsed from 2.38 to 1.48 under persistent fiscal stress. Eastern Europe lost 30-40% of fertility during 1989-95 transition crisis.</p>
          
          <p class="modal-sources" style="font-size: 10px; margin-top: 12px;">
            <em>Sources: Cochrane/Leeper/Sims (Fiscal Theory of Price Level); BIS Papers No. 65 "Threat of fiscal dominance?"; Boston Fed (2025) "Household Beliefs about Fiscal Dominance"; Mercatus (2023)</em>
          </p>
          
          <p class="modal-assumption"><strong>Recommendation:</strong> Consider adding offsets (entitlement reform or taxes) to bring net deficit impact below $500B, or accept significantly reduced fertility gains from your package.</p>
        </div>
        <button class="modal-close-btn" id="close-fiscal-crisis-modal">I understand the tradeoff</button>
      </div>
    </div>

    <!-- Share Results Modal -->
    <div class="modal-overlay" id="share-modal">
      <div class="modal-content share-modal-content">
        <div class="modal-header share-header">
          <span class="modal-icon" id="share-type-icon">üéØ</span>
          <h3 id="share-type-title">The Pragmatist</h3>
        </div>
        <div class="modal-body">
          <div class="share-type-description" id="share-type-desc">
            You balance ambition with fiscal reality.
          </div>
          
          <div class="share-results">
            <div class="share-result-row">
              <span class="share-result-label">Projected TFR</span>
              <span class="share-result-value" id="share-tfr">1.62</span>
            </div>
            <div class="share-result-row">
              <span class="share-result-label">GDP 2075</span>
              <span class="share-result-value" id="share-gdp">$75T</span>
            </div>
            <div class="share-result-row">
              <span class="share-result-label">Net Fiscal</span>
              <span class="share-result-value" id="share-fiscal">$0B</span>
            </div>
          </div>

          <div class="share-policies">
            <div class="share-policies-title">Your Package</div>
            <div class="share-policies-list" id="share-policies-list">
              <em>No policies selected</em>
            </div>
          </div>

          <div class="share-buttons">
            <button class="share-btn share-btn-x" id="share-x">
              <span>ùïè</span> Share
            </button>
            <button class="share-btn share-btn-copy" id="share-copy">
              <span>üìã</span> Copy Link
            </button>
          </div>
          
          <div class="share-copied" id="share-copied">Link copied!</div>
        </div>
        <button class="modal-close-btn" id="close-share-modal">Close</button>
      </div>
    </div>

    <!-- Floating Share Button -->
    <button class="floating-share-btn" id="open-share-modal">
      <span>üìä</span> Share Results
    </button>
  </header>

  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="0">
      Policies<span class="tab-count" id="count-policies">0</span>
    </button>
    <button class="tab-btn" data-tab="1">
      Entitlements<span class="tab-count" id="count-entitlements">0</span>
    </button>
    <button class="tab-btn" data-tab="2">
      Taxes<span class="tab-count" id="count-taxes">0</span>
    </button>
  </nav>

  <div class="tab-container">
    <div class="tab-panel active" id="panel-0">
      <h2 class="section-header">Fertility Policies</h2>
      <p class="section-intro">Tap any policy name to see methodology and sources.</p>
      <div id="liberal-policies"></div>
      <div class="subsection">
        <div class="subsection-header">Illiberal Policies</div>
        <div class="callout">
          <div class="callout-title">Ethical Warning</div>
          These policies restrict reproductive autonomy. Included for analytical completeness.
        </div>
        <div id="illiberal-policies"></div>
      </div>
      <div class="subsection">
        <div class="subsection-header">Model Parameters</div>
        <div id="model-params"></div>
      </div>
    </div>

    <div class="tab-panel" id="panel-1">
      <h2 class="section-header">Entitlement Reform</h2>
      <p class="section-intro">Intergenerational rebalancing. These offsets have no growth penalty‚Äîthe only "free" funding source.</p>
      <div id="entitlement-reforms"></div>
    </div>

    <div class="tab-panel" id="panel-2">
      <h2 class="section-header">Tax Increases</h2>
      <p class="section-intro">Alternative funding. Tap any policy name to see sources for growth drag estimates. Adjust thresholds to see revenue/drag tradeoffs.</p>
      <div id="tax-increases"></div>
    </div>
  </div>

  <script>
    const liberalPolicies = [
      { 
        id: 'child-allowance', 
        name: 'Universal Child Allowance', 
        description: 'Monthly payment per child, ages 0-6. (Ages 7-17 at 60%)', 
        costLow: 250, costHigh: 300, tfrLow: 0.15, tfrHigh: 0.20, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Monthly amount', min: 200, max: 800, default: 500, format: v => `$${v}/mo` },
        confidence: 'medium',
        methodology: {
          derivation: 'Laroque & Salani√© (2014): ‚Ç¨1k/mo ‚Üí +0.05 TFR. At $500/mo (~‚Ç¨450/mo equivalent), base estimate: +0.02-0.03. Universal design + front-loading + no marriage penalty amplifies effect. Cohen elasticity applied to effective ~50% income increase for median family.',
          sources: [
            { cite: 'Cohen et al. (2013)', finding: '30% benefit increase ‚Üí 10% fertility increase', elasticity: '~0.3' },
            { cite: 'Laroque & Salani√© (2014)', finding: '‚Ç¨1k/mo ‚Üí +0.05 TFR', elasticity: '~0.05 per ‚Ç¨12k' }
          ],
          notes: 'Universal design eliminates marriage penalties and reduces administrative overhead. Front-loading to ages 0-6 targets period of highest childcare costs.'
        }
      },
      { 
        id: 'third-child-bonus', 
        name: '3+ Child Tax Bonus', 
        description: 'Federal tax return per 3rd+ child, ages 0-6.', 
        costLow: 100, costHigh: 150, tfrLow: 0.10, tfrHigh: 0.15, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Tax return %', min: 50, max: 150, default: 100, format: v => `${v}%` },
        confidence: 'medium',
        methodology: {
          derivation: 'Cohen: ($32k/$12k) √ó 0.3 √ó 0.28 (3rd+ share) = +0.07. Duclos Quebec 3rd+ bonus showed +25% increase in 3rd births, scaled to US context = +0.08-0.12. Stacking on allowance creates additional marginal incentive.',
          sources: [
            { cite: 'Cohen et al. (2013)', finding: 'Marginal incentive effects on higher-parity births', elasticity: '~0.3' },
            { cite: 'Duclos et al. (2001)', finding: 'Quebec 3rd+ bonus ‚Üí +25% third births', elasticity: 'Parity-specific' }
          ],
          notes: '100% = full federal tax liability returned. 150% = refundable beyond liability. FISCAL REALITY: This is a transfer, not an investment with positive fiscal return.'
        }
      },
      { 
        id: 'childcare', 
        name: 'Universal Childcare', 
        description: 'Subsidized childcare, ages 0-5. Quebec model.', 
        costLow: 80, costHigh: 100, tfrLow: 0.10, tfrHigh: 0.15, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Family daily cost', min: 0, max: 20, default: 5, format: v => v === 0 ? 'Free' : `$${v}/day`, invert: true },
        confidence: 'high',
        methodology: {
          derivation: 'Direct application of Milligan (2005) Quebec estimate. This is the highest-confidence estimate in the package due to direct replication and sustained effects confirmed by Ang (2015).',
          sources: [
            { cite: 'Milligan (2005)', finding: 'Quebec $5/day program ‚Üí +0.10-0.15 TFR', elasticity: 'Direct estimate' },
            { cite: 'Ang (2015)', finding: 'Confirmed sustained effects of Quebec program', elasticity: 'Replication' }
          ],
          notes: 'Current avg US childcare cost: ~$50/day ($1,200/month). Quebec charges ~$9 CAD/day. $0 = fully subsidized.'
        }
      },
      { 
        id: 'parental-leave', 
        name: 'Paid Parental Leave', 
        description: '80% salary replacement, job-protected.', 
        costLow: 60, costHigh: 100, tfrLow: 0.08, tfrHigh: 0.12, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Leave duration', min: 3, max: 18, default: 12, format: v => `${v} months` },
        confidence: 'medium-high',
        methodology: {
          derivation: 'Lalive baseline: +0.04-0.06. Raute finding: +0.08-0.10 for educated women. US zero baseline maximizes potential impact. Extended to 12 months for full effect.',
          sources: [
            { cite: 'Raute (2019)', finding: 'Germany Elterngeld ‚Üí +22% first births among educated women', elasticity: '+0.08-0.10' },
            { cite: 'Lalive & Zweim√ºller (2009)', finding: 'Austria leave extension ‚Üí +5.7% second births', elasticity: '+0.04-0.06' }
          ],
          notes: 'The US is the only OECD country without federal paid leave. Nordic countries offer 12-18 months. Effects diminish beyond ~12 months.'
        }
      },
      { 
        id: 'debt-relief', 
        name: 'Marriage-Linked Debt Relief', 
        description: 'Student loans paused on marriage, forgiven on birth.', 
        costLow: 60, costHigh: 80, tfrLow: 0.06, tfrHigh: 0.12, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Forgiveness %', min: 25, max: 100, default: 100, format: v => `${v}%` },
        confidence: 'low',
        methodology: {
          derivation: 'Addo: $10k debt ‚Üí 7 month marriage delay. At $52k avg total debt ‚Üí ~3yr shift in family formation timing. Curve shift estimate: +0.10-0.15, discounted 40% for tempo effects (timing vs. quantum).',
          sources: [
            { cite: 'Addo (2014)', finding: '$10k student debt ‚Üí 7 month marriage delay', elasticity: 'Indirect' }
          ],
          notes: 'HIGH UNCERTAINTY: 30-50% of impact may be timing shift rather than additional births. Tempo vs quantum effects unclear. Includes both federal (~$37k avg) and private (~$15k avg) loans.'
        }
      },
      { 
        id: 'housing', 
        name: 'Federal Housing Program', 
        description: 'Direct federal construction in high-cost metros.', 
        costLow: 150, costHigh: 200, tfrLow: 0.12, tfrHigh: 0.20, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Units per year', min: 250, max: 1500, default: 1000, format: v => `${v}k units` },
        confidence: 'low',
        methodology: {
          derivation: 'Dettling & Kearney: 10% housing price increase ‚Üí 2-3% fertility decrease. Inverting: 30% price reduction √ó 2.5% √ó 1.62 baseline √ó 2.5 (multiplier for sustained effect) = +0.12-0.20.',
          sources: [
            { cite: 'Dettling & Kearney (2014)', finding: '10% housing price increase ‚Üí 2-3% fertility decrease', elasticity: '~0.25' }
          ],
          notes: 'HIGH UNCERTAINTY: Current US multifamily construction ~400k/yr. 1M units requires 2.5x capacity increase. Singapore HDB model as reference.'
        }
      },
      { 
        id: 'fertility-coverage', 
        name: 'Universal Fertility Coverage', 
        description: 'IVF, IUI, egg freezing covered by insurance.', 
        costLow: 15, costHigh: 25, tfrLow: 0.02, tfrHigh: 0.05, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'IVF cycles covered', min: 2, max: 10, default: 6, format: v => v >= 10 ? 'Unlimited' : `${v} cycles` },
        confidence: 'medium',
        methodology: {
          derivation: 'Israeli universal fertility coverage contributes ~0.03 TFR. 15-20% of couples affected by infertility. Modest but additive effect.',
          sources: [
            { cite: 'Israeli experience', finding: 'Universal coverage ‚Üí ~0.03 TFR contribution', elasticity: 'Direct observation' }
          ],
          notes: 'Israel covers unlimited cycles. Current avg IVF cost: ~$15-20k per cycle, avg 2.5 cycles needed.'
        }
      },
      { 
        id: 'baby-bonds', 
        name: 'Baby Bonds', 
        description: 'Trust fund at birth, accessible at 18 for education/housing.', 
        costLow: 40, costHigh: 50, tfrLow: 0.03, tfrHigh: 0.06, 
        enabled: false, intensity: 100,
        sliderConfig: { label: 'Bond amount', min: 5, max: 25, default: 10, format: v => `$${v}k` },
        confidence: 'low',
        methodology: {
          derivation: 'No direct fertility precedent. UK Child Trust Fund provides partial model. Theoretical signal effect: reduces parental anxiety about child\'s future economic prospects.',
          sources: [
            { cite: 'UK Child Trust Fund', finding: 'Partial precedent for universal child accounts', elasticity: 'Theoretical' }
          ],
          notes: '$10k grows to ~$34k over 18 years at 7% return. Eligible uses: education, housing down payment, business startup. PRIMARY VALUE: Creates forward-looking constituency, not direct fertility impact.'
        }
      }
    ];

    const illiberalPolicies = [
      { 
        id: 'abortion-ban', 
        name: 'Complete Abortion Ban', 
        description: 'Total prohibition, criminal penalties.', 
        costLow: 5, costHigh: 15, tfrLow: 0.50, tfrHigh: 0.70, 
        enabled: false, intensity: 100, 
        historical: 'Romania 1966: TFR 1.9‚Üí3.7 in one year. ~10,000 women died.',
        confidence: 'medium',
        methodology: {
          derivation: 'Arithmetic approach: ~1.04M US abortions annually (Guttmacher 2024) vs ~3.6M births. A complete ban with 70-80% enforcement effectiveness (accounting for cross-border travel and black market access by upper-income women) yields 730-830k additional births. This represents a 20-23% increase in births, translating to +0.32-0.37 on current 1.62 TFR. Upper bound accounts for Romania\'s +1.8 TFR experience (Decree 770, 1966), heavily discounted for modern circumvention methods.',
          sources: [
            { cite: 'Guttmacher (2024)', finding: '~1.04M US abortions annually', elasticity: 'Baseline volume' },
            { cite: 'CDC (2023)', finding: '3.6M US births annually', elasticity: 'Denominator' },
            { cite: 'Romanian Decree 770', finding: 'TFR 1.9‚Üí3.7 (+1.8) in one year', elasticity: 'Upper bound reference' }
          ],
          notes: 'Stratified circumvention estimate: Elite (~5% of abortions) 80% circumvention via travel/private physicians; Upper-middle (~15%) 50% circumvention; Middle class (~30%) 25% circumvention; Working class/poor (~50%) 10% circumvention. Weighted average: ~25% circumvention, ~75% conversion to births. ETHICAL WARNING: Romanian experience included ~10,000 maternal deaths from unsafe procedures. Poland\'s 2020 near-total ban shows fertility *declined* after implementation, but Poland had only ~1,000 legal abortions annually pre-ban (most went abroad or used pills already). US has 1,000x the volume.'
        }
      },
      { 
        id: 'contraception-ban', 
        name: 'Contraception Restrictions', 
        description: 'Ban hormonal contraception and IUDs.', 
        costLow: 2, costHigh: 8, tfrLow: 0.35, tfrHigh: 0.60, 
        enabled: false, intensity: 100,
        confidence: 'medium',
        methodology: {
          derivation: 'US TFR dropped from 3.6 to 1.9 (1960-1973) following Pill introduction‚Äîa 1.7 TFR decline. Bailey (2010) found states that legalized Pill sales after Griswold v. Connecticut (1965) saw ~4% birth rate decline. Ireland delayed Pill introduction until 1981; their fertility collapse was delayed ~20 years vs other Western nations. Not all decline was Pill (cultural shifts, workforce entry), but modern contraception is the primary mechanical enabler of fertility control.',
          sources: [
            { cite: 'NSFG/CDC Historical', finding: 'TFR 3.6‚Üí1.9 (1960-1973), -47%', elasticity: 'Post-Pill decline' },
            { cite: 'Bailey (2010)', finding: 'Griswold legalization ‚Üí ~4% birth rate decline', elasticity: 'Causal estimate' },
            { cite: 'Ireland comparison', finding: 'Pill legalized 1981; fertility collapse delayed 20 years', elasticity: 'Natural experiment' }
          ],
          notes: 'STACKING NOTE: Contraception ban effects would largely stack with abortion ban‚Äîthey target different points in the reproductive process. Combined effect could approach +1.0 TFR. However, enforcement of contraception bans is extremely difficult in modern context (pills can be imported, prescribed for other conditions). Would require unprecedented surveillance. Estimate assumes partial enforcement (~60-70% effective).'
        }
      },
      { 
        id: 'celibacy-tax', 
        name: 'Childlessness Tax', 
        description: '5-15% tax on childless adults over 25.', 
        costLow: -50, costHigh: -30, tfrLow: 0.05, tfrHigh: 0.12, 
        enabled: false, intensity: 100, revenue: true,
        historical: 'USSR 1941-1990: 6% tax. High compliance, unclear impact.',
        confidence: 'low',
        methodology: {
          derivation: 'USSR childlessness tax (1941-1990) provides historical precedent. 6% tax on childless adults. High compliance but fertility impact unclear‚Äîmay have been primarily revenue measure.',
          sources: [
            { cite: 'USSR Tax (1941-1990)', finding: '6% tax, high compliance', elasticity: 'Unclear fertility impact' }
          ],
          notes: 'REVENUE-GENERATING: -$30-50B (negative cost = revenue). Fertility impact likely modest. May function more as intergenerational transfer mechanism than fertility incentive.'
        }
      },
      { 
        id: 'divorce-restrictions', 
        name: 'Divorce Restrictions', 
        description: 'Eliminate no-fault divorce.', 
        costLow: 0, costHigh: 5, tfrLow: 0.02, tfrHigh: 0.08, 
        enabled: false, intensity: 100,
        historical: 'Pre-1970 US: higher stability, minimal fertility evidence.',
        confidence: 'low',
        methodology: {
          derivation: 'Pre-1970 US had no no-fault divorce. Higher marital stability observed, but minimal direct fertility evidence. Effect likely operates through marriage formation incentives rather than within-marriage fertility.',
          sources: [
            { cite: 'Pre-1970 US marriage law', finding: 'Higher marital stability', elasticity: 'Indirect/unclear' }
          ],
          notes: 'Primarily affects marriage dissolution, not formation or fertility within marriage. May reduce marriage rates if exit becomes costly.'
        }
      },
      { 
        id: 'mandatory-marriage', 
        name: 'Marriage Mandates', 
        description: 'Benefits/housing tied to married status.', 
        costLow: 5, costHigh: 15, tfrLow: 0.06, tfrHigh: 0.15, 
        enabled: false, intensity: 100,
        historical: 'Singapore: Housing priority for married couples.',
        confidence: 'low',
        methodology: {
          derivation: 'Singapore HDB gives priority access to married couples. Creates strong marriage incentive in housing-constrained environment. Effect depends on scarcity of tied benefits.',
          sources: [
            { cite: 'Singapore HDB policy', finding: 'Housing priority for married couples', elasticity: 'Context-dependent' }
          ],
          notes: 'Effectiveness depends on scarcity of tied benefits. In abundant-resource environment, mandate has limited bite. Singapore context: extreme housing scarcity amplifies effect.'
        }
      }
    ];

    const entitlementReforms = [
      { 
        id: 'medicare-age', 
        name: 'Raise Medicare Age', 
        savingsLow: 80, savingsHigh: 100, 
        description: 'Phase in over 12 years.', 
        enabled: false,
        sliderConfig: { label: 'Eligibility age', min: 66, max: 70, default: 67, format: v => `${v} years` }
      },
      { 
        id: 'ss-means-test', 
        name: 'SS Means-Test', 
        savingsLow: 120, savingsHigh: 150, 
        description: 'Reduce benefits for high earners.', 
        enabled: false,
        sliderConfig: { label: 'Income threshold', min: 75, max: 200, default: 100, format: v => `>$${v}k` }
      },
      { 
        id: 'ss-cola', 
        name: 'SS COLA Adjustment', 
        savingsLow: 80, savingsHigh: 100, 
        description: 'Switch to Chained CPI.', 
        enabled: false,
        sliderConfig: { label: 'Annual reduction', min: 25, max: 75, default: 50, format: v => `‚àí${(v/100).toFixed(2)}%` }
      },
      { 
        id: 'medicare-drugs', 
        name: 'Medicare Drug Negotiation', 
        savingsLow: 50, savingsHigh: 80, 
        description: 'Expand negotiation authority.', 
        enabled: false,
        sliderConfig: { label: 'Drugs covered', min: 50, max: 250, default: 100, format: v => `${v} drugs` }
      },
      { 
        id: 'ss-retirement-70', 
        name: 'Raise SS Retirement Age', 
        savingsLow: 100, savingsHigh: 150, 
        description: 'Phase in over 18 years.', 
        enabled: false,
        sliderConfig: { label: 'Full retirement age', min: 68, max: 72, default: 70, format: v => `${v} years` }
      },
      { 
        id: 'ss-cap', 
        name: 'Cap SS Benefits', 
        savingsLow: 60, savingsHigh: 80, 
        description: 'Maximum monthly benefit.', 
        enabled: false,
        sliderConfig: { label: 'Monthly cap', min: 2500, max: 4000, default: 3200, format: v => `$${v.toLocaleString()}/mo` }
      },
      { 
        id: 'medicare-premiums', 
        name: 'Medicare Premium Surcharge', 
        savingsLow: 40, savingsHigh: 60, 
        description: 'Income-related Part B/D premiums.', 
        enabled: false,
        sliderConfig: { label: 'Surcharge threshold', min: 50, max: 150, default: 85, format: v => `>$${v}k` }
      }
    ];

    const taxIncreases = [
      { 
        id: 'income-tax-top', 
        name: 'Top Marginal Rate Increase', 
        description: 'Raise top bracket rate. Threshold adjustable.', 
        savingsLow: 80, savingsHigh: 120, 
        enabled: false,
        threshold: 500, // $500k default
        thresholdMin: 250,
        thresholdMax: 1000,
        thresholdLabel: 'Income threshold ($k)',
        gdpDrag: 0.002, // 0.2% annual GDP drag
        tfrDrag: 0.01, // TFR penalty from reduced wages/uncertainty
        dragRationale: 'Labor supply elasticity ~0.1-0.3 for high earners; reduced work effort and tax avoidance',
        confidence: 'medium',
        methodology: {
          derivation: 'GDP drag: ~0.2% annually from labor supply response. TFR drag: reduced high-income wages + uncertainty. Keane (2011): compensated elasticity ~0.3 for high earners.',
          sources: [
            { cite: 'Keane (2011)', finding: 'Meta-analysis of labor supply elasticities', elasticity: '~0.3 compensated' },
            { cite: 'Saez et al. (2012)', finding: 'Top income elasticity to tax rates', elasticity: '~0.5' },
            { cite: 'Becker (1960)', finding: 'Income-fertility relationship', elasticity: '~0.005 TFR per 1% GDP' }
          ],
          notes: 'Higher thresholds reduce revenue but also reduce behavioral distortion. $250k threshold captures more revenue but higher growth drag.'
        }
      },
      { 
        id: 'corporate-tax', 
        name: 'Corporate Tax Increase', 
        description: 'Raise corporate rate toward pre-TCJA levels.', 
        savingsLow: 100, savingsHigh: 150, 
        enabled: false,
        threshold: 28, // 28% default rate
        thresholdMin: 25,
        thresholdMax: 35,
        thresholdLabel: 'Corporate rate (%)',
        gdpDrag: 0.01, // 1% annual GDP drag (7pp √ó 0.15%)
        tfrDrag: 0.04, // Higher TFR impact via wage channel
        dragRationale: 'Reduces business investment; CBO estimates 0.1-0.2% GDP per percentage point',
        confidence: 'medium-high',
        methodology: {
          derivation: 'GDP drag: CBO estimates ~0.15% GDP per 1pp. At 28% (vs 21%), 7pp increase ‚Üí ~1% GDP drag. TFR drag higher due to wage incidence (20-50% falls on workers).',
          sources: [
            { cite: 'CBO (2017)', finding: 'Corporate tax and GDP relationship', elasticity: '~0.15% GDP per 1pp' },
            { cite: 'Gravelle (2014)', finding: 'Corporate tax incidence on wages', elasticity: '20-50% on workers' },
            { cite: 'Zwick & Mahon (2017)', finding: 'Investment response to tax changes', elasticity: 'High for SMEs' }
          ],
          notes: 'Investment effects take 5-10 years to fully materialize. Short-run revenue higher than long-run due to behavioral response.'
        }
      },
      { 
        id: 'capital-gains', 
        name: 'Capital Gains Tax Parity', 
        description: 'Tax capital gains as ordinary income above threshold.', 
        savingsLow: 150, savingsHigh: 200, 
        enabled: false,
        threshold: 1000, // $1M default
        thresholdMin: 400,
        thresholdMax: 5000,
        thresholdLabel: 'Income threshold ($k)',
        gdpDrag: 0.003, // 0.3% annual GDP drag from capital misallocation
        tfrDrag: 0.05, // Higher TFR impact: entrepreneurship, wealth building
        dragRationale: 'Strong lock-in effect; reduces capital reallocation efficiency',
        confidence: 'medium',
        methodology: {
          derivation: 'GDP drag: ~0.3% annually from lock-in effect reducing capital mobility. TFR drag higher: reduced entrepreneurship, wealth building for family formation. Dai et al. (2008): realization elasticity ~-0.5 to -0.7.',
          sources: [
            { cite: 'Dai et al. (2008)', finding: 'Elasticity of capital gains realizations', elasticity: '-0.5 to -0.7' },
            { cite: 'Auerbach (1988)', finding: 'Lock-in effect magnitude', elasticity: 'Significant above 25% rate' },
            { cite: 'Poterba (1987)', finding: 'Capital gains and entrepreneurship', elasticity: 'Negative relationship' }
          ],
          notes: 'Revenue estimates assume significant behavioral response. Actual revenue could be 40-60% of static estimate due to lock-in.'
        }
      },
      { 
        id: 'financial-transaction', 
        name: 'Financial Transaction Tax', 
        description: 'Small tax on securities trades.', 
        savingsLow: 60, savingsHigh: 100, 
        enabled: false,
        threshold: 10, // 0.10% default (shown as basis points √ó 10)
        thresholdMin: 5,
        thresholdMax: 50,
        thresholdLabel: 'Rate (basis points)',
        gdpDrag: 0.002, // 0.2% annual GDP drag
        tfrDrag: 0.02, // Modest TFR impact
        dragRationale: 'Reduces market liquidity; widens bid-ask spreads',
        confidence: 'low',
        methodology: {
          derivation: 'GDP drag: ~0.1-0.2% annually from increased cost of capital. TFR drag modest: primarily affects financial sector, less direct impact on families. Swedish FTT (1984-91) reduced trading 50%.',
          sources: [
            { cite: 'Umlauf (1993)', finding: 'Swedish FTT reduced trading 50%', elasticity: 'High volume elasticity' },
            { cite: 'Matheson (2011)', finding: 'IMF review of FTT experiences', elasticity: 'Varied by market depth' },
            { cite: 'Burman et al. (2016)', finding: 'US FTT revenue and impact estimates', elasticity: 'Moderate' }
          ],
          notes: 'HIGH UNCERTAINTY: Effects depend heavily on market structure and rate level. Revenue estimates vary 3x across studies.'
        }
      },
      { 
        id: 'estate-tax', 
        name: 'Estate Tax Reform', 
        description: 'Lower exemption threshold for estate taxation.', 
        savingsLow: 40, savingsHigh: 70, 
        enabled: false,
        threshold: 3500, // $3.5M default
        thresholdMin: 1000,
        thresholdMax: 7000,
        thresholdLabel: 'Exemption ($k)',
        gdpDrag: 0.001, // Minimal GDP drag
        tfrDrag: 0.01, // Modest TFR impact
        dragRationale: 'Minimal growth impact; affects intergenerational transfers',
        confidence: 'medium',
        methodology: {
          derivation: 'GDP drag minimal‚Äîmost economic activity unaffected. TFR effect ambiguous: reduces bequests but also reduces "Carnegie effect". Kopczuk (2013): estate elasticity ~0.1-0.2.',
          sources: [
            { cite: 'Kopczuk (2013)', finding: 'Elasticity of reported estates', elasticity: '~0.1-0.2' },
            { cite: 'Gale & Slemrod (2001)', finding: 'Estate tax and savings behavior', elasticity: 'Small effect' },
            { cite: 'Holtz-Eakin et al. (1993)', finding: 'Inheritance and labor supply', elasticity: 'Negative (Carnegie effect)' }
          ],
          notes: 'Current $13M exemption (2024) means estate tax affects <0.2% of estates. Lower exemption broadens base significantly.'
        }
      },
      { 
        id: 'carbon-tax', 
        name: 'Carbon Tax', 
        description: 'Price on carbon emissions, phased in over 5 years.', 
        savingsLow: 80, savingsHigh: 150, 
        enabled: false,
        threshold: 50, // $50/ton default
        thresholdMin: 25,
        thresholdMax: 150,
        thresholdLabel: 'Price per ton ($)',
        gdpDrag: 0.005, // 0.5% GDP drag (disputed - could be 0.2-1%)
        tfrDrag: 0.025, // Higher TFR impact due to regressivity
        dragRationale: 'Energy price increases hit young families hardest; regressive burden 2-4x higher on low-income households',
        confidence: 'medium',
        methodology: {
          derivation: 'GDP drag disputed: 0.2-1% depending on model. TFR drag higher due to regressivity‚ÄîNBER finds burden 2-4x higher on low-income as share of income. Young families disproportionately affected.',
          sources: [
            { cite: 'Goulder & Hafstead (2013)', finding: '$10/ton rising 5%/yr ‚Üí 0.6% lower GDP at year 20', elasticity: 'Moderate' },
            { cite: 'NERA/NAM (2013)', finding: '$20/ton ‚Üí $350/household by year 20; 80% reduction ‚Üí 3.4% GDP loss', elasticity: 'High' },
            { cite: 'Heritage Foundation', finding: '$25/ton ‚Üí $1,400-1,900/yr income loss per family of four', elasticity: 'High' },
            { cite: 'NBER Grainger & Kolstad', finding: 'Burden 2-4x higher on low-income as share of income', elasticity: 'Regressive' }
          ],
          notes: 'KEY ISSUE: Carbon tax is regressive‚Äîlow-income households spend larger share of income on energy. Young families particularly affected. Revenue recycling can offset but politically uncertain. Fertility drag assumes partial but incomplete recycling to families.'
        }
      },
      { 
        id: 'vat', 
        name: 'Federal VAT', 
        description: 'Consumption tax with exemptions for necessities.', 
        savingsLow: 400, savingsHigh: 600, 
        enabled: false,
        threshold: 10, // 10% rate default
        thresholdMin: 5,
        thresholdMax: 20,
        thresholdLabel: 'VAT rate (%)',
        gdpDrag: 0.001, // Minimal GDP drag - least distortionary
        tfrDrag: 0.02, // Modest TFR impact with exemptions
        dragRationale: 'Consumption reduction; regressive before exemptions',
        confidence: 'medium-high',
        methodology: {
          derivation: 'GDP drag minimal‚ÄîVAT is least distortionary broad-based tax. TFR drag from reduced consumption capacity, partially offset by exemptions for necessities.',
          sources: [
            { cite: 'Mankiw et al. (2009)', finding: 'Optimal tax theory favors consumption taxes', elasticity: 'Lower deadweight loss' },
            { cite: 'OECD (2020)', finding: 'VAT revenue potential in US', elasticity: '~$50B per 1% rate' },
            { cite: 'Chetty et al. (2009)', finding: 'Salience and behavioral response to VAT', elasticity: 'Moderate' }
          ],
          notes: 'Exemptions for food, housing, healthcare, and childcare reduce regressivity and fertility drag. US is only OECD country without national VAT.'
        }
      }
    ];

    const modelParams = { 
      interactionDiscount: 25, 
      contextAdjustment: 10, 
      implementationRate: 90,
      // Inflation elasticity parameters (from empirical literature)
      deficitToInflation: 0.30,      // % inflation per 1% GDP deficit (range: 0.20-0.40)
      inflationToTFR: 0.65,          // % TFR decline per 1% inflation (midpoint of -0.5 to -0.8)
      economicSlack: 'near-full',    // 'slack', 'near-full', 'constrained'
      currentGDP: 28000,             // $28T in billions
      // CBO baseline deficit (FY2025 projection: $1.9T, 6.2% of GDP)
      baselineDeficit: 1900,         // $1.9T baseline deficit from CBO Jan 2025
      includeBaselineInPenalty: false, // Whether inflation penalty applies to baseline or just incremental
      // Current inflation baseline (BLS Nov 2025: 2.7% CPI, Fed target: 2.0%)
      baselineInflation: 0.7,        // Current inflation above 2% target (pp)
      fedTarget: 2.0                 // Fed's inflation target (%)
    };

    function calculateInflationPenalty(deficit) {
      // Determine which deficit to use for the penalty calculation
      const policyDeficit = deficit > 0 ? deficit : 0;
      const totalDeficit = modelParams.baselineDeficit + policyDeficit;
      
      // Calculate deficit as % of GDP (always use total for threshold determination)
      const deficitPctGDP = (totalDeficit / modelParams.currentGDP) * 100;
      
      // NONLINEAR FISCAL DOMINANCE ADJUSTMENT
      // Based on: BIS Papers No. 65, Boston Fed (2025), Mercatus Center research, FTPL
      // Key insight: At high debt/GDP (>100%), central bank loses ability to fight inflation
      // because rate hikes explode debt service costs, creating a doom loop
      //
      // CRITICAL: Under fiscal dominance, inflation is driven by TOTAL deficit expectations,
      // not just incremental policy. Markets price in the full unsustainability.
      //
      // Thresholds calibrated to US context (currently at ~100% debt/GDP):
      // - <6% deficit/GDP: Standard elasticity, incremental calculation OK
      // - 6-8% deficit/GDP: Elevated risk, still incremental (1.5x multiplier)
      // - 8-10% deficit/GDP: Fiscal stress - switch to TOTAL deficit calculation (2.5x)
      // - >10% deficit/GDP: Fiscal dominance - TOTAL deficit, FTPL-approaching elasticities (4-6x)
      //
      // Citations:
      // - Cochrane, Leeper, Sims (FTPL): elasticities approach 1:1 under fiscal dominance
      // - Boston Fed (2025): households expecting fiscal dominance revise inflation up
      // - Mercatus (2023): debt/GDP >100% creates doom loop with rate hikes
      // - BIS (2012): "threat of fiscal dominance" when debt constrains monetary policy
      // - Sargent & Wallace (1981): "unpleasant monetarist arithmetic"
      
      let fiscalDominanceMultiplier = 1.0;
      let fiscalStressLevel = 'normal';
      let useFullDeficit = modelParams.includeBaselineInPenalty; // User setting as baseline
      
      if (deficitPctGDP < 6) {
        fiscalDominanceMultiplier = 1.0;
        fiscalStressLevel = 'normal';
      } else if (deficitPctGDP < 8) {
        // Linear interpolation from 1.0 at 6% to 1.75 at 8%
        fiscalDominanceMultiplier = 1.0 + (deficitPctGDP - 6) * 0.375;
        fiscalStressLevel = 'elevated';
      } else if (deficitPctGDP < 10) {
        // Fiscal stress: switch to total deficit calculation
        // Linear interpolation from 1.75 at 8% to 3.5 at 10%
        fiscalDominanceMultiplier = 1.75 + (deficitPctGDP - 8) * 0.875;
        fiscalStressLevel = 'high';
        useFullDeficit = true; // Force total deficit in fiscal stress
      } else {
        // Fiscal dominance: approaching FTPL predictions
        // At 10%: 3.5x, accelerating toward 6x at 15%
        fiscalDominanceMultiplier = Math.min(6.0, 3.5 + (deficitPctGDP - 10) * 0.5);
        fiscalStressLevel = 'crisis';
        useFullDeficit = true; // Force total deficit in crisis
      }
      
      // Economic condition multiplier for deficit‚Üíinflation elasticity
      const slackMultiplier = {
        'slack': 0.5,           // Significant economic slack: 0.15-0.20%
        'near-full': 1.0,       // Near full employment: 0.25-0.40%
        'constrained': 1.75     // At/above capacity + supply constraints: 0.50-1.0%
      }[modelParams.economicSlack] || 1.0;
      
      // CRITICAL CHANGE: In fiscal stress/crisis, use TOTAL deficit for penalty
      // This reflects that markets price in full unsustainability, not just marginal changes
      const deficitForCalc = useFullDeficit ? totalDeficit : policyDeficit;
      
      // Calculate deficit-induced inflation
      const deficitPctForCalc = (deficitForCalc / modelParams.currentGDP) * 100;
      const deficitInducedInflation = deficitPctForCalc * modelParams.deficitToInflation * slackMultiplier * fiscalDominanceMultiplier;
      
      // INFLATION PENALTY LOGIC:
      // - In NORMAL/ELEVATED: Only policy-induced inflation creates NEW penalty
      //   (baseline inflation is already reflected in current TFR of 1.62)
      // - In HIGH/CRISIS: The TOTAL inflation stack matters because Fed loses control
      //   and baseline inflation can no longer be managed separately
      //
      // This reflects the fiscal dominance dynamic: in normal times, the Fed can
      // offset deficit-driven inflation, but in fiscal stress they cannot.
      let inflationForPenalty;
      if (fiscalStressLevel === 'high' || fiscalStressLevel === 'crisis') {
        // Fiscal dominance: the entire inflation situation becomes destabilizing
        // Markets lose confidence that Fed can manage even baseline inflation
        inflationForPenalty = modelParams.baselineInflation + deficitInducedInflation;
      } else {
        // Normal/elevated: only additional policy-induced inflation matters
        // Fed can still manage baseline, so it's already "priced into" TFR 1.62
        inflationForPenalty = deficitInducedInflation;
      }
      
      // Store for display
      window.lastFiscalStress = { 
        level: fiscalStressLevel, 
        multiplier: fiscalDominanceMultiplier,
        deficitPctGDP: deficitPctGDP,
        totalDeficit: totalDeficit,
        useFullDeficit: useFullDeficit,
        baselineInflation: modelParams.baselineInflation,
        deficitInducedInflation: deficitInducedInflation,
        totalInflation: modelParams.baselineInflation + deficitInducedInflation,
        inflationForPenalty: inflationForPenalty,
        includesBaseline: (fiscalStressLevel === 'high' || fiscalStressLevel === 'crisis')
      };
      
      if (inflationForPenalty <= 0) return 0;
      
      // Stage 2: Inflation ‚Üí TFR decline
      // Under fiscal dominance, use higher elasticity (uncertainty effect amplified)
      let inflationToTFR = modelParams.inflationToTFR;
      if (fiscalStressLevel === 'crisis') {
        // In crisis, uncertainty effect increases the fertility impact
        inflationToTFR = Math.min(1.2, inflationToTFR * 1.5);
      }
      
      const tfrDeclinePct = inflationForPenalty * inflationToTFR;
      
      // Convert % TFR decline to absolute TFR points
      const baseTFR = 1.62;
      const tfrPenalty = (tfrDeclinePct / 100) * baseTFR;
      
      return tfrPenalty;
    }
    
    // Helper to get inflation estimate for display
    function calculateInflationEstimate(deficit) {
      const effectiveDeficit = modelParams.includeBaselineInPenalty 
        ? modelParams.baselineDeficit + deficit 
        : deficit;
      if (effectiveDeficit <= 0) return 0;
      const slackMultiplier = {
        'slack': 0.5,
        'near-full': 1.0,
        'constrained': 1.75
      }[modelParams.economicSlack] || 1.0;
      const deficitPctGDP = (effectiveDeficit / modelParams.currentGDP) * 100;
      return deficitPctGDP * modelParams.deficitToInflation * slackMultiplier;
    }

    // TFR drag from tax policies (separate from GDP drag)
    function calculateTfrDrag() {
      return taxIncreases.filter(t => t.enabled && t.tfrDrag).reduce((sum, t) => sum + t.tfrDrag, 0);
    }

    // GDP drag from tax policies (in annual GDP growth points)
    function calculateGdpDrag() {
      return taxIncreases.filter(t => t.enabled && t.gdpDrag).reduce((sum, t) => sum + t.gdpDrag, 0);
    }

    function calculateEntitlementSavings() {
      return entitlementReforms.filter(r => r.enabled).reduce((sum, r) => sum + (r.savingsLow + r.savingsHigh) / 2, 0);
    }

    function calculateGDP2075(tfr, gdpDrag, entitlementSavings = 0, deficit = 0) {
      // Baseline assumptions:
      // - Current US GDP: ~$28T (2024)
      // - Baseline real growth: 2.0% per year
      // - Population effect: higher TFR increases labor force in ~20 years
      // - Tax drag: reduces annual growth rate (already in GDP growth points)
      // - Entitlement reform: reduces debt burden, boosts growth
      // - Deficit: crowds out investment, reduces growth
      // - Inflation drag: fiscal dominance creates persistent inflation that reduces growth
      
      const currentGDP = 28; // $28T
      const years = 50; // 2025 to 2075
      const baselineGrowth = 0.02; // 2% real growth
      
      // Tax policy drag on annual growth (gdpDrag is already in annual GDP growth points)
      const taxDragOnGrowth = gdpDrag;
      
      // Entitlement reform boost on annual growth
      // Reduced future obligations = lower debt burden = more private investment
      // CBO estimates: $100B annual deficit reduction ‚Üí ~0.02-0.05% higher growth long-term
      // Conservative estimate: $100B savings ‚Üí 0.03% annual growth boost
      const entitlementBoost = (entitlementSavings / 100) * 0.0003;
      
      // Deficit drag on growth (crowding out effect)
      // $100B deficit ‚Üí ~0.02% lower growth from crowding out
      const deficitDrag = (deficit / 100) * 0.0002;
      
      // INFLATION DRAG FROM FISCAL DOMINANCE
      // High inflation reduces growth through:
      // - Investment uncertainty and capital misallocation
      // - Menu costs and price signal distortion  
      // - Potential monetary tightening causing recessions
      // - Currency effects and capital flight risk
      //
      // Literature estimates (Fischer 1993, Barro 1995, Bruno & Easterly 1998):
      // - Below 5% inflation: minimal growth impact
      // - 5-10% inflation: ~0.1-0.2% lower growth per inflation point
      // - Above 10%: nonlinear drag, potentially 0.3-0.5% per point
      //
      // Calculate implied inflation from deficit
      const policyDeficit = deficit > 0 ? deficit : 0;
      const totalDeficit = modelParams.baselineDeficit + policyDeficit;
      const deficitPctGDP = (totalDeficit / modelParams.currentGDP) * 100;
      
      // Get fiscal dominance multiplier (same logic as inflation penalty)
      let fiscalDominanceMultiplier = 1.0;
      if (deficitPctGDP < 6) {
        fiscalDominanceMultiplier = 1.0;
      } else if (deficitPctGDP < 8) {
        fiscalDominanceMultiplier = 1.0 + (deficitPctGDP - 6) * 0.25;
      } else if (deficitPctGDP < 10) {
        fiscalDominanceMultiplier = 1.5 + (deficitPctGDP - 8) * 0.5;
      } else {
        fiscalDominanceMultiplier = Math.min(4.0, 2.5 + (deficitPctGDP - 10) * 0.3);
      }
      
      // Calculate implied annual inflation from deficit
      const slackMultiplier = {
        'slack': 0.5,
        'near-full': 1.0,
        'constrained': 1.75
      }[modelParams.economicSlack] || 1.0;
      
      // CRITICAL: In fiscal stress/crisis, use TOTAL deficit for inflation calculation
      // This matches the TFR penalty logic - markets price in full unsustainability
      let useFullDeficitForGDP = false;
      if (deficitPctGDP >= 8) {
        useFullDeficitForGDP = true;
      }
      
      const deficitForInflation = useFullDeficitForGDP ? totalDeficit : policyDeficit;
      const deficitPctForInflation = (deficitForInflation / modelParams.currentGDP) * 100;
      const deficitInducedInflation = deficitPctForInflation * modelParams.deficitToInflation * slackMultiplier * fiscalDominanceMultiplier;
      
      // TOTAL IMPLIED INFLATION = baseline (above target) + deficit-induced
      // Baseline inflation already drags on growth; deficit adds to it
      const totalImpliedInflation = modelParams.baselineInflation + deficitInducedInflation;
      
      // Inflation drag on growth (phases in over time as inflation persists)
      // Literature: Fischer (1993), Barro (1995), Bruno & Easterly (1998)
      // - Below 2% above target: minimal growth impact
      // - 2-5% above target: ~0.1% lower growth per inflation point
      // - Above 5%: nonlinear drag, potentially 0.2-0.3% per point
      let inflationGrowthDrag = 0;
      if (totalImpliedInflation > 0) {
        // Nonlinear: higher inflation has disproportionate growth impact
        if (totalImpliedInflation <= 2) {
          inflationGrowthDrag = totalImpliedInflation * 0.0003; // 0.03% per pp (mild)
        } else if (totalImpliedInflation <= 4) {
          inflationGrowthDrag = 2 * 0.0003 + (totalImpliedInflation - 2) * 0.0007; // 0.07% per pp
        } else if (totalImpliedInflation <= 7) {
          inflationGrowthDrag = 2 * 0.0003 + 2 * 0.0007 + (totalImpliedInflation - 4) * 0.0015; // 0.15% per pp
        } else if (totalImpliedInflation <= 10) {
          inflationGrowthDrag = 2 * 0.0003 + 2 * 0.0007 + 3 * 0.0015 + (totalImpliedInflation - 7) * 0.002; // 0.2% per pp
        } else {
          // Above 10% inflation: severe growth drag (0.3% per pp)
          inflationGrowthDrag = 2 * 0.0003 + 2 * 0.0007 + 3 * 0.0015 + 3 * 0.002 + (totalImpliedInflation - 10) * 0.003;
        }
      }
      
      // Population growth effect on GDP
      // Higher TFR ‚Üí larger working-age population in 20-50 years
      // Rule of thumb: 0.1 TFR increase ‚Üí 0.05% higher annual growth after 20 years
      // This is conservative; some estimates are higher
      const tfrDelta = tfr - 1.62; // Change from baseline
      const populationGrowthBoost = tfrDelta * 0.005; // 0.5% per 1.0 TFR
      
      // Store for display
      window.lastGDPCalc = {
        baselineInflation: modelParams.baselineInflation,
        deficitInducedInflation: deficitInducedInflation,
        impliedInflation: totalImpliedInflation,
        inflationGrowthDrag: inflationGrowthDrag,
        fiscalDominanceMultiplier: fiscalDominanceMultiplier,
        deficitPctGDP: deficitPctGDP,
        useFullDeficit: useFullDeficitForGDP
      };
      
      // Phased effects
      let gdp = currentGDP;
      for (let year = 1; year <= years; year++) {
        let annualGrowth = baselineGrowth - taxDragOnGrowth + entitlementBoost - deficitDrag;
        
        // Inflation drag phases in over first 10 years (takes time to become persistent)
        if (year <= 10) {
          const phaseIn = year / 10;
          annualGrowth -= inflationGrowthDrag * phaseIn;
        } else {
          annualGrowth -= inflationGrowthDrag;
        }
        
        // Population effect phases in after year 20
        if (year > 20) {
          const phaseIn = Math.min(1, (year - 20) / 10); // Full effect by year 30
          annualGrowth += populationGrowthBoost * phaseIn;
        }
        
        gdp *= (1 + annualGrowth);
      }
      
      return gdp;
    }

    // Baseline GDP for comparison (no policy changes)
    const baselineGDP2075 = calculateGDP2075(1.62, 0, 0, 0);

    function calculateFiscal() {
      let spending = 0, offsets = 0;
      [...liberalPolicies, ...illiberalPolicies].forEach(p => {
        if (p.enabled) {
          // costLow and costHigh are already scaled by the slider
          if (p.revenue) offsets += (Math.abs(p.costLow) + Math.abs(p.costHigh)) / 2;
          else spending += (p.costLow + p.costHigh) / 2;
        }
      });
      entitlementReforms.forEach(r => { if (r.enabled) offsets += (r.savingsLow + r.savingsHigh) / 2; });
      taxIncreases.forEach(t => { if (t.enabled) offsets += (t.savingsLow + t.savingsHigh) / 2; });
      return { spending, offsets, net: spending - offsets };
    }

    function calculateTFR() {
      const baseTFR = 1.62;
      let grossLow = 0, grossHigh = 0;
      let enabledCount = 0;
      
      [...liberalPolicies, ...illiberalPolicies].forEach(p => {
        if (p.enabled) {
          enabledCount++;
          // tfrLow and tfrHigh are already scaled by the slider
          grossLow += p.tfrLow;
          grossHigh += p.tfrHigh;
        }
      });

      // Interaction discount only applies when multiple policies are stacked
      // With 1 policy: no interaction discount
      // With 2+ policies: apply discount for diminishing returns
      const interactionFactor = enabledCount > 1 ? (1 - modelParams.interactionDiscount/100) : 1;
      const contextFactor = (1 - modelParams.contextAdjustment/100);
      const implementationFactor = (modelParams.implementationRate/100);
      
      const factor = interactionFactor * contextFactor * implementationFactor;
      let netLow = grossLow * factor, netHigh = grossHigh * factor;

      const fiscal = calculateFiscal();
      const deficit = fiscal.net > 0 ? fiscal.net : 0;
      const inflationPenalty = calculateInflationPenalty(deficit);
      netLow -= inflationPenalty;
      netHigh -= inflationPenalty;

      const tfrDrag = calculateTfrDrag();
      const gdpDrag = calculateGdpDrag();
      netLow -= tfrDrag;
      netHigh -= tfrDrag;

      return { low: baseTFR + netLow, mid: baseTFR + (netLow + netHigh) / 2, high: baseTFR + netHigh, inflationPenalty, tfrDrag, gdpDrag, deficit };
    }

    function updateDisplay() {
      const tfr = calculateTFR();
      const fiscal = calculateFiscal();

      const tfrEl = document.getElementById('tfr-number');
      const statusEl = document.getElementById('tfr-status');
      const progressEl = document.getElementById('tfr-progress');

      tfrEl.textContent = tfr.mid.toFixed(2);
      tfrEl.className = 'tfr-number-large';
      progressEl.className = 'tfr-progress-fill';
      
      if (tfr.mid >= 2.1) {
        statusEl.textContent = 'AT REPLACEMENT ‚úì';
        tfrEl.classList.add('at-replacement');
        progressEl.classList.add('at-replacement');
      } else if (tfr.mid >= 1.8) {
        statusEl.textContent = 'BELOW REPLACEMENT';
        tfrEl.classList.add('below');
      } else {
        statusEl.textContent = 'CRITICALLY LOW';
        tfrEl.classList.add('critical');
      }

      progressEl.style.width = `${Math.min(100, (tfr.mid / 3) * 100)}%`;

      document.getElementById('total-spending').textContent = `$${Math.round(fiscal.spending)}B`;
      document.getElementById('total-offsets').textContent = `$${Math.round(fiscal.offsets)}B`;
      
      const netEl = document.getElementById('net-impact');
      if (fiscal.net <= 0) {
        // Surplus: offsets exceed spending
        netEl.textContent = `+$${Math.abs(Math.round(fiscal.net))}B`;
        netEl.className = 'fiscal-value positive';
      } else {
        // Deficit: spending exceeds offsets
        netEl.textContent = `‚àí$${Math.round(fiscal.net)}B`;
        netEl.className = 'fiscal-value negative';
      }
      
      // Update total deficit (CBO baseline + policy net)
      const totalDeficit = modelParams.baselineDeficit + fiscal.net;
      const totalDeficitEl = document.getElementById('total-deficit');
      const deficitBreakdownEl = document.getElementById('deficit-breakdown');
      
      totalDeficitEl.textContent = `$${Math.round(totalDeficit).toLocaleString()}B`;
      
      // Color code based on fiscal stress level
      const deficitPctGDP = (totalDeficit / modelParams.currentGDP) * 100;
      if (deficitPctGDP >= 10) {
        totalDeficitEl.className = 'fiscal-value';
        totalDeficitEl.style.color = '#c62828'; // Crisis red
      } else if (deficitPctGDP >= 8) {
        totalDeficitEl.className = 'fiscal-value';
        totalDeficitEl.style.color = '#e65100'; // High stress orange
      } else if (deficitPctGDP >= 6) {
        totalDeficitEl.className = 'fiscal-value';
        totalDeficitEl.style.color = '#ef6c00'; // Elevated orange
      } else {
        totalDeficitEl.className = 'fiscal-value negative';
        totalDeficitEl.style.color = ''; // Default
      }
      
      if (fiscal.net === 0) {
        deficitBreakdownEl.textContent = `${deficitPctGDP.toFixed(1)}% GDP (baseline)`;
      } else if (fiscal.net > 0) {
        deficitBreakdownEl.textContent = `${deficitPctGDP.toFixed(1)}% GDP (+$${Math.round(fiscal.net)}B)`;
      } else {
        deficitBreakdownEl.textContent = `${deficitPctGDP.toFixed(1)}% GDP (‚àí$${Math.abs(Math.round(fiscal.net))}B)`;
      }

      const inflationContainer = document.getElementById('inflation-container');
      const growthContainer = document.getElementById('growth-container');

      inflationContainer.classList.toggle('visible', tfr.inflationPenalty > 0.005);
      if (tfr.inflationPenalty > 0.005) {
        document.getElementById('inflation-penalty-val').textContent = `-${tfr.inflationPenalty.toFixed(2)}`;
        
        // Update calculation breakdown display
        const inflationBreakdown = document.getElementById('inflation-calc-breakdown');
        const fiscalStressIndicator = document.getElementById('fiscal-stress-indicator');
        
        if (inflationBreakdown && window.lastFiscalStress) {
          const fs = window.lastFiscalStress;
          
          // Build detailed breakdown
          let breakdownHtml = '';
          
          if (fs.includesBaseline) {
            // In fiscal stress/crisis: show full stack
            breakdownHtml += `<span style="color: #c62828;"><strong>‚ö† Fiscal dominance:</strong> baseline inflation now counts</span><br>`;
            breakdownHtml += `Baseline: ${fs.baselineInflation.toFixed(1)}pp above target<br>`;
            if (fs.deficitInducedInflation > 0.01) {
              const deficitMode = fs.useFullDeficit ? 'TOTAL' : 'incremental';
              const deficitUsed = fs.useFullDeficit ? fs.totalDeficit : tfr.deficit;
              breakdownHtml += `+ Deficit ($${Math.round(deficitUsed).toLocaleString()}B ${deficitMode}) √ó ${fs.multiplier.toFixed(1)}√ó: +${fs.deficitInducedInflation.toFixed(1)}pp<br>`;
            }
            breakdownHtml += `<strong>= Penalized inflation: ${fs.inflationForPenalty.toFixed(1)}pp ‚Üí ‚àí${tfr.inflationPenalty.toFixed(2)} TFR</strong>`;
          } else {
            // Normal/elevated: only policy-induced
            if (fs.deficitInducedInflation > 0.01) {
              const deficitMode = fs.useFullDeficit ? 'TOTAL' : 'incremental';
              const deficitUsed = fs.useFullDeficit ? fs.totalDeficit : tfr.deficit;
              breakdownHtml += `Baseline: ${fs.baselineInflation.toFixed(1)}pp (already in TFR 1.62)<br>`;
              breakdownHtml += `<strong>+ Policy deficit:</strong> $${Math.round(deficitUsed).toLocaleString()}B √ó ${fs.multiplier.toFixed(1)}√ó = +${fs.deficitInducedInflation.toFixed(1)}pp<br>`;
              breakdownHtml += `<strong>= New penalty: ‚àí${tfr.inflationPenalty.toFixed(2)} TFR</strong>`;
            } else {
              breakdownHtml += `Baseline: ${fs.baselineInflation.toFixed(1)}pp above target<br>`;
              breakdownHtml += `<em>No policy deficit ‚Üí no additional penalty</em>`;
            }
          }
          
          inflationBreakdown.innerHTML = breakdownHtml;
          
          // Update fiscal stress indicator
          if (fiscalStressIndicator) {
            fiscalStressIndicator.style.display = 'block';
            const stressColors = {
              'normal': { bg: '#e8f5e9', text: '#2e7d32' },
              'elevated': { bg: '#fff3e0', text: '#ef6c00' },
              'high': { bg: '#ffebee', text: '#c62828' },
              'crisis': { bg: '#c62828', text: '#ffffff' }
            };
            const stressLabels = {
              'normal': 'Normal',
              'elevated': 'Elevated Risk',
              'high': '‚ö† Fiscal Stress',
              'crisis': 'üö® FISCAL DOMINANCE'
            };
            const colors = stressColors[fs.level] || stressColors.normal;
            fiscalStressIndicator.style.background = colors.bg;
            fiscalStressIndicator.style.color = colors.text;
            
            // Show that we switched to total deficit calculation
            let modeNote = '';
            if (fs.useFullDeficit && (fs.level === 'high' || fs.level === 'crisis')) {
              modeNote = ' ‚Äî using TOTAL deficit (markets price unsustainability)';
            }
            fiscalStressIndicator.textContent = `${stressLabels[fs.level]} (${fs.multiplier.toFixed(1)}√ó @ ${fs.deficitPctGDP.toFixed(1)}% GDP)${modeNote}`;
          }
          
          // Trigger fiscal crisis modal when entering high stress
          if ((fs.level === 'high' || fs.level === 'crisis') && !window.fiscalCrisisWarningShown) {
            window.fiscalCrisisWarningShown = true;
            document.getElementById('fiscal-crisis-modal').classList.add('visible');
          }
        }
      }

      growthContainer.classList.toggle('visible', tfr.tfrDrag > 0);
      if (tfr.tfrDrag > 0) document.getElementById('growth-penalty-val').textContent = `-${tfr.tfrDrag.toFixed(2)}`;
      
      // Show deficit warning modal on first deficit
      if (tfr.deficit > 0 && !window.deficitWarningShown) {
        window.deficitWarningShown = true;
        document.getElementById('deficit-modal').classList.add('visible');
      }

      // GDP 2075 projection with clean additive decomposition
      const entitlementSavings = calculateEntitlementSavings();
      const deficit = tfr.deficit;
      const gdp2075 = calculateGDP2075(tfr.mid, tfr.gdpDrag, entitlementSavings, deficit);
      const gdpEl = document.getElementById('gdp-projection');
      const gdpChangeEl = document.getElementById('gdp-change');
      
      gdpEl.textContent = `$${gdp2075.toFixed(0)}T`;
      
      const gdpDelta = gdp2075 - baselineGDP2075;
      const gdpPct = ((gdp2075 / baselineGDP2075) - 1) * 100;
      
      if (Math.abs(gdpPct) < 0.5) {
        gdpChangeEl.textContent = '(baseline)';
        gdpChangeEl.className = 'fiscal-sublabel';
      } else if (gdpDelta > 0) {
        gdpChangeEl.textContent = `+${gdpPct.toFixed(1)}%`;
        gdpChangeEl.className = 'fiscal-sublabel positive';
      } else {
        gdpChangeEl.textContent = `${gdpPct.toFixed(1)}%`;
        gdpChangeEl.className = 'fiscal-sublabel negative';
      }

      // Clean additive decomposition: each effect computed holding others at baseline
      document.getElementById('gdp-baseline-val').textContent = `$${baselineGDP2075.toFixed(0)}T`;
      
      // Fiscal effect only (entitlement savings + deficit crowding out, but NOT inflation)
      // We need to temporarily disable baseline deficit for this calculation
      const savedBaseline = modelParams.baselineDeficit;
      modelParams.baselineDeficit = 0; // Temporarily zero out for decomposition
      const gdpFiscalOnly = calculateGDP2075(1.62, 0, entitlementSavings, 0); // No deficit = no inflation drag
      modelParams.baselineDeficit = savedBaseline; // Restore
      
      // Simple crowding out effect (linear, without inflation)
      const crowdingOutDrag = (deficit / 100) * 0.0002; // Same as in the function
      const crowdingOutGDP = 28 * Math.pow(1 + (0.02 - crowdingOutDrag), 50);
      const fiscalEffect = (gdpFiscalOnly - baselineGDP2075) + (crowdingOutGDP - baselineGDP2075);
      document.getElementById('gdp-fiscal-val').textContent = fiscalEffect >= 0 ? `+$${fiscalEffect.toFixed(0)}T` : `‚àí$${Math.abs(fiscalEffect).toFixed(0)}T`;
      
      // Tax drag effect only
      const gdpTaxOnly = calculateGDP2075(1.62, tfr.gdpDrag, 0, 0);
      const taxEffect = gdpTaxOnly - baselineGDP2075;
      document.getElementById('gdp-tax-drag-val').textContent = taxEffect >= 0 ? `+$${taxEffect.toFixed(0)}T` : `‚àí$${Math.abs(taxEffect).toFixed(0)}T`;
      
      // Inflation drag effect (from fiscal dominance)
      const inflationRow = document.getElementById('gdp-inflation-row');
      const inflationVal = document.getElementById('gdp-inflation-val');
      if (window.lastGDPCalc && window.lastGDPCalc.inflationGrowthDrag > 0.0001) {
        inflationRow.style.display = 'flex';
        // Calculate GDP loss from inflation drag over 50 years
        const dragPerYear = window.lastGDPCalc.inflationGrowthDrag;
        const gdpWithoutInflationDrag = 28 * Math.pow(1.02, 50);
        const gdpWithInflationDrag = 28 * Math.pow(1.02 - dragPerYear, 50);
        const inflationEffect = gdpWithInflationDrag - gdpWithoutInflationDrag;
        inflationVal.textContent = `‚àí$${Math.abs(inflationEffect).toFixed(0)}T`;
        inflationVal.title = `${(window.lastGDPCalc.impliedInflation).toFixed(1)}pp inflation ‚Üí ${(dragPerYear * 100).toFixed(2)}% lower annual growth`;
      } else {
        inflationRow.style.display = 'none';
      }
      
      // Population effect only
      const gdpPopOnly = calculateGDP2075(tfr.mid, 0, 0, 0);
      const popEffect = gdpPopOnly - baselineGDP2075;
      document.getElementById('gdp-pop-val').textContent = popEffect >= 0 ? `+$${popEffect.toFixed(0)}T` : `‚àí$${Math.abs(popEffect).toFixed(0)}T`;
      
      // Interaction residual (total - sum of individual effects)
      const inflationEffect = window.lastGDPCalc ? -(28 * Math.pow(1.02, 50) - 28 * Math.pow(1.02 - window.lastGDPCalc.inflationGrowthDrag, 50)) : 0;
      const sumOfEffects = fiscalEffect + taxEffect + popEffect + (inflationEffect < 0 ? inflationEffect : 0);
      const interactionResidual = gdpDelta - sumOfEffects;
      document.getElementById('gdp-interaction-val').textContent = interactionResidual >= 0 ? `+$${interactionResidual.toFixed(0)}T` : `‚àí$${Math.abs(interactionResidual).toFixed(0)}T`;
      
      document.getElementById('gdp-total-val').textContent = `$${gdp2075.toFixed(0)}T`;

      document.getElementById('count-policies').textContent = [...liberalPolicies, ...illiberalPolicies].filter(p => p.enabled).length;
      document.getElementById('count-entitlements').textContent = entitlementReforms.filter(r => r.enabled).length;
      document.getElementById('count-taxes').textContent = taxIncreases.filter(t => t.enabled).length;
      
      // Update effective impact on each policy card
      updateEffectiveImpacts(tfr, fiscal);
    }

    function updateEffectiveImpacts(tfr, fiscal) {
      const enabledPolicies = [...liberalPolicies, ...illiberalPolicies].filter(p => p.enabled);
      const enabledCount = enabledPolicies.length;
      
      // Calculate the discount factors
      const interactionFactor = enabledCount > 1 ? (1 - modelParams.interactionDiscount/100) : 1;
      const contextFactor = (1 - modelParams.contextAdjustment/100);
      const implementationFactor = (modelParams.implementationRate/100);
      const totalFactor = interactionFactor * contextFactor * implementationFactor;
      
      // Calculate per-policy share of inflation penalty
      const inflationPenaltyPerPolicy = enabledCount > 0 ? tfr.inflationPenalty / enabledCount : 0;
      
      // Update each enabled policy card
      [...liberalPolicies, ...illiberalPolicies].forEach(policy => {
        const card = document.querySelector(`[data-policy-id="${policy.id}"]`);
        if (!card) return;
        
        const effectiveDiv = card.querySelector('.effective-impact');
        const effectiveValue = card.querySelector('.effective-value');
        const effectiveBreakdown = card.querySelector('.effective-breakdown');
        
        if (!effectiveDiv) return;
        
        if (policy.enabled) {
          effectiveDiv.classList.remove('hidden');
          
          // Calculate this policy's effective contribution
          const grossTfr = (policy.tfrLow + policy.tfrHigh) / 2;
          const afterDiscounts = grossTfr * totalFactor;
          const effectiveTfr = afterDiscounts - inflationPenaltyPerPolicy;
          
          effectiveValue.textContent = effectiveTfr >= 0 ? `+${effectiveTfr.toFixed(2)} TFR` : `${effectiveTfr.toFixed(2)} TFR`;
          effectiveValue.classList.toggle('negative', effectiveTfr < 0);
          
          // Build breakdown text
          let breakdownParts = [];
          breakdownParts.push(`Base: +${grossTfr.toFixed(2)}`);
          
          if (totalFactor < 1) {
            const discountPct = Math.round((1 - totalFactor) * 100);
            breakdownParts.push(`Discounts: ‚àí${discountPct}%`);
          }
          
          if (inflationPenaltyPerPolicy > 0.001) {
            breakdownParts.push(`Inflation: ‚àí${inflationPenaltyPerPolicy.toFixed(2)}`);
          }
          
          effectiveBreakdown.textContent = breakdownParts.join(' ‚Üí ');
        } else {
          effectiveDiv.classList.add('hidden');
        }
      });
    }

    function renderPolicyCard(policy, container, isIlliberal = false) {
      const cardContainer = document.createElement('div');
      cardContainer.className = 'card-container';

      const tfrMid = ((policy.tfrLow + policy.tfrHigh) / 2).toFixed(2);
      const costMid = Math.round((policy.costLow + policy.costHigh) / 2);

      // Build sources table HTML
      let sourcesHTML = '';
      if (policy.methodology && policy.methodology.sources) {
        sourcesHTML = `
          <table class="elasticity-table">
            <thead>
              <tr>
                <th>Source</th>
                <th>Finding</th>
                <th>Elasticity</th>
              </tr>
            </thead>
            <tbody>
              ${policy.methodology.sources.map(s => `
                <tr>
                  <td><span class="source-cite">${s.cite}</span></td>
                  <td>${s.finding}</td>
                  <td>${s.elasticity}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      const confidenceClass = policy.confidence === 'high' ? 'high' : 
                              policy.confidence === 'medium-high' ? 'medium' :
                              policy.confidence === 'medium' ? 'medium' : 'low';

      // Custom slider config or fallback to intensity
      const sc = policy.sliderConfig || { label: 'Intensity', min: 25, max: 100, default: 100, format: v => `${v}%` };
      const sliderValue = sc.default;

      cardContainer.innerHTML = `
        <div class="card-flipper">
          <div class="card-front">
            <div class="policy-card${isIlliberal ? ' illiberal' : ''}" data-policy-id="${policy.id}">
              <div class="policy-header">
                <span class="policy-title" data-flip="true">${policy.name}</span>
                <div class="policy-stats">
                  <span class="policy-stat tfr policy-tfr">+${tfrMid} TFR</span>
                  <span class="policy-stat cost policy-cost">${policy.revenue ? '‚àí' : ''}$${Math.abs(costMid)}B</span>
                </div>
              </div>
              <p class="policy-description">${policy.description}</p>
              ${policy.historical ? `<div class="historical-note">${policy.historical}</div>` : ''}
              <div class="toggle-row">
                <span class="toggle-label">Disabled</span>
                <label class="toggle"><input type="checkbox"><div class="toggle-track"><div class="toggle-thumb"></div></div></label>
              </div>
              <div class="slider-row hidden">
                <div class="slider-header"><span class="slider-label">${sc.label}</span><span class="slider-value">${sc.format(sliderValue)}</span></div>
                <input type="range" min="${sc.min}" max="${sc.max}" value="${sliderValue}">
              </div>
              <div class="effective-impact hidden">
                <span class="effective-label">Effective impact:</span>
                <span class="effective-value">+0.00 TFR</span>
                <span class="effective-breakdown"></span>
              </div>
            </div>
          </div>
          <div class="card-back">
            <div class="methodology-card${isIlliberal ? ' illiberal' : ''}">
              <div class="methodology-header">
                <span class="methodology-title">Methodology & Sources</span>
                <button class="back-button" data-flip="true">‚Üê Back</button>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Confidence Level</div>
                <span class="confidence-badge ${confidenceClass}">${policy.confidence || 'Unknown'}</span>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Derivation</div>
                <div class="methodology-content">${policy.methodology ? policy.methodology.derivation : 'No methodology available.'}</div>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Literature Sources</div>
                ${sourcesHTML || '<div class="methodology-content"><em>No direct sources available.</em></div>'}
              </div>
              ${policy.methodology && policy.methodology.notes ? `
              <div class="methodology-section">
                <div class="methodology-section-title">Notes & Caveats</div>
                <div class="methodology-content">${policy.methodology.notes}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      // Flip handlers
      const flipTriggers = cardContainer.querySelectorAll('[data-flip="true"]');
      flipTriggers.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          cardContainer.classList.toggle('flipped');
        });
      });

      // Toggle and slider handlers
      const policyCard = cardContainer.querySelector('.policy-card');
      const toggle = cardContainer.querySelector('input[type="checkbox"]');
      const slider = cardContainer.querySelector('input[type="range"]');
      const sliderRow = cardContainer.querySelector('.slider-row');
      const sliderValueEl = cardContainer.querySelector('.slider-value');
      const toggleLabel = cardContainer.querySelector('.toggle-label');
      const tfrStat = cardContainer.querySelector('.policy-tfr');
      const costStat = cardContainer.querySelector('.policy-cost');

      // Store base values for scaling
      const baseTfrLow = policy.tfrLow;
      const baseTfrHigh = policy.tfrHigh;
      const baseCostLow = policy.costLow;
      const baseCostHigh = policy.costHigh;

      toggle.addEventListener('change', () => {
        policy.enabled = toggle.checked;
        policyCard.classList.toggle('enabled', policy.enabled);
        sliderRow.classList.toggle('hidden', !policy.enabled);
        toggleLabel.textContent = policy.enabled ? 'Enabled' : 'Disabled';
        updateDisplay();
      });

      slider.addEventListener('input', () => {
        const val = parseInt(slider.value);
        sliderValueEl.textContent = sc.format(val);
        
        // Calculate intensity as ratio to default
        let ratio;
        
        if (sc.invert) {
          // For inverted sliders (like childcare cost), lower value = higher effect
          // Map [min, max] to [maxRatio, minRatio] linearly
          const minRatio = 0.25;  // At max value ($20/day), effect is 25% of default
          const maxRatio = 1.25;  // At min value ($0/day), effect is 125% of default
          const t = (val - sc.min) / (sc.max - sc.min); // 0 to 1
          ratio = maxRatio + (minRatio - maxRatio) * t;
        } else {
          ratio = val / sc.default;
        }
        
        // Clamp ratio to reasonable bounds
        ratio = Math.max(0.1, Math.min(2.5, ratio));
        
        policy.intensity = ratio * 100;
        
        // Update displayed TFR and cost
        policy.tfrLow = baseTfrLow * ratio;
        policy.tfrHigh = baseTfrHigh * ratio;
        policy.costLow = baseCostLow * ratio;
        policy.costHigh = baseCostHigh * ratio;
        
        const newTfrMid = ((policy.tfrLow + policy.tfrHigh) / 2).toFixed(2);
        const newCostMid = Math.round((policy.costLow + policy.costHigh) / 2);
        
        tfrStat.textContent = `+${newTfrMid} TFR`;
        costStat.textContent = `${policy.revenue ? '‚àí' : ''}$${Math.abs(newCostMid)}B`;
        
        updateDisplay();
      });

      container.appendChild(cardContainer);
    }

    function renderReformCard(reform, container, isTax = false) {
      if (isTax && reform.methodology) {
        // Tax cards with methodology get flip functionality
        renderTaxCard(reform, container);
        return;
      }

      // Entitlement reform cards with optional sliders
      const card = document.createElement('div');
      card.className = 'policy-card entitlement-card';

      const savingsMid = Math.round((reform.savingsLow + reform.savingsHigh) / 2);
      const hasDrag = reform.growthDrag > 0;
      const sc = reform.sliderConfig;

      card.innerHTML = `
        <div class="policy-header">
          <span class="policy-title" style="cursor: default;">${reform.name}</span>
          <div class="policy-stats">
            <span class="policy-stat cost reform-savings">$${savingsMid}B/yr</span>
            ${hasDrag ? `<span class="policy-stat drag">‚àí${reform.growthDrag.toFixed(2)} TFR</span>` : ''}
          </div>
        </div>
        <p class="policy-description">${reform.description}${hasDrag ? ` <em style="color:#5d4037;">(${reform.dragRationale})</em>` : ''}</p>
        <div class="toggle-row">
          <span class="toggle-label">Disabled</span>
          <label class="toggle"><input type="checkbox"><div class="toggle-track"><div class="toggle-thumb"></div></div></label>
        </div>
        ${sc ? `
        <div class="slider-row hidden">
          <div class="slider-header">
            <span class="slider-label">${sc.label}</span>
            <span class="slider-value">${sc.format(sc.default)}</span>
          </div>
          <input type="range" min="${sc.min}" max="${sc.max}" value="${sc.default}">
        </div>
        ` : ''}
      `;

      const title = card.querySelector('.policy-title');
      title.style.cursor = 'default';

      const toggle = card.querySelector('input[type="checkbox"]');
      const toggleLabel = card.querySelector('.toggle-label');
      const sliderRow = card.querySelector('.slider-row');
      const slider = card.querySelector('input[type="range"]');
      const sliderValueEl = card.querySelector('.slider-value');
      const savingsStat = card.querySelector('.reform-savings');

      // Store base values for scaling
      const baseSavingsLow = reform.savingsLow;
      const baseSavingsHigh = reform.savingsHigh;

      toggle.addEventListener('change', () => {
        reform.enabled = toggle.checked;
        card.classList.toggle('enabled', reform.enabled);
        if (sliderRow) sliderRow.classList.toggle('hidden', !reform.enabled);
        toggleLabel.textContent = reform.enabled ? 'Enabled' : 'Disabled';
        updateDisplay();
      });

      if (slider && sc) {
        slider.addEventListener('input', () => {
          const val = parseInt(slider.value);
          sliderValueEl.textContent = sc.format(val);
          
          // Calculate ratio based on reform type
          let ratio = 1;
          
          if (reform.id === 'medicare-age') {
            // 65 (current) to slider value, each year = ~$40-50B
            const denom = sc.default - 65;
            ratio = denom !== 0 ? (val - 65) / denom : 1;
          } else if (reform.id === 'ss-means-test') {
            // Lower threshold = more savings (more people affected)
            ratio = val > 0 ? sc.default / val : 2.5;
          } else if (reform.id === 'ss-cola') {
            // Higher reduction = more savings
            ratio = sc.default > 0 ? val / sc.default : 1;
          } else if (reform.id === 'medicare-drugs') {
            // More drugs = more savings
            ratio = sc.default > 0 ? val / sc.default : 1;
          } else if (reform.id === 'ss-retirement-70') {
            // 67 (current) to slider value
            const denom = sc.default - 67;
            ratio = denom !== 0 ? (val - 67) / denom : 1;
          } else if (reform.id === 'ss-cap') {
            // Lower cap = more savings
            ratio = val > 0 ? sc.default / val : 2.5;
          } else if (reform.id === 'medicare-premiums') {
            // Lower threshold = more savings
            ratio = val > 0 ? sc.default / val : 2.5;
          }
          
          // Clamp ratio to reasonable bounds and handle NaN/Infinity
          if (!isFinite(ratio) || isNaN(ratio)) ratio = 1;
          ratio = Math.max(0.25, Math.min(2.5, ratio));
          
          reform.savingsLow = Math.round(baseSavingsLow * ratio);
          reform.savingsHigh = Math.round(baseSavingsHigh * ratio);
          
          const newSavingsMid = Math.round((reform.savingsLow + reform.savingsHigh) / 2);
          savingsStat.textContent = `$${newSavingsMid}B/yr`;
          
          updateDisplay();
        });
      }

      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '12px';
      wrapper.appendChild(card);
      container.appendChild(wrapper);
    }

    function renderTaxCard(tax, container) {
      const cardContainer = document.createElement('div');
      cardContainer.className = 'card-container';
      cardContainer.setAttribute('data-tax-id', tax.id);

      const savingsMid = Math.round((tax.savingsLow + tax.savingsHigh) / 2);

      // Build sources table HTML
      let sourcesHTML = '';
      if (tax.methodology && tax.methodology.sources) {
        sourcesHTML = `
          <table class="elasticity-table">
            <thead>
              <tr>
                <th>Source</th>
                <th>Finding</th>
                <th>Elasticity</th>
              </tr>
            </thead>
            <tbody>
              ${tax.methodology.sources.map(s => `
                <tr>
                  <td><span class="source-cite">${s.cite}</span></td>
                  <td>${s.finding}</td>
                  <td>${s.elasticity}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      const confidenceClass = tax.confidence === 'high' ? 'high' : 
                              tax.confidence === 'medium-high' ? 'medium' :
                              tax.confidence === 'medium' ? 'medium' : 'low';

      // Format threshold display
      const formatThreshold = (val) => {
        if (tax.id === 'financial-transaction') return `${val} bp`;
        if (tax.id === 'corporate-tax' || tax.id === 'vat') return `${val}%`;
        if (tax.id === 'carbon-tax') return `$${val}/ton`;
        return `$${val >= 1000 ? (val/1000).toFixed(1) + 'M' : val + 'k'}`;
      };

      cardContainer.innerHTML = `
        <div class="card-flipper">
          <div class="card-front">
            <div class="policy-card tax-card" data-tax-id="${tax.id}">
              <div class="policy-header">
                <span class="policy-title" data-flip="true">${tax.name}</span>
                <div class="policy-stats">
                  <span class="policy-stat cost tax-cost">$${savingsMid}B/yr</span>
                  <span class="policy-stat drag tax-drag">‚àí${tax.tfrDrag.toFixed(2)} TFR</span>
                </div>
              </div>
              <p class="policy-description">${tax.description} <em style="color:#5d4037;">(${tax.dragRationale})</em></p>
              <div class="toggle-row">
                <span class="toggle-label">Disabled</span>
                <label class="toggle"><input type="checkbox" class="tax-toggle"><div class="toggle-track"><div class="toggle-thumb"></div></div></label>
              </div>
              <div class="slider-row threshold-row hidden">
                <div class="slider-header">
                  <span class="slider-label">${tax.thresholdLabel}</span>
                  <span class="slider-value threshold-value">${formatThreshold(tax.threshold)}</span>
                </div>
                <input type="range" class="threshold-slider" min="${tax.thresholdMin}" max="${tax.thresholdMax}" value="${tax.threshold}">
              </div>
            </div>
          </div>
          <div class="card-back">
            <div class="methodology-card tax-methodology">
              <div class="methodology-header">
                <span class="methodology-title">Methodology & Sources</span>
                <button class="back-button" data-flip="true">‚Üê Back</button>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Confidence Level</div>
                <span class="confidence-badge ${confidenceClass}">${tax.confidence || 'Unknown'}</span>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Impact Derivation</div>
                <div class="methodology-content">${tax.methodology ? tax.methodology.derivation : 'No methodology available.'}</div>
              </div>
              <div class="methodology-section">
                <div class="methodology-section-title">Literature Sources</div>
                ${sourcesHTML || '<div class="methodology-content"><em>No direct sources available.</em></div>'}
              </div>
              ${tax.methodology && tax.methodology.notes ? `
              <div class="methodology-section">
                <div class="methodology-section-title">Notes & Caveats</div>
                <div class="methodology-content">${tax.methodology.notes}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      // Flip handlers
      const flipTriggers = cardContainer.querySelectorAll('[data-flip="true"]');
      flipTriggers.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          cardContainer.classList.toggle('flipped');
        });
      });

      // Toggle and threshold slider handlers
      const policyCard = cardContainer.querySelector('.policy-card');
      const toggle = cardContainer.querySelector('.tax-toggle');
      const thresholdSlider = cardContainer.querySelector('.threshold-slider');
      const thresholdRow = cardContainer.querySelector('.threshold-row');
      const thresholdValue = cardContainer.querySelector('.threshold-value');
      const toggleLabel = cardContainer.querySelector('.toggle-label');
      const costStat = cardContainer.querySelector('.tax-cost');
      const dragStat = cardContainer.querySelector('.tax-drag');

      toggle.addEventListener('change', () => {
        tax.enabled = toggle.checked;
        policyCard.classList.toggle('enabled', tax.enabled);
        thresholdRow.classList.toggle('hidden', !tax.enabled);
        toggleLabel.textContent = tax.enabled ? 'Enabled' : 'Disabled';
        updateDisplay();
      });

      thresholdSlider.addEventListener('input', () => {
        tax.threshold = parseInt(thresholdSlider.value);
        thresholdValue.textContent = formatThreshold(tax.threshold);
        updateTaxRevenue(tax, costStat, dragStat);
        updateDisplay();
      });

      container.appendChild(cardContainer);
    }

    function updateTaxRevenue(tax, costStat, dragStat) {
      // Adjust revenue based on threshold
      const baseRevenueLow = tax.id === 'income-tax-top' ? 80 :
                             tax.id === 'corporate-tax' ? 100 :
                             tax.id === 'capital-gains' ? 150 :
                             tax.id === 'financial-transaction' ? 60 :
                             tax.id === 'estate-tax' ? 40 :
                             tax.id === 'carbon-tax' ? 80 :
                             tax.id === 'vat' ? 400 : 50;
      
      const baseRevenueHigh = tax.id === 'income-tax-top' ? 120 :
                              tax.id === 'corporate-tax' ? 150 :
                              tax.id === 'capital-gains' ? 200 :
                              tax.id === 'financial-transaction' ? 100 :
                              tax.id === 'estate-tax' ? 70 :
                              tax.id === 'carbon-tax' ? 120 :
                              tax.id === 'vat' ? 600 : 75;

      // Base TFR drags (at default threshold)
      const baseTfrDrag = tax.id === 'income-tax-top' ? 0.01 :
                       tax.id === 'corporate-tax' ? 0.04 :
                       tax.id === 'capital-gains' ? 0.05 :
                       tax.id === 'financial-transaction' ? 0.02 :
                       tax.id === 'estate-tax' ? 0.01 :
                       tax.id === 'carbon-tax' ? 0.025 :
                       tax.id === 'vat' ? 0.02 : 0.01;

      // Base GDP drags (at default threshold)
      const baseGdpDrag = tax.id === 'income-tax-top' ? 0.002 :
                       tax.id === 'corporate-tax' ? 0.01 :
                       tax.id === 'capital-gains' ? 0.003 :
                       tax.id === 'financial-transaction' ? 0.002 :
                       tax.id === 'estate-tax' ? 0.001 :
                       tax.id === 'carbon-tax' ? 0.005 :
                       tax.id === 'vat' ? 0.001 : 0.001;

      // Calculate multiplier based on threshold vs default
      let multiplier = 1;
      let dragMultiplier = 1;
      
      if (tax.id === 'income-tax-top') {
        // Lower threshold = more revenue, but also more drag
        // $500k is base; $250k doubles revenue/drag, $1M halves it
        multiplier = 500 / tax.threshold;
        dragMultiplier = multiplier;
      } else if (tax.id === 'corporate-tax') {
        // Higher rate = more revenue and more drag
        // 28% is base
        multiplier = tax.threshold / 28;
        dragMultiplier = multiplier;
      } else if (tax.id === 'capital-gains') {
        // Lower threshold = more revenue
        // $1M is base
        multiplier = 1000 / tax.threshold;
        dragMultiplier = Math.min(multiplier, 1.5); // Cap drag increase
      } else if (tax.id === 'financial-transaction') {
        // Higher rate = more revenue but diminishing returns due to reduced trading
        // 10bp is base
        const rateRatio = tax.threshold / 10;
        multiplier = rateRatio * Math.max(0.2, 1 - (tax.threshold - 10) * 0.003); // Diminishing returns, clamped
        dragMultiplier = rateRatio;
      } else if (tax.id === 'estate-tax') {
        // Lower exemption = more revenue
        // $3.5M is base
        multiplier = 3500 / tax.threshold;
        dragMultiplier = Math.min(multiplier, 2); // Cap drag increase
      } else if (tax.id === 'carbon-tax') {
        // Higher price = more revenue (roughly linear)
        // $50/ton is base
        multiplier = tax.threshold / 50;
        dragMultiplier = multiplier;
      } else if (tax.id === 'vat') {
        // Higher rate = more revenue (roughly linear)
        // 10% is base
        multiplier = tax.threshold / 10;
        dragMultiplier = multiplier;
      }

      // Clamp multipliers to prevent negative/NaN values
      multiplier = Math.max(0.1, Math.min(5, multiplier));
      dragMultiplier = Math.max(0.1, Math.min(5, dragMultiplier));
      if (!isFinite(multiplier)) multiplier = 1;
      if (!isFinite(dragMultiplier)) dragMultiplier = 1;

      tax.savingsLow = Math.round(baseRevenueLow * multiplier);
      tax.savingsHigh = Math.round(baseRevenueHigh * multiplier);
      tax.tfrDrag = baseTfrDrag * dragMultiplier;
      tax.gdpDrag = baseGdpDrag * dragMultiplier;

      // Update the displayed stats
      if (costStat) costStat.textContent = `$${Math.round((tax.savingsLow + tax.savingsHigh) / 2)}B/yr`;
      if (dragStat) dragStat.textContent = `‚àí${tax.tfrDrag.toFixed(2)} TFR`;
    }

    function renderModelParams(container) {
      // Existing TFR model parameters
      [
        { key: 'interactionDiscount', name: 'Interaction Discount', desc: 'Overlapping benefits reduce effects (20-30%)', min: 10, max: 40, format: v => `${v}%` },
        { key: 'contextAdjustment', name: 'US Context Adjustment', desc: 'European elasticities may not transfer', min: 0, max: 30, format: v => `${v}%` },
        { key: 'implementationRate', name: 'Implementation Rate', desc: 'Admin capacity and execution risk', min: 70, max: 100, format: v => `${v}%` }
      ].forEach(p => {
        const card = document.createElement('div');
        card.className = 'params-card';
        card.innerHTML = `
          <div class="slider-header"><span class="params-title">${p.name}</span><span class="slider-value">${p.format(modelParams[p.key])}</span></div>
          <input type="range" min="${p.min}" max="${p.max}" value="${modelParams[p.key]}">
          <p class="params-description">${p.desc}</p>
        `;
        const slider = card.querySelector('input[type="range"]');
        const value = card.querySelector('.slider-value');
        slider.addEventListener('input', () => {
          modelParams[p.key] = parseInt(slider.value);
          value.textContent = p.format(modelParams[p.key]);
          updateDisplay();
        });
        container.appendChild(card);
      });
      
      // Inflation Elasticity Section Header
      const sectionHeader = document.createElement('div');
      sectionHeader.className = 'params-section-header';
      sectionHeader.innerHTML = `
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: #8b0000; margin: 20px 0 8px 0; padding-top: 12px; border-top: 1px solid #ccc;">
          Inflation Elasticities
          <span style="font-size: 9px; color: #666; text-transform: none; display: block; margin-top: 4px;">
            From empirical literature review. Tap ‚ìò on Inflation badge above for citations.
          </span>
        </div>
      `;
      container.appendChild(sectionHeader);
      
      // Economic Slack selector (dropdown)
      const slackCard = document.createElement('div');
      slackCard.className = 'params-card';
      slackCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">Economic Conditions</span>
          <select id="economic-slack-select" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 4px 8px; border: 1px solid #ccc; background: white;">
            <option value="slack" ${modelParams.economicSlack === 'slack' ? 'selected' : ''}>Significant Slack</option>
            <option value="near-full" ${modelParams.economicSlack === 'near-full' ? 'selected' : ''}>Near Full Employment</option>
            <option value="constrained" ${modelParams.economicSlack === 'constrained' ? 'selected' : ''}>Supply Constrained</option>
          </select>
        </div>
        <p class="params-description" id="slack-desc">Affects deficit‚Üíinflation elasticity (0.15-1.0% per 1% GDP)</p>
      `;
      const slackSelect = slackCard.querySelector('select');
      const slackDesc = slackCard.querySelector('#slack-desc');
      const slackDescriptions = {
        'slack': 'Low inflation sensitivity: 0.15-0.20% per 1% GDP deficit',
        'near-full': 'Moderate sensitivity: 0.25-0.40% per 1% GDP deficit',
        'constrained': 'High sensitivity: 0.50-1.0% per 1% GDP deficit (2021-23 conditions)'
      };
      slackDesc.textContent = slackDescriptions[modelParams.economicSlack];
      slackSelect.addEventListener('change', () => {
        modelParams.economicSlack = slackSelect.value;
        slackDesc.textContent = slackDescriptions[modelParams.economicSlack];
        updateDisplay();
      });
      container.appendChild(slackCard);
      
      // Deficit‚ÜíInflation elasticity slider
      const defInflCard = document.createElement('div');
      defInflCard.className = 'params-card';
      defInflCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">Deficit ‚Üí Inflation</span>
          <span class="slider-value">${modelParams.deficitToInflation.toFixed(2)}% per 1% GDP</span>
        </div>
        <input type="range" min="10" max="60" value="${modelParams.deficitToInflation * 100}">
        <p class="params-description">Central: 0.30% (SF Fed, NY Fed, Bernanke-Blanchard)</p>
      `;
      const defInflSlider = defInflCard.querySelector('input');
      const defInflValue = defInflCard.querySelector('.slider-value');
      defInflSlider.addEventListener('input', () => {
        modelParams.deficitToInflation = parseInt(defInflSlider.value) / 100;
        defInflValue.textContent = `${modelParams.deficitToInflation.toFixed(2)}% per 1% GDP`;
        updateDisplay();
      });
      container.appendChild(defInflCard);
      
      // Inflation‚ÜíTFR elasticity slider
      const inflTfrCard = document.createElement('div');
      inflTfrCard.className = 'params-card';
      inflTfrCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">Inflation ‚Üí TFR</span>
          <span class="slider-value">${modelParams.inflationToTFR.toFixed(2)}% decline per 1% CPI</span>
        </div>
        <input type="range" min="30" max="100" value="${modelParams.inflationToTFR * 100}">
        <p class="params-description">Range: 0.5-0.8% (Pacific Islands, Comolli, Adsera-Menendez)</p>
      `;
      const inflTfrSlider = inflTfrCard.querySelector('input');
      const inflTfrValue = inflTfrCard.querySelector('.slider-value');
      inflTfrSlider.addEventListener('input', () => {
        modelParams.inflationToTFR = parseInt(inflTfrSlider.value) / 100;
        inflTfrValue.textContent = `${modelParams.inflationToTFR.toFixed(2)}% decline per 1% CPI`;
        updateDisplay();
      });
      container.appendChild(inflTfrCard);
      
      // Baseline Deficit Section Header
      const baselineHeader = document.createElement('div');
      baselineHeader.innerHTML = `
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: #5d4037; margin: 20px 0 8px 0; padding-top: 12px; border-top: 1px solid #ccc;">
          Fiscal & Inflation Baseline
          <span style="font-size: 9px; color: #666; text-transform: none; display: block; margin-top: 4px;">
            Current conditions as of Jan 2025. Adjust to model different scenarios.
          </span>
        </div>
      `;
      container.appendChild(baselineHeader);
      
      // Current inflation slider
      const inflationCard = document.createElement('div');
      inflationCard.className = 'params-card';
      inflationCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">Current Inflation</span>
          <span class="slider-value">${(modelParams.fedTarget + modelParams.baselineInflation).toFixed(1)}% (${modelParams.baselineInflation > 0 ? '+' : ''}${modelParams.baselineInflation.toFixed(1)}pp above target)</span>
        </div>
        <input type="range" min="0" max="40" step="1" value="${modelParams.baselineInflation * 10}">
        <p class="params-description">BLS Nov 2025: 2.7% CPI. Fed target: 2.0%. Set to 0 to model from neutral baseline.</p>
      `;
      const inflationSlider = inflationCard.querySelector('input');
      const inflationValue = inflationCard.querySelector('.slider-value');
      inflationSlider.addEventListener('input', () => {
        modelParams.baselineInflation = parseInt(inflationSlider.value) / 10;
        const total = modelParams.fedTarget + modelParams.baselineInflation;
        const delta = modelParams.baselineInflation > 0 ? `+${modelParams.baselineInflation.toFixed(1)}pp above target` : 'at target';
        inflationValue.textContent = `${total.toFixed(1)}% (${delta})`;
        updateDisplay();
      });
      container.appendChild(inflationCard);
      
      // Baseline deficit slider
      const baselineCard = document.createElement('div');
      baselineCard.className = 'params-card';
      baselineCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">CBO Baseline Deficit</span>
          <span class="slider-value">$${modelParams.baselineDeficit.toLocaleString()}B/yr</span>
        </div>
        <input type="range" min="0" max="3000" step="100" value="${modelParams.baselineDeficit}">
        <p class="params-description">FY2025: $1.9T (6.2% GDP). Set to 0 to model incremental only.</p>
      `;
      const baselineSlider = baselineCard.querySelector('input');
      const baselineValue = baselineCard.querySelector('.slider-value');
      baselineSlider.addEventListener('input', () => {
        modelParams.baselineDeficit = parseInt(baselineSlider.value);
        baselineValue.textContent = `$${modelParams.baselineDeficit.toLocaleString()}B/yr`;
        updateDisplay();
      });
      container.appendChild(baselineCard);
      
      // Toggle for including baseline in inflation penalty
      const penaltyToggleCard = document.createElement('div');
      penaltyToggleCard.className = 'params-card';
      penaltyToggleCard.innerHTML = `
        <div class="slider-header">
          <span class="params-title">Inflation Penalty Scope</span>
          <select id="penalty-scope-select" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 4px 8px; border: 1px solid #ccc; background: white;">
            <option value="incremental" ${!modelParams.includeBaselineInPenalty ? 'selected' : ''}>Incremental Only</option>
            <option value="total" ${modelParams.includeBaselineInPenalty ? 'selected' : ''}>Total Deficit</option>
          </select>
        </div>
        <p class="params-description" id="penalty-scope-desc">Incremental: penalty on new policy spending only (baseline already priced in)</p>
      `;
      const penaltyScopeSelect = penaltyToggleCard.querySelector('select');
      const penaltyScopeDesc = penaltyToggleCard.querySelector('#penalty-scope-desc');
      const scopeDescriptions = {
        'incremental': 'Incremental: penalty on new policy spending only (baseline already priced in)',
        'total': 'Total: penalty on full deficit (assumes markets haven\'t priced in baseline)'
      };
      penaltyScopeSelect.addEventListener('change', () => {
        modelParams.includeBaselineInPenalty = penaltyScopeSelect.value === 'total';
        penaltyScopeDesc.textContent = scopeDescriptions[penaltyScopeSelect.value];
        updateDisplay();
      });
      container.appendChild(penaltyToggleCard);
    }

    function initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabIndex = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          document.getElementById(`panel-${tabIndex}`).classList.add('active');
        });
      });
    }

    function initPenaltyBadges() {
      // Inflation badge flip
      const inflationBadge = document.getElementById('penalty-inflation');
      const inflationMethodology = document.getElementById('inflation-methodology');
      const inflationBack = inflationMethodology.querySelector('.penalty-back-button');
      
      inflationBadge.addEventListener('click', () => {
        inflationMethodology.classList.add('visible');
      });
      
      inflationBack.addEventListener('click', (e) => {
        e.stopPropagation();
        inflationMethodology.classList.remove('visible');
      });

      // Growth badge flip
      const growthBadge = document.getElementById('penalty-growth');
      const growthMethodology = document.getElementById('growth-methodology');
      const growthBack = growthMethodology.querySelector('.penalty-back-button');
      
      growthBadge.addEventListener('click', () => {
        growthMethodology.classList.add('visible');
      });
      
      growthBack.addEventListener('click', (e) => {
        e.stopPropagation();
        growthMethodology.classList.remove('visible');
      });

      // GDP projection click
      const gdpValue = document.getElementById('gdp-projection');
      const gdpMethodology = document.getElementById('gdp-methodology');
      const gdpBack = gdpMethodology.querySelector('.gdp-back-button');
      
      gdpValue.addEventListener('click', () => {
        gdpMethodology.classList.add('visible');
      });
      
      gdpBack.addEventListener('click', (e) => {
        e.stopPropagation();
        gdpMethodology.classList.remove('visible');
      });

      // Close methodologies when clicking outside
      document.addEventListener('click', (e) => {
        if (!inflationBadge.contains(e.target) && !inflationMethodology.contains(e.target)) {
          inflationMethodology.classList.remove('visible');
        }
        if (!growthBadge.contains(e.target) && !growthMethodology.contains(e.target)) {
          growthMethodology.classList.remove('visible');
        }
        if (!gdpValue.contains(e.target) && !gdpMethodology.contains(e.target)) {
          gdpMethodology.classList.remove('visible');
        }
      });
    }

    function initDeficitModal() {
      window.deficitWarningShown = false;
      window.fiscalCrisisWarningShown = false;
      
      const modal = document.getElementById('deficit-modal');
      const closeBtn = document.getElementById('close-deficit-modal');
      
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('visible');
      });
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('visible');
        }
      });
      
      // Fiscal crisis modal
      const crisisModal = document.getElementById('fiscal-crisis-modal');
      const closeCrisisBtn = document.getElementById('close-fiscal-crisis-modal');
      
      closeCrisisBtn.addEventListener('click', () => {
        crisisModal.classList.remove('visible');
      });
      
      crisisModal.addEventListener('click', (e) => {
        if (e.target === crisisModal) {
          crisisModal.classList.remove('visible');
        }
      });
    }

    function getPersonalityType(tfr, fiscal, policies, entitlements, taxes, illiberalPolicies) {
      const tfrMid = tfr.mid;
      const netFiscal = fiscal.net;
      const policyCount = policies;
      const entitlementCount = entitlements;
      const taxCount = taxes;
      
      // Check which illiberal policies are enabled
      const hardAuthoritarian = illiberalPolicies.filter(p => 
        p.enabled && (p.id === 'abortion-ban' || p.id === 'contraception-ban')
      ).length > 0;
      
      const softAuthoritarian = illiberalPolicies.filter(p => 
        p.enabled && (p.id === 'celibacy-tax' || p.id === 'mandatory-marriage' || p.id === 'divorce-restrictions')
      ).length > 0;
      
      const anyIlliberal = illiberalPolicies.filter(p => p.enabled).length > 0;

      // Personality types based on choices
      if (policyCount === 0 && entitlementCount === 0 && taxCount === 0 && !anyIlliberal) {
        return { icon: 'ü§∑', title: 'The Spectator', desc: 'You\'re still exploring the options. Try enabling some policies!' };
      }
      
      if (hardAuthoritarian) {
        return { icon: '‚öîÔ∏è', title: 'The Authoritarian', desc: 'You believe the ends justify the means. History will judge.' };
      }
      
      if (softAuthoritarian && !hardAuthoritarian) {
        return { icon: 'üé≠', title: 'The Soft Authoritarian', desc: 'Nudges with teeth. You prefer carrots and sticks over outright bans.' };
      }
      
      if (tfrMid >= 2.1 && netFiscal <= 0) {
        return { icon: 'üèÜ', title: 'The Unicorn', desc: 'Replacement fertility AND fiscal balance? You found the holy grail.' };
      }
      
      if (tfrMid >= 2.1 && netFiscal > 500) {
        return { icon: 'üí∏', title: 'The MMT Maximalist', desc: 'Deficits are just numbers, right? Future generations can sort it out.' };
      }
      
      if (tfrMid >= 2.0 && entitlementCount >= 4) {
        return { icon: '‚öñÔ∏è', title: 'The Intergenerational Warrior', desc: 'You\'re willing to take on the AARP. Respect.' };
      }
      
      if (taxCount >= 4 && entitlementCount === 0) {
        return { icon: 'üèõÔ∏è', title: 'The Tax-and-Spend Liberal', desc: 'Soak the rich to save the future. Classic.' };
      }
      
      if (entitlementCount >= 4 && taxCount === 0) {
        return { icon: 'üìâ', title: 'The Entitlement Reformer', desc: 'You\'re betting seniors will accept less for the next generation.' };
      }
      
      if (tfrMid >= 1.9 && Math.abs(netFiscal) <= 100) {
        return { icon: 'üéØ', title: 'The Pragmatist', desc: 'Meaningful impact without breaking the bank. Sensible.' };
      }
      
      if (tfrMid < 1.75 && policyCount >= 3) {
        return { icon: 'üò¨', title: 'The Underfunder', desc: 'Good intentions, but you\'re not moving the needle much.' };
      }
      
      if (policyCount === 1 && entitlementCount === 0 && taxCount === 0) {
        return { icon: 'üå±', title: 'The Minimalist', desc: 'One small step. Maybe add some funding?' };
      }
      
      if (netFiscal < -200) {
        return { icon: 'üí∞', title: 'The Surplus Builder', desc: 'More offsets than spending? Future generations thank you.' };
      }
      
      return { icon: 'üî¨', title: 'The Policy Wonk', desc: 'A thoughtful mix of interventions. Keep experimenting!' };
    }

    function initShareModal() {
      const modal = document.getElementById('share-modal');
      const openBtn = document.getElementById('open-share-modal');
      const closeBtn = document.getElementById('close-share-modal');
      const shareX = document.getElementById('share-x');
      const shareCopy = document.getElementById('share-copy');
      const copiedMsg = document.getElementById('share-copied');

      openBtn.addEventListener('click', () => {
        updateShareModal();
        modal.classList.add('visible');
      });

      closeBtn.addEventListener('click', () => {
        modal.classList.remove('visible');
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('visible');
        }
      });

      shareX.addEventListener('click', () => {
        const tfr = calculateTFR();
        const type = document.getElementById('share-type-title').textContent;
        const text = `I'm "${type}" in the Fertility Policy Simulator! My package achieves TFR ${tfr.mid.toFixed(2)}. Can you do better?`;
        const url = 'https://joshfkon.github.io/LifeAppGame/';
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
      });

      shareCopy.addEventListener('click', () => {
        const tfr = calculateTFR();
        const type = document.getElementById('share-type-title').textContent;
        const text = `Fertility Policy Simulator: I'm "${type}" with TFR ${tfr.mid.toFixed(2)}. Try it: https://joshfkon.github.io/LifeAppGame/`;
        
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(() => {
            copiedMsg.classList.add('visible');
            setTimeout(() => copiedMsg.classList.remove('visible'), 2000);
          }).catch(() => {
            prompt('Copy this link:', text);
          });
        } else {
          // Fallback for non-secure contexts
          prompt('Copy this link:', text);
        }
      });
    }

    function updateShareModal() {
      const tfr = calculateTFR();
      const fiscal = calculateFiscal();
      const entitlementSavings = calculateEntitlementSavings();
      const gdp2075 = calculateGDP2075(tfr.mid, tfr.gdpDrag, entitlementSavings, tfr.deficit);

      const enabledPolicies = [...liberalPolicies].filter(p => p.enabled);
      const enabledIlliberal = [...illiberalPolicies].filter(p => p.enabled);
      const enabledEntitlements = entitlementReforms.filter(r => r.enabled);
      const enabledTaxes = taxIncreases.filter(t => t.enabled);

      // Get personality type
      const type = getPersonalityType(
        tfr, fiscal, 
        enabledPolicies.length, 
        enabledEntitlements.length, 
        enabledTaxes.length,
        illiberalPolicies
      );

      document.getElementById('share-type-icon').textContent = type.icon;
      document.getElementById('share-type-title').textContent = type.title;
      document.getElementById('share-type-desc').textContent = type.desc;

      // Update results
      document.getElementById('share-tfr').textContent = tfr.mid.toFixed(2);
      document.getElementById('share-tfr').style.color = tfr.mid >= 2.1 ? 'var(--success)' : tfr.mid >= 1.8 ? '#daa520' : 'var(--accent)';
      
      document.getElementById('share-gdp').textContent = `$${gdp2075.toFixed(0)}T`;
      
      const fiscalEl = document.getElementById('share-fiscal');
      if (fiscal.net <= 0) {
        fiscalEl.textContent = `+$${Math.abs(Math.round(fiscal.net))}B surplus`;
        fiscalEl.style.color = 'var(--success)';
      } else {
        fiscalEl.textContent = `‚àí$${Math.round(fiscal.net)}B deficit`;
        fiscalEl.style.color = 'var(--accent)';
      }

      // Build policy list
      const listEl = document.getElementById('share-policies-list');
      const allEnabled = [
        ...enabledPolicies.map(p => ({ name: p.name, type: 'fertility' })),
        ...enabledIlliberal.map(p => ({ name: p.name, type: 'illiberal' })),
        ...enabledEntitlements.map(r => ({ name: r.name, type: 'entitlement' })),
        ...enabledTaxes.map(t => ({ name: t.name, type: 'tax' }))
      ];

      if (allEnabled.length === 0) {
        listEl.innerHTML = '<em>No policies selected</em>';
      } else {
        listEl.innerHTML = allEnabled.map(p => 
          `<span class="share-policy-item ${p.type}">${p.name}</span>`
        ).join('');
      }
    }

    function initSplash() {
      const splash = document.getElementById('splash-overlay');
      const startBtn = document.getElementById('splash-start-btn');
      
      // Check if user has seen splash before (this session)
      if (sessionStorage.getItem('splashSeen')) {
        splash.classList.add('hidden');
        return;
      }
      
      startBtn.addEventListener('click', () => {
        splash.classList.add('hidden');
        sessionStorage.setItem('splashSeen', 'true');
      });
      
      // Also allow pressing Enter or Space to start
      document.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' || e.key === ' ') && !splash.classList.contains('hidden')) {
          e.preventDefault();
          splash.classList.add('hidden');
          sessionStorage.setItem('splashSeen', 'true');
        }
      });
    }

    function init() {
      initSplash();
      liberalPolicies.forEach(p => renderPolicyCard(p, document.getElementById('liberal-policies')));
      illiberalPolicies.forEach(p => renderPolicyCard(p, document.getElementById('illiberal-policies'), true));
      entitlementReforms.forEach(r => renderReformCard(r, document.getElementById('entitlement-reforms'), false));
      taxIncreases.forEach(t => renderReformCard(t, document.getElementById('tax-increases'), true));
      renderModelParams(document.getElementById('model-params'));
      initTabs();
      initPenaltyBadges();
      initDeficitModal();
      initShareModal();
      updateDisplay();
    }

    init();
  </script>
</body>
</html>
