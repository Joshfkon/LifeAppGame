<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PATH // A Life in Choices</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        body { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
            font-family: 'Crimson Text', serif;
        }

        .event-card {
            background: linear-gradient(145deg, #2a2a4a 0%, #1a1a3a 100%);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        .choice-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }
        .choice-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }
        .choice-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .stat-icon {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        .stat-fill { transition: width 0.5s ease; }

        .phase-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .outcome-flash { animation: flashIn 0.3s ease; }
        @keyframes flashIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Dice rolling animation */
        .dice-container {
            background: rgba(0, 0, 0, 0.9);
            padding: 2rem 3rem;
            border-radius: 1rem;
            border: 2px solid #4a5568;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
        }
        
        .dice-roller .dice {
            font-size: 5rem;
            animation: diceRoll 0.6s ease-in-out;
            display: inline-block;
        }
        
        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(180deg) scale(1.2); }
            50% { transform: rotate(360deg) scale(0.9); }
            75% { transform: rotate(540deg) scale(1.1); }
            100% { transform: rotate(720deg) scale(1); }
        }
        
        .dice-result {
            animation: resultReveal 0.3s ease-out;
        }
        
        @keyframes resultReveal {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .dice-nat20 { color: #ffd700 !important; text-shadow: 0 0 20px #ffd700; }
        .dice-nat1 { color: #ff4444 !important; text-shadow: 0 0 20px #ff4444; }
        .dice-success { color: #48bb78 !important; }
        .dice-fail { color: #f56565 !important; }

        .particle {
            position: absolute; width: 2px; height: 2px;
            background: rgba(255,255,255,0.3); border-radius: 50%;
            animation: float 20s infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; } 90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }

        .possession-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tab-btn.active {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body class="text-gray-200 overflow-hidden">

    <div id="particles" class="fixed inset-0 pointer-events-none overflow-hidden"></div>

    <!-- Housing Modal -->
    <div id="housingModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">üè† Change Living Situation</h3>
                <button onclick="closeHousingModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="housingOptions" class="space-y-2"></div>
        </div>
    </div>

    <!-- Transport Modal -->
    <div id="transportModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">üöó Change Transportation</h3>
                <button onclick="closeTransportModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="transportOptions" class="space-y-2"></div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-cyan-500 rounded-lg p-6 max-w-xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2" id="tutorialIcon">üìñ</div>
                <h3 class="text-xl font-bold text-white" id="tutorialTitle">Welcome to Life Game!</h3>
            </div>
            <div id="tutorialContent" class="text-gray-300 mb-6 space-y-3"></div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-500" id="tutorialProgress">Step 1 of 5</span>
                <div class="flex gap-2">
                    <button onclick="skipTutorial()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors">
                        Skip Tutorial
                    </button>
                    <button onclick="nextTutorialStep()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded transition-colors" id="tutorialNextBtn">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Menu Modal -->
    <div id="gameMenuModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white text-center mb-6">‚öôÔ∏è Game Menu</h3>
            <div class="space-y-3">
                <button onclick="saveGame()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    üíæ Save Game
                </button>
                <button onclick="loadGame()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    üìÇ Load Game
                </button>
                <button onclick="showTutorial()" class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    üìñ View Tutorial
                </button>
                <button onclick="confirmEndGame()" class="w-full py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    üèÅ End Game Early
                </button>
                <button onclick="closeGameMenu()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm End Game Modal -->
    <div id="confirmEndModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-red-500 rounded-lg p-6 max-w-sm w-full mx-4 text-center">
            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-xl font-bold text-white mb-2">End Game Early?</h3>
            <p class="text-gray-400 mb-6">Your life story will be assessed based on your current progress. This cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmEnd()" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors">
                    Keep Playing
                </button>
                <button onclick="endGameEarly()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded transition-colors">
                    End Game
                </button>
            </div>
        </div>
    </div>

    <!-- Education/Status Modal -->
    <div id="educationModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white" id="eduModalTitle">üìö Academic Progress</h3>
                <button onclick="closeEducationModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="educationContent" class="space-y-4"></div>
            <div class="mt-4">
                <button onclick="closeEducationModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Relationships Modal -->
    <div id="relationshipsModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">üë• People in Your Life</h3>
                <button onclick="closeRelationshipsModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="relationshipsList" class="space-y-3"></div>
            <div class="mt-4">
                <button onclick="closeRelationshipsModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Fishing Mini-Game Modal -->
    <div id="fishingModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gradient-to-b from-blue-900 to-blue-950 border border-blue-500 rounded-lg p-6 max-w-md w-full mx-4 text-center">
            <div class="text-4xl mb-2" id="fishingIcon">üé£</div>
            <h3 class="text-xl font-bold text-white mb-2" id="fishingTitle">Gone Fishing</h3>
            <div id="fishingContent" class="text-gray-300 mb-4"></div>
            <div id="fishingWater" class="text-6xl my-4 transition-all">üåä</div>
            <div id="fishingActions" class="space-y-2"></div>
        </div>
    </div>

    <!-- Habits Modal -->
    <div id="habitsModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">üß† Manage Habits</h3>
                <button onclick="closeHabitsModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <!-- Willpower Bar -->
            <div class="bg-gray-800 rounded-lg p-3 mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-400">Willpower Budget</span>
                    <span id="habitsWillpowerText" class="text-purple-400">50/50</span>
                </div>
                <div class="w-full h-3 bg-gray-700 rounded-full overflow-hidden">
                    <div id="habitsWillpowerBar" class="h-full bg-purple-500 rounded-full transition-all" style="width: 100%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2" id="willpowerFactors"></div>
            </div>
            
            <div class="text-xs text-gray-400 mb-3">
                <span class="text-green-400">Good habits</span> cost willpower but improve your life. 
                <span class="text-red-400">Bad habits</span> give willpower back but have downsides.
                <br><span class="text-purple-400">Habits maintained longer cost less willpower!</span>
            </div>
            
            <div class="mb-3">
                <div class="text-sm font-bold text-green-400 mb-2">‚ú® Good Habits</div>
                <div id="goodHabitsList" class="space-y-2"></div>
            </div>
            
            <div class="mb-3">
                <div class="text-sm font-bold text-red-400 mb-2">‚ö†Ô∏è Bad Habits</div>
                <div id="badHabitsList" class="space-y-2"></div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="closeHabitsModal()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 px-4 rounded transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Subscriptions Modal -->
    <div id="subscriptionsModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">üì± Manage Subscriptions</h3>
                <button onclick="closeSubscriptionsModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="text-sm text-gray-400 mb-4">
                Total: <span id="subsModalCost" class="text-yellow-400 font-bold">$0</span>/week
            </div>
            <div id="subscriptionsList" class="space-y-2"></div>
            <div class="mt-4 flex gap-2">
                <button onclick="closeSubscriptionsModal()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white py-2 px-4 rounded transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Free Time Modal -->
    <div id="freeTimeModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">‚è∞ Manage Weekly Schedule</h3>
                <button onclick="closeFreeTimeModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="text-sm text-gray-400 mb-4">
                Allocate your <span class="text-cyan-400 font-bold">20 hours</span> of free time per week.
                <br><span class="text-gray-500">Remaining: <span id="freeTimeRemaining" class="text-cyan-400">20</span> hrs | Cost: <span id="freeTimeModalCost" class="text-yellow-400">$0</span>/week</span>
            </div>
            <div id="freeTimeActivities" class="space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="text-xs text-gray-500 mb-2">Weekly Effects Preview:</div>
                <div id="freeTimeEffectsPreview" class="text-xs text-gray-400 grid grid-cols-2 gap-1"></div>
            </div>
            <div class="mt-4 flex gap-2">
                <button onclick="saveFreeTimeAllocation()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white py-2 px-4 rounded transition-colors">
                    Save Schedule
                </button>
                <button onclick="closeFreeTimeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div class="h-screen flex flex-col max-w-5xl mx-auto relative z-10">

        <!-- Top Stats Bar -->
        <div class="p-3 flex justify-between items-center border-b border-gray-800/50">
            <div class="flex gap-4">
                <div class="flex items-center gap-1" title="Health">
                    <div class="stat-icon bg-red-900/50 text-red-400">‚ô•</div>
                    <div class="w-14 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                        <div id="healthBar" class="stat-fill h-full bg-red-500 rounded-full" style="width: 100%"></div>
                    </div>
                    <span class="text-xs text-gray-500" id="healthVal">100</span>
                </div>
                <div class="flex items-center gap-1" title="Energy">
                    <div class="stat-icon bg-yellow-900/50 text-yellow-400">‚ö°</div>
                    <div class="w-14 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                        <div id="energyBar" class="stat-fill h-full bg-yellow-500 rounded-full" style="width: 100%"></div>
                    </div>
                    <span class="text-xs text-gray-500" id="energyVal">100</span>
                </div>
                <div class="flex items-center gap-1" title="Happiness">
                    <div class="stat-icon bg-blue-900/50 text-blue-400">‚ò∫</div>
                    <div class="w-14 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                        <div id="happyBar" class="stat-fill h-full bg-blue-500 rounded-full" style="width: 75%"></div>
                    </div>
                    <span class="text-xs text-gray-500" id="happyVal">75</span>
                </div>
                <div class="flex items-center gap-1" title="Stress">
                    <div class="stat-icon bg-purple-900/50 text-purple-400">üò∞</div>
                    <div class="w-14 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                        <div id="stressBar" class="stat-fill h-full bg-purple-500 rounded-full" style="width: 20%"></div>
                    </div>
                    <span class="text-xs text-gray-500" id="stressVal">20</span>
                </div>
            </div>
            
            <div class="text-center">
                <div class="text-lg font-bold text-white">
                    <span id="ageDisplay">18</span> yrs, <span id="monthDisplay">1</span> mo
                </div>
                <div id="phaseBadge" class="phase-badge bg-purple-900/50 text-purple-300">Deciding Future</div>
            </div>

            <div class="text-right flex items-center gap-3">
                <div>
                <div class="text-lg font-bold text-green-400" id="moneyDisplay">$1,200</div>
                <div class="text-[10px] text-gray-500">Savings</div>
                <div class="text-[10px] text-red-400 hidden" id="debtDisplay"></div>
                </div>
                <button onclick="openGameMenu()" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors" title="Game Menu">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>

        <!-- Phase Progress Bar -->
        <div class="px-4 py-2 border-b border-gray-800/30">
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-500 w-24" id="phaseLabel">Week 1</span>
                <div class="flex-grow h-1 bg-gray-800 rounded-full overflow-hidden">
                    <div id="phaseProgress" class="h-full bg-purple-500 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <span class="text-[10px] text-gray-500" id="phaseTarget"></span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow flex gap-4 p-4 overflow-hidden">
            
            <!-- Left Panel: Status -->
            <div class="w-56 flex flex-col gap-2 overflow-y-auto">
                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" id="statusCard" onclick="openEducationModal()" title="Click for details">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>Current Status</span>
                        <span class="text-cyan-400" id="statusViewIcon">üëÅÔ∏è</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xl" id="statusIcon">üéì</span>
                        <div>
                            <div class="text-sm text-white" id="statusTitle">High School Senior</div>
                            <div class="text-[10px] text-gray-500" id="statusDesc">Graduation approaching</div>
                        </div>
                    </div>
                    <div id="gpaDisplay" class="text-[10px] mt-1 hidden">
                        <div class="flex justify-between">
                            <span class="text-gray-500">GPA:</span>
                            <span id="gpaValue" class="text-cyan-400">3.00</span>
                        </div>
                        <div class="h-1 bg-gray-800 rounded-full mt-0.5">
                            <div id="gpaBar" class="h-full bg-cyan-500 rounded-full" style="width: 75%"></div>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="traitsCard" style="display:none;">
                    <div class="text-[10px] text-gray-500 uppercase">Character Traits</div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between"><span class="text-gray-500">Height:</span><span id="traitHeight" class="text-gray-300">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Family:</span><span id="traitWealth" class="text-yellow-400">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Intelligence:</span><span id="traitIntel" class="text-blue-400">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Looks:</span><span id="traitAttr" class="text-pink-400">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Self-Control:</span><span id="traitSelfControl" class="text-purple-400">-</span></div>
                        <div class="flex justify-between border-t border-gray-700 pt-1 mt-1"><span class="text-gray-500">üíï Dating Appeal:</span><span id="datingAppeal" class="text-pink-400">-</span></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="fitnessCard" style="display:none;">
                    <div class="text-[10px] text-gray-500 uppercase">Fitness</div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div id="fitnessGym" class="text-gray-400">No gym membership</div>
                        <div id="fitnessEating" class="text-gray-400">Normal diet</div>
                        <div id="fitnessStreak" class="text-gray-500"></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openFreeTimeModal()" title="Click to manage">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>‚è∞ Weekly Schedule</span>
                        <span class="text-cyan-400">‚öôÔ∏è</span>
                    </div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Free Time:</span>
                            <span id="freeTimeUsed" class="text-cyan-400">0/20 hrs</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Weekly Cost:</span>
                            <span id="freeTimeCost" class="text-yellow-400">$0</span>
                        </div>
                        <div id="freeTimeSummary" class="text-[9px] text-gray-500 mt-1"></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openHousingModal()" title="Click to change">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>Living Situation</span>
                        <span class="text-cyan-400">‚öôÔ∏è</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xl" id="homeIcon">üè†</span>
                        <div>
                            <div class="text-sm text-white" id="homeName">Parents' House</div>
                            <div class="text-[10px] text-gray-500" id="homeDesc">Free rent</div>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openTransportModal()" title="Click to change">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>Transportation</span>
                        <span class="text-cyan-400">‚öôÔ∏è</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xl" id="carIcon">üöå</span>
                        <div>
                            <div class="text-sm text-white" id="carName">Bus Pass</div>
                            <div class="text-[10px] text-gray-500" id="carDesc">$20/week</div>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openSubscriptionsModal()" title="Click to manage">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>üì± Subscriptions</span>
                        <span class="text-cyan-400">‚öôÔ∏è</span>
                    </div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Active:</span>
                            <span id="subsCount" class="text-cyan-400">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Cost:</span>
                            <span id="subsCost" class="text-yellow-400">$0/week</span>
                        </div>
                        <div id="subsSummary" class="text-[9px] text-gray-500 mt-1"></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openHabitsModal()" title="Click to manage">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>üß† Habits</span>
                        <span class="text-cyan-400">‚öôÔ∏è</span>
                    </div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Willpower:</span>
                            <span id="willpowerDisplay" class="text-purple-400">50/50</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Habit Cost:</span>
                            <span id="habitCostDisplay" class="text-cyan-400">0</span>
                        </div>
                        <div id="habitsSummary" class="text-[9px] text-gray-500 mt-1"></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="jobCard" style="display:none;">
                    <div class="text-[10px] text-gray-500 uppercase">Employment</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xl" id="jobIcon">üíº</span>
                        <div>
                            <div class="text-sm text-white" id="jobName">--</div>
                            <div class="text-[10px] text-green-400" id="jobPay">--</div>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="flex justify-between text-[10px]">
                            <span class="text-gray-500">Performance</span>
                            <span id="jobPerfVal" class="text-yellow-400">50%</span>
                        </div>
                        <div class="h-1 bg-gray-800 rounded-full mt-0.5">
                            <div id="jobPerfBar" class="h-full bg-yellow-500 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="partnerCard" style="display:none;">
                    <div class="text-[10px] text-gray-500 uppercase">Relationship</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xl">üíï</span>
                        <div class="flex-grow">
                            <div class="text-sm text-white" id="partnerName">--</div>
                            <div class="text-[10px] text-gray-500" id="partnerStatus">Dating</div>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="flex justify-between text-[10px]">
                            <span class="text-gray-500">Bond</span>
                            <span id="partnerBondVal" class="text-pink-400">50%</span>
                        </div>
                        <div class="h-1 bg-gray-800 rounded-full mt-0.5">
                            <div id="partnerBondBar" class="h-full bg-pink-500 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors" onclick="openRelationshipsModal()" title="View all relationships">
                    <div class="text-[10px] text-gray-500 uppercase flex justify-between items-center">
                        <span>üë• People in Your Life</span>
                        <span class="text-cyan-400">üëÅÔ∏è</span>
                    </div>
                    <div id="relationshipsSummary" class="text-[10px] space-y-0.5 mt-1">
                        <div class="text-gray-500">No close relationships yet</div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded">
                    <div class="text-[10px] text-gray-500 uppercase">Your Skills</div>
                    <div class="mt-1 space-y-1">
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] w-12 text-gray-500">Tech</span>
                            <div class="flex-grow h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="techBar" class="h-full bg-blue-500 rounded-full transition-all" style="width: 10%"></div>
                            </div>
                            <span class="text-[10px] text-gray-500 w-6" id="techVal">10</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] w-12 text-gray-500">Social</span>
                            <div class="flex-grow h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="socialBar" class="h-full bg-purple-500 rounded-full transition-all" style="width: 30%"></div>
                            </div>
                            <span class="text-[10px] text-gray-500 w-6" id="socialVal">30</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] w-12 text-gray-500">Physical</span>
                            <div class="flex-grow h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="physicalBar" class="h-full bg-green-500 rounded-full transition-all" style="width: 40%"></div>
                            </div>
                            <span class="text-[10px] text-gray-500 w-6" id="physicalVal">40</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] w-12 text-gray-500">Creative</span>
                            <div class="flex-grow h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                <div id="creativeBar" class="h-full bg-orange-500 rounded-full transition-all" style="width: 20%"></div>
                            </div>
                            <span class="text-[10px] text-gray-500 w-6" id="creativeVal">20</span>
                        </div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded">
                    <div class="text-[10px] text-gray-500 uppercase">Education & Traits</div>
                    <div id="skillsList" class="text-[10px] text-gray-400 mt-1">
                        High School Diploma (in progress)
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="networkCard">
                    <div class="text-[10px] text-gray-500 uppercase">Network & Connections</div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between"><span class="text-gray-500">Contacts:</span><span id="networkContacts" class="text-cyan-400">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Credit Score:</span><span id="creditScoreDisplay" class="text-yellow-400">650</span></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded">
                    <div class="text-[10px] text-gray-500 uppercase">Weekly Budget</div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between"><span class="text-gray-500">Income:</span><span id="weeklyIncome" class="text-green-400">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Expenses:</span><span id="weeklyExpenses" class="text-red-400">$0</span></div>
                        <div class="flex justify-between border-t border-gray-700 pt-0.5"><span class="text-gray-400">Net:</span><span id="weeklyNet" class="text-white">$0</span></div>
                    </div>
                </div>

                <div class="possession-card p-2 rounded" id="creditCardCard" style="display: none;">
                    <div class="text-[10px] text-gray-500 uppercase">üí≥ Credit Card</div>
                    <div class="text-[10px] space-y-0.5 mt-1">
                        <div class="flex justify-between"><span class="text-gray-500">Balance:</span><span id="creditBalance" class="text-red-400">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Limit:</span><span id="creditLimit" class="text-gray-400">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">APR:</span><span id="creditAPR" class="text-yellow-400">0%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Available:</span><span id="creditAvailable" class="text-green-400">$0</span></div>
                    </div>
                </div>
            </div>

            <!-- Center: Event Card -->
            <div class="flex-grow flex items-center justify-center relative">
                
                <div id="diceDisplay" class="hidden absolute inset-0 flex items-center justify-center z-30">
                    <div class="dice-container text-center">
                        <div id="diceRoller" class="dice-roller">
                            <div class="dice">üé≤</div>
                        </div>
                        <div id="diceResult" class="dice-result hidden">
                            <span id="diceValue" class="text-5xl font-bold text-white">20</span>
                            <div id="diceLabel" class="text-sm text-gray-400 mt-1">Rolling...</div>
                        </div>
                    </div>
                </div>
                
                <div id="outcomeDisplay" class="hidden absolute inset-0 flex items-center justify-center z-20">
                    <div class="outcome-flash bg-gray-900/95 border border-gray-700 rounded-xl p-6 text-center max-w-sm">
                        <div id="outcomeIcon" class="text-4xl mb-3">‚ö°</div>
                        <p id="outcomeText" class="text-base text-gray-300"></p>
                        <div id="outcomeStats" class="mt-3 text-sm text-gray-500"></div>
                    </div>
                </div>

                <div id="eventCard" class="event-card rounded-2xl p-5 w-full max-w-md">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-[10px] uppercase tracking-wider text-gray-500" id="eventCategory">Life Event</div>
                        <div class="text-[10px] text-gray-600" id="eventDate">Week 1, Year 1</div>
                    </div>
                    <h2 class="text-xl font-semibold text-white mb-3" id="eventTitle">The Journey Begins</h2>
                    <p class="text-gray-400 leading-relaxed mb-4 text-sm" id="eventDesc">
                        You're 18, about to graduate high school. The future stretches before you.
                    </p>
                    <div id="choicesContainer" class="space-y-2"></div>
                </div>
            </div>

            <!-- Right Panel: Log -->
            <div class="w-48 flex flex-col">
                <div class="text-[10px] uppercase text-gray-500 mb-2">Life Log</div>
                <div id="eventLog" class="flex-grow overflow-y-auto space-y-1 text-[10px] text-gray-500">
                    <div class="border-l-2 border-gray-700 pl-2">Age 18: Senior year begins...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-8 overflow-y-auto">
        <div class="text-center max-w-2xl my-8">
            <div class="text-6xl mb-4" id="endIcon">üåÖ</div>
            <h1 class="text-4xl font-bold text-white mb-2" id="endTitle">The End</h1>
            <p class="text-gray-400 mb-6" id="endDesc">Your journey has concluded.</p>
            
            <!-- Life Tier Banner -->
            <div id="lifeTierBanner" class="mb-6 py-4 px-6 rounded-xl border-2">
                <div class="text-sm uppercase tracking-widest mb-1 opacity-75" id="lifeTierLabel">Life Assessment</div>
                <div class="text-3xl font-bold" id="lifeTierTitle">--</div>
                <div class="text-sm mt-1 opacity-75" id="lifeTierSubtitle">--</div>
            </div>
            
            <!-- Obituary -->
            <div class="bg-gray-900/50 rounded-xl p-6 mb-6 text-left">
                <div class="text-center mb-4">
                    <div class="text-lg font-serif italic text-gray-300" id="obituaryHeader">In Memoriam</div>
                </div>
                <p id="obituaryText" class="text-gray-300 leading-relaxed text-center font-serif">--</p>
            </div>
            
            <!-- Stats Summary -->
            <div class="bg-gray-900/50 rounded-xl p-6 mb-6 text-left space-y-2">
                <div class="text-xs uppercase text-gray-500 mb-3">Final Statistics</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex justify-between"><span class="text-gray-500">Age:</span><span id="finalAge" class="text-white">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Career:</span><span id="finalCareer" class="text-yellow-400">--</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Net Worth:</span><span id="finalWealth" class="text-green-400">--</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Family:</span><span id="finalFamily" class="text-purple-400">--</span></div>
                </div>
                <hr class="border-gray-800 my-3">
                <div class="text-xs uppercase text-gray-500 mb-2">Legacy & Achievements</div>
                <p id="finalEpitaph" class="text-gray-300 text-sm">--</p>
            </div>
            
            <button onclick="location.reload()" class="px-8 py-3 bg-white/10 hover:bg-white/20 rounded-lg transition">
                Live Again
            </button>
        </div>
    </div>

    <script>
        // ============ CONSTANTS ============
        const WEEKS_PER_MONTH = 4;
        const MONTHS_PER_YEAR = 12;
        const WEEKS_PER_YEAR = 52;

        // Education durations in weeks
        const EDUCATION_DURATION = {
            high_school: 36, // Remaining senior year
            community_college: 104, // 2 years
            university: 208, // 4 years
            trade_school: 78, // 1.5 years
            military_training: 10, // Boot camp
            military_service: 156 // 3 year commitment after training
        };

        // ============ TRAIT DESCRIPTORS ============
        const TRAIT_DESCRIPTORS = {
            height: {
                1: "Very Short", 2: "Short", 3: "Below Average", 4: "Slightly Short",
                5: "Average", 6: "Slightly Tall", 7: "Above Average", 8: "Tall", 9: "Very Tall", 10: "Towering"
            },
            familyWealth: {
                1: "Impoverished", 2: "Poor", 3: "Working Class", 4: "Lower Middle",
                5: "Middle Class", 6: "Upper Middle", 7: "Comfortable", 8: "Wealthy", 9: "Very Wealthy", 10: "Elite"
            },
            intelligence: {
                1: "Struggling", 2: "Slow Learner", 3: "Below Average", 4: "Slightly Below",
                5: "Average", 6: "Bright", 7: "Smart", 8: "Gifted", 9: "Brilliant", 10: "Genius"
            },
            attractiveness: {
                1: "Unfortunate", 2: "Plain", 3: "Below Average", 4: "Unremarkable",
                5: "Average", 6: "Cute", 7: "Attractive", 8: "Very Attractive", 9: "Stunning", 10: "Breathtaking"
            },
            selfControl: {
                1: "Impulsive", 2: "Weak-Willed", 3: "Easily Tempted", 4: "Struggles",
                5: "Average", 6: "Disciplined", 7: "Strong-Willed", 8: "Iron Will", 9: "Monk-like", 10: "Unshakeable"
            }
        };

        // ============ GAME STATE ============
        let state = {
            // Time
            week: 1,
            totalWeeks: 0,
            
            // Character identity
            gender: null, // 'male' or 'female'
            characterTraits: {
                height: 5,           // 1-10 scale
                familyWealth: 5,     // 1-10 scale
                intelligence: 5,     // 1-10 scale
                attractiveness: 5,   // 1-10 scale (base, can be modified by fitness)
                selfControl: 5       // 1-10 scale (affects willpower/habits)
            },
            currentAttractiveness: 5, // Actual attractiveness (base + fitness bonuses)
            
            // Willpower & Habits
            willpower: 50,           // Current willpower (0-100)
            maxWillpower: 50,        // Max willpower based on traits
            habits: {},              // Active habits { habitKey: { active: true, weeksActive: 0 } }
            habitCost: 0,            // Total willpower cost of habits
            
            // Fitness/Self-improvement
            fitness: {
                gymMember: false,
                healthyEating: false,
                workoutStreak: 0,     // Consecutive weeks of working out
                fitnessLevel: 0,      // 0-20, adds to attractiveness
                routineEstablished: false // After 8 weeks, stress reduction kicks in
            },
            
            // Free time allocation (hours per week, total 20 hours)
            freeTime: {
                gym: 0,           // Requires gym membership, +attractiveness/physical
                hobbies: 0,       // -stress, +happiness, +creativity, costs $20/hr
                socialize: 0,     // +social skill, +meeting chance, -stress, costs $15/hr
                overtime: 0,      // +money, +career, +stress, -energy
                study: 0,         // +technical/skills, -energy
                rest: 0           // -stress, +energy, +health
            },
            
            // Core stats
            health: 100,
            energy: 100,
            happiness: 75,
            stress: 20,
            
            // Money (will be modified by familyWealth during character creation)
            money: 1200,
            debt: 0,
            weeklyIncome: 0,
            weeklyExpenses: 50,
            freeTimeExpenses: 0,   // Cost of free time activities
            overtimeEarnings: 0,   // Extra income from overtime
            subscriptions: {},     // Active subscriptions { gym: true, streaming: true, etc. }
            subscriptionCost: 0,   // Total weekly subscription cost
            
            // Tutorial
            tutorialComplete: false,
            
            // Life phase
            phase: 'character_creation', // character_creation, deciding, education, job_hunting, employed, retired
            phaseWeek: 0,
            phaseTarget: 0,
            
            // Education
            education: 'high_school_senior',
            educationType: null, // What they're pursuing
            educationProgress: 0,
            gpa: 3.0,
            
            // Career
            employed: false,
            job: null,
            jobTitle: '',
            salary: 0,
            performance: 50,
            weeksAtJob: 0,
            jobApplications: 0,
            interviews: 0,
            
            // Skills (0-100)
            skills: {
                technical: 10,
                social: 30,
                physical: 40,
                creativity: 20,
                fishing: 0       // Fishing mini-game skill
            },
            
            // Fishing stats
            fishing: {
                totalCatches: 0,
                bestCatch: null,
                fishingTrips: 0,
                legendsCaught: []
            },
            
            // Living situation
            home: 'parents',
            car: 'bus',
            
            // Relationships
            hasPartner: false,
            partnerName: null,
            partnerStats: null,
            relationshipWeeks: 0,
            married: false,
            
            // Flags
            achievements: [],
            traits: [],
            exhaustionCollapse: false,
            lastFamilyHelpWeek: null,
            
            // Military specific
            military: {
                rank: 0, // 0=Recruit, 1=Private, 2=PFC, 3=Specialist, 4=Corporal, 5=Sergeant
                mos: null, // Military Occupational Specialty
                squadMorale: 50,
                combatXP: 0,
                missionsCompleted: 0,
                deployed: false,
                deploymentWeek: 0,
                buddyName: null,
                buddyAlive: true,
                medals: [],
                killCount: 0,
                wounded: false
            },
            
            // University specific
            university: {
                major: null,
                majorSelected: false,
                semester: 1, // 1-8 semesters
                professorMentor: null,
                professorRelationship: 0, // 0-100
                club: null,
                clubWeeks: 0,
                studyBuddy: null,
                studyBuddyRelationship: 0,
                internshipCompleted: false,
                onProbation: false,
                honorsList: false,
                studyAbroadDone: false,
                thesisStarted: false,
                thesisProgress: 0,
                partiesAttended: 0,
                allNighters: 0,
                droppedClasses: 0
            },
            
            // Trade school specific
            tradeSchool: {
                trade: null, // electrician, plumber, hvac, welder, mechanic
                certLevel: 0, // 0=Student, 1=Apprentice, 2=Journeyman, 3=Master
                hoursLogged: 0,
                projectsCompleted: 0,
                safetyIncidents: 0,
                mentorName: null,
                mentorRelationship: 0,
                unionMember: false,
                toolQuality: 1, // 1-3 (basic, professional, premium)
                clientRating: 50, // 0-100
                injuries: 0
            },
            
            // Employment specific
            career: {
                coworkerAlly: null,
                coworkerRival: null,
                bossRelationship: 50,
                projectActive: false,
                projectWeek: 0,
                projectSuccess: 0,
                promotionsDenied: 0,
                companiesWorked: 0,
                networkContacts: 0,
                sideHustle: null,
                businessOwner: false
            },
            
            // Relationship specific
            relationship: {
                datesCount: 0,
                arguments: 0,
                lastDateWeek: 0,
                metFamily: false,
                familyApproval: 50,
                livingTogether: false,
                children: 0,
                childrenAges: [],
                weddingSize: null, // small, medium, large
                anniversaries: 0
            },
            
            // Financial specific
            finances: {
                investments: 0,
                investmentType: null, // conservative, moderate, aggressive
                homeOwned: false,
                homeValue: 0,
                mortgage: 0,
                carOwned: null,
                carValue: 0,
                carPayment: 0,
                creditScore: 650,
                emergencyFund: 0,
                retirementAccount: 0,
                // Credit card
                hasCreditCard: false,
                creditLimit: 0,
                creditBalance: 0,
                creditAPR: 0, // Annual percentage rate
                minPaymentDue: 0,
                missedPayments: 0
            },
            
            // Weekly Balance tracking
            neglect: {
                work: 0,      // Weeks neglecting work
                health: 0,    // Weeks neglecting health
                relationship: 0, // Weeks neglecting partner
                growth: 0,    // Weeks neglecting skills
                fun: 0        // Weeks without fun/relaxation
            },
            
            // Meta
            eventQueue: [],
            usedEvents: new Set()
        };

        // ============ MILITARY SYSTEM ============
        const RANKS = [
            { name: "Recruit", abbr: "RCT", pay: 350 },
            { name: "Private", abbr: "PVT", pay: 400 },
            { name: "Private First Class", abbr: "PFC", pay: 450 },
            { name: "Specialist", abbr: "SPC", pay: 500 },
            { name: "Corporal", abbr: "CPL", pay: 550 },
            { name: "Sergeant", abbr: "SGT", pay: 650 }
        ];

        const MOS_OPTIONS = {
            infantry: { name: "Infantry (11B)", icon: "‚öîÔ∏è", desc: "Front-line combat", statBonus: "physical", combatChance: 0.7, reqPhysical: 45, reqIntel: 0 },
            medic: { name: "Combat Medic (68W)", icon: "üè•", desc: "Save lives under fire", statBonus: "technical", combatChance: 0.5, reqPhysical: 35, reqIntel: 6 },
            engineer: { name: "Combat Engineer (12B)", icon: "üí£", desc: "Demolitions & construction", statBonus: "technical", combatChance: 0.4, reqPhysical: 40, reqIntel: 5 },
            intel: { name: "Intelligence (35F)", icon: "üîç", desc: "Information warfare", statBonus: "technical", combatChance: 0.2, reqPhysical: 25, reqIntel: 7 },
            logistics: { name: "Logistics (92A)", icon: "üì¶", desc: "Supply & support", statBonus: "social", combatChance: 0.15, reqPhysical: 25, reqIntel: 4 },
            armor: { name: "Armor Crewman (19K)", icon: "üõ°Ô∏è", desc: "Tank operations", statBonus: "technical", combatChance: 0.5, reqPhysical: 35, reqIntel: 5, reqHeight: { max: 8 } },
            special_ops: { name: "Special Forces (18X)", icon: "ü¶Ö", desc: "Elite operations", statBonus: "physical", combatChance: 0.8, reqPhysical: 65, reqIntel: 6 }
        };

        const BUDDY_NAMES = ["Rodriguez", "Murphy", "Jackson", "Williams", "Davis", "Miller", "Wilson", "Thompson", "Garcia", "Martinez"];

        // ============ UNIVERSITY SYSTEM ============
        const MAJORS = {
            stem: { name: "Computer Science", icon: "üíª", desc: "Tech & programming", statBonus: "technical", jobBonus: ["software_dev", "senior_dev", "it_support"], socialPenalty: -5 },
            business: { name: "Business Admin", icon: "üìä", desc: "Management & finance", statBonus: "social", jobBonus: ["junior_analyst", "senior_analyst", "marketing", "manager"], socialPenalty: 0 },
            premed: { name: "Pre-Med Biology", icon: "üî¨", desc: "Path to medicine", statBonus: "technical", jobBonus: ["dental_hygienist"], socialPenalty: -3, stressBonus: 10 },
            arts: { name: "Fine Arts", icon: "üé®", desc: "Creative expression", statBonus: "creativity", jobBonus: ["marketing"], socialPenalty: 5, moneyPenalty: true },
            engineering: { name: "Engineering", icon: "‚öôÔ∏è", desc: "Build the future", statBonus: "technical", jobBonus: ["software_dev", "senior_dev"], socialPenalty: -5, stressBonus: 5 },
            communications: { name: "Communications", icon: "üì£", desc: "Media & PR", statBonus: "social", jobBonus: ["marketing", "admin_assistant"], socialPenalty: 10 }
        };

        const PROFESSOR_TYPES = [
            { name: "Dr. Chen", personality: "demanding", field: "stem", bonus: { technical: 5, stress: 10 } },
            { name: "Prof. Williams", personality: "nurturing", field: "arts", bonus: { creativity: 5, happiness: 5 } },
            { name: "Dr. Reeves", personality: "connected", field: "business", bonus: { social: 5 } },
            { name: "Prof. Martinez", personality: "brilliant", field: "premed", bonus: { technical: 8, stress: 15 } },
            { name: "Dr. Thompson", personality: "inspiring", field: "engineering", bonus: { technical: 5, creativity: 3 } },
            { name: "Prof. Anderson", personality: "charismatic", field: "communications", bonus: { social: 8 } }
        ];

        const CLUBS = {
            greek: { name: "Greek Life (Fraternity/Sorority)", icon: "üèõÔ∏è", cost: 200, social: 15, happiness: 10, gpaRisk: -0.2, networkBonus: 20 },
            sports: { name: "Intramural Sports", icon: "üèÄ", cost: 50, physical: 10, social: 5, happiness: 8, energy: -10 },
            academic: { name: "Honor Society", icon: "üéì", cost: 25, technical: 5, gpaBonus: 0.1, social: -5 },
            volunteer: { name: "Community Service", icon: "ü§ù", cost: 0, social: 10, happiness: 10, resumeBonus: true },
            arts_club: { name: "Arts & Theater", icon: "üé≠", cost: 30, creativity: 10, social: 5, happiness: 5 },
            debate: { name: "Debate Team", icon: "üé§", cost: 25, social: 8, technical: 3, confidence: 10 }
        };

        const STUDY_BUDDY_NAMES = ["Alex", "Jamie", "Chris", "Morgan", "Taylor", "Jordan", "Casey", "Riley"];

        // ============ TRADE SCHOOL SYSTEM ============
        const TRADES = {
            electrician: { name: "Electrician", icon: "‚ö°", desc: "Power systems & wiring", statBonus: "technical", dangerLevel: 3, baseHourlyPay: 18 },
            plumber: { name: "Plumber", icon: "üîß", desc: "Pipes & water systems", statBonus: "technical", dangerLevel: 2, baseHourlyPay: 17 },
            hvac: { name: "HVAC Technician", icon: "‚ùÑÔ∏è", desc: "Heating & cooling", statBonus: "technical", dangerLevel: 2, baseHourlyPay: 19 },
            welder: { name: "Welder", icon: "üî•", desc: "Metal fabrication", statBonus: "technical", dangerLevel: 4, baseHourlyPay: 20 },
            carpenter: { name: "Carpenter", icon: "ü™ö", desc: "Woodwork & framing", statBonus: "physical", dangerLevel: 2, baseHourlyPay: 16 },
            mechanic: { name: "Auto Mechanic", icon: "üöó", desc: "Vehicle repair", statBonus: "technical", dangerLevel: 2, baseHourlyPay: 17 }
        };

        const TRADE_CERT_LEVELS = [
            { name: "Student", abbr: "STU", hourlyMultiplier: 0.5 },
            { name: "Apprentice", abbr: "APP", hourlyMultiplier: 0.75 },
            { name: "Journeyman", abbr: "JRN", hourlyMultiplier: 1.0 },
            { name: "Master", abbr: "MST", hourlyMultiplier: 1.5 }
        ];

        const TRADE_MENTOR_NAMES = ["Big Mike", "Old Joe", "Dave", "Tony", "Frank", "Carlos", "Steve", "Rick"];

        const TRADE_CLIENT_TYPES = [
            { type: "Residential", difficulty: 10, pay: 1.0, stressBonus: 0 },
            { type: "Commercial", difficulty: 13, pay: 1.3, stressBonus: 5 },
            { type: "Industrial", difficulty: 16, pay: 1.6, stressBonus: 10 },
            { type: "Emergency", difficulty: 12, pay: 2.0, stressBonus: 15 }
        ];

        // ============ EMPLOYMENT/CAREER SYSTEM ============
        const COWORKER_NAMES = ["Sarah", "Mike", "Jennifer", "David", "Lisa", "Kevin", "Amanda", "Brian", "Nicole", "Jason"];
        
        const BOSS_TYPES = [
            { name: "micromanager", trait: "Watches everything", stressBonus: 10, promotionChance: 0.8 },
            { name: "hands-off", trait: "Never around", stressBonus: -5, promotionChance: 0.6 },
            { name: "mentor", trait: "Supportive guide", stressBonus: 0, promotionChance: 1.0 },
            { name: "climber", trait: "Political player", stressBonus: 5, promotionChance: 1.2 },
            { name: "old-school", trait: "By the book", stressBonus: 5, promotionChance: 0.7 }
        ];

        const JOB_CATEGORIES = {
            retail: { jobs: ['fast_food', 'retail', 'server'], projects: ['inventory', 'holiday_rush', 'customer_complaint'], culture: 'fast-paced' },
            office: { jobs: ['admin_assistant', 'junior_analyst', 'accountant', 'marketing', 'senior_analyst', 'manager'], projects: ['quarterly_report', 'audit', 'presentation'], culture: 'corporate' },
            tech: { jobs: ['it_support', 'software_dev', 'senior_dev'], projects: ['product_launch', 'bug_crisis', 'system_migration'], culture: 'startup' },
            trades: { jobs: ['electrician_apprentice', 'plumber_apprentice', 'mechanic', 'master_electrician'], projects: ['big_contract', 'inspection', 'emergency_call'], culture: 'blue-collar' },
            healthcare: { jobs: ['dental_hygienist'], projects: ['difficult_patient', 'compliance_audit', 'equipment_upgrade'], culture: 'clinical' }
        };

        const PROJECT_TYPES = {
            quarterly_report: { name: "Quarterly Report", duration: 4, difficulty: 12, reward: 0.2, failure: 'warning' },
            audit: { name: "Company Audit", duration: 3, difficulty: 14, reward: 0.15, failure: 'stress' },
            presentation: { name: "Big Presentation", duration: 2, difficulty: 13, reward: 0.25, failure: 'reputation' },
            product_launch: { name: "Product Launch", duration: 6, difficulty: 15, reward: 0.4, failure: 'blame' },
            bug_crisis: { name: "Critical Bug Fix", duration: 1, difficulty: 16, reward: 0.3, failure: 'blame' },
            system_migration: { name: "System Migration", duration: 8, difficulty: 14, reward: 0.35, failure: 'overtime' },
            inventory: { name: "Inventory Count", duration: 2, difficulty: 10, reward: 0.1, failure: 'warning' },
            holiday_rush: { name: "Holiday Season", duration: 6, difficulty: 11, reward: 0.2, failure: 'exhaustion' },
            customer_complaint: { name: "Customer Escalation", duration: 1, difficulty: 12, reward: 0.15, failure: 'stress' }
        };

        const SIDE_HUSTLES = {
            freelance: { name: "Freelancing", icon: "üíª", income: 200, timeReq: 15, skillReq: 'technical', minSkill: 40 },
            rideshare: { name: "Rideshare Driver", icon: "üöó", income: 150, timeReq: 20, skillReq: null, minSkill: 0 },
            tutoring: { name: "Tutoring", icon: "üìö", income: 175, timeReq: 10, skillReq: 'technical', minSkill: 50 },
            ecommerce: { name: "Online Store", icon: "üì¶", income: 100, timeReq: 8, skillReq: 'social', minSkill: 30, variance: 150 },
            content: { name: "Content Creation", icon: "üì±", income: 50, timeReq: 12, skillReq: 'creativity', minSkill: 40, variance: 300 }
        };

        // ============ RELATIONSHIP SYSTEM ============
        const DATE_ACTIVITIES = {
            dinner: { name: "Nice Dinner", icon: "üçΩÔ∏è", cost: 80, bondGain: 8, happinessGain: 10, dc: 10 },
            movie: { name: "Movie Night", icon: "üé¨", cost: 40, bondGain: 5, happinessGain: 6, dc: 8 },
            adventure: { name: "Adventure Date", icon: "üé¢", cost: 100, bondGain: 12, happinessGain: 15, dc: 12 },
            cooking: { name: "Cook Together", icon: "üë®‚Äçüç≥", cost: 30, bondGain: 10, happinessGain: 8, dc: 11 },
            concert: { name: "Concert/Show", icon: "üéµ", cost: 120, bondGain: 15, happinessGain: 18, dc: 10 },
            staycation: { name: "Weekend Getaway", icon: "üèñÔ∏è", cost: 300, bondGain: 25, happinessGain: 25, dc: 10 },
            simple: { name: "Walk in the Park", icon: "üå≥", cost: 0, bondGain: 4, happinessGain: 5, dc: 8 }
        };

        const RELATIONSHIP_CRISES = [
            { name: "Trust Issues", desc: "They found old texts on your phone. Nothing happened, but...", dc: 14, bondLoss: 15 },
            { name: "Growing Apart", desc: "You've both been so busy. When did you last really talk?", dc: 12, bondLoss: 10 },
            { name: "Family Conflict", desc: "Your families don't get along. It's becoming a problem.", dc: 13, bondLoss: 12 },
            { name: "Future Disagreement", desc: "You want different things. Kids? Location? Career vs family?", dc: 15, bondLoss: 20 },
            { name: "Money Stress", desc: "Financial pressure is straining the relationship.", dc: 11, bondLoss: 8 }
        ];

        const CHILD_NAMES = ["Emma", "Liam", "Olivia", "Noah", "Ava", "Oliver", "Sophia", "Elijah", "Isabella", "Lucas"];
        
        const PARENTING_EVENTS = [
            { age: 0, title: "Sleepless Nights", desc: "The baby won't stop crying. Neither of you has slept.", energy: -30, stress: 20, happiness: -5, bond: 5 },
            { age: 1, title: "First Steps", desc: "They took their first steps today!", energy: 0, stress: -10, happiness: 25, bond: 10 },
            { age: 2, title: "Terrible Twos", desc: "Tantrums. So many tantrums.", energy: -20, stress: 15, happiness: -5, bond: 0 },
            { age: 5, title: "First Day of School", desc: "They look so small with that big backpack.", energy: 10, stress: -5, happiness: 15, bond: 5 },
            { age: 10, title: "Growing Up Fast", desc: "They're developing their own personality. Where did the time go?", energy: 0, stress: 5, happiness: 10, bond: 5 },
            { age: 13, title: "Teenage Rebellion", desc: "Door slamming. Eye rolling. \"You don't understand!\"", energy: -15, stress: 20, happiness: -10, bond: -5 },
            { age: 16, title: "Learning to Drive", desc: "White-knuckle grip on the door handle. They're doing fine.", energy: -10, stress: 15, happiness: 5, bond: 5 },
            { age: 18, title: "Graduation Day", desc: "They did it. They're ready for the world. You're not ready to let go.", energy: 0, stress: -10, happiness: 30, bond: 10 }
        ];

        // ============ RANDOM LIFE EVENTS SYSTEM ============
        const CRISIS_EVENTS = [
            { 
                type: "car_accident",
                title: "Car Accident",
                desc: "Screeching tires. Impact. Your car is totaled.",
                condition: () => state.car !== 'walk' && state.car !== 'bus',
                dc: 13,
                successOutcome: { health: -5, stress: 15, money: -500, text: "Minor accident. You're shaken but okay. Deductible hurts." },
                failOutcome: { health: -25, stress: 30, money: -2000, text: "Serious accident. Hospital bills, no car." },
                critFailOutcome: { health: -40, stress: 40, money: -5000, text: "ICU. Months of recovery. Life-changing." }
            },
            {
                type: "medical_emergency",
                title: "Medical Emergency",
                desc: "Sharp pain. Something's very wrong. You need help NOW.",
                condition: () => true,
                dc: 0,
                successOutcome: { health: -10, stress: 20, money: -800, text: "ER visit. Expensive but caught early. You'll be fine." },
                failOutcome: { health: -20, stress: 30, money: -3000, text: "Surgery required. Recovery will take time." },
                critFailOutcome: { health: -35, stress: 45, money: -10000, text: "Major procedure. Bills are devastating." }
            },
            {
                type: "theft",
                title: "Robbed!",
                desc: "You come home to an open door. Someone's been here.",
                condition: () => state.home !== 'parents',
                dc: 0,
                successOutcome: { happiness: -10, stress: 20, money: -500, text: "Some valuables gone. Police can't help. Violation feeling." },
                failOutcome: { happiness: -15, stress: 25, money: -1500, text: "They took everything of value. Insurance doesn't cover half." },
                critFailOutcome: { happiness: -25, stress: 35, money: -3000, text: "Total loss. Some things had sentimental value. Gone forever." }
            },
            {
                type: "lawsuit",
                title: "Legal Trouble",
                desc: "Official letter. Someone is suing you.",
                condition: () => state.employed || state.finances.homeOwned,
                dc: 14,
                successOutcome: { stress: 25, money: -1000, text: "Lawyer helped settle it. Expensive lesson." },
                failOutcome: { stress: 35, money: -5000, text: "Lost the case. Damages and legal fees pile up." },
                critFailOutcome: { stress: 50, money: -15000, happiness: -20, text: "Devastating judgment. Financial ruin looms." }
            },
            {
                type: "natural_disaster",
                title: "Natural Disaster",
                desc: "Storm, flood, fire ‚Äî nature doesn't care about your plans.",
                condition: () => state.home !== 'parents',
                dc: 0,
                successOutcome: { stress: 20, money: -1000, happiness: -10, text: "Minor damage. Insurance covers most of it." },
                failOutcome: { stress: 30, money: -5000, happiness: -20, text: "Major damage. Displaced for weeks." },
                critFailOutcome: { stress: 45, money: -20000, happiness: -30, text: "Total loss. Starting over from nothing." }
            }
        ];

        const WINDFALL_EVENTS = [
            {
                title: "Inheritance",
                desc: "A distant relative you barely knew passed away. They left you something.",
                minAmount: 5000,
                maxAmount: 50000,
                condition: () => getAge() >= 25,
                rarity: 0.02
            },
            {
                title: "Lottery Win",
                desc: "You bought a scratch-off on a whim. Wait... is that...?",
                minAmount: 100,
                maxAmount: 10000,
                condition: () => true,
                rarity: 0.01
            },
            {
                title: "Tax Refund Surprise",
                desc: "The accountant found deductions you missed. Big refund incoming.",
                minAmount: 500,
                maxAmount: 3000,
                condition: () => state.employed,
                rarity: 0.03
            },
            {
                title: "Investment Payout",
                desc: "That stock tip from years ago? It finally paid off.",
                minAmount: 1000,
                maxAmount: 20000,
                condition: () => state.finances.investments > 0,
                rarity: 0.02
            },
            {
                title: "Class Action Settlement",
                desc: "Remember that sketchy product? There was a lawsuit. You're getting a check.",
                minAmount: 200,
                maxAmount: 2000,
                condition: () => true,
                rarity: 0.02
            },
            {
                title: "Found Money",
                desc: "Cleaning out old boxes... wait, is that cash? Is that a LOT of cash?",
                minAmount: 100,
                maxAmount: 1000,
                condition: () => true,
                rarity: 0.01
            }
        ];

        const FAMILY_EVENTS = [
            {
                title: "Parent Health Scare",
                desc: "Mom/Dad is in the hospital. Doctor says it's serious.",
                condition: () => getAge() >= 30,
                effects: { stress: 25, happiness: -15, money: -500 },
                choices: true
            },
            {
                title: "Sibling Wedding",
                desc: "Your brother/sister is getting married! You're in the wedding party.",
                condition: () => getAge() >= 22,
                effects: { happiness: 15, money: -800, stress: 10 },
                choices: false
            },
            {
                title: "Family Reunion",
                desc: "The whole extended family is gathering. Aunts, uncles, cousins, drama.",
                condition: () => true,
                effects: { stress: 10, happiness: 5, social: 3 },
                choices: false
            },
            {
                title: "Niece/Nephew Born",
                desc: "Your sibling had a baby! You're an aunt/uncle now.",
                condition: () => getAge() >= 25,
                effects: { happiness: 15 },
                choices: false
            },
            {
                title: "Parent Needs Help",
                desc: "Your parents are getting older. They need help around the house... or more.",
                condition: () => getAge() >= 35,
                effects: { stress: 15, money: -200, happiness: -5 },
                choices: true
            },
            {
                title: "Family Falling Out",
                desc: "Big argument at a family gathering. Things were said. Sides taken.",
                condition: () => true,
                effects: { stress: 20, happiness: -15 },
                choices: false
            }
        ];

        // ============ FINANCIAL SYSTEM ============
        const INVESTMENT_TYPES = {
            conservative: { name: "Conservative (Bonds/Index)", icon: "üìä", weeklyReturn: 0.001, risk: 0.05, minLoss: -0.02, maxGain: 0.015 },
            moderate: { name: "Moderate (Balanced)", icon: "üìà", weeklyReturn: 0.002, risk: 0.15, minLoss: -0.05, maxGain: 0.04 },
            aggressive: { name: "Aggressive (Growth)", icon: "üöÄ", weeklyReturn: 0.003, risk: 0.25, minLoss: -0.15, maxGain: 0.1 },
            crypto: { name: "Cryptocurrency", icon: "‚Çø", weeklyReturn: 0.005, risk: 0.4, minLoss: -0.3, maxGain: 0.25 }
        };

        const HOMES_FOR_SALE = {
            starter: { name: "Starter Home", icon: "üè†", price: 150000, downPayment: 30000, mortgage: 800, equity: 0.3, happiness: 15 },
            family: { name: "Family Home", icon: "üè°", price: 300000, downPayment: 60000, mortgage: 1500, equity: 0.35, happiness: 25 },
            luxury: { name: "Luxury Home", icon: "üè∞", price: 600000, downPayment: 120000, mortgage: 3000, equity: 0.4, happiness: 40 }
        };

        const CARS_FOR_SALE = {
            used_economy: { name: "Used Economy Car", icon: "üöó", price: 8000, loan: 200, maintenance: 30, reliability: 0.9 },
            used_suv: { name: "Used SUV", icon: "üöô", price: 15000, loan: 350, maintenance: 40, reliability: 0.85 },
            new_sedan: { name: "New Sedan", icon: "üöò", price: 30000, loan: 500, maintenance: 25, reliability: 0.98 },
            new_suv: { name: "New SUV", icon: "üöê", price: 45000, loan: 750, maintenance: 30, reliability: 0.98 },
            sports: { name: "Sports Car", icon: "üèéÔ∏è", price: 60000, loan: 1000, maintenance: 50, reliability: 0.95 }
        };

        const CREDIT_SCORE_FACTORS = {
            excellent: { min: 750, loanMultiplier: 0.9, approvalBonus: 20 },
            good: { min: 700, loanMultiplier: 1.0, approvalBonus: 10 },
            fair: { min: 650, loanMultiplier: 1.1, approvalBonus: 0 },
            poor: { min: 0, loanMultiplier: 1.3, approvalBonus: -20 }
        };

        function getCreditTier() {
            if (state.finances.creditScore >= 750) return CREDIT_SCORE_FACTORS.excellent;
            if (state.finances.creditScore >= 700) return CREDIT_SCORE_FACTORS.good;
            if (state.finances.creditScore >= 650) return CREDIT_SCORE_FACTORS.fair;
            return CREDIT_SCORE_FACTORS.poor;
        }

        // Neglect thresholds - consecutive weeks of neglect before consequences
        const NEGLECT_THRESHOLDS = {
            work: { weeks: 4, consequence: "Performance review warning" },
            health: { weeks: 6, consequence: "Health issues emerge" },
            relationship: { weeks: 5, consequence: "Partner feels neglected" },
            growth: { weeks: 8, consequence: "Feeling stagnant" },
            fun: { weeks: 6, consequence: "Burnout risk" }
        };

        function getNeglectWarningEvent() {
            // Check each neglect area and return warning event if threshold exceeded
            
            if (state.neglect.work >= NEGLECT_THRESHOLDS.work.weeks && state.employed) {
                return {
                    category: "‚ö†Ô∏è Warning",
                    title: "Performance Slipping",
                    desc: `You've been coasting at work for ${state.neglect.work} weeks. Your boss has noticed.`,
                    choices: [
                        {
                            text: "Promise to do better [Reset neglect, +20 Stress]",
                            effect: () => {
                                state.neglect.work = 0;
                                state.stress += 20;
                                state.performance = Math.max(20, state.performance - 10);
                                return { icon: "üò∞", text: "You smooth things over, but the pressure is on.", stats: "-10 Performance, +20 Stress" };
                            }
                        },
                        {
                            text: "Blame external factors [50% chance they buy it]",
                            effect: () => {
                                if (Math.random() > 0.5) {
                                    state.neglect.work = Math.floor(state.neglect.work / 2);
                                    return { icon: "ü§∑", text: "They bought your excuse. For now.", stats: "Partial neglect reset" };
                                }
                                state.performance -= 20;
                                state.career.bossRelationship -= 15;
                                state.neglect.work = 0;
                                return { icon: "üò¨", text: "They didn't buy it. You're on thin ice.", stats: "-20 Performance, -15 Boss relationship" };
                            }
                        },
                        {
                            text: "Accept the consequences",
                            effect: () => {
                                state.performance -= 15;
                                state.neglect.work = 0;
                                if (state.performance < 20) {
                                    state.employed = false;
                                    state.job = null;
                                    state.phase = 'job_hunting';
                                    addLog("Fired for poor performance");
                                    return { icon: "üì¶", text: "You're let go. Time to find something new.", stats: "Fired!" };
                                }
                                return { icon: "üìâ", text: "Formal warning on your record.", stats: "-15 Performance" };
                            }
                        }
                    ]
                };
            }
            
            if (state.neglect.health >= NEGLECT_THRESHOLDS.health.weeks) {
                return {
                    category: "‚ö†Ô∏è Health Warning",
                    title: "Body Breaking Down",
                    desc: `You've ignored your health for ${state.neglect.health} weeks. Your body is rebelling.`,
                    choices: [
                        {
                            text: "See a doctor [-$200, Prevent worse]",
                            condition: () => state.money >= 200,
                            effect: () => {
                                state.money -= 200;
                                state.health -= 10;
                                state.neglect.health = 0;
                                return { icon: "üè•", text: "Doctor says you caught it early. Rest and lifestyle changes needed.", stats: "-$200, -10 Health, Neglect reset" };
                            }
                        },
                        {
                            text: "Push through [-25 Health, Keep going]",
                            effect: () => {
                                state.health -= 25;
                                state.energy -= 20;
                                state.neglect.health = Math.floor(state.neglect.health / 2);
                                if (state.health <= 20) {
                                    state.stress += 30;
                                    return { icon: "üö®", text: "Collapse imminent. You need to change NOW.", stats: "-25 Health, -20 Energy, Critical!" };
                                }
                                return { icon: "üò§", text: "You ignore the warning signs. For now.", stats: "-25 Health, -20 Energy" };
                            }
                        },
                        {
                            text: "Take a week off [Miss work, Full recovery]",
                            effect: () => {
                                state.health = Math.min(100, state.health + 20);
                                state.energy = Math.min(100, state.energy + 30);
                                state.neglect.health = 0;
                                if (state.employed) state.performance -= 10;
                                return { icon: "üõèÔ∏è", text: "Rest. Real rest. Your body thanks you.", stats: "+20 Health, +30 Energy, -10 Perf" };
                            }
                        }
                    ]
                };
            }
            
            if (state.neglect.relationship >= NEGLECT_THRESHOLDS.relationship.weeks && state.hasPartner) {
                return {
                    category: "üíî Relationship Warning",
                    title: `${state.partnerName} Feels Neglected`,
                    desc: `You haven't prioritized the relationship in ${state.neglect.relationship} weeks. ${state.partnerName} is pulling away.`,
                    choices: [
                        {
                            text: "Plan a special date [-$150, Show you care]",
                            condition: () => state.money >= 150,
                            effect: () => {
                                state.money -= 150;
                                state.partnerStats.supportiveness += 15;
                                state.neglect.relationship = 0;
                                state.happiness += 10;
                                return { icon: "üíï", text: `${state.partnerName} is touched by the effort. "I needed this."`, stats: "-$150, +15 Bond, +10 Happy" };
                            }
                        },
                        {
                            text: "Have an honest conversation [Risky but free]",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 12);
                                state.neglect.relationship = 0;
                                
                                if (check.success) {
                                    state.partnerStats.supportiveness += 10;
                                    return { icon: "ü§ù", text: `[Rolled ${check.total}] You talked it out. Understanding reached.`, stats: "+10 Bond" };
                                }
                                state.partnerStats.supportiveness -= 10;
                                state.stress += 15;
                                return { icon: "üò¢", text: `[Rolled ${check.total}] It turned into an argument. Tension remains.`, stats: "-10 Bond, +15 Stress" };
                            }
                        },
                        {
                            text: "Promise to change [Buys time but...]",
                            effect: () => {
                                state.neglect.relationship = 2; // Partial reset
                                state.partnerStats.supportiveness -= 5;
                                return { icon: "ü§û", text: `"I'll do better." ${state.partnerName} has heard this before.`, stats: "-5 Bond, Partial reset" };
                            }
                        },
                        {
                            text: "Maybe we need space...",
                            effect: () => {
                                if (state.partnerStats.supportiveness < 40) {
                                    state.hasPartner = false;
                                    state.partnerName = null;
                                    state.happiness -= 25;
                                    addLog("Relationship ended");
                                    return { icon: "üíî", text: "It's over. They agree. Maybe it's for the best?", stats: "-25 Happiness, Relationship ended" };
                                }
                                state.partnerStats.supportiveness -= 20;
                                state.neglect.relationship = 0;
                                return { icon: "üòî", text: `${state.partnerName} is hurt but gives you space.`, stats: "-20 Bond" };
                            }
                        }
                    ]
                };
            }
            
            if (state.neglect.fun >= NEGLECT_THRESHOLDS.fun.weeks) {
                return {
                    category: "‚ö†Ô∏è Burnout Warning",
                    title: "All Work, No Play",
                    desc: `${state.neglect.fun} weeks without real relaxation. You're burning out.`,
                    choices: [
                        {
                            text: "Take a mental health day [+Energy, -Performance]",
                            effect: () => {
                                state.energy += 25;
                                state.happiness += 15;
                                state.stress -= 20;
                                state.neglect.fun = 0;
                                if (state.employed) state.performance -= 5;
                                return { icon: "üå¥", text: "You called in. Guilt-free rest. Needed this.", stats: "+25 Energy, +15 Happy, -20 Stress" };
                            }
                        },
                        {
                            text: "Small treat [-$50, Partial relief]",
                            condition: () => state.money >= 50,
                            effect: () => {
                                state.money -= 50;
                                state.happiness += 8;
                                state.stress -= 10;
                                state.neglect.fun = Math.floor(state.neglect.fun / 2);
                                return { icon: "üéÅ", text: "A small indulgence. Helps a little.", stats: "-$50, +8 Happy, -10 Stress" };
                            }
                        },
                        {
                            text: "Keep grinding [Risk serious burnout]",
                            effect: () => {
                                state.neglect.fun += 2;
                                state.stress += 15;
                                state.happiness -= 10;
                                if (state.stress > 80) {
                                    state.health -= 15;
                                    return { icon: "üî•", text: "Pushing through... but at what cost?", stats: "+15 Stress, -10 Happy, -15 Health (burnout)" };
                                }
                                return { icon: "üò§", text: "No time for fun. Back to the grind.", stats: "+15 Stress, -10 Happy" };
                            }
                        }
                    ]
                };
            }
            
            return null;
        }

        // Store last roll for display
        let lastRollData = null;

        function rollD20() {
            return Math.floor(Math.random() * 20) + 1;
        }

        function rollWithModifier(baseStat, difficulty, context = {}) {
            let roll = rollD20();
            
            // Base modifier from stat
            let statModifier = Math.floor((baseStat - 50) / 10);
            
            // Stress penalty (high stress impairs performance)
            let stressPenalty = 0;
            if (state.stress >= 80) stressPenalty = -4;       // Severe: barely functioning
            else if (state.stress >= 60) stressPenalty = -2;  // High: noticeably impaired
            else if (state.stress >= 40) stressPenalty = -1;  // Moderate: slightly off
            // Low stress = no penalty
            
            // Energy penalty (exhaustion hurts)
            let energyPenalty = 0;
            if (state.energy <= 20) energyPenalty = -2;
            else if (state.energy <= 40) energyPenalty = -1;
            
            // Combine all modifiers
            let totalModifier = statModifier + stressPenalty + energyPenalty;
            let total = roll + totalModifier;
            
            let result = { 
                roll, 
                modifier: totalModifier,
                statMod: statModifier,
                stressMod: stressPenalty,
                energyMod: energyPenalty,
                total, 
                success: total >= difficulty, 
                nat20: roll === 20, 
                nat1: roll === 1, 
                dc: difficulty,
                context: context
            };
            lastRollData = result; // Store for animation
            return result;
        }
        
        function buildModifierBreakdown(rollData) {
            let parts = [];
            
            // Start with the roll
            parts.push(`<span class="text-white font-mono">${rollData.roll}</span>`);
            
            // Stat modifier
            if (rollData.statMod !== 0) {
                let color = rollData.statMod > 0 ? 'text-cyan-400' : 'text-orange-400';
                let sign = rollData.statMod > 0 ? '+' : '';
                parts.push(`<span class="${color}">${sign}${rollData.statMod} skill</span>`);
            }
            
            // Stress penalty
            if (rollData.stressMod && rollData.stressMod !== 0) {
                parts.push(`<span class="text-purple-400">${rollData.stressMod} stress</span>`);
            }
            
            // Energy penalty
            if (rollData.energyMod && rollData.energyMod !== 0) {
                parts.push(`<span class="text-yellow-600">${rollData.energyMod} fatigue</span>`);
            }
            
            // Build the breakdown string
            let breakdown = `<div class="text-gray-300 mt-1">`;
            breakdown += parts.join(' <span class="text-gray-500">‚Üí</span> ');
            breakdown += ` <span class="text-gray-500">=</span> <span class="font-bold text-white">${rollData.total}</span>`;
            breakdown += `</div>`;
            
            // Target DC
            breakdown += `<div class="text-gray-400">Need: <span class="font-bold">${rollData.dc}</span>`;
            let margin = rollData.total - rollData.dc;
            if (!rollData.nat1 && !rollData.nat20) {
                if (margin >= 0) {
                    breakdown += ` <span class="text-green-400">(+${margin})</span>`;
                } else {
                    breakdown += ` <span class="text-red-400">(${margin})</span>`;
                }
            }
            breakdown += `</div>`;
            
            return breakdown;
        }
        
        function showDiceRoll(rollData) {
            return new Promise((resolve) => {
                let diceDisplay = document.getElementById('diceDisplay');
                let diceRoller = document.getElementById('diceRoller');
                let diceResult = document.getElementById('diceResult');
                let diceValue = document.getElementById('diceValue');
                let diceLabel = document.getElementById('diceLabel');
                
                // Reset and show
                diceRoller.innerHTML = '<div class="dice">üé≤</div>';
                diceResult.classList.add('hidden');
                diceDisplay.classList.remove('hidden');
                
                // Animate through random numbers (SLOWER)
                let animDuration = 1200; // Slower roll
                let startTime = Date.now();
                let animInterval = setInterval(() => {
                    let elapsed = Date.now() - startTime;
                    if (elapsed < animDuration) {
                        let randomNum = Math.floor(Math.random() * 20) + 1;
                        // Slow down animation as it progresses
                        diceRoller.innerHTML = `<div class="dice" style="animation: none; font-size: 3rem;">${randomNum}</div>`;
                    }
                }, 80); // Slower interval
                
                // Show final result
                setTimeout(() => {
                    clearInterval(animInterval);
                    diceRoller.classList.add('hidden');
                    diceResult.classList.remove('hidden');
                    
                    // Set the value and styling
                    diceValue.innerText = rollData.roll;
                    diceValue.className = 'text-5xl font-bold';
                    
                    // Build detailed modifier breakdown
                    let modBreakdown = buildModifierBreakdown(rollData);
                    
                    if (rollData.nat20) {
                        diceValue.classList.add('dice-nat20');
                        diceLabel.innerHTML = `<div class="text-lg font-bold">‚ú® NATURAL 20! ‚ú®</div>${modBreakdown}<div class="text-yellow-400 font-bold mt-1">AUTO SUCCESS!</div>`;
                        diceLabel.className = 'text-sm mt-2';
                    } else if (rollData.nat1) {
                        diceValue.classList.add('dice-nat1');
                        diceLabel.innerHTML = `<div class="text-lg font-bold">üíÄ CRITICAL FAIL!</div>${modBreakdown}<div class="text-red-400 font-bold mt-1">AUTO FAIL!</div>`;
                        diceLabel.className = 'text-sm mt-2';
                    } else if (rollData.success) {
                        diceValue.classList.add('dice-success');
                        diceLabel.innerHTML = `<div class="text-lg font-bold text-green-400">‚úì Success!</div>${modBreakdown}`;
                        diceLabel.className = 'text-sm mt-2';
                    } else {
                        diceValue.classList.add('dice-fail');
                        diceLabel.innerHTML = `<div class="text-lg font-bold text-red-400">‚úó Failed</div>${modBreakdown}`;
                        diceLabel.className = 'text-sm mt-2';
                    }
                    
                    // Hide after showing result (longer to read breakdown)
                    setTimeout(() => {
                        diceDisplay.classList.add('hidden');
                        diceRoller.classList.remove('hidden');
                        resolve();
                    }, 2000); // 2 seconds to read the result
                }, animDuration);
            });
        }

        function getMilitaryRank() {
            return RANKS[state.military.rank];
        }

        // ============ HOUSING ============
        const HOUSING = {
            parents: { name: "Parents' House", icon: "üè†", rent: 0, happiness: -2, stress: 5, appeal: -15, desc: "Free but cramped", upgradeReq: { money: 400 } },
            room: { name: "Rented Room", icon: "üö™", rent: 100, happiness: 0, stress: 2, appeal: 0, desc: "$100/week", upgradeReq: { money: 800, creditScore: 550 } },
            apartment: { name: "Studio Apartment", icon: "üè¢", rent: 200, happiness: 5, stress: 0, appeal: 5, desc: "$200/week", upgradeReq: { money: 1500, creditScore: 600 } },
            nice_apartment: { name: "1BR Apartment", icon: "üè¢", rent: 350, happiness: 10, stress: -3, appeal: 12, desc: "$350/week", upgradeReq: { money: 3000, creditScore: 650 } },
            house: { name: "Small House", icon: "üè°", rent: 500, happiness: 15, stress: -5, appeal: 20, desc: "$500/week", upgradeReq: null }
        };
        
        const HOUSING_ORDER = ['parents', 'room', 'apartment', 'nice_apartment', 'house'];

        // ============ TRANSPORT ============
        const TRANSPORT = {
            walk: { name: "Walking", icon: "üö∂", cost: 0, stress: 8, appeal: -10, desc: "Free but slow", upgradeReq: { money: 50 } },
            bus: { name: "Bus Pass", icon: "üöå", cost: 20, stress: 5, appeal: -5, desc: "$20/week", upgradeReq: { money: 100 } },
            bike: { name: "Bicycle", icon: "üö≤", cost: 5, stress: 3, appeal: 0, desc: "$5/week upkeep", upgradeReq: { money: 800, creditScore: 500 } },
            beater: { name: "Old Car", icon: "üöó", cost: 50, stress: 2, appeal: 8, desc: "$50/week (gas+insurance)", upgradeReq: { money: 3000, creditScore: 600 } },
            car: { name: "Reliable Car", icon: "üöô", cost: 100, stress: 0, appeal: 15, desc: "$100/week", upgradeReq: null }
        };
        
        const TRANSPORT_ORDER = ['walk', 'bus', 'bike', 'beater', 'car'];

        // ============ FISHING MINI-GAME ============
        const FISH_TYPES = {
            // Common fish (DC 8-10)
            bluegill: { name: "Bluegill", icon: "üêü", dc: 8, value: 5, xp: 1, rarity: "common" },
            perch: { name: "Perch", icon: "üêü", dc: 9, value: 8, xp: 1, rarity: "common" },
            catfish: { name: "Catfish", icon: "üê±", dc: 10, value: 12, xp: 2, rarity: "common" },
            carp: { name: "Carp", icon: "üêü", dc: 9, value: 6, xp: 1, rarity: "common" },
            
            // Uncommon fish (DC 12-14)
            bass: { name: "Largemouth Bass", icon: "üêü", dc: 12, value: 25, xp: 3, rarity: "uncommon" },
            trout: { name: "Rainbow Trout", icon: "üåà", dc: 13, value: 30, xp: 3, rarity: "uncommon" },
            pike: { name: "Northern Pike", icon: "ü¶à", dc: 14, value: 35, xp: 4, rarity: "uncommon" },
            walleye: { name: "Walleye", icon: "üëÅÔ∏è", dc: 13, value: 40, xp: 4, rarity: "uncommon" },
            
            // Rare fish (DC 16-18)
            salmon: { name: "Atlantic Salmon", icon: "üê†", dc: 16, value: 60, xp: 6, rarity: "rare" },
            muskie: { name: "Muskie", icon: "ü¶à", dc: 17, value: 80, xp: 7, rarity: "rare" },
            sturgeon: { name: "Sturgeon", icon: "üêã", dc: 18, value: 100, xp: 8, rarity: "rare" },
            
            // Legendary fish (DC 20+)
            goldenTrout: { name: "Golden Trout", icon: "‚ú®", dc: 20, value: 200, xp: 15, rarity: "legendary" },
            giantCatfish: { name: "Giant Catfish", icon: "üëë", dc: 22, value: 300, xp: 20, rarity: "legendary" },
            lochNess: { name: "???", icon: "ü¶ï", dc: 25, value: 1000, xp: 50, rarity: "mythical" },
            
            // Junk (always catchable)
            boot: { name: "Old Boot", icon: "üë¢", dc: 0, value: 0, xp: 0, rarity: "junk" },
            tire: { name: "Tire", icon: "‚≠ï", dc: 0, value: 0, xp: 0, rarity: "junk" },
            can: { name: "Tin Can", icon: "ü•´", dc: 0, value: 0, xp: 0, rarity: "junk" }
        };
        
        const FISHING_LOCATIONS = {
            pond: { name: "Local Pond", icon: "üèûÔ∏è", fish: ['bluegill', 'perch', 'catfish', 'carp', 'boot', 'can'], cost: 0, bonus: 0 },
            lake: { name: "Lake", icon: "üåä", fish: ['bass', 'trout', 'pike', 'walleye', 'catfish', 'bluegill', 'tire'], cost: 10, bonus: 2 },
            river: { name: "River", icon: "üèûÔ∏è", fish: ['salmon', 'trout', 'bass', 'pike', 'sturgeon', 'boot'], cost: 15, bonus: 3 },
            ocean: { name: "Deep Sea", icon: "üåä", fish: ['muskie', 'sturgeon', 'salmon', 'goldenTrout', 'giantCatfish'], cost: 50, bonus: 5 },
            secret: { name: "Secret Spot", icon: "üó∫Ô∏è", fish: ['goldenTrout', 'giantCatfish', 'lochNess', 'sturgeon'], cost: 100, bonus: 8, unlock: 50 }
        };

        // ============ HABITS ============
        const HABITS = {
            // GOOD HABITS (cost willpower to maintain)
            earlyRiser: {
                name: "Early Riser",
                icon: "üåÖ",
                type: "good",
                desc: "Wake up at 6am consistently",
                baseCost: 15,
                effects: {
                    energy: 3,
                    happiness: 1,
                    desc: "+3 Energy, +1 Happy/week"
                }
            },
            exercise: {
                name: "Daily Exercise",
                icon: "üèÉ",
                type: "good",
                desc: "30 min exercise daily",
                baseCost: 18,
                requires: () => true,
                effects: {
                    health: 2,
                    physical: 0.3,
                    stress: -2,
                    desc: "+2 Health, +0.3 Physical, -2 Stress/week"
                }
            },
            healthyEating: {
                name: "Healthy Eating",
                icon: "ü•ó",
                type: "good",
                desc: "Meal prep, avoid junk food",
                baseCost: 12,
                moneyCost: 30,
                effects: {
                    health: 3,
                    energy: 2,
                    attractiveness: 0.02,
                    desc: "+3 Health, +2 Energy, slight looks boost"
                }
            },
            meditation: {
                name: "Daily Meditation",
                icon: "üßò",
                type: "good",
                desc: "15 min mindfulness practice",
                baseCost: 10,
                effects: {
                    stress: -5,
                    happiness: 2,
                    willpowerRegen: 3,
                    desc: "-5 Stress, +2 Happy, +3 Willpower regen"
                }
            },
            reading: {
                name: "Daily Reading",
                icon: "üìñ",
                type: "good",
                desc: "Read for 30 min before bed",
                baseCost: 8,
                effects: {
                    technical: 0.2,
                    creativity: 0.2,
                    stress: -1,
                    desc: "+0.2 Technical, +0.2 Creativity"
                }
            },
            noPhone: {
                name: "Phone-Free Mornings",
                icon: "üìµ",
                type: "good",
                desc: "No phone for first hour",
                baseCost: 14,
                effects: {
                    stress: -3,
                    energy: 2,
                    happiness: 1,
                    desc: "-3 Stress, +2 Energy, +1 Happy"
                }
            },
            budgeting: {
                name: "Track Spending",
                icon: "üìä",
                type: "good",
                desc: "Review finances weekly",
                baseCost: 6,
                effects: {
                    moneySave: 0.05,
                    desc: "Save 5% on weekly expenses"
                }
            },
            
            // BAD HABITS (give willpower BACK but have negative effects)
            smoking: {
                name: "Smoking",
                icon: "üö¨",
                type: "bad",
                desc: "A pack a day keeps the stress away... temporarily",
                willpowerGain: 8,
                moneyCost: 50,
                effects: {
                    health: -3,
                    stress: -4,
                    attractiveness: -0.05,
                    desc: "-3 Health, -4 Stress, costs $50/week"
                }
            },
            drinking: {
                name: "Heavy Drinking",
                icon: "üç∫",
                type: "bad",
                desc: "Several drinks most nights",
                willpowerGain: 10,
                moneyCost: 60,
                effects: {
                    health: -2,
                    energy: -3,
                    stress: -5,
                    social: 0.2,
                    desc: "-2 Health, -3 Energy, -5 Stress, $60/week"
                }
            },
            junkFood: {
                name: "Junk Food Diet",
                icon: "üçî",
                type: "bad",
                desc: "Fast food and snacks",
                willpowerGain: 6,
                moneyCost: 40,
                effects: {
                    health: -2,
                    happiness: 3,
                    attractiveness: -0.03,
                    desc: "-2 Health, +3 Happy, -looks, $40/week"
                }
            },
            doomScrolling: {
                name: "Doom Scrolling",
                icon: "üì±",
                type: "bad",
                desc: "Hours on social media daily",
                willpowerGain: 7,
                effects: {
                    energy: -2,
                    happiness: -2,
                    stress: 2,
                    social: 0.1,
                    desc: "-2 Energy, -2 Happy, +2 Stress"
                }
            },
            gambling: {
                name: "Gambling",
                icon: "üé∞",
                type: "bad",
                desc: "Regular betting/casino visits",
                willpowerGain: 12,
                moneyCost: 100,
                effects: {
                    stress: -3,
                    happiness: 2,
                    moneyRisk: true,
                    desc: "Stress relief but $100+/week risk"
                }
            },
            lateSleeper: {
                name: "Night Owl",
                icon: "ü¶â",
                type: "bad",
                desc: "Stay up past 2am regularly",
                willpowerGain: 5,
                effects: {
                    energy: -4,
                    creativity: 0.3,
                    health: -1,
                    desc: "-4 Energy, -1 Health, +0.3 Creativity"
                }
            },
            procrastination: {
                name: "Procrastinator",
                icon: "‚è∞",
                type: "bad",
                desc: "Put everything off until last minute",
                willpowerGain: 8,
                effects: {
                    stress: 3,
                    technical: -0.2,
                    happiness: 2,
                    desc: "+3 Stress, -0.2 Technical, +2 Happy (short-term)"
                }
            }
        };

        // ============ SUBSCRIPTIONS ============
        const SUBSCRIPTIONS = {
            gym: {
                name: "Gym Membership",
                icon: "üèãÔ∏è",
                desc: "Access to fitness equipment",
                cost: 50,
                effects: { 
                    desc: "Enables gym in free time, +Physical, +Attractiveness over time",
                    onSubscribe: () => { state.fitness.gymMember = true; },
                    onCancel: () => { state.fitness.gymMember = false; state.freeTime.gym = 0; }
                }
            },
            streaming: {
                name: "Streaming Services",
                icon: "üì∫",
                desc: "Netflix, etc.",
                cost: 15,
                effects: { 
                    desc: "+2 Happiness/week, cheaper Rest activity",
                    weekly: () => { state.happiness = Math.min(100, state.happiness + 2); }
                }
            },
            music: {
                name: "Music Streaming",
                icon: "üéµ",
                desc: "Spotify, etc.",
                cost: 10,
                effects: { 
                    desc: "+1 Happiness/week, -1 Stress/week",
                    weekly: () => { 
                        state.happiness = Math.min(100, state.happiness + 1);
                        state.stress = Math.max(0, state.stress - 1);
                    }
                }
            },
            mealKit: {
                name: "Meal Kit Delivery",
                icon: "ü•ó",
                desc: "Hello Fresh, etc.",
                cost: 60,
                effects: { 
                    desc: "+2 Health/week, enables healthy eating bonus",
                    onSubscribe: () => { state.fitness.healthyEating = true; },
                    onCancel: () => { state.fitness.healthyEating = false; },
                    weekly: () => { state.health = Math.min(100, state.health + 2); }
                }
            },
            cloud: {
                name: "Cloud Storage",
                icon: "‚òÅÔ∏è",
                desc: "Backup & productivity",
                cost: 10,
                effects: { 
                    desc: "+0.2 Technical/week",
                    weekly: () => { state.skills.technical = Math.min(100, state.skills.technical + 0.2); }
                }
            },
            news: {
                name: "News Subscription",
                icon: "üì∞",
                desc: "Stay informed",
                cost: 15,
                effects: { 
                    desc: "+0.1 Social/week, better interview performance",
                    weekly: () => { state.skills.social = Math.min(100, state.skills.social + 0.1); }
                }
            },
            gaming: {
                name: "Game Pass",
                icon: "üéÆ",
                desc: "Xbox/PlayStation",
                cost: 15,
                effects: { 
                    desc: "+3 Happiness/week, but +1 Stress (addictive)",
                    weekly: () => { 
                        state.happiness = Math.min(100, state.happiness + 3);
                        state.stress = Math.min(100, state.stress + 1);
                    }
                }
            },
            meditation: {
                name: "Meditation App",
                icon: "üßò",
                desc: "Calm, Headspace",
                cost: 12,
                effects: { 
                    desc: "-3 Stress/week, +1 Energy/week",
                    weekly: () => { 
                        state.stress = Math.max(0, state.stress - 3);
                        state.energy = Math.min(100, state.energy + 1);
                    }
                }
            },
            learning: {
                name: "Online Learning",
                icon: "üéì",
                desc: "Coursera, Skillshare",
                cost: 25,
                effects: { 
                    desc: "+0.3 Technical/week, +0.2 Creativity/week",
                    weekly: () => { 
                        state.skills.technical = Math.min(100, state.skills.technical + 0.3);
                        state.skills.creativity = Math.min(100, state.skills.creativity + 0.2);
                    }
                }
            },
            dating: {
                name: "Dating Apps Premium",
                icon: "üíï",
                desc: "Tinder Gold, etc.",
                cost: 30,
                effects: { 
                    desc: "+5% chance to meet someone",
                    condition: () => !state.married
                }
            }
        };

        // ============ FREE TIME ACTIVITIES ============
        const FREE_TIME_ACTIVITIES = {
            gym: {
                name: "Gym",
                icon: "üèãÔ∏è",
                desc: "Build fitness & looks",
                costPerHour: 0, // Free if member
                requires: () => state.fitness.gymMember,
                requiresText: "Need gym membership",
                effects: {
                    physical: 0.3,      // per hour
                    attractiveness: 0.05,
                    health: 0.5,
                    energy: -2,
                    stress: -0.5        // Stress relief once routine established
                }
            },
            hobbies: {
                name: "Hobbies",
                icon: "üé®",
                desc: "Creative pursuits",
                costPerHour: 20,
                requires: () => true,
                effects: {
                    creativity: 0.4,
                    happiness: 1,
                    stress: -1.5,
                    energy: -1
                }
            },
            socialize: {
                name: "Socialize",
                icon: "üçª",
                desc: "Friends & networking",
                costPerHour: 15,
                requires: () => true,
                effects: {
                    social: 0.4,
                    happiness: 0.8,
                    stress: -1,
                    meetingBonus: 0.02, // +2% chance to meet someone per hour
                    networkBonus: 0.1   // Career network boost
                }
            },
            overtime: {
                name: "Work Overtime",
                icon: "üíº",
                desc: "Extra hours at work",
                costPerHour: 0, // Actually earns money
                earningsPerHour: () => state.employed ? Math.floor((state.weeklyIncome || 400) / 40 * 1.5) : 0, // Time and a half
                requires: () => state.employed,
                requiresText: "Need a job",
                effects: {
                    stress: 2,
                    energy: -3,
                    careerXP: 0.5,      // Career advancement
                    happiness: -0.5
                }
            },
            study: {
                name: "Study",
                icon: "üìö",
                desc: () => state.phase === 'education' ? "Coursework & homework (free!)" : "Self-improvement",
                costPerHour: () => state.phase === 'education' ? 0 : 15, // Free for students, costs money otherwise
                requires: () => true,
                effects: {
                    technical: 0.3,
                    creativity: 0.1,
                    energy: -2,
                    stress: 0.5,
                    gpaBonus: 0.02,     // +0.02 GPA per hour if in school
                    examBonus: 0.5      // Better exam performance
                }
            },
            rest: {
                name: "Rest & Relax",
                icon: "üõãÔ∏è",
                desc: "Recharge your batteries",
                costPerHour: 5, // Netflix, snacks
                requires: () => true,
                effects: {
                    energy: 3,
                    stress: -2,
                    health: 0.3,
                    happiness: 0.5
                }
            }
        };
        
        // Base free time, modified by situation
        const BASE_FREE_TIME = 25; // Hours per week base
        
        // Time costs that reduce free time
        const TIME_MODIFIERS = {
            transport: {
                walk: -6,      // Walking everywhere takes time
                bus: -4,       // Bus commutes
                bike: -2,      // Biking is faster
                beater: 0,     // Car is baseline
                car: 0         // Good car = baseline
            },
            job: {
                military: -8,  // Military has very limited free time
                fast_food: -2, // Long/variable shifts
                retail: -2,
                warehouse: -3, // Physical exhaustion
                default: 0
            },
            education: {
                university: -4,      // Classes + homework
                community_college: -3,
                trade_school: -2,
                military_training: -10, // Boot camp = no free time
                default: 0
            },
            housing: {
                parents: 2,    // Mom does laundry, etc.
                default: 0
            }
        };
        
        function getAvailableFreeTime() {
            let time = BASE_FREE_TIME;
            
            // Transport modifier
            time += TIME_MODIFIERS.transport[state.car] || 0;
            
            // Job modifier
            if (state.employed) {
                time += TIME_MODIFIERS.job[state.job] || TIME_MODIFIERS.job.default;
            }
            
            // Education modifier
            if (state.phase === 'education' || state.phase === 'military_training') {
                let eduType = state.educationType || state.phase;
                time += TIME_MODIFIERS.education[eduType] || TIME_MODIFIERS.education.default;
            }
            
            // Housing modifier
            time += TIME_MODIFIERS.housing[state.home] || TIME_MODIFIERS.housing.default;
            
            // Kids take time!
            if (state.relationship.children > 0) {
                time -= state.relationship.children * 3;
            }
            
            return Math.max(5, time); // Minimum 5 hours
        }

        // ============ JOBS DATABASE ============
        const JOBS = {
            // No education required
            fast_food: { title: "Fast Food Worker", icon: "üçî", salary: 320, req: {}, stress: 30 },
            retail: { title: "Retail Associate", icon: "üõí", salary: 340, req: {}, stress: 25 },
            warehouse: { title: "Warehouse Worker", icon: "üì¶", salary: 400, req: { physical: 30 }, stress: 35 },
            server: { title: "Restaurant Server", icon: "üçΩÔ∏è", salary: 380, req: { social: 25 }, stress: 30 },
            
            // Trait-based jobs (no education required)
            model: { title: "Model", icon: "üì∏", salary: 600, req: { minAttr: 8 }, stress: 20 },
            bouncer: { title: "Bouncer", icon: "üö™", salary: 450, req: { physical: 50, minHeight: 7 }, stress: 35 },
            personal_trainer: { title: "Personal Trainer", icon: "üí™", salary: 500, req: { physical: 60, minAttr: 6 }, stress: 20 },
            sales_rep: { title: "Sales Representative", icon: "ü§ù", salary: 550, req: { social: 40, minAttr: 6 }, stress: 35 },
            
            // Trade school
            electrician_apprentice: { title: "Electrician Apprentice", icon: "‚ö°", salary: 500, req: { education: 'trade_school', technical: 30 }, stress: 25 },
            plumber_apprentice: { title: "Plumber Apprentice", icon: "üîß", salary: 480, req: { education: 'trade_school', technical: 30 }, stress: 25 },
            mechanic: { title: "Auto Mechanic", icon: "üîß", salary: 520, req: { education: 'trade_school', technical: 35 }, stress: 20 },
            
            // Community college
            admin_assistant: { title: "Admin Assistant", icon: "üìã", salary: 450, req: { education: 'community_college' }, stress: 20 },
            dental_hygienist: { title: "Dental Hygienist", icon: "ü¶∑", salary: 600, req: { education: 'community_college', technical: 30 }, stress: 15 },
            it_support: { title: "IT Support", icon: "üíª", salary: 550, req: { education: 'community_college', technical: 40, minIntel: 5 }, stress: 25 },
            
            // University - requires intelligence
            junior_analyst: { title: "Junior Analyst", icon: "üìä", salary: 700, req: { education: 'university', minIntel: 5 }, stress: 30 },
            software_dev: { title: "Software Developer", icon: "üíª", salary: 900, req: { education: 'university', technical: 50, minIntel: 6 }, stress: 35 },
            accountant: { title: "Accountant", icon: "üßÆ", salary: 750, req: { education: 'university', technical: 40, minIntel: 6 }, stress: 25 },
            marketing: { title: "Marketing Associate", icon: "üì£", salary: 650, req: { education: 'university', social: 40 }, stress: 30 },
            data_scientist: { title: "Data Scientist", icon: "üìà", salary: 1100, req: { education: 'university', technical: 55, minIntel: 8 }, stress: 30 },
            
            // PRESTIGIOUS ENTRY-LEVEL (requires high GPA)
            investment_banking: { title: "Investment Banking Analyst", icon: "üè¶", salary: 1400, req: { education: 'university', minIntel: 7, minGPA: 3.7 }, stress: 60, prestigious: true },
            consulting: { title: "Management Consultant", icon: "üìã", salary: 1300, req: { education: 'university', minIntel: 7, social: 45, minGPA: 3.5 }, stress: 55, prestigious: true },
            big_tech: { title: "Big Tech Engineer", icon: "üöÄ", salary: 1500, req: { education: 'university', technical: 60, minIntel: 8, minGPA: 3.5 }, stress: 45, prestigious: true },
            corporate_law_clerk: { title: "Law Firm Clerk", icon: "‚öñÔ∏è", salary: 1100, req: { education: 'university', minIntel: 7, minGPA: 3.6 }, stress: 50, prestigious: true },
            research_scientist: { title: "Research Scientist", icon: "üî¨", salary: 1000, req: { education: 'university', technical: 55, minIntel: 8, minGPA: 3.8 }, stress: 35, prestigious: true },
            
            // Military
            military: { title: "Military Service", icon: "üéñÔ∏è", salary: 450, req: { education: 'military' }, stress: 40 },
            
            // Senior positions (promotions) - often require higher intelligence
            senior_analyst: { title: "Senior Analyst", icon: "üìä", salary: 1100, req: { education: 'university', technical: 60, minIntel: 6 }, stress: 35 },
            senior_dev: { title: "Senior Developer", icon: "üíª", salary: 1400, req: { education: 'university', technical: 70, minIntel: 7 }, stress: 40 },
            manager: { title: "Manager", icon: "üëî", salary: 1200, req: { social: 50, minIntel: 5 }, stress: 45 },
            executive: { title: "Executive", icon: "üè¢", salary: 2000, req: { social: 70, minIntel: 7, minAttr: 6 }, stress: 50 },
            master_electrician: { title: "Master Electrician", icon: "‚ö°", salary: 900, req: { education: 'trade_school', technical: 70 }, stress: 20 }
        };

        // ============ PARTNER GENERATION ============
        const NAMES = ["Alex", "Jordan", "Sam", "Casey", "Morgan", "Riley", "Quinn", "Taylor", "Jamie", "Drew"];
        
        function generatePartner() {
            let appeal = calculateAppeal();
            let quality = Math.max(20, Math.min(90, appeal + (Math.random() - 0.5) * 40));
            
            return {
                name: NAMES[Math.floor(Math.random() * NAMES.length)],
                age: state.week / 52 + 18 + Math.floor(Math.random() * 6) - 3,
                quality: quality,
                supportiveness: Math.floor(Math.random() * 40 + 30 + (100 - quality) * 0.3),
                attractiveness: Math.floor(quality * 0.7 + Math.random() * 30),
                income: Math.floor(quality * 8 + Math.random() * 200)
            };
        }

        function calculateAppeal() {
            let appeal = 20;
            
            // Attractiveness is now the primary factor (0-30 points)
            let attractiveness = state.currentAttractiveness || state.characterTraits?.attractiveness || 5;
            appeal += attractiveness * 3;
            
            // Other factors
            appeal += state.money / 500;
            appeal += state.health / 10;
            appeal += (100 - state.stress) / 15;
            if (state.employed) appeal += 10;
            if (state.education === 'university') appeal += 5;
            
            // Housing and Transport matter more for males (provider status)
            let housingAppeal = HOUSING[state.home]?.appeal || 0;
            let transportAppeal = TRANSPORT[state.car]?.appeal || 0;
            
            if (state.gender === 'male') {
                // Males get significant boost from nice housing/car
                appeal += housingAppeal;
                appeal += transportAppeal;
            } else {
                // Females get modest boost (independence is attractive)
                appeal += housingAppeal * 0.3;
                appeal += transportAppeal * 0.2;
            }
            
            // Height can matter slightly
            let height = state.characterTraits?.height || 5;
            if (height >= 7) appeal += 3;
            if (height <= 3) appeal -= 2;
            
            return Math.min(100, appeal);
        }
        
        // Calculate credit card APR based on credit score (better score = lower rate)
        function getCreditCardAPR(creditScore) {
            if (creditScore >= 800) return 0.129;  // 12.9% - Excellent
            if (creditScore >= 750) return 0.159;  // 15.9% - Very Good
            if (creditScore >= 700) return 0.189;  // 18.9% - Good
            if (creditScore >= 650) return 0.229;  // 22.9% - Fair
            if (creditScore >= 600) return 0.259;  // 25.9% - Poor
            return 0.299;                           // 29.9% - Bad
        }
        
        // Calculate credit card limit based on credit score and income
        function getCreditCardLimit(creditScore, weeklyIncome) {
            let annualIncome = weeklyIncome * 52;
            let baseLimit;
            
            if (creditScore >= 800) {
                baseLimit = Math.min(25000, annualIncome * 0.5);
            } else if (creditScore >= 750) {
                baseLimit = Math.min(15000, annualIncome * 0.4);
            } else if (creditScore >= 700) {
                baseLimit = Math.min(10000, annualIncome * 0.3);
            } else if (creditScore >= 650) {
                baseLimit = Math.min(5000, annualIncome * 0.25);
            } else if (creditScore >= 600) {
                baseLimit = Math.min(2000, annualIncome * 0.15);
            } else {
                baseLimit = Math.min(500, annualIncome * 0.1);
            }
            
            // Minimum limit of $300
            return Math.max(300, Math.floor(baseLimit / 100) * 100);
        }
        
        // Process weekly fitness effects
        function processFitnessWeek() {
            // Gym membership effects
            if (state.fitness.gymMember) {
                state.fitness.workoutStreak++;
                state.skills.physical = Math.min(100, state.skills.physical + 0.5);
                state.health = Math.min(100, state.health + 1);
                
                // Slow attractiveness improvement (max +2 from base)
                let baseAttr = state.characterTraits?.attractiveness || 5;
                let fitnessBonus = Math.min(2, state.fitness.workoutStreak / 20);
                state.currentAttractiveness = Math.min(10, baseAttr + fitnessBonus);
                state.fitness.fitnessLevel = Math.min(20, state.fitness.workoutStreak / 2);
                
                // First 8 weeks are hard, then it gets easier
                if (state.fitness.workoutStreak < 8) {
                    state.stress += 2;
                } else {
                    state.fitness.routineEstablished = true;
                    state.stress = Math.max(0, state.stress - 1);
                }
            } else {
                // Lose fitness if not working out
                if (state.fitness.workoutStreak > 0) {
                    state.fitness.workoutStreak = Math.max(0, state.fitness.workoutStreak - 2);
                }
            }
            
            // Healthy eating effects
            if (state.fitness.healthyEating) {
                state.health = Math.min(100, state.health + 0.5);
                // Very slow attractiveness boost from good nutrition
                let baseAttr = state.characterTraits?.attractiveness || 5;
                if (state.currentAttractiveness < baseAttr + 1) {
                    state.currentAttractiveness = Math.min(10, state.currentAttractiveness + 0.05);
                }
            }
        }
        
        // Attractiveness bonus events for highly attractive people
        function getAttractivenessBonusEvent() {
            let attractiveness = state.currentAttractiveness || 5;
            let events = [];
            
            // Different opportunities based on context
            if (getAge() < 30) {
                events.push({
                    category: "‚ú® Opportunity",
                    title: "Noticed",
                    desc: "Someone approaches you at a coffee shop. Turns out they're a talent scout for a modeling agency.",
                    choices: [
                        {
                            text: "Hear them out",
                            effect: () => {
                                let bonus = attractiveness >= 9 ? 800 : 400;
                                state.money += bonus;
                                state.skills.social += 3;
                                state.happiness += 10;
                                return { icon: "üì∏", text: "A few photoshoots later, you've got some extra cash and confidence.", stats: `+$${bonus}, +3 Social, +10 Happy` };
                            }
                        },
                        {
                            text: "Not interested",
                            effect: () => {
                                return { icon: "üôÖ", text: "Flattering, but not your thing.", stats: "" };
                            }
                        }
                    ]
                });
            }
            
            events.push({
                category: "‚ú® Opportunity",
                title: "Networking Advantage",
                desc: "At a professional event, people seem eager to talk to you. Your appearance opens doors.",
                choices: [
                    {
                        text: "Work the room",
                        effect: () => {
                            state.career.networkContacts += attractiveness >= 9 ? 8 : 5;
                            state.skills.social += 2;
                            return { icon: "ü§ù", text: "Business cards exchanged, LinkedIn requests sent. Connections made.", stats: `+${attractiveness >= 9 ? 8 : 5} Network` };
                        }
                    },
                    {
                        text: "Keep a low profile",
                        effect: () => {
                            state.career.networkContacts += 1;
                            return { icon: "üëÄ", text: "You observe from the sidelines.", stats: "+1 Network" };
                        }
                    }
                ]
            });
            
            events.push({
                category: "‚ú® Opportunity", 
                title: "Better Service",
                desc: "You notice you tend to get better treatment at restaurants, stores, everywhere really.",
                choices: [
                    {
                        text: "Use it to your advantage",
                        effect: () => {
                            state.money += 100; // Freebies, discounts
                            state.happiness += 5;
                            return { icon: "üéÅ", text: "Free upgrades, comped drinks, preferential treatment. Life's a bit easier.", stats: "+$100 in perks, +5 Happy" };
                        }
                    },
                    {
                        text: "Feel conflicted about it",
                        effect: () => {
                            state.happiness -= 3;
                            return { icon: "ü§î", text: "Is this really fair? The privilege weighs on you.", stats: "-3 Happy (introspection)" };
                        }
                    }
                ]
            });
            
            return events[Math.floor(Math.random() * events.length)];
        }
        
        // Family help event for wealthy families
        function getFamilyHelpEvent() {
            let wealth = state.characterTraits?.familyWealth || 5;
            if (wealth < 7 || state.money > 500) return null;
            
            // Can only ask once per year
            if (state.lastFamilyHelpWeek && (state.totalWeeks - state.lastFamilyHelpWeek) < 52) return null;
            
            let helpAmount = wealth >= 9 ? 5000 : wealth >= 8 ? 2500 : 1500;
            
            return {
                category: "üë®‚Äçüë©‚Äçüëß Family",
                title: "Reaching Out to Family",
                desc: `Things are tight. Your ${wealth >= 9 ? 'wealthy' : 'well-off'} family could probably help...`,
                choices: [
                    {
                        text: `Ask for help (they'd give ~$${helpAmount.toLocaleString()})`,
                        effect: () => {
                            state.money += helpAmount;
                            state.lastFamilyHelpWeek = state.totalWeeks;
                            state.happiness += 5;
                            state.stress -= 15;
                            return { icon: "üíù", text: "Family came through. No strings attached... mostly.", stats: `+$${helpAmount.toLocaleString()}` };
                        }
                    },
                    {
                        text: "Figure it out yourself",
                        effect: () => {
                            state.happiness += 3;
                            return { icon: "üí™", text: "Independence has its own value.", stats: "+3 Happiness (pride)" };
                        }
                    }
                ]
            };
        }

        // ============ HELPER FUNCTIONS ============
        
        // Intelligence modifier for learning/academic tasks
        function getIntelligenceModifier() {
            let intel = state.characterTraits?.intelligence || 5;
            // Returns multiplier: 0.7 (intel 1) to 1.5 (intel 10)
            return 0.6 + (intel * 0.1);
        }
        
        // Intelligence bonus for DC rolls (reduces difficulty for smart characters)
        function getIntelligenceDCBonus() {
            let intel = state.characterTraits?.intelligence || 5;
            // Returns -3 to +5 based on intelligence
            return Math.floor((intel - 5) * 1);
        }
        
        // Apply intelligence to skill gains
        function gainSkill(skillName, baseAmount) {
            let modifier = getIntelligenceModifier();
            let actualGain = baseAmount * modifier;
            state.skills[skillName] = Math.min(100, state.skills[skillName] + actualGain);
            return actualGain;
        }
        
        // Apply intelligence to GPA gains
        function gainGPA(baseAmount) {
            let modifier = getIntelligenceModifier();
            let actualGain = baseAmount * modifier;
            state.gpa = Math.min(4.0, state.gpa + actualGain);
            return actualGain;
        }
        
        function getAge() {
            return Math.floor(18 + state.totalWeeks / 52);
        }

        function getMonth() {
            return Math.floor((state.totalWeeks % 52) / 4) + 1;
        }

        function meetsRequirements(jobKey) {
            let job = JOBS[jobKey];
            if (!job.req) return true;
            
            // Education requirements
            if (job.req.education) {
                if (job.req.education === 'university' && state.education !== 'university') return false;
                if (job.req.education === 'community_college' && !['community_college', 'university'].includes(state.education)) return false;
                if (job.req.education === 'trade_school' && state.education !== 'trade_school') return false;
                if (job.req.education === 'military' && state.education !== 'military') return false;
            }
            
            // GPA requirements (for prestigious positions)
            if (job.req.minGPA && (state.gpa || 0) < job.req.minGPA) return false;
            
            // Trait requirements
            let traits = state.characterTraits || {};
            if (job.req.minIntel && (traits.intelligence || 5) < job.req.minIntel) return false;
            if (job.req.minAttr && (state.currentAttractiveness || traits.attractiveness || 5) < job.req.minAttr) return false;
            if (job.req.minHeight && (traits.height || 5) < job.req.minHeight) return false;
            
            // Skill requirements
            for (let skill in job.req) {
                if (!['education', 'minIntel', 'minAttr', 'minHeight', 'minGPA'].includes(skill)) {
                    if (state.skills[skill] < job.req[skill]) return false;
                }
            }
            return true;
        }
        
        // Get GPA bonus/penalty for job hunting
        function getGPAHiringModifier() {
            if (state.education !== 'university' && state.education !== 'community_college') return 0;
            
            let gpa = state.gpa || 2.5;
            
            // GPA bonuses/penalties for interview rolls
            if (gpa >= 3.9) return 6;      // Summa Cum Laude - huge advantage
            if (gpa >= 3.7) return 4;      // Magna Cum Laude
            if (gpa >= 3.5) return 3;      // Cum Laude
            if (gpa >= 3.2) return 1;      // Above average
            if (gpa >= 2.8) return 0;      // Average - no bonus
            if (gpa >= 2.5) return -1;     // Below average
            if (gpa >= 2.0) return -3;     // Poor grades
            return -5;                      // Barely graduated
        }
        
        // Get GPA salary modifier (percentage bonus/penalty)
        function getGPASalaryModifier() {
            if (state.education !== 'university' && state.education !== 'community_college') return 1.0;
            
            let gpa = state.gpa || 2.5;
            
            if (gpa >= 3.9) return 1.15;   // +15% starting salary
            if (gpa >= 3.7) return 1.10;   // +10%
            if (gpa >= 3.5) return 1.05;   // +5%
            if (gpa >= 3.0) return 1.0;    // Standard
            if (gpa >= 2.5) return 0.95;   // -5%
            return 0.90;                    // -10% for poor grades
        }

        function getAvailableJobs() {
            return Object.keys(JOBS).filter(j => meetsRequirements(j));
        }

        function calculateWeeklyFinances() {
            let income = 0;
            let expenses = 0;
            
            if (state.employed && state.job) {
                // Military uses rank-based pay
                if (state.job === 'military') {
                    income = getMilitaryRank().pay;
                    // Combat/deployment bonus
                    if (state.military.deployed) {
                        income += 150;
                    }
                } else if (state.job === 'part_time') {
                    // Part-time student job
                    income = state.weeklyIncome || 150;
                } else if (JOBS[state.job]) {
                    income = JOBS[state.job].salary;
                }
            }
            
            expenses += HOUSING[state.home].rent;
            expenses += TRANSPORT[state.car].cost;
            expenses += 50; // Base living expenses
            
            if (state.debt > 0) {
                expenses += Math.ceil(state.debt / 200); // Loan payments
            }
            
            // Free time activity costs
            let freeTimeCost = 0;
            let overtimeEarnings = 0;
            Object.keys(state.freeTime).forEach(key => {
                let hours = state.freeTime[key] || 0;
                if (hours === 0) return;
                let activity = FREE_TIME_ACTIVITIES[key];
                let costPerHour = typeof activity.costPerHour === 'function' ? activity.costPerHour() : activity.costPerHour;
                freeTimeCost += hours * costPerHour;
                if (activity.earningsPerHour && state.employed) {
                    overtimeEarnings += hours * activity.earningsPerHour();
                }
            });
            
            expenses += freeTimeCost;
            income += overtimeEarnings;
            state.freeTimeExpenses = freeTimeCost;
            state.overtimeEarnings = overtimeEarnings;
            
            // Subscription costs
            let subCost = 0;
            Object.keys(state.subscriptions).forEach(key => {
                if (state.subscriptions[key] && SUBSCRIPTIONS[key]) {
                    subCost += SUBSCRIPTIONS[key].cost;
                }
            });
            expenses += subCost;
            state.subscriptionCost = subCost;
            
            // Habit costs (smoking, drinking, junk food, gambling, etc.)
            let habitCost = 0;
            Object.keys(state.habits || {}).forEach(key => {
                if (state.habits[key]?.active && HABITS[key]?.moneyCost) {
                    habitCost += HABITS[key].moneyCost;
                }
            });
            expenses += habitCost;
            state.habitMoneyCost = habitCost;
            
            state.weeklyIncome = income;
            state.weeklyExpenses = expenses;
            
            return income - expenses;
        }

        function addLog(text) {
            let age = getAge();
            let entry = document.createElement('div');
            entry.className = 'border-l-2 border-gray-700 pl-2';
            entry.innerText = `Age ${age}: ${text}`;
            document.getElementById('eventLog').prepend(entry);
        }

        // ============ EVENT SYSTEM ============
        function getPhaseEvents() {
            // Priority: Check for pending bad habit event first
            if (pendingBadHabitEvent) {
                let badHabitEvent = showBadHabitEvent();
                if (badHabitEvent) return [badHabitEvent];
            }
            
            switch(state.phase) {
                case 'character_creation': return getCharacterCreationEvents();
                case 'deciding': return getDecidingEvents();
                case 'education': return getEducationEvents();
                case 'job_hunting': return getJobHuntingEvents();
                case 'employed': return getEmployedEvents();
                default: return getRandomLifeEvents();
            }
        }

        // Helper to roll a trait (weighted toward middle values)
        function rollTrait() {
            // Roll 2d6-1 for range 1-11, clamped to 1-10 (bell curve favoring 5-6)
            let roll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 1;
            return Math.max(1, Math.min(10, roll - 1));
        }
        
        function rollAllTraits() {
            return {
                height: rollTrait(),
                familyWealth: rollTrait(),
                intelligence: rollTrait(),
                attractiveness: rollTrait(),
                selfControl: rollTrait()
            };
        }
        
        let rerollsRemaining = 3;
        let pendingTraits = null;
        
        function getCharacterCreationEvents() {
            // Step 1: Gender selection
            if (!state.gender) {
            return [{
                    category: "üë§ Character Creation",
                    title: "Who Are You?",
                    desc: "Before your story begins, let's establish who you are.",
                choices: [
                    {
                            text: "I'm a young man",
                            effect: () => {
                                state.gender = 'male';
                                pendingTraits = rollAllTraits();
                                return { icon: "üë®", text: "Your story begins...", stats: "" };
                            }
                        },
                        {
                            text: "I'm a young woman",
                            effect: () => {
                                state.gender = 'female';
                                pendingTraits = rollAllTraits();
                                return { icon: "üë©", text: "Your story begins...", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // Step 2: Show traits and allow reroll
            if (!pendingTraits) {
                pendingTraits = rollAllTraits();
            }
            
            let traitDesc = `
Height: ${pendingTraits.height}/10 - ${TRAIT_DESCRIPTORS.height[pendingTraits.height]}
Family Wealth: ${pendingTraits.familyWealth}/10 - ${TRAIT_DESCRIPTORS.familyWealth[pendingTraits.familyWealth]}
Intelligence: ${pendingTraits.intelligence}/10 - ${TRAIT_DESCRIPTORS.intelligence[pendingTraits.intelligence]}
Attractiveness: ${pendingTraits.attractiveness}/10 - ${TRAIT_DESCRIPTORS.attractiveness[pendingTraits.attractiveness]}
Self-Control: ${pendingTraits.selfControl}/10 - ${TRAIT_DESCRIPTORS.selfControl[pendingTraits.selfControl]}
            `.trim();
            
            let choices = [
                {
                    text: "Accept these traits and begin my story",
                    effect: () => {
                        // Apply traits
                        state.characterTraits = { ...pendingTraits };
                        state.currentAttractiveness = pendingTraits.attractiveness;
                        
                        // Initialize willpower based on self-control
                        state.maxWillpower = 30 + (pendingTraits.selfControl * 5);
                        state.willpower = state.maxWillpower;
                        
                        // Apply family wealth effects
                        let wealth = pendingTraits.familyWealth;
                        state.money = 500 + (wealth * 200); // $700 to $2,500
                        
                        // Very poor families start with some debt
                        if (wealth <= 2) {
                            state.debt = (3 - wealth) * 500; // $500-$1000 debt
                        }
                        
                        // Intelligence affects starting skills slightly
                        let intBonus = Math.floor((pendingTraits.intelligence - 5) * 2);
                        state.skills.technical = Math.max(5, state.skills.technical + intBonus);
                        
                        // High attractiveness gives slight social boost
                        if (pendingTraits.attractiveness >= 7) {
                            state.skills.social += (pendingTraits.attractiveness - 6) * 3;
                        }
                        
                        // Move to deciding phase
                        state.phase = 'deciding';
                        pendingTraits = null;
                        rerollsRemaining = 3;
                        
                        // Trigger tutorial after a short delay
                        setTimeout(() => checkTutorial(), 500);
                        
                        let wealthMsg = wealth >= 7 ? "Your family's wealth opens doors." : 
                                       wealth <= 3 ? "Money's always been tight." : "A typical upbringing.";
                        
                        return { icon: "üé≠", text: `Your character is set. ${wealthMsg}`, stats: `Starting with $${state.money}` };
                    }
                }
            ];
            
            if (rerollsRemaining > 0) {
                choices.push({
                    text: `Reroll traits (${rerollsRemaining} remaining)`,
                    effect: () => {
                        rerollsRemaining--;
                        pendingTraits = rollAllTraits();
                        return { icon: "üé≤", text: "The dice are cast again...", stats: `${rerollsRemaining} rerolls left` };
                    }
                });
            }
            
            return [{
                category: "üé≤ Your Traits",
                title: "The Hand You're Dealt",
                desc: `Life isn't fair. Some are born with advantages, others with challenges. Here's what fate has given you:\n\n${traitDesc}`,
                choices: choices
            }];
        }

        function getDecidingEvents() {
            let intel = state.characterTraits?.intelligence || 5;
            let wealth = state.characterTraits?.familyWealth || 5;
            let physical = state.skills?.physical || 40;
            let height = state.characterTraits?.height || 5;
            
            let choices = [];
            
            // UNIVERSITY OPTIONS - requires intelligence 4+ 
            if (intel >= 4) {
                // Academic Scholarship for high intelligence
                if (intel >= 8) {
                    choices.push({
                        text: "üåü University with Academic Scholarship (Intelligence 8+)",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'university';
                            state.phaseTarget = EDUCATION_DURATION.university;
                            state.phaseWeek = 0;
                            state.debt = 5000; // Much less debt!
                            state.home = 'room';
                            state.money -= 500;
                            state.gpa = 3.5; // Start with better GPA
                            addLog("Received academic scholarship");
                            return { icon: "üéì", text: "Your grades earned you a scholarship! University with minimal debt.", stats: "Scholarship! Only +$5,000 debt, +0.5 GPA" };
                        }
                    });
                }
                
                // Family pays for wealthy families
                if (wealth >= 8) {
                    choices.push({
                        text: "üèõÔ∏è University (Family Pays) - Wealth 8+",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'university';
                            state.phaseTarget = EDUCATION_DURATION.university;
                            state.phaseWeek = 0;
                            state.debt = 0; // No debt!
                            state.home = 'room';
                            state.money += 500; // Spending money from parents
                            addLog("Family paying for university");
                            return { icon: "üéì", text: "Your family is covering tuition. Focus on learning, not loans.", stats: "Family pays! No debt, +$500 spending money" };
                        }
                    });
                }
                
                // Standard university option
                choices.push({
                    text: "University ‚Äî 4 years, ~$60,000 debt",
                    effect: () => {
                        state.phase = 'education';
                        state.educationType = 'university';
                        state.phaseTarget = EDUCATION_DURATION.university;
                        state.phaseWeek = 0;
                        state.debt = 15000;
                        state.home = 'room';
                        state.money -= 500;
                            return { icon: "üéì", text: "You pack your bags for university. Four years of learning await.", stats: "Started university, +$15,000 debt" };
                        }
                });
            }
            
            // COMMUNITY COLLEGE - always available
            choices.push({
                        text: "Community College ‚Äî 2 years, ~$8,000",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'community_college';
                            state.phaseTarget = EDUCATION_DURATION.community_college;
                            state.phaseWeek = 0;
                    state.debt = wealth >= 7 ? 0 : 4000; // Wealthy families cover it
                    let debtMsg = wealth >= 7 ? "Family covered it!" : "+$4,000 debt";
                    return { icon: "üìö", text: "Smart choice. Same foundation, less debt. You stay local and commute.", stats: `Started community college, ${debtMsg}` };
                }
            });
            
            // TRADE SCHOOL - always available, bonus for good physical stats
            choices.push({
                        text: "Trade School ‚Äî 1.5 years, ~$15,000",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'trade_school';
                            state.phaseTarget = EDUCATION_DURATION.trade_school;
                            state.phaseWeek = 0;
                    state.debt = wealth >= 7 ? 3000 : 8000;
                    let techBonus = physical >= 50 ? 15 : 10; // Better physical = better start
                    state.skills.technical += techBonus;
                    return { icon: "üîß", text: "You enroll in trade school. Learn a real skill, earn real money.", stats: `Started trade school, +${techBonus} Technical` };
                }
            });
            
            // MILITARY OPTIONS
            // Standard enlistment - needs minimum physical
            if (physical >= 30 && height >= 3) {
                choices.push({
                        text: "Enlist in the Military",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'military_training';
                            state.phaseTarget = EDUCATION_DURATION.military_training;
                            state.phaseWeek = 0;
                        state.money += 2000;
                        state.home = 'room';
                            state.skills.physical += 15;
                            state.traits.push('Enlisted');
                            return { icon: "üéñÔ∏è", text: "You sign the papers. Boot camp starts next week. Your country thanks you.", stats: "+$2,000 bonus, +15 Physical" };
                        }
                });
                
                // Special forces track for exceptional physical specimens
                if (physical >= 60 && height >= 6 && intel >= 5) {
                    choices.push({
                        text: "‚≠ê Military - Special Forces Track (Elite Physical)",
                        effect: () => {
                            state.phase = 'education';
                            state.educationType = 'military_training';
                            state.phaseTarget = EDUCATION_DURATION.military_training;
                            state.phaseWeek = 0;
                            state.money += 5000; // Better bonus
                            state.home = 'room';
                            state.skills.physical += 20;
                            state.military.combatXP = 10; // Start with some XP
                            state.traits.push('Enlisted');
                            state.traits.push('SF Candidate');
                            addLog("Enlisted on Special Forces track");
                            return { icon: "ü¶Ö", text: "Your physical abilities caught a recruiter's eye. Special Forces pipeline awaits.", stats: "+$5,000 bonus, +20 Physical, SF Track" };
                        }
                    });
                }
            }
            
            // WORK - always available
            choices.push({
                        text: "Start Working Now",
                        effect: () => {
                            state.phase = 'job_hunting';
                            state.education = 'high_school';
                            state.phaseWeek = 0;
                            return { icon: "üíº", text: "No time or money for more school. You need a job.", stats: "Now job hunting" };
                        }
            });
            
            // Build description based on traits
            let desc = "High school graduation is around the corner. Everyone keeps asking about your plans.";
            if (intel <= 3) {
                desc += " Your grades weren't great - university isn't really an option.";
            } else if (intel >= 8) {
                desc += " Your excellent grades have opened some doors.";
            }
            if (wealth >= 8) {
                desc += " Your family has offered to help financially.";
            } else if (wealth <= 3) {
                desc += " Money is tight - you'll need to be practical.";
            }
            
            return [{
                category: "Crossroads",
                title: "What's Next?",
                desc: desc,
                choices: choices
            }];
        }

        function getEducationEvents() {
            let events = [];
            let progress = state.phaseWeek / state.phaseTarget;
            let type = state.educationType;
            
            // Check for graduation
            if (state.phaseWeek >= state.phaseTarget) {
                return [getGraduationEvent()];
            }
            
            // Tuition due events (every semester for college)
            if ((type === 'university' || type === 'community_college') && state.phaseWeek % 20 === 0 && state.phaseWeek > 0) {
                let cost = type === 'university' ? 3000 : 1500;
                let wealth = state.characterTraits?.familyWealth || 5;
                let tuitionChoices = [
                    {
                        text: `Pay from savings ($${cost.toLocaleString()})`,
                        condition: () => state.money >= cost,
                            effect: () => {
                                state.money -= cost;
                                state.happiness += 5;
                                return { icon: "‚úÖ", text: "Paid in full. No new debt.", stats: `-$${cost.toLocaleString()}` };
                            }
                        },
                        {
                            text: "Take out more loans",
                            effect: () => {
                                let loan = type === 'university' ? 4000 : 2000;
                                state.debt += loan;
                                return { icon: "üìù", text: `Signed for another loan. Debt is growing.`, stats: `+$${loan.toLocaleString()} debt` };
                            }
                        }
                ];
                
                // Wealthy families help with tuition
                if (wealth >= 8) {
                    let familyHelp = wealth >= 9 ? cost : Math.floor(cost * 0.7);
                    tuitionChoices.unshift({
                        text: `Family pays (they cover $${familyHelp.toLocaleString()})`,
                        effect: () => {
                            let remaining = cost - familyHelp;
                            if (remaining > 0) state.money -= remaining;
                            state.happiness += 8;
                            return { icon: "üíù", text: "The benefits of a supportive family.", stats: remaining > 0 ? `-$${remaining} (family covered rest)` : "Fully covered!" };
                        }
                    });
                }
                
                events.push({
                    category: "Finance",
                    title: "Tuition Due",
                    desc: `Another semester, another bill. Tuition is due.`,
                    choices: tuitionChoices
                });
            }
            
            // Regular education events
            if (type === 'university' || type === 'community_college') {
                events.push(...getCollegeEvents());
            } else if (type === 'trade_school') {
                events.push(...getTradeSchoolEvents());
            } else if (type === 'military_training') {
                events.push(...getMilitaryTrainingEvents());
            } else if (type === 'military_service') {
                events.push(...getMilitaryServiceEvents());
            }
            
            if (events.length === 0) {
                events.push(getRoutineEducationEvent());
            }
            
            return events;
        }

        function getCollegeEvents() {
            let events = [];
            let roll = Math.random();
            let semester = Math.floor(state.phaseWeek / 26) + 1; // 26 weeks per semester
            state.university.semester = semester;
            
            // FINANCIAL AID OFFICE - Available when money is low or at semester boundaries
            let semesterStart = (state.phaseWeek % 26) < 4;
            let moneyTight = state.money < 800;
            let financialAidChance = moneyTight ? 0.5 : (semesterStart ? 0.4 : 0.08);
            
            if (Math.random() < financialAidChance) {
                return [{
                    category: "üí∞ Financial Aid",
                    title: moneyTight ? "Financial Aid Check-In" : "Financial Aid Office",
                    desc: moneyTight 
                        ? "Your bank account is looking thin. The financial aid office reaches out about additional funding options."
                        : "The financial aid office has some options available if you need extra funds.",
                    choices: [
                        {
                            text: "Take out an extra $2,000 in loans",
                            effect: () => {
                                state.money += 2000;
                                state.debt += 2000;
                                return { icon: "üíµ", text: "Money now, payments later. That's future you's problem.", stats: "+$2,000, +$2,000 Debt" };
                            }
                        },
                        {
                            text: "Take out $5,000 - live a little more comfortably",
                            effect: () => {
                                state.money += 5000;
                                state.debt += 5000;
                                state.happiness += 10;
                                return { icon: "üí∞", text: "Breathing room. Maybe even some fun money.", stats: "+$5,000, +$5,000 Debt, +10 Happy" };
                            }
                        },
                        {
                            text: "Take out $10,000 - max it out",
                            effect: () => {
                                state.money += 10000;
                                state.debt += 10000;
                                state.happiness += 15;
                                state.stress -= 10;
                                return { icon: "ü§ë", text: "Go big or go home. You'll worry about this after graduation.", stats: "+$10,000, +$10,000 Debt" };
                            }
                        },
                        {
                            text: "Decline - keep debt low",
                            effect: () => {
                                state.skills.creativity += 1; // Resourcefulness
                                return { icon: "üôÖ", text: "You'll make it work somehow. Ramen isn't that bad.", stats: "No new debt" };
                            }
                        }
                    ]
                }];
            }
            
            // MAJOR SELECTION (Week 1-4 of university)
            if (!state.university.majorSelected && state.phaseWeek < 4) {
                return [{
                    category: "Academic",
                    title: "Choose Your Major",
                    desc: "Freshman orientation. Time to declare what you'll study for the next four years. Choose wisely.",
                    choices: Object.entries(MAJORS).map(([key, major]) => ({
                        text: `${major.icon} ${major.name} - ${major.desc}`,
                        effect: () => {
                            state.university.major = key;
                            state.university.majorSelected = true;
                            state.skills[major.statBonus] += 5;
                            if (major.stressBonus) state.stress += major.stressBonus;
                            addLog(`Declared ${major.name} major`);
                            return { icon: major.icon, text: `You're now a ${major.name} major. Your journey begins.`, stats: `+5 ${major.statBonus}` };
                        }
                    }))
                }];
            }
            
            // STUDY BUDDY ASSIGNMENT (Week 4-6)
            if (!state.university.studyBuddy && state.phaseWeek >= 4 && state.phaseWeek < 8) {
                let buddyName = STUDY_BUDDY_NAMES[Math.floor(Math.random() * STUDY_BUDDY_NAMES.length)];
                return [{
                    category: "Social",
                    title: "Study Group Formation",
                    desc: `In your intro class, ${buddyName} asks if you want to form a study group.`,
                    choices: [
                        {
                            text: `Partner up with ${buddyName}`,
                            effect: () => {
                                state.university.studyBuddy = buddyName;
                                state.university.studyBuddyRelationship = 50;
                                state.skills.social += 2;
                                return { icon: "üìö", text: `You and ${buddyName} start meeting weekly. Could be helpful.`, stats: "+2 Social, Study buddy gained" };
                            }
                        },
                        {
                            text: "Prefer to study alone",
                            effect: () => {
                                state.skills.technical += 2;
                                return { icon: "üß†", text: "Solo studying builds discipline.", stats: "+2 Technical" };
                            }
                        }
                    ]
                }];
            }
            
            // CLUB RECRUITMENT (Week 8-12, Semester 1)
            if (!state.university.club && state.phaseWeek >= 8 && state.phaseWeek < 14) {
                return [{
                    category: "Campus Life",
                    title: "Club Fair",
                    desc: "The quad is packed with booths. Every organization wants fresh blood. What catches your eye?",
                    choices: [
                        ...Object.entries(CLUBS).slice(0, 3).map(([key, club]) => ({
                            text: `${club.icon} ${club.name} ($${club.cost}/semester)`,
                            condition: () => state.money >= club.cost,
                            effect: () => {
                                state.university.club = key;
                                state.university.clubWeeks = 0;
                                state.money -= club.cost;
                                if (club.social) state.skills.social += club.social;
                                if (club.physical) state.skills.physical += club.physical;
                                if (club.networkBonus) state.career.networkContacts += club.networkBonus;
                                addLog(`Joined ${club.name}`);
                                return { icon: club.icon, text: `Welcome to ${club.name}! The activities begin.`, stats: `-$${club.cost}, +${club.social || club.physical || 0} skills` };
                            }
                        })),
                        {
                            text: "Not interested in clubs",
                            effect: () => {
                                state.energy += 10;
                                return { icon: "üòé", text: "More time for yourself.", stats: "+10 Energy" };
                            }
                        }
                    ]
                }];
            }
            
            // PROFESSOR MENTOR (Semester 2-3)
            if (!state.university.professorMentor && semester >= 2 && semester <= 3 && roll < 0.25) {
                let profs = PROFESSOR_TYPES.filter(p => p.field === state.university.major || Math.random() > 0.7);
                let prof = profs[Math.floor(Math.random() * profs.length)] || PROFESSOR_TYPES[0];
                return [{
                    category: "Academic",
                    title: "Office Hours",
                    desc: `${prof.name} notices your work in class. "Have you considered research opportunities?"`,
                    choices: [
                        {
                            text: `Become ${prof.name}'s research assistant`,
                            effect: () => {
                                state.university.professorMentor = prof;
                                state.university.professorRelationship = 40;
                                Object.entries(prof.bonus).forEach(([stat, val]) => {
                                    if (stat === 'technical') state.skills.technical += val;
                                    if (stat === 'creativity') state.skills.creativity += val;
                                    if (stat === 'social') state.skills.social += val;
                                    if (stat === 'stress') state.stress += val;
                                    if (stat === 'happiness') state.happiness += val;
                                });
                                addLog(`Became research assistant to ${prof.name}`);
                                return { icon: "üî¨", text: `${prof.name} takes you under their wing. This could open doors.`, stats: `Professor mentor gained` };
                            }
                        },
                        {
                            text: "Too busy right now",
                            effect: () => {
                                return { icon: "‚è∞", text: "You politely decline. Maybe next semester.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // GPA CHECK - ACADEMIC PROBATION (Every semester end)
            if (state.phaseWeek % 26 === 25 && state.gpa < 2.0) {
                if (!state.university.onProbation) {
                    state.university.onProbation = true;
                    return [{
                        category: "‚ö†Ô∏è WARNING",
                        title: "Academic Probation",
                        desc: `Your GPA of ${state.gpa.toFixed(2)} is below 2.0. One more bad semester and you're out.`,
                        choices: [
                            {
                                text: "Promise to do better",
                                effect: () => {
                                    state.stress += 25;
                                    state.happiness -= 15;
                                    addLog("Placed on academic probation");
                                    return { icon: "üò∞", text: "The dean's letter is clear: shape up or ship out.", stats: "+25 Stress, -15 Happiness" };
                                }
                            }
                        ]
                    }];
                } else {
                    // Already on probation with bad GPA - expelled
                    return [{
                        category: "üíî EXPELLED",
                        title: "Academic Dismissal",
                        desc: "Your GPA remained below 2.0. The university has no choice.",
                        choices: [
                            {
                                text: "Pack your things",
                                effect: () => {
                                    state.phase = 'job_hunting';
                                    state.education = 'some_college';
                                    state.happiness -= 30;
                                    state.stress += 30;
                                    addLog("Expelled from university");
                                    return { icon: "üì¶", text: "Four years of dreams, gone. Time to figure out what's next.", stats: "-30 Happiness, +30 Stress" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // DEAN'S LIST CHECK (Every semester end)
            if (state.phaseWeek % 26 === 25 && state.gpa >= 3.5) {
                state.university.honorsList = true;
                events.push({
                    category: "üåü Achievement",
                    title: "Dean's List!",
                    desc: `Your ${state.gpa.toFixed(2)} GPA earns you a spot on the Dean's List.`,
                    choices: [
                        {
                            text: "Accept the recognition",
                            effect: () => {
                                state.happiness += 15;
                                state.career.networkContacts += 5;
                                if (!state.achievements.includes("Dean's List")) state.achievements.push("Dean's List");
                                return { icon: "üèÜ", text: "Your name on the wall. Parents are proud.", stats: "+15 Happiness, +5 Network" };
                            }
                        }
                    ]
                });
                return events;
            }
            
            // STUDY ABROAD OPPORTUNITY (Semester 4-5)
            if (!state.university.studyAbroadDone && semester >= 4 && semester <= 5 && roll < 0.2) {
                return [{
                    category: "Opportunity",
                    title: "Study Abroad Program",
                    desc: "A semester in Europe. Different culture, new perspectives. But it's expensive.",
                    choices: [
                        {
                            text: "Go abroad ($5,000 extra)",
                            condition: () => state.money >= 5000 || state.debt < 50000,
                            effect: () => {
                                if (state.money >= 5000) state.money -= 5000;
                                else state.debt += 5000;
                                state.university.studyAbroadDone = true;
                                state.skills.social += 10;
                                state.skills.creativity += 5;
                                state.happiness += 20;
                                if (!state.hasPartner && Math.random() > 0.6) {
                                    let partner = generatePartner();
                                    state.hasPartner = true;
                                    state.partnerName = partner.name;
                                    state.partnerStats = partner;
                                    addLog(`Met ${partner.name} abroad`);
                                }
                                state.achievements.push("Study Abroad");
                                addLog("Studied abroad in Europe");
                                return { icon: "‚úàÔ∏è", text: "Three months that changed your worldview forever.", stats: "+10 Social, +5 Creativity, +20 Happiness" };
                            }
                        },
                        {
                            text: "Can't afford it",
                            effect: () => {
                                state.happiness -= 5;
                                return { icon: "üòî", text: "Maybe someday you'll travel.", stats: "-5 Happiness" };
                            }
                        }
                    ]
                }];
            }
            
            // INTERNSHIP (Semester 5-6)
            if (!state.university.internshipCompleted && semester >= 5 && semester <= 6 && roll < 0.3) {
                let major = MAJORS[state.university.major] || MAJORS.business;
                return [{
                    category: "Career",
                    title: "Summer Internship Offer",
                    desc: `A company wants a ${major.name} intern. Unpaid, but looks great on a resume.`,
                    choices: [
                        {
                            text: "Take the internship",
                            effect: () => {
                                let check = rollWithModifier(state.skills.technical + state.skills.social, 12);
                                state.university.internshipCompleted = true;
                                state.energy -= 20;
                                
                                if (check.nat20) {
                                    state.career.networkContacts += 20;
                                    state.money += 2000; // They liked you so much they paid you
                                    addLog("Stellar internship - job offer secured");
                                    return { icon: "üåü", text: "[NAT 20!] You impressed everyone. They offer you a job after graduation!", stats: "+20 Network, +$2,000 bonus" };
                                }
                                if (check.success) {
                                    state.career.networkContacts += 10;
                                    state.skills.technical += 5;
                                    addLog("Completed summer internship");
                                    return { icon: "üíº", text: `[Rolled ${check.total} vs DC 12] Great learning experience. You have references now.`, stats: "+10 Network, +5 Technical" };
                                }
                                state.stress += 10;
                                return { icon: "üòê", text: `[Rolled ${check.total} vs DC 12] Survived it. Not sure they'll remember you.`, stats: "+10 Stress" };
                            }
                        },
                        {
                            text: "Enjoy the summer off",
                            effect: () => {
                                state.happiness += 10;
                                state.energy += 20;
                                return { icon: "üèñÔ∏è", text: "Summer vibes. You'll get a job eventually.", stats: "+10 Happiness, +20 Energy" };
                            }
                        }
                    ]
                }];
            }
            
            // THESIS/CAPSTONE (Semester 7-8)
            if (!state.university.thesisStarted && semester >= 7) {
                return [{
                    category: "Senior Year",
                    title: "Capstone Project",
                    desc: "Time to prove what you've learned. Your thesis advisor wants a topic by next week.",
                    choices: [
                        {
                            text: "Ambitious original research",
                            effect: () => {
                                state.university.thesisStarted = true;
                                state.university.thesisProgress = 0;
                                state.stress += 20;
                                return { icon: "üî¨", text: "You're going big. High risk, high reward.", stats: "+20 Stress, Thesis started (Hard mode)" };
                            }
                        },
                        {
                            text: "Safe, well-defined project",
                            effect: () => {
                                state.university.thesisStarted = true;
                                state.university.thesisProgress = 20;
                                return { icon: "üìù", text: "Smart choice. Known territory.", stats: "Thesis started (Normal mode)" };
                            }
                        }
                    ]
                }];
            }
            
            // THESIS WORK EVENTS
            if (state.university.thesisStarted && state.university.thesisProgress < 100) {
                if (roll < 0.3) {
                    return [{
                        category: "Thesis",
                        title: "Research Progress",
                        desc: `Thesis is ${state.university.thesisProgress}% complete. The deadline looms.`,
                        choices: [
                            {
                                text: "All-nighter work session",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.technical, 13);
                                    state.university.allNighters++;
                                    state.energy -= 30;
                                    state.health -= 5;
                                    
                                    if (check.nat20) {
                                        state.university.thesisProgress += 35;
                                        return { icon: "‚≠ê", text: "[NAT 20!] BREAKTHROUGH! Everything clicks into place.", stats: "+35% thesis, -30 Energy, -5 Health" };
                                    }
                                    if (check.success) {
                                        state.university.thesisProgress += 20;
                                        return { icon: "üìä", text: `[Rolled ${check.total} vs DC 13] Good progress. Seeing the light.`, stats: "+20% thesis, -30 Energy" };
                                    }
                                    state.university.thesisProgress += 10;
                                    state.stress += 15;
                                    return { icon: "üò´", text: `[Rolled ${check.total} vs DC 13] Spinning wheels. Some progress at least.`, stats: "+10% thesis, +15 Stress" };
                                }
                            },
                            {
                                text: "Steady, sustainable pace",
                                effect: () => {
                                    state.university.thesisProgress += 12;
                                    state.energy -= 10;
                                    return { icon: "üìù", text: "Slow and steady. It adds up.", stats: "+12% thesis" };
                                }
                            },
                            {
                                text: "Ask professor for guidance",
                                condition: () => state.university.professorMentor,
                                effect: () => {
                                    state.university.thesisProgress += 18;
                                    state.university.professorRelationship += 5;
                                    return { icon: "üéì", text: `${state.university.professorMentor.name} points you in the right direction.`, stats: "+18% thesis, +5 Professor relationship" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // REGULAR COLLEGE EVENTS - Academic challenges with dice rolls
            if (roll < 0.35) { // Increased from 15% to 35%
                let intelBonus = getIntelligenceDCBonus();
                let intelMod = getIntelligenceModifier();
                let intelDesc = intelBonus > 0 ? " (your intelligence helps)" : intelBonus < -1 ? " (this is harder for you)" : "";
                
                events.push({
                    category: "Academic",
                    title: "Big Exam Coming",
                    desc: `Midterms are next week. How do you prepare?${intelDesc}`,
                    choices: [
                        {
                            text: "Pull an all-nighter. Coffee and desperation.",
                            effect: () => {
                                let dc = Math.max(5, 12 - intelBonus);
                                let check = rollWithModifier(state.skills.technical, dc);
                                state.energy -= 20;
                                state.health -= 10;
                                state.stress += 15;
                                state.university.allNighters++;
                                
                                if (check.nat20) {
                                    let gpaGain = gainGPA(0.4);
                                    gainSkill('technical', 5);
                                    return { icon: "üåü", text: "[NAT 20!] Perfect score! The all-nighter paid off.", stats: `+${gpaGain.toFixed(2)} GPA` };
                                }
                                if (check.success) {
                                    let gpaGain = gainGPA(0.25);
                                    gainSkill('technical', 3);
                                    return { icon: "üìö", text: `[Rolled ${check.total} vs DC ${dc}] Aced it!`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                }
                                if (check.nat1) {
                                    state.gpa = Math.max(0, state.gpa - 0.4);
                                    state.happiness -= 15;
                                    return { icon: "üíÄ", text: "[NAT 1!] Fell asleep during the exam. Complete failure.", stats: "-0.4 GPA, -15 Happy" };
                                }
                                // Failed the exam - GPA hit
                                state.gpa = Math.max(0, state.gpa - 0.15);
                                state.happiness -= 8;
                                return { icon: "üò´", text: `[Rolled ${check.total} vs DC ${dc}] Failed the exam. Sleep-deprived brain couldn't handle it.`, stats: "-0.15 GPA, -8 Happy" };
                            }
                        },
                        {
                            text: "Hire a tutor. Money can solve this problem.",
                            condition: () => state.money >= 150,
                            effect: () => {
                                state.money -= 150;
                                let dc = Math.max(4, 8 - intelBonus);
                                let check = rollWithModifier(state.skills.technical + 10, dc);
                                state.energy -= 10;
                                
                                if (check.nat20) {
                                    let gpaGain = gainGPA(0.35);
                                    return { icon: "üåü", text: "[NAT 20!] Tutor was amazing.", stats: `-$150, +${gpaGain.toFixed(2)} GPA` };
                                }
                                let gpaGain = gainGPA(0.2);
                                return { icon: "üìñ", text: `[Rolled ${check.total} vs DC ${dc}] Money well spent.`, stats: `-$150, +${gpaGain.toFixed(2)} GPA` };
                            }
                        },
                        {
                            text: "Study at a reasonable pace. Balance is key.",
                            effect: () => {
                                let dc = Math.max(8, 11 - intelBonus);
                                let check = rollWithModifier(state.skills.technical, dc);
                                state.energy -= 10;
                                state.stress += 5;
                                
                                if (check.nat20) {
                                    let gpaGain = gainGPA(0.25);
                                    state.skills.technical += 2;
                                    return { icon: "üåü", text: "[NAT 20!] Perfect balance. Aced it effortlessly.", stats: `+${gpaGain.toFixed(2)} GPA, +2 Technical` };
                                }
                                if (check.success) {
                                    state.gpa = Math.min(4.0, state.gpa + 0.15);
                                    state.skills.technical += 1;
                                    return { icon: "üìö", text: `[Rolled ${check.total} vs DC ${dc}] Healthy approach. Good grade.`, stats: "+0.15 GPA, +1 Technical" };
                                }
                                if (check.nat1) {
                                    state.gpa = Math.max(0, state.gpa - 0.25);
                                    state.happiness -= 10;
                                    return { icon: "üíÄ", text: "[NAT 1!] Studied the wrong chapter entirely.", stats: "-0.25 GPA, -10 Happy" };
                                }
                                // Failed but studied - smaller penalty
                                state.gpa = Math.max(0, state.gpa - 0.08);
                                return { icon: "üòê", text: `[Rolled ${check.total} vs DC ${dc}] The exam was harder than expected. Below average grade.`, stats: "-0.08 GPA" };
                            }
                        },
                        {
                            text: "Wing it. You're smart enough, right?",
                            effect: () => {
                                let check = rollWithModifier(state.skills.technical - 10, 15);
                                if (check.nat20) {
                                    state.gpa = Math.min(4.0, state.gpa + 0.4);
                                    state.happiness += 10;
                                    return { icon: "üòé", text: "[NAT 20!] Pure genius. Didn't study, still crushed it.", stats: "+0.4 GPA, +10 Happy" };
                                }
                                if (check.success) {
                                    state.gpa = Math.min(4.0, state.gpa + 0.15);
                                    return { icon: "üòÖ", text: `[Rolled ${check.total} vs DC 15] Scraped by on intuition.`, stats: "+0.15 GPA" };
                                }
                                if (check.nat1) {
                                    state.gpa = Math.max(0, state.gpa - 0.5);
                                    state.happiness -= 20;
                                    return { icon: "üíÄ", text: "[NAT 1!] Complete disaster. What were you thinking?", stats: "-0.5 GPA, -20 Happy" };
                                }
                                state.gpa = Math.max(0, state.gpa - 0.2);
                                    state.happiness -= 10;
                                return { icon: "üò∞", text: `[Rolled ${check.total}] Failed. Should have studied.`, stats: "-0.2 GPA, -10 Happy" };
                            }
                        },
                        {
                            text: `Study with ${state.university.studyBuddy || 'your study group'}. Strength in numbers.`,
                            condition: () => state.university.studyBuddy,
                            effect: () => {
                                state.gpa = Math.min(4.0, state.gpa + 0.15);
                                state.university.studyBuddyRelationship += 5;
                                state.energy -= 15;
                                return { icon: "üë•", text: `${state.university.studyBuddy} helps you nail the tricky parts.`, stats: "+0.15 GPA, +5 Buddy relationship" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.50) {
                // More academic events with dice rolls
                let academicEventType = Math.random();
                
                if (academicEventType < 0.33) {
                    // CLASS PRESENTATION
                events.push({
                        category: "Academic",
                        title: "Class Presentation",
                        desc: `You have to present your research to the class. Public speaking isn't for everyone.${intelDesc}`,
                    choices: [
                        {
                                text: "üé≤ Wing it with confidence",
                            effect: () => {
                                    let dc = Math.max(8, 14 - intelBonus);
                                    let check = rollWithModifier(state.skills.social, dc);
                                    
                                    if (check.nat20) {
                                        let gpaGain = gainGPA(0.3);
                                        gainSkill('social', 4);
                                        return { icon: "üåü", text: "[NAT 20!] Standing ovation! Professor asks you to present at a conference.", stats: `+${gpaGain.toFixed(2)} GPA, +4 Social` };
                                    }
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.15);
                                        gainSkill('social', 2);
                                        return { icon: "üé§", text: `[Rolled ${check.total} vs DC ${dc}] Smooth delivery. Class is impressed.`, stats: `+${gpaGain.toFixed(2)} GPA, +2 Social` };
                                    }
                                    if (check.nat1) {
                                        state.gpa = Math.max(0, state.gpa - 0.2);
                                        state.stress += 20;
                                        return { icon: "üíÄ", text: "[NAT 1!] Complete meltdown. You froze up and ran out.", stats: "-0.2 GPA, +20 Stress" };
                                    }
                                    state.stress += 10;
                                    return { icon: "üò¨", text: `[Rolled ${check.total}] Stumbled through it. At least it's over.`, stats: "+10 Stress" };
                                }
                            },
                            {
                                text: "üé≤ Prepare extensively (costs energy)",
                                effect: () => {
                                    state.energy -= 20;
                                    let dc = Math.max(6, 10 - intelBonus);
                                    let check = rollWithModifier(state.skills.technical + 5, dc);
                                    
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.2);
                                        gainSkill('social', 1);
                                        gainSkill('technical', 1);
                                        return { icon: "üìä", text: `[Rolled ${check.total} vs DC ${dc}] Preparation paid off. Solid presentation.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    state.gpa = Math.min(4.0, state.gpa + 0.05);
                                    return { icon: "üòê", text: `[Rolled ${check.total}] All that prep and still nervous. Passing grade.`, stats: "+0.05 GPA" };
                                }
                            },
                            {
                                text: "Fake being sick",
                                effect: () => {
                                    state.stress -= 10;
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    return { icon: "ü§í", text: "Bought yourself time, but you'll have to do it eventually.", stats: "-0.1 GPA, -10 Stress" };
                                }
                            }
                        ]
                    });
                } else if (academicEventType < 0.66) {
                    // LAB EXPERIMENT
                    events.push({
                        category: "Academic",
                        title: "Lab Experiment",
                        desc: `Time to put theory into practice. One wrong move could ruin the whole thing.${intelDesc}`,
                        choices: [
                            {
                                text: "üé≤ Follow the instructions carefully",
                                effect: () => {
                                    let dc = Math.max(7, 12 - intelBonus);
                                    let check = rollWithModifier(state.skills.technical, dc);
                                    
                                    if (check.nat20) {
                                        let gpaGain = gainGPA(0.25);
                                        gainSkill('technical', 5);
                                        return { icon: "üåü", text: "[NAT 20!] Perfect execution! TA asks if you want to assist in research.", stats: `+${gpaGain.toFixed(2)} GPA, +5 Technical` };
                                    }
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.15);
                                        gainSkill('technical', 2);
                                        return { icon: "üî¨", text: `[Rolled ${check.total} vs DC ${dc}] Experiment successful!`, stats: `+${gpaGain.toFixed(2)} GPA, +2 Technical` };
                                    }
                                    if (check.nat1) {
                                        state.gpa = Math.max(0, state.gpa - 0.15);
                                        state.health -= 5;
                                        return { icon: "üí•", text: "[NAT 1!] Something exploded. Safety goggles saved your eyes.", stats: "-0.15 GPA, -5 Health" };
                                    }
                                    return { icon: "üòï", text: `[Rolled ${check.total}] Results inconclusive. Partial credit.`, stats: "+0.05 GPA" };
                                }
                            },
                            {
                                text: "üé≤ Try an innovative approach",
                                effect: () => {
                                    let dc = Math.max(10, 16 - intelBonus);
                                    let check = rollWithModifier(state.skills.creativity + state.skills.technical/2, dc);
                                    
                                    if (check.nat20) {
                                        let gpaGain = gainGPA(0.4);
                                        gainSkill('creativity', 5);
                                        gainSkill('technical', 3);
                                        return { icon: "üèÜ", text: "[NAT 20!] You discovered something new! Professor wants to publish with you!", stats: `+${gpaGain.toFixed(2)} GPA, +5 Creativity` };
                                    }
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.25);
                                        gainSkill('creativity', 3);
                                        return { icon: "üí°", text: `[Rolled ${check.total} vs DC ${dc}] Your approach worked! Extra credit.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    return { icon: "ü§∑", text: `[Rolled ${check.total}] Your 'innovation' just made a mess.`, stats: "-0.1 GPA" };
                                }
                            },
                            {
                                text: "Partner with someone smart",
                                condition: () => state.university.studyBuddy,
                                effect: () => {
                                    let gpaGain = gainGPA(0.12);
                                    state.university.studyBuddyRelationship += 3;
                                    return { icon: "ü§ù", text: `${state.university.studyBuddy} carries you through. Teamwork!`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                }
                            }
                        ]
                    });
                } else {
                    // RESEARCH PAPER
                    events.push({
                        category: "Academic",
                        title: "Research Paper Due",
                        desc: `A major paper is due. Your thesis needs to be solid.${intelDesc}`,
                        choices: [
                            {
                                text: "üé≤ Write it properly over several days",
                                effect: () => {
                                state.energy -= 15;
                                    let dc = Math.max(8, 13 - intelBonus);
                                    let check = rollWithModifier(state.skills.technical + state.skills.creativity/2, dc);
                                    
                                    if (check.nat20) {
                                        let gpaGain = gainGPA(0.3);
                                        gainSkill('technical', 3);
                                        gainSkill('creativity', 2);
                                        return { icon: "üåü", text: "[NAT 20!] Professor reads it aloud as an example. Perfect score.", stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.18);
                                        gainSkill('technical', 1);
                                        return { icon: "üìù", text: `[Rolled ${check.total} vs DC ${dc}] Well-researched paper. Good grade.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    let gpaGain = gainGPA(0.08);
                                    return { icon: "üòê", text: `[Rolled ${check.total}] Decent effort. Average grade.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                }
                            },
                            {
                                text: "üé≤ Last-minute all-nighter",
                                effect: () => {
                                    state.energy -= 25;
                                    state.health -= 5;
                                    state.stress += 15;
                                    let dc = Math.max(10, 15 - intelBonus);
                                    let check = rollWithModifier(state.skills.technical, dc);
                                    
                                    if (check.nat20) {
                                        let gpaGain = gainGPA(0.35);
                                        return { icon: "üåü", text: "[NAT 20!] Somehow your sleep-deprived brain produced genius.", stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    if (check.success) {
                                        let gpaGain = gainGPA(0.15);
                                        return { icon: "üòµ", text: `[Rolled ${check.total} vs DC ${dc}] Barely coherent, but it passed.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    if (check.nat1) {
                                        state.gpa = Math.max(0, state.gpa - 0.3);
                                        return { icon: "üíÄ", text: "[NAT 1!] You fell asleep and submitted gibberish.", stats: "-0.3 GPA" };
                                    }
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    return { icon: "üò´", text: `[Rolled ${check.total}] Professor saw right through it.`, stats: "-0.1 GPA" };
                                }
                            },
                            {
                                text: "Use AI to help (risky)",
                                effect: () => {
                                    let check = rollWithModifier(0, 12); // Pure luck
                                    
                                    if (check.roll >= 15) {
                                        let gpaGain = gainGPA(0.2);
                                        return { icon: "ü§ñ", text: `[Rolled ${check.roll}] Got away with it. Paper turned out decent.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                    }
                                    if (check.roll <= 5) {
                                        state.gpa = Math.max(0, state.gpa - 0.5);
                                        state.stress += 30;
                                        return { icon: "üö®", text: `[Rolled ${check.roll}] CAUGHT! Academic integrity violation.`, stats: "-0.5 GPA, +30 Stress" };
                                    }
                                    let gpaGain = gainGPA(0.1);
                                    return { icon: "üòÖ", text: `[Rolled ${check.roll}] It worked, but the writing felt off.`, stats: `+${gpaGain.toFixed(2)} GPA` };
                                }
                            }
                        ]
                    });
                }
            } else if (roll < 0.60) {
                events.push({
                    category: "Social",
                    title: state.university.club === 'greek' ? "Frat/Sorority Party" : "Campus Party",
                    desc: state.university.club === 'greek' ? "Your house is throwing a massive party. You're expected to be there." : "There's a big party this weekend. Everyone's going.",
                    choices: [
                        {
                            text: "Go hard üéâ",
                            effect: () => {
                                state.happiness += 20;
                                state.energy -= 25;
                                state.skills.social += 3;
                                state.money -= 50;
                                state.university.partiesAttended++;
                                
                                if (Math.random() < 0.15) {
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    state.health -= 10;
                                    return { icon: "ü§Æ", text: "You don't remember half of it. Missed Monday's class.", stats: "+20 Happiness, -0.1 GPA, -10 Health" };
                                }
                                if (!state.hasPartner && Math.random() > 0.6) {
                                    let partner = generatePartner();
                                    state.hasPartner = true;
                                    state.partnerName = partner.name;
                                    state.partnerStats = partner;
                                    state.relationshipWeeks = 0;
                                    addLog(`Met ${partner.name} at a party`);
                                    return { icon: "üéâ", text: `Epic night! And you met someone named ${partner.name}.`, stats: "+20 Happiness, +3 Social, Romance!" };
                                }
                                return { icon: "üéâ", text: "What a night! These are the memories.", stats: "+20 Happiness, +3 Social, -$50" };
                            }
                        },
                        {
                            text: "Make an appearance, leave early",
                            effect: () => {
                                state.happiness += 8;
                                state.skills.social += 1;
                                state.money -= 15;
                                return { icon: "üôÇ", text: "Said hi, showed face, went home. Balance.", stats: "+8 Happiness, +1 Social" };
                            }
                        },
                        {
                            text: "Stay in and study",
                            effect: () => {
                                state.gpa = Math.min(4.0, state.gpa + 0.05);
                                state.skills.technical += 1;
                                state.happiness -= 5;
                                return { icon: "üìö", text: "FOMO hits hard, but your GPA thanks you.", stats: "+0.05 GPA, -5 Happiness" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.68 && !state.employed) {
                events.push({
                    category: "Work",
                    title: "Part-Time Job Opportunity",
                    desc: "The campus coffee shop is hiring. Flexible hours, but it'll cut into study time.",
                    choices: [
                        {
                            text: "Take the job ($150/week)",
                            effect: () => {
                                state.employed = true;
                                state.job = 'part_time';
                                state.jobTitle = 'Campus Barista';
                                state.weeklyIncome = 150;
                                state.skills.social += 3;
                                addLog("Started part-time job");
                                return { icon: "‚òï", text: "You start next week. Work-study life begins.", stats: "+$150/week income, +3 Social" };
                            }
                        },
                        {
                            text: "Focus on studies",
                            effect: () => {
                                state.gpa = Math.min(4.0, state.gpa + 0.05);
                                return { icon: "üìö", text: "School is your job right now.", stats: "+0.05 GPA" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.75 && state.university.professorMentor) {
                // Professor relationship events
                events.push({
                    category: "Academic",
                    title: `Meeting with ${state.university.professorMentor.name}`,
                    desc: "Your mentor wants to discuss your progress and future plans.",
                    choices: [
                        {
                            text: "Ask for a recommendation letter",
                            effect: () => {
                                let check = rollWithModifier(state.university.professorRelationship, 12);
                                if (check.success) {
                                    state.career.networkContacts += 15;
                                    state.university.professorRelationship += 10;
                                    return { icon: "üìú", text: `[Rolled ${check.total} vs DC 12] "${state.university.professorMentor.name} speaks highly of you" - that letter will open doors.`, stats: "+15 Network, +10 Prof relationship" };
                                }
                                state.stress += 5;
                                return { icon: "üò¨", text: `[Rolled ${check.total} vs DC 12] "Perhaps after you improve your work..." Ouch.`, stats: "+5 Stress" };
                            }
                        },
                        {
                            text: "Discuss research ideas",
                            effect: () => {
                                state.skills.technical += 3;
                                state.university.professorRelationship += 5;
                                state.energy -= 10;
                                return { icon: "üí°", text: `${state.university.professorMentor.name} shares insights you won't find in textbooks.`, stats: "+3 Technical, +5 Prof relationship" };
                            }
                        },
                        {
                            text: "Ask about career paths",
                            effect: () => {
                                state.skills.social += 2;
                                state.career.networkContacts += 5;
                                return { icon: "üó∫Ô∏è", text: "Real talk about what comes after graduation.", stats: "+2 Social, +5 Network" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.82) {
                // VARIED CAMPUS LIFE EVENTS - All with tradeoffs
                let campusEventType = Math.random();
                
                if (campusEventType < 0.12 && state.university.studyBuddy) {
                    // FRIEND VS EXAM - Classic college dilemma
                    events.push({
                        category: "‚öñÔ∏è Dilemma",
                        title: "Night Before the Exam",
                        desc: `You have a big test tomorrow. ${state.university.studyBuddy} texts: "Everyone's going to this party, last one before finals. You in?"`,
                        choices: [
                            {
                                text: "Go to the party - you only live once",
                                effect: () => {
                                    state.happiness += 15;
                                    state.university.studyBuddyRelationship += 10;
                                    state.skills.social += 2;
                                    state.energy -= 20;
                                    state.gpa = Math.max(0, state.gpa - 0.15);
                                    return { icon: "üéâ", text: `Amazing night. Worth it? Ask yourself tomorrow during the exam.`, stats: "+15 Happy, +10 Bond, -0.15 GPA" };
                                }
                            },
                            {
                                text: "Study instead - grades matter",
                                effect: () => {
                                    state.university.studyBuddyRelationship -= 5;
                                    state.gpa = Math.min(4.0, state.gpa + 0.1);
                                    state.stress += 5;
                                    state.happiness -= 5;
                                    return { icon: "üìö", text: `FOMO is real, but you feel prepared. ${state.university.studyBuddy} sends pics of what you're missing.`, stats: "+0.1 GPA, -5 Bond, -5 Happy" };
                                }
                            },
                            {
                                text: "Go for an hour, then study",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social, 12);
                                    if (check.success) {
                                        state.happiness += 8;
                                        state.university.studyBuddyRelationship += 3;
                                        return { icon: "üéØ", text: `[Rolled ${check.total}] Balanced it perfectly. Quick appearance, then home to study.`, stats: "+8 Happy, +3 Bond" };
                                    }
                                    state.energy -= 25;
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    return { icon: "üòµ", text: `[Rolled ${check.total}] "One hour" became four. You stumble home at 2am.`, stats: "-0.1 GPA, -25 Energy" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.24) {
                    // BURNOUT CHECK
                    events.push({
                        category: "üß† Mental Health",
                        title: "Hitting a Wall",
                        desc: "You've been grinding hard. Everything feels overwhelming. Your body is screaming for a break.",
                        choices: [
                            {
                                text: "Take a mental health day",
                                effect: () => {
                                    state.stress -= 20;
                                    state.energy += 25;
                                    state.happiness += 10;
                                    state.gpa = Math.max(0, state.gpa - 0.05);
                                    return { icon: "üõå", text: "Skip class. Sleep in. Watch movies. Sometimes you need to recharge.", stats: "-20 Stress, +25 Energy, -0.05 GPA" };
                                }
                            },
                            {
                                text: "Push through - finals are coming",
                                effect: () => {
                                    state.stress += 15;
                                    state.energy -= 15;
                                    state.health -= 5;
                                    state.gpa = Math.min(4.0, state.gpa + 0.08);
                                    return { icon: "üò§", text: "Coffee. More coffee. You're running on fumes but keeping up.", stats: "+0.08 GPA, +15 Stress, -5 Health" };
                                }
                            },
                            {
                                text: "Hit the gym - exercise helps",
                                condition: () => state.fitness.gymMember,
                                effect: () => {
                                    state.stress -= 10;
                                    state.energy -= 10;
                                    state.health += 5;
                                    state.skills.physical += 1;
                                    return { icon: "üí™", text: "Endorphins kick in. You feel human again.", stats: "-10 Stress, +5 Health" };
                                }
                            },
                            {
                                text: "Call home - need to hear a familiar voice",
                                effect: () => {
                                    state.stress -= 12;
                                    state.happiness += 8;
                                    if (state.characterTraits.familyWealth >= 7) {
                                        state.money += 100;
                                        return { icon: "üì±", text: "Mom sends a care package and some 'emergency' money.", stats: "-12 Stress, +8 Happy, +$100" };
                                    }
                                    return { icon: "üì±", text: "Sometimes you just need to hear 'I'm proud of you.'", stats: "-12 Stress, +8 Happy" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.36) {
                    // SLEEP VS STUDY
                    events.push({
                        category: "‚öñÔ∏è Dilemma",
                        title: "2 AM Decision",
                        desc: "You've been studying for hours. The material isn't sticking. Your bed looks so inviting.",
                        choices: [
                            {
                                text: "Keep studying - sleep when you're dead",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.technical, 14);
                                    state.energy -= 20;
                                    state.health -= 5;
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.12);
                                        return { icon: "üåô", text: `[Rolled ${check.total}] Something clicks at 3am. You finally get it!`, stats: "+0.12 GPA, -20 Energy, -5 Health" };
                                    }
                                    state.stress += 10;
                                    return { icon: "üòµ", text: `[Rolled ${check.total}] Stared at the same page for an hour. Wasted effort.`, stats: "-20 Energy, +10 Stress" };
                                }
                            },
                            {
                                text: "Sleep now, wake up early",
                                effect: () => {
                                    let check = rollWithModifier(0, 10); // Pure willpower
                                    if (check.roll >= 12) {
                                        state.energy += 15;
                                        state.gpa = Math.min(4.0, state.gpa + 0.05);
                                        return { icon: "‚è∞", text: `[Rolled ${check.roll}] Actually woke up at 6am. Morning study session!`, stats: "+15 Energy, +0.05 GPA" };
                                    }
                                    state.energy += 20;
                                    state.gpa = Math.max(0, state.gpa - 0.05);
                                    return { icon: "üò¥", text: `[Rolled ${check.roll}] Slept through all your alarms. Classic.`, stats: "+20 Energy, -0.05 GPA" };
                                }
                            },
                            {
                                text: "Power nap (20 minutes)",
                                effect: () => {
                                    state.energy += 10;
                                    state.gpa = Math.min(4.0, state.gpa + 0.03);
                                    return { icon: "üòå", text: "Science says this works. Feels like it might have helped.", stats: "+10 Energy, +0.03 GPA" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.48) {
                    // WORK VS CLASS
                    events.push({
                        category: "‚öñÔ∏è Dilemma",
                        title: "Schedule Conflict",
                        desc: state.employed ? 
                            "Your boss wants you to pick up extra shifts this week. But you have a group project meeting." :
                            "A tutoring opportunity pays $30/hour. But it conflicts with a class you're struggling in.",
                        choices: [
                            {
                                text: "Prioritize money",
                                effect: () => {
                                    state.money += state.employed ? 150 : 90;
                                    state.gpa = Math.max(0, state.gpa - 0.1);
                                    state.stress += 8;
                                    return { icon: "üíµ", text: "Bills don't pay themselves. You'll catch up on the material later... probably.", stats: `+$${state.employed ? 150 : 90}, -0.1 GPA, +8 Stress` };
                                }
                            },
                            {
                                text: "Prioritize school",
                                effect: () => {
                                    state.gpa = Math.min(4.0, state.gpa + 0.08);
                                    state.stress += 5;
                                    if (state.employed) {
                                        state.career.performanceRating = Math.max(0, (state.career.performanceRating || 50) - 5);
                                    }
                                    return { icon: "üìö", text: "School comes first. That's what you're here for.", stats: "+0.08 GPA, +5 Stress" };
                                }
                            },
                            {
                                text: "Try to do both (exhausting)",
                                effect: () => {
                                    let check = rollWithModifier(state.energy, 50);
                                    if (check.success) {
                                        state.money += state.employed ? 100 : 60;
                                        state.gpa = Math.min(4.0, state.gpa + 0.03);
                                        state.energy -= 30;
                                        return { icon: "üò§", text: `[Rolled ${check.total}] Somehow pulled it off. Barely.`, stats: `+$${state.employed ? 100 : 60}, +0.03 GPA, -30 Energy` };
                                    }
                                    state.energy -= 25;
                                    state.stress += 15;
                                    return { icon: "üíÄ", text: `[Rolled ${check.total}] Overcommitted. Both suffered.`, stats: "-25 Energy, +15 Stress" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.60) {
                    // DATING VS STUDYING
                    let crushName = state.gender === 'male' ? 
                        ['Emma', 'Sofia', 'Olivia', 'Mia', 'Ava'][Math.floor(Math.random() * 5)] :
                        ['Jake', 'Ryan', 'Tyler', 'Alex', 'Chris'][Math.floor(Math.random() * 5)];
                    events.push({
                        category: "üíï Romance",
                        title: "Cute Classmate",
                        desc: `${crushName} from your study group keeps finding excuses to talk to you. They just asked if you want to grab coffee.`,
                        choices: [
                            {
                                text: "Yes! Finally some fun",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social + calculateAppeal(), 12);
                                    state.happiness += 10;
                                    state.energy -= 10;
                                    state.gpa = Math.max(0, state.gpa - 0.03);
                                    
                                    if (check.nat20) {
                                        if (!state.hasPartner) {
                                            state.hasPartner = true;
                                            state.partnerName = crushName;
                                            state.partnerStats = generatePartner();
                                            state.relationshipWeeks = 0;
                                            return { icon: "üíò", text: `[NAT 20!] Coffee turned into dinner turned into... you're dating ${crushName} now!`, stats: "+10 Happy, New relationship!" };
                                        }
                                    }
                                    if (check.success) {
                                        state.skills.social += 2;
                                        return { icon: "‚òï", text: `[Rolled ${check.total}] Great conversation! ${crushName} wants to hang out again.`, stats: "+10 Happy, +2 Social" };
                                    }
                                    return { icon: "üòÖ", text: `[Rolled ${check.total}] Awkward silence. You both made excuses to leave.`, stats: "+5 Happy, -0.03 GPA" };
                                }
                            },
                            {
                                text: "Rain check - midterms are killing me",
                                effect: () => {
                                    state.gpa = Math.min(4.0, state.gpa + 0.05);
                                    state.happiness -= 5;
                                    return { icon: "üì±", text: `${crushName} says "sure" but looks disappointed. Focus on grades.`, stats: "+0.05 GPA, -5 Happy" };
                                }
                            },
                            {
                                text: "Study date? Best of both worlds",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social, 11);
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.05);
                                        state.happiness += 8;
                                        state.skills.social += 1;
                                        return { icon: "üìöüíï", text: `[Rolled ${check.total}] Actually got work done AND had fun. ${crushName} is impressed.`, stats: "+0.05 GPA, +8 Happy" };
                                    }
                                    state.happiness += 5;
                                    return { icon: "üòä", text: `[Rolled ${check.total}] More flirting than studying, but worth it.`, stats: "+5 Happy" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.72) {
                    // HEALTH VS ACADEMICS
                    events.push({
                        category: "üè• Health",
                        title: "Feeling Sick",
                        desc: "You wake up feeling terrible. Sore throat, headache, the works. But you have class today.",
                        choices: [
                            {
                                text: "Power through it",
                                effect: () => {
                                    state.health -= 10;
                                    state.energy -= 15;
                                    let check = rollWithModifier(state.health, 40);
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.03);
                                        return { icon: "ü§ß", text: `[Rolled ${check.total}] Survived. Didn't miss anything important.`, stats: "+0.03 GPA, -10 Health" };
                                    }
                                    state.health -= 10;
                                    return { icon: "ü§Æ", text: `[Rolled ${check.total}] Made it worse. Now you're really sick.`, stats: "-20 Health, -15 Energy" };
                                }
                            },
                            {
                                text: "Stay in bed - health first",
                                effect: () => {
                                    state.health += 10;
                                    state.energy += 20;
                                    state.gpa = Math.max(0, state.gpa - 0.05);
                                    return { icon: "üõå", text: "Rest, fluids, Netflix. You'll recover faster this way.", stats: "+10 Health, +20 Energy, -0.05 GPA" };
                                }
                            },
                            {
                                text: "Email professor, attend virtually",
                                effect: () => {
                                    state.health += 5;
                                    let check = rollWithModifier(state.skills.technical, 10);
                                    if (check.success) {
                                        return { icon: "üíª", text: `[Rolled ${check.total}] Zoom from bed. Professor appreciates your dedication.`, stats: "+5 Health" };
                                    }
                                    state.gpa = Math.max(0, state.gpa - 0.02);
                                    return { icon: "üìµ", text: `[Rolled ${check.total}] WiFi issues. Missed half the lecture anyway.`, stats: "+5 Health, -0.02 GPA" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.84) {
                    // SPRING BREAK DILEMMA
                    events.push({
                        category: "üèñÔ∏è Break Time",
                        title: "Spring Break Plans",
                        desc: "Everyone's talking about spring break. Your friends are planning a trip. But it's not cheap.",
                        choices: [
                            {
                                text: "Join the trip ($400)",
                                condition: () => state.money >= 400,
                                effect: () => {
                                    state.money -= 400;
                                    state.happiness += 25;
                                    state.stress -= 20;
                                    state.skills.social += 3;
                                    state.energy -= 15; // Exhausting but fun
                                    return { icon: "üèñÔ∏è", text: "Best week ever. Memories that'll last a lifetime.", stats: "-$400, +25 Happy, -20 Stress, +3 Social" };
                                }
                            },
                            {
                                text: "Put it on credit card",
                                condition: () => state.finances.hasCreditCard && (state.finances.creditLimit - state.finances.creditBalance) >= 400,
                                effect: () => {
                                    state.finances.creditBalance += 400;
                                    state.happiness += 25;
                                    state.stress -= 15; // Less stress relief knowing you owe money
                                    state.skills.social += 3;
                                    return { icon: "üí≥", text: "YOLO. You'll figure out the bill later.", stats: "+$400 CC debt, +25 Happy, +3 Social" };
                                }
                            },
                            {
                                text: "Stay on campus and study",
                                effect: () => {
                                    state.gpa = Math.min(4.0, state.gpa + 0.15);
                                    state.skills.technical += 2;
                                    state.happiness -= 10;
                                    state.stress += 5;
                                    return { icon: "üìö", text: "Empty campus. Perfect for catching up. But the FOMO is real.", stats: "+0.15 GPA, +2 Technical, -10 Happy" };
                                }
                            },
                            {
                                text: "Go home and work",
                                effect: () => {
                                    state.money += 300;
                                    state.stress -= 10;
                                    state.happiness += 5;
                                    return { icon: "üè†", text: "Mom's cooking, your old room, and some shifts at a local job. Not bad.", stats: "+$300, -10 Stress, +5 Happy" };
                                }
                            }
                        ]
                    });
                } else if (campusEventType < 0.92 && state.university.studyBuddy) {
                    // FRIEND IN TROUBLE
                    events.push({
                        category: "üë• Friendship",
                        title: `${state.university.studyBuddy}'s Crisis`,
                        desc: `${state.university.studyBuddy} texts at midnight: "Can we talk? It's important." You have an 8am class.`,
                        choices: [
                            {
                                text: "Go be there for them",
                                effect: () => {
                                    state.university.studyBuddyRelationship += 25;
                                    state.skills.social += 3;
                                    state.energy -= 25;
                                    state.happiness += 5;
                                    state.gpa = Math.max(0, state.gpa - 0.05);
                                    return { icon: "ü§ù", text: `You stayed up until 4am talking. ${state.university.studyBuddy} really needed someone.`, stats: "+25 Bond, +3 Social, -0.05 GPA" };
                                }
                            },
                            {
                                text: "Call but keep it short",
                                effect: () => {
                                    state.university.studyBuddyRelationship += 8;
                                    state.energy -= 10;
                                    return { icon: "üì±", text: "Quick check-in. They understand you have class.", stats: "+8 Bond, -10 Energy" };
                                }
                            },
                            {
                                text: "Text that you'll talk tomorrow",
                                effect: () => {
                                    state.university.studyBuddyRelationship -= 10;
                                    return { icon: "üí§", text: "\"Sure, tomorrow.\" They seem a bit hurt but say it's fine.", stats: "-10 Bond" };
                                }
                            }
                        ]
                    });
                } else {
                    // GROUP PROJECT DRAMA
                    events.push({
                        category: "üìã Teamwork",
                        title: "Group Project Disaster",
                        desc: "Your group project partner ghosted. Deadline is in 3 days. You have their half unfinished.",
                        choices: [
                            {
                                text: "Do their part yourself",
                                effect: () => {
                                    state.energy -= 30;
                                    state.stress += 20;
                                    let check = rollWithModifier(state.skills.technical, 13);
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.2);
                                        state.skills.technical += 2;
                                        return { icon: "üí™", text: `[Rolled ${check.total}] Did it all yourself. Actually learned a lot.`, stats: "+0.2 GPA, +2 Technical, -30 Energy" };
                                    }
                                    state.gpa = Math.min(4.0, state.gpa + 0.1);
                                    return { icon: "üò´", text: `[Rolled ${check.total}] Pulled it off, barely. Never again.`, stats: "+0.1 GPA, +20 Stress" };
                                }
                            },
                            {
                                text: "Tell the professor what happened",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social, 11);
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.15);
                                        return { icon: "üéì", text: `[Rolled ${check.total}] Professor understands. You get graded individually.`, stats: "+0.15 GPA" };
                                    }
                                    state.gpa = Math.min(4.0, state.gpa + 0.05);
                                    return { icon: "üòê", text: `[Rolled ${check.total}] "That's between you and your partner." Still have to finish it.`, stats: "+0.05 GPA" };
                                }
                            },
                            {
                                text: "Hunt down your partner and confront them",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social, 14);
                                    if (check.nat20) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.15);
                                        state.skills.social += 2;
                                        return { icon: "üåü", text: "[NAT 20!] They had a family emergency. They apologize and finish their part overnight.", stats: "+0.15 GPA, +2 Social" };
                                    }
                                    if (check.success) {
                                        state.gpa = Math.min(4.0, state.gpa + 0.1);
                                        return { icon: "üò§", text: `[Rolled ${check.total}] Guilt-tripped them into doing half. Team tension but it's done.`, stats: "+0.1 GPA" };
                                    }
                                    state.stress += 15;
                                    return { icon: "üôÑ", text: `[Rolled ${check.total}] They made excuses. You're doing it yourself anyway.`, stats: "+15 Stress" };
                                }
                            }
                        ]
                    });
                }
            } else if (roll < 0.90 && state.university.club) {
                // Club activity events
                let club = CLUBS[state.university.club];
                events.push({
                    category: "Club",
                    title: `${club.name} Event`,
                    desc: state.university.club === 'greek' ? "Philanthropy event this weekend. Attendance is mandatory." :
                          state.university.club === 'sports' ? "Big game coming up. Time to represent." :
                          state.university.club === 'academic' ? "Honor society meeting - discussing grad school prep." :
                          "Club activity this week.",
                    choices: [
                        {
                            text: "Participate actively",
                            effect: () => {
                                state.university.clubWeeks++;
                                state.happiness += club.happiness || 5;
                                state.energy -= club.energy || 10;
                                if (club.physical) state.skills.physical += 2;
                                if (club.social) state.skills.social += 2;
                                if (club.gpaBonus) state.gpa = Math.min(4.0, state.gpa + club.gpaBonus);
                                return { icon: club.icon, text: "Active member. Building memories and resume lines.", stats: `+${club.happiness || 5} Happiness` };
                            }
                        },
                        {
                            text: "Skip it this time",
                            effect: () => {
                                state.energy += 10;
                                if (state.university.club === 'greek') {
                                    state.skills.social -= 3;
                                    return { icon: "üò¨", text: "People noticed you weren't there. Politics.", stats: "-3 Social" };
                                }
                                return { icon: "üõãÔ∏è", text: "Sometimes you need a break.", stats: "+10 Energy" };
                            }
                        }
                    ]
                });
            }
            
            return events;
        }

        function getTradeSchoolEvents() {
            let events = [];
            let roll = Math.random();
            let weekProgress = state.phaseWeek;
            
            // TRADE SELECTION (Week 1)
            if (!state.tradeSchool.trade && weekProgress < 2) {
                return [{
                    category: "Choose Your Trade",
                    title: "What Will You Master?",
                    desc: "Trade school orientation. Time to pick a career path. Each has its own rewards and risks.",
                    choices: Object.entries(TRADES).map(([key, trade]) => ({
                        text: `${trade.icon} ${trade.name} - ${trade.desc}`,
                        effect: () => {
                            state.tradeSchool.trade = key;
                            state.skills[trade.statBonus] += 5;
                            addLog(`Started ${trade.name} training`);
                            return { icon: trade.icon, text: `You're going to be a ${trade.name}. Hard work ahead.`, stats: `+5 ${trade.statBonus}` };
                        }
                    }))
                }];
            }
            
            let trade = TRADES[state.tradeSchool.trade] || TRADES.electrician;
            let certLevel = TRADE_CERT_LEVELS[state.tradeSchool.certLevel];
            
            // MENTOR ASSIGNMENT (Week 2-4)
            if (!state.tradeSchool.mentorName && weekProgress >= 2 && weekProgress < 6) {
                let mentorName = TRADE_MENTOR_NAMES[Math.floor(Math.random() * TRADE_MENTOR_NAMES.length)];
                return [{
                    category: "Apprenticeship",
                    title: "Meet Your Mentor",
                    desc: `${mentorName} has been in the trade for 30 years. Rough hands, rougher attitude. But he knows everything.`,
                    choices: [
                        {
                            text: `Learn from ${mentorName}`,
                            effect: () => {
                                state.tradeSchool.mentorName = mentorName;
                                state.tradeSchool.mentorRelationship = 40;
                                state.skills.technical += 3;
                                return { icon: "üë∑", text: `"Don't touch anything until I say so." ${mentorName} will teach you the RIGHT way.`, stats: "+3 Technical, Mentor gained" };
                            }
                        }
                    ]
                }];
            }
            
            // TOOL QUALITY UPGRADE OPPORTUNITY (Every 20 weeks)
            if (state.tradeSchool.toolQuality < 3 && weekProgress % 20 === 15 && weekProgress > 10) {
                let upgradeCost = state.tradeSchool.toolQuality === 1 ? 500 : 1500;
                let newLevel = state.tradeSchool.toolQuality === 1 ? "Professional" : "Premium";
                return [{
                    category: "Equipment",
                    title: "Tool Upgrade Available",
                    desc: `Your ${state.tradeSchool.toolQuality === 1 ? 'basic' : 'professional'} tools are holding you back. ${newLevel} gear would make the work easier and safer.`,
                    choices: [
                        {
                            text: `Buy ${newLevel} tools ($${upgradeCost})`,
                            condition: () => state.money >= upgradeCost,
                            effect: () => {
                                state.money -= upgradeCost;
                                state.tradeSchool.toolQuality++;
                                state.skills.technical += 5;
                                return { icon: "üß∞", text: `Quality tools make quality work. ${state.tradeSchool.mentorName} approves.`, stats: `-$${upgradeCost}, +5 Technical, Better safety` };
                            }
                        },
                        {
                            text: "Make do with what you have",
                            effect: () => {
                                return { icon: "üîß", text: "A bad workman blames his tools... but good tools help.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // UNION OPPORTUNITY (Week 30+)
            if (!state.tradeSchool.unionMember && weekProgress >= 30 && roll < 0.15) {
                return [{
                    category: "Career",
                    title: "Union Recruitment",
                    desc: `The ${trade.name}s Union wants you. Better pay, job protection, but dues and politics.`,
                    choices: [
                        {
                            text: "Join the union ($50/month dues)",
                            effect: () => {
                                state.tradeSchool.unionMember = true;
                                state.weeklyExpenses += 12;
                                state.career.networkContacts += 15;
                                addLog(`Joined ${trade.name}s Union`);
                                return { icon: "‚úä", text: "Welcome, brother/sister. Solidarity. Better contracts, better protection.", stats: "+$12/week expenses, +15 Network, Union benefits" };
                            }
                        },
                        {
                            text: "Stay independent",
                            effect: () => {
                                state.skills.social -= 3;
                                return { icon: "üö∂", text: "Not for you. Some call it stubborn. You call it freedom.", stats: "-3 Social (with union workers)" };
                            }
                        }
                    ]
                }];
            }
            
            // CERTIFICATION EXAM (At milestones)
            let examWeek = state.tradeSchool.certLevel === 0 ? 40 : 
                          state.tradeSchool.certLevel === 1 ? 65 : 
                          state.tradeSchool.certLevel === 2 ? 78 : -1;
            
            if (weekProgress === examWeek && state.tradeSchool.certLevel < 3) {
                let nextCert = TRADE_CERT_LEVELS[state.tradeSchool.certLevel + 1];
                return [{
                    category: "‚≠ê CERTIFICATION",
                    title: `${nextCert.name} Exam`,
                    desc: `Time to prove you've earned the ${nextCert.name} certification. Written test AND practical demonstration.`,
                    choices: [
                        {
                            text: "üé≤ Take the exam (Technical check)",
                            effect: () => {
                                let dc = 12 + (state.tradeSchool.certLevel * 2);
                                let bonus = state.tradeSchool.toolQuality * 2 + (state.tradeSchool.mentorRelationship > 60 ? 3 : 0);
                                let check = rollWithModifier(state.skills.technical + bonus, dc);
                                
                                if (check.nat20) {
                                    state.tradeSchool.certLevel++;
                                    state.skills.technical += 10;
                                    state.happiness += 20;
                                    state.money += 500;
                                    addLog(`Achieved ${nextCert.name} certification with top marks`);
                                    return { icon: "üèÜ", text: `[NAT 20!] PERFECT SCORE! You're the best they've seen in years.`, stats: `Now ${nextCert.name}, +10 Technical, +$500 bonus` };
                                }
                                if (check.success) {
                                    state.tradeSchool.certLevel++;
                                    state.skills.technical += 5;
                                    state.happiness += 15;
                                    addLog(`Achieved ${nextCert.name} certification`);
                                    return { icon: "üìú", text: `[Rolled ${check.total} vs DC ${dc}] You passed! ${nextCert.name} certified.`, stats: `Now ${nextCert.name}, +5 Technical` };
                                }
                                if (check.nat1) {
                                    state.stress += 25;
                                    state.happiness -= 20;
                                    state.tradeSchool.mentorRelationship -= 10;
                                    return { icon: "üíÄ", text: `[NAT 1!] Complete disaster. You damaged the testing equipment.`, stats: "+25 Stress, -20 Happiness, Retry in 4 weeks" };
                                }
                                state.stress += 15;
                                return { icon: "üòî", text: `[Rolled ${check.total} vs DC ${dc}] Not this time. Try again in 4 weeks.`, stats: "+15 Stress" };
                            }
                        }
                    ]
                }];
            }
            
            // JOB SITE ACCIDENT EVENT
            if (roll < 0.03 * trade.dangerLevel && weekProgress > 10) {
                let safetyBonus = state.tradeSchool.toolQuality * 3 + (state.tradeSchool.mentorRelationship > 50 ? 5 : 0);
                return [{
                    category: "‚ö†Ô∏è DANGER",
                    title: "Workplace Accident!",
                    desc: trade.name === "Electrician" ? "Live wire where it shouldn't be. Your hand is inches away." :
                          trade.name === "Welder" ? "Sparks catch your sleeve. Fire!" :
                          trade.name === "Plumber" ? "Pipe burst. Scalding water everywhere." :
                          trade.name === "HVAC Technician" ? "Refrigerant leak. Can't breathe." :
                          "Something went wrong. Fast.",
                    choices: [
                        {
                            text: "üé≤ React fast (Physical + Safety check)",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical + safetyBonus, 14);
                                
                                if (check.nat20) {
                                    state.skills.technical += 5;
                                    state.tradeSchool.safetyIncidents++;
                                    if (state.tradeSchool.mentorName) state.tradeSchool.mentorRelationship += 10;
                                    return { icon: "‚ö°", text: `[NAT 20!] Superhuman reflexes! Crisis averted brilliantly.`, stats: "+5 Technical, +10 Mentor respect" };
                                }
                                if (check.success) {
                                    state.tradeSchool.safetyIncidents++;
                                    state.stress += 15;
                                    return { icon: "üòÖ", text: `[Rolled ${check.total} vs DC 14] Close call! Heart pounding, but you're okay.`, stats: "+15 Stress" };
                                }
                                if (check.nat1) {
                                    state.health -= 30;
                                    state.tradeSchool.injuries++;
                                    state.money -= 500;
                                    state.stress += 30;
                                    addLog("Serious workplace injury");
                                    return { icon: "üè•", text: `[NAT 1!] CRITICAL INJURY! Hospital. Weeks of recovery ahead.`, stats: "-30 Health, -$500 medical, +30 Stress" };
                                }
                                state.health -= 15;
                                state.tradeSchool.injuries++;
                                state.stress += 20;
                                return { icon: "ü©π", text: `[Rolled ${check.total} vs DC 14] Got hurt. Not critical, but painful.`, stats: "-15 Health, +20 Stress" };
                            }
                        }
                    ]
                }];
            }
            
            // CLIENT WORK (After becoming apprentice)
            if (state.tradeSchool.certLevel >= 1 && roll < 0.25) {
                let client = TRADE_CLIENT_TYPES[Math.floor(Math.random() * TRADE_CLIENT_TYPES.length)];
                let basePay = trade.baseHourlyPay * 40 * TRADE_CERT_LEVELS[state.tradeSchool.certLevel].hourlyMultiplier;
                let jobPay = Math.floor(basePay * client.pay);
                
                return [{
                    category: "Job",
                    title: `${client.type} Job`,
                    desc: client.type === "Emergency" ? `3 AM call. ${trade.name === 'Plumber' ? 'Flooded basement' : 'System failure'}. They're desperate.` :
                          client.type === "Industrial" ? `Big factory contract. Complex work, tight deadline.` :
                          client.type === "Commercial" ? `Office building needs work. Professional environment.` :
                          `Homeowner needs ${trade.name.toLowerCase()} work done.`,
                    choices: [
                        {
                            text: `üé≤ Do the job ($${jobPay})`,
                            effect: () => {
                                let dc = client.difficulty;
                                let toolBonus = state.tradeSchool.toolQuality * 2;
                                let check = rollWithModifier(state.skills.technical + toolBonus, dc);
                                
                                state.tradeSchool.projectsCompleted++;
                                state.energy -= 20;
                                state.stress += client.stressBonus;
                                
                                if (check.nat20) {
                                    let bonus = Math.floor(jobPay * 0.5);
                                    state.money += jobPay + bonus;
                                    state.tradeSchool.clientRating = Math.min(100, state.tradeSchool.clientRating + 15);
                                    state.skills.technical += 3;
                                    state.tradeSchool.hoursLogged += 50;
                                    return { icon: "üåü", text: `[NAT 20!] PERFECT JOB! Client tips big and promises referrals.`, stats: `+$${jobPay + bonus}, +15 Rating, +3 Technical` };
                                }
                                if (check.success) {
                                    state.money += jobPay;
                                    state.tradeSchool.clientRating = Math.min(100, state.tradeSchool.clientRating + 5);
                                    state.skills.technical += 1;
                                    state.tradeSchool.hoursLogged += 40;
                                    return { icon: "‚úÖ", text: `[Rolled ${check.total} vs DC ${dc}] Job done right. Client satisfied.`, stats: `+$${jobPay}, +5 Rating` };
                                }
                                if (check.nat1) {
                                    state.tradeSchool.clientRating = Math.max(0, state.tradeSchool.clientRating - 20);
                                    state.money += Math.floor(jobPay * 0.3);
                                    state.happiness -= 15;
                                    return { icon: "üò±", text: `[NAT 1!] DISASTER! Made it worse. Reputation hit.`, stats: `+$${Math.floor(jobPay * 0.3)}, -20 Rating` };
                                }
                                state.money += Math.floor(jobPay * 0.7);
                                state.tradeSchool.clientRating = Math.max(0, state.tradeSchool.clientRating - 5);
                                return { icon: "üòê", text: `[Rolled ${check.total} vs DC ${dc}] Had to fix issues. Partial pay.`, stats: `+$${Math.floor(jobPay * 0.7)}, -5 Rating` };
                            }
                        },
                        {
                            text: "Pass on this one",
                            effect: () => {
                                if (client.type === "Emergency") {
                                    state.tradeSchool.clientRating = Math.max(0, state.tradeSchool.clientRating - 10);
                                    return { icon: "üìµ", text: "Emergency calls build reputation. Missed opportunity.", stats: "-10 Rating" };
                                }
                                return { icon: "ü§∑", text: "There'll be other jobs.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // MENTOR RELATIONSHIP EVENTS
            if (state.tradeSchool.mentorName && roll < 0.35) {
                let mentorEvent = Math.random();
                
                if (mentorEvent < 0.3) {
                    return [{
                        category: "Training",
                        title: `${state.tradeSchool.mentorName}'s Secret`,
                        desc: `"Come here, kid. Let me show you something they don't teach in books."`,
                        choices: [
                            {
                                text: "Watch and learn",
                                effect: () => {
                                    state.skills.technical += 4;
                                    state.tradeSchool.mentorRelationship += 8;
                                    state.tradeSchool.hoursLogged += 10;
                                    return { icon: "üí°", text: `${state.tradeSchool.mentorName} shares a trick from 30 years in the trade.`, stats: "+4 Technical, +8 Mentor bond" };
                                }
                            }
                        ]
                    }];
                } else if (mentorEvent < 0.5 && state.tradeSchool.mentorRelationship > 60) {
                    return [{
                        category: "Opportunity",
                        title: "Moonlight Job",
                        desc: `${state.tradeSchool.mentorName}: "I got a side job this weekend. Good money. You in?"`,
                        choices: [
                            {
                                text: "Let's do it ($300)",
                                effect: () => {
                                    state.money += 300;
                                    state.energy -= 25;
                                    state.skills.technical += 3;
                                    state.tradeSchool.hoursLogged += 20;
                                    state.tradeSchool.mentorRelationship += 5;
                                    return { icon: "üí∞", text: "Working alongside the master. Learning and earning.", stats: "+$300, +3 Technical, +5 Mentor bond" };
                                }
                            },
                            {
                                text: "Need the rest",
                                effect: () => {
                                    state.tradeSchool.mentorRelationship -= 5;
                                    state.energy += 15;
                                    return { icon: "üò¥", text: `${state.tradeSchool.mentorName} shrugs. "Your loss, kid."`, stats: "-5 Mentor bond, +15 Energy" };
                                }
                            }
                        ]
                    }];
                } else if (mentorEvent < 0.7) {
                    return [{
                        category: "Training",
                        title: "Harsh Feedback",
                        desc: `${state.tradeSchool.mentorName} examines your work. Shakes his head. "This is garbage. Do it again."`,
                        choices: [
                            {
                                text: "Accept it and redo",
                                effect: () => {
                                    state.skills.technical += 2;
                                    state.energy -= 15;
                                    state.tradeSchool.mentorRelationship += 5;
                                    return { icon: "üò§", text: "Swallow your pride. He's right. Better this time.", stats: "+2 Technical, +5 Mentor bond" };
                                }
                            },
                            {
                                text: "Push back",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social, 14);
                                    if (check.success) {
                                        state.tradeSchool.mentorRelationship += 3;
                                        return { icon: "ü§ù", text: `[Rolled ${check.total}] You defend your work. ${state.tradeSchool.mentorName} respects the backbone.`, stats: "+3 Mentor bond" };
                                    }
                                    state.tradeSchool.mentorRelationship -= 15;
                                    state.stress += 10;
                                    return { icon: "üò†", text: `[Rolled ${check.total}] "Don't talk back to me." Tension.`, stats: "-15 Mentor bond, +10 Stress" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // REGULAR TRAINING EVENTS
            if (roll < 0.2) {
                events.push({
                    category: "Training",
                    title: "Hands-On Test",
                    desc: `Practical exam. ${state.tradeSchool.mentorName || 'The instructor'} is evaluating.`,
                    choices: [
                        {
                            text: "üé≤ Focus and execute",
                            effect: () => {
                                let check = rollWithModifier(state.skills.technical, 11);
                                state.energy -= 15;
                                state.tradeSchool.hoursLogged += 8;
                                
                                if (check.nat20) {
                                    state.skills.technical += 6;
                                    return { icon: "‚≠ê", text: "[NAT 20!] Flawless execution. Even the old-timers are impressed.", stats: "+6 Technical" };
                                }
                                if (check.success) {
                                    state.skills.technical += 4;
                                    return { icon: "‚úÖ", text: `[Rolled ${check.total}] Clean work. Passing grade.`, stats: "+4 Technical" };
                                }
                                state.skills.technical += 1;
                                return { icon: "üìù", text: `[Rolled ${check.total}] Some mistakes. Notes for improvement.`, stats: "+1 Technical" };
                            }
                        },
                        {
                            text: "Ask mentor for help",
                            condition: () => state.tradeSchool.mentorName && state.tradeSchool.mentorRelationship > 30,
                            effect: () => {
                                state.skills.technical += 4;
                                state.tradeSchool.mentorRelationship += 3;
                                return { icon: "üë∑", text: `${state.tradeSchool.mentorName} walks you through it.`, stats: "+4 Technical, +3 Mentor bond" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.35) {
                events.push({
                    category: "Opportunity",
                    title: "Side Job Offer",
                    desc: "A local contractor needs help this weekend. Cash under the table.",
                    choices: [
                        {
                            text: "Take the gig ($200)",
                            effect: () => {
                                state.money += 200;
                                state.energy -= 25;
                                state.skills.technical += 3;
                                state.skills.physical += 2;
                                state.tradeSchool.hoursLogged += 16;
                                return { icon: "üí∞", text: "Hard work but good money. Real experience.", stats: "+$200, +3 Technical, +2 Physical" };
                            }
                        },
                        {
                            text: "Rest up instead",
                            effect: () => {
                                state.energy += 20;
                                state.happiness += 5;
                                return { icon: "üò¥", text: "Sometimes you need a weekend off.", stats: "+20 Energy, +5 Happiness" };
                            }
                        }
                    ]
                });
            }
            
            return events;
        }

        function getMilitaryTrainingEvents() {
            let events = [];
            let week = state.phaseWeek;
            
            // Week 0: Arrival
            if (week === 0) {
                return [{
                    category: "Boot Camp",
                    title: "Welcome to Hell",
                    desc: "The bus stops. A drill sergeant boards, screaming. \"GET OFF MY BUS! MOVE MOVE MOVE!\" A recruit next to you is frozen in terror.",
                    choices: [
                        {
                            text: "Sprint off first - every man for himself",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical, 10);
                                state.stress += 20;
                                state.energy -= 25;
                                if (check.success) {
                                    state.skills.physical += 3;
                                    state.military.combatXP += 2;
                                    return { icon: "üèÉ", text: `[Rolled ${check.total} vs DC 10] First off the bus. The drill sergeant nods. "At least ONE of you isn't useless."`, stats: "+3 Physical, +2 XP" };
                                }
                                state.happiness -= 5;
                                return { icon: "üò∞", text: `[Rolled ${check.total}] You tried but stumbled. "PUSHUPS! NOW!"`, stats: "-5 Happiness" };
                            }
                        },
                        {
                            text: "Grab the frozen recruit and drag them with you",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical + state.skills.social, 12);
                                state.stress += 25;
                                state.energy -= 30;
                                if (check.success) {
                                    state.skills.social += 3;
                                    state.military.squadMorale += 10;
                                    return { icon: "ü§ù", text: `[Rolled ${check.total} vs DC 12] You pull them along. Later, they find you: "Thanks. I'm ${BUDDY_NAMES[Math.floor(Math.random() * BUDDY_NAMES.length)]}." You've made a friend.`, stats: "+3 Social, +Squad Morale" };
                                }
                                state.happiness -= 10;
                                return { icon: "üò§", text: `[Rolled ${check.total}] You both end up last. Double punishment. But they remember you tried.`, stats: "-10 Happiness, But earned respect" };
                            }
                        },
                        {
                            text: "Stay calm, move efficiently - don't panic",
                            effect: () => {
                                state.stress += 15;
                                state.energy -= 20;
                                state.skills.technical += 2;
                                return { icon: "üß†", text: "While others scramble, you move with purpose. The drill sergeant's eyes track you. Noted.", stats: "+2 Technical, Less stress than panicking" };
                            }
                        }
                    ]
                }];
            }
            
            // Week 1: Red Phase - Basic Discipline
            if (week === 1) {
                state.military.buddyName = BUDDY_NAMES[Math.floor(Math.random() * BUDDY_NAMES.length)];
                return [{
                    category: "Red Phase",
                    title: "Breaking You Down",
                    desc: `5 AM wake-ups. Inspections. PT until you puke. ${state.military.buddyName} is in your platoon - you've been helping each other. The drill sergeant announces a 5-mile run. Your body is already broken.`,
                    choices: [
                        {
                            text: "Push yourself to the absolute limit",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical, 13);
                                state.energy -= 35;
                                state.health -= 5;
                                if (check.success) {
                                    state.skills.physical += 6;
                                    state.military.combatXP += 5;
                                    return { icon: "üèÉ", text: `[Rolled ${check.total} vs DC 13] You finish in the top 10. The pain was worth it. Drill sergeant knows your name now.`, stats: "+6 Physical, +5 XP, -5 Health" };
                                }
                                state.stress += 20;
                                return { icon: "ü§Æ", text: `[Rolled ${check.total}] You push too hard, vomit, keep running. Finish mid-pack. Body is screaming.`, stats: "+3 Physical, +20 Stress, -5 Health" };
                            }
                        },
                        {
                            text: "Pace yourself - survive, don't shine",
                            effect: () => {
                                state.skills.physical += 4;
                                state.stress += 10;
                                state.energy -= 20;
                                return { icon: "üèÉ‚Äç‚ôÇÔ∏è", text: `Steady pace. You finish middle of the pack. ${state.military.buddyName} matches your stride. "Smart."`, stats: "+4 Physical, +10 Stress" };
                            }
                        },
                        {
                            text: "Help a struggling recruit keep up",
                            effect: () => {
                                state.skills.physical += 3;
                                state.skills.social += 3;
                                state.energy -= 30;
                                state.military.squadMorale += 15;
                                return { icon: "ü§ù", text: "You grab a struggling recruit's arm. \"We finish together.\" The platoon notices. Leadership material.", stats: "+3 Physical, +3 Social, +Squad Morale" };
                            }
                        },
                        {
                            text: "Fake a minor injury to get out of it",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 15);
                                if (check.success) {
                                    state.energy += 10;
                                    state.stress -= 5;
                                    return { icon: "ü§ï", text: `[Rolled ${check.total} vs DC 15] Medic buys it. You rest while others run. But you know you cheated.`, stats: "+10 Energy, -5 Stress, No gains" };
                                }
                                state.stress += 25;
                                state.military.combatXP -= 3;
                                return { icon: "üò†", text: `[Rolled ${check.total}] "MALINGERER! You think I'm stupid?!" Extra PT for a week. Everyone knows.`, stats: "+25 Stress, -3 XP, Reputation damaged" };
                            }
                        }
                    ]
                }];
            }
            
            // Week 2-3: White Phase - Rifle Training
            if (week >= 2 && week <= 3) {
                let intelBonus = getIntelligenceDCBonus();
                return [{
                    category: "White Phase",
                    title: "Rifle Qualification",
                    desc: `Week ${week + 1}. You're on the range. The M4 is heavy. 40 targets, 40 rounds. How do you approach it?`,
                    choices: [
                        {
                            text: "Stay up late practicing dry-fire drills",
                            effect: () => {
                                let dc = Math.max(8, 11 - intelBonus);
                                let check = rollWithModifier(state.skills.technical + state.skills.physical, dc);
                                state.skills.technical += 4;
                                state.energy -= 20;
                                
                                if (check.nat20) {
                                    state.military.medals.push("Expert Marksmanship");
                                    state.skills.technical += 4;
                                    return { icon: "üéØ", text: `[NAT 20!] EXPERT! 39/40. Your preparation paid off. Badge earned.`, stats: "+8 Technical, Expert Badge!" };
                                }
                                if (check.success) {
                                    return { icon: "üéØ", text: `[Rolled ${check.total} vs DC ${dc}] Qualified with a solid score. The extra practice showed.`, stats: "+4 Technical" };
                                }
                                state.stress += 10;
                                return { icon: "üò§", text: `[Rolled ${check.total}] Close but not enough. At least you learned something.`, stats: "+4 Technical, +10 Stress" };
                            }
                        },
                        {
                            text: "Trust your natural ability - get sleep instead",
                            effect: () => {
                                let dc = 13;
                                let check = rollWithModifier(state.skills.physical, dc);
                                state.energy += 10;
                                
                                if (check.nat20) {
                                    state.military.medals.push("Expert Marksmanship");
                                    state.skills.technical += 5;
                                    return { icon: "üéØ", text: `[NAT 20!] Natural talent! You're a born shooter. Expert qualification.`, stats: "+5 Technical, Expert Badge!" };
                                }
                                if (check.success) {
                                    state.skills.technical += 2;
                                    return { icon: "üéØ", text: `[Rolled ${check.total} vs DC ${dc}] Qualified. Could've been better with practice, but you passed.`, stats: "+2 Technical, Well rested" };
                                }
                                state.stress += 20;
                                return { icon: "‚ùå", text: `[Rolled ${check.total}] Failed. "Should've practiced, recruit!" Remedial training.`, stats: "+20 Stress, Must retry" };
                            }
                        },
                        {
                            text: "Ask the range instructor for extra coaching",
                            effect: () => {
                                let dc = Math.max(7, 10 - intelBonus);
                                let check = rollWithModifier(state.skills.technical + state.skills.social, dc);
                                state.skills.technical += 3;
                                state.skills.social += 1;
                                
                                if (check.success) {
                                    state.military.combatXP += 3;
                                    return { icon: "üéØ", text: `[Rolled ${check.total} vs DC ${dc}] The instructor's tips clicked. Solid qualification. "Good initiative, recruit."`, stats: "+3 Technical, +1 Social, +3 XP" };
                                }
                                return { icon: "üòê", text: `[Rolled ${check.total}] The coaching helped but not enough. Barely qualified.`, stats: "+3 Technical, +1 Social" };
                            }
                        }
                    ]
                }];
            }
            
            // Week 4-5: Blue Phase - Field Training
            if (week >= 4 && week <= 5) {
                let roll = Math.random();
                
                if (roll < 0.4) {
                    return [{
                        category: "Blue Phase",
                        title: "Night Land Navigation",
                        desc: "2 AM. Just a compass, a map, and the dark. Find 5 checkpoints before dawn or fail.",
                        choices: [
                            {
                                text: "Trust your training",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.technical, 13);
                                    state.energy -= 20;
                                    
                                    if (check.nat1) {
                                        state.health -= 10;
                                        state.stress += 20;
                                        return { icon: "üå≤", text: `[NAT 1!] Completely lost. Fell into a ravine. Medics had to find you. Humiliating.`, stats: "-10 Health, +20 Stress" };
                                    }
                                    if (check.success) {
                                        state.skills.technical += 4;
                                        return { icon: "üß≠", text: `[Rolled ${check.total} vs DC 13] All checkpoints found. You emerge from the woods as the sun rises.`, stats: "+4 Technical" };
                                    }
                                    state.stress += 10;
                                    return { icon: "üåô", text: `[Rolled ${check.total} vs DC 13] Only found 3 checkpoints. Have to redo it next week.`, stats: "+10 Stress" };
                                }
                            },
                            {
                                text: "Follow another recruit",
                                effect: () => {
                                    if (Math.random() > 0.5) {
                                        state.skills.technical += 2;
                                        return { icon: "üë•", text: "They knew what they were doing. You both passed.", stats: "+2 Technical" };
                                    }
                                    state.stress += 20;
                                    state.skills.social -= 5;
                                    return { icon: "üò¨", text: "They were just as lost. Both of you failed. Drill sergeant is FURIOUS.", stats: "+20 Stress, -5 Social" };
                                }
                            }
                        ]
                    }];
                } else {
                    return [{
                        category: "Blue Phase",
                        title: "The Gas Chamber",
                        desc: "They line you up outside a small building. CS gas inside. \"To build confidence in your mask.\" Everyone dreads this.",
                        choices: [
                            {
                                text: "Focus on your breathing, stay calm",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.physical, 11);
                                    
                                    if (check.success) {
                                        state.skills.physical += 3;
                                        state.happiness += 5;
                                        return { icon: "üò∑", text: `[Rolled ${check.total} vs DC 11] Mask sealed. You watch others panic. You're fine. Confidence surges.`, stats: "+3 Physical, +5 Happiness" };
                                    }
                                    state.health -= 5;
                                    state.stress += 15;
                                    return { icon: "ü§Æ", text: `[Rolled ${check.total}] Mask leaked. Lungs on fire. Snot everywhere. But you survived.`, stats: "-5 Health, +15 Stress" };
                                }
                            },
                            {
                                text: "Help a panicking recruit adjust their mask",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.social + state.skills.technical, 13);
                                    state.military.squadMorale += 10;
                                    
                                    if (check.success) {
                                        state.skills.social += 3;
                                        state.health -= 3; // Some exposure while helping
                                        return { icon: "ü§ù", text: `[Rolled ${check.total} vs DC 13] You fixed their seal. Drill sergeant saw. "That's what soldiers do."`, stats: "+3 Social, -3 Health, +Squad Morale" };
                                    }
                                    state.health -= 10;
                                    state.stress += 10;
                                    return { icon: "üòµ", text: `[Rolled ${check.total}] Your own mask came loose helping them. Both of you suffered. But they remember.`, stats: "-10 Health, +10 Stress, +Squad Morale" };
                                }
                            },
                            {
                                text: "Volunteer to go first and get it over with",
                                effect: () => {
                                    state.stress -= 10; // Less anticipation anxiety
                                    state.skills.physical += 2;
                                    state.military.combatXP += 3;
                                    if (Math.random() > 0.4) {
                                        state.health -= 3;
                                        return { icon: "üí™", text: "First in, first out. It burned, but the waiting was worse. Drill sergeant notes your initiative.", stats: "+2 Physical, +3 XP, -3 Health" };
                                    }
                                    state.health -= 8;
                                    return { icon: "ü§Æ", text: "First in. Your mask leaked. But at least you weren't dreading it all day.", stats: "+2 Physical, +3 XP, -8 Health" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // Week 6-7: Final Phase
            if (week >= 6 && week <= 7) {
                return [{
                    category: "Final Phase",
                    title: "The Forge",
                    desc: `48-hour field exercise. Everything you've learned. Simulated combat, minimal sleep, full gear. ${state.military.buddyName} is by your side. This is the final test.`,
                    choices: [
                        {
                            text: "Lead from the front - push the pace",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical + state.skills.social, 15);
                                state.energy = 5;
                                state.skills.physical += 4;
                                
                                if (check.nat20) {
                                    state.military.combatXP += 15;
                                    state.happiness += 25;
                                    state.stress = Math.max(0, state.stress - 25);
                                    return { icon: "üåü", text: `[NAT 20!] You became the rally point. Others followed your lead. Drill sergeant pulls you aside: "Leadership material."`, stats: "+4 Physical, +15 XP, Distinguished Graduate!" };
                                }
                                if (check.success) {
                                    state.military.combatXP += 8;
                                    state.happiness += 15;
                                    return { icon: "‚≠ê", text: `[Rolled ${check.total} vs DC 15] You pushed hard and others rose to match. Strong finish.`, stats: "+4 Physical, +8 XP, +15 Happy" };
                                }
                                state.health -= 10;
                                state.stress += 15;
                                return { icon: "üò§", text: `[Rolled ${check.total}] You pushed too hard, hit the wall. Finished, but barely. Lesson learned.`, stats: "+4 Physical, -10 Health" };
                            }
                        },
                        {
                            text: "Stay with your buddy - finish together",
                            effect: () => {
                                let check = rollWithModifier(state.skills.physical, 12);
                                state.energy = 15;
                                state.skills.physical += 3;
                                state.skills.social += 3;
                                state.military.squadMorale += 15;
                                
                                if (check.success) {
                                    state.happiness += 20;
                                    return { icon: "ü§ù", text: `[Rolled ${check.total} vs DC 12] You and ${state.military.buddyName} cross the finish line together. "We made it." Battle buddies for life.`, stats: "+3 Physical, +3 Social, +Squad Bond" };
                                }
                                state.stress += 10;
                                return { icon: "üí™", text: `[Rolled ${check.total}] Tough, but you had each other. ${state.military.buddyName} carried you the last mile. You'll return the favor someday.`, stats: "+3 Physical, +3 Social" };
                            }
                        },
                        {
                            text: "Conserve energy - smart pace, guaranteed finish",
                            effect: () => {
                                state.energy = 25;
                                state.skills.physical += 2;
                                state.skills.technical += 2;
                                state.military.combatXP += 3;
                                
                                return { icon: "üéØ", text: "You paced yourself perfectly. Not the fastest, not the slowest. Efficient. Professional.", stats: "+2 Physical, +2 Technical, +3 XP, Energy preserved" };
                            }
                        },
                        {
                            text: "Help struggling recruits - even if it costs you",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social + state.skills.physical, 14);
                                state.energy = 5;
                                state.skills.social += 4;
                                state.military.squadMorale += 20;
                                
                                if (check.success) {
                                    state.military.combatXP += 10;
                                    state.happiness += 15;
                                    return { icon: "ü¶∏", text: `[Rolled ${check.total} vs DC 14] You carried packs, gave water, kept morale up. Everyone finished. Drill sergeant: "THAT is a soldier."`, stats: "+4 Social, +10 XP, Squad Hero" };
                                }
                                state.health -= 8;
                                state.stress += 10;
                                return { icon: "üò´", text: `[Rolled ${check.total}] You gave everything to help others. Barely finished yourself. But they'll never forget.`, stats: "+4 Social, -8 Health, Squad remembers" };
                            }
                        }
                    ]
                }];
            }
            
            // Week 8-9: MOS Selection and Graduation prep
            if (week === 8) {
                let intel = state.characterTraits?.intelligence || 5;
                let physical = state.skills?.physical || 40;
                let height = state.characterTraits?.height || 5;
                
                // Filter MOS options based on requirements
                let availableMOS = Object.entries(MOS_OPTIONS).filter(([key, mos]) => {
                    if (mos.reqPhysical && physical < mos.reqPhysical) return false;
                    if (mos.reqIntel && intel < mos.reqIntel) return false;
                    if (mos.reqHeight?.max && height > mos.reqHeight.max) return false;
                    if (mos.reqHeight?.min && height < mos.reqHeight.min) return false;
                    return true;
                });
                
                // Always have at least logistics as fallback
                if (availableMOS.length === 0) {
                    availableMOS = [['logistics', MOS_OPTIONS.logistics]];
                }
                
                // Build description based on what's locked
                let lockedMOS = Object.entries(MOS_OPTIONS).filter(([key, mos]) => {
                    if (mos.reqPhysical && physical < mos.reqPhysical) return true;
                    if (mos.reqIntel && intel < mos.reqIntel) return true;
                    if (mos.reqHeight?.max && height > mos.reqHeight.max) return true;
                    return false;
                });
                
                let desc = "You've proven yourself. Now choose your MOS - your job for the next 3 years.";
                if (lockedMOS.length > 0) {
                    let lockedNames = lockedMOS.map(([k, m]) => m.name.split(' ')[0]).slice(0, 3).join(', ');
                    desc += ` Some specialties (${lockedNames}${lockedMOS.length > 3 ? '...' : ''}) aren't available based on your qualifications.`;
                }
                if (availableMOS.some(([k]) => k === 'special_ops')) {
                    desc += " Your exceptional abilities have opened the Special Forces pipeline.";
                }
                
                return [{
                    category: "Final Week",
                    title: "Choose Your Path",
                    desc: desc,
                    choices: availableMOS.map(([key, mos]) => ({
                        text: `${mos.icon} ${mos.name} - ${mos.desc}`,
                        effect: () => {
                            state.military.mos = key;
                            state.military.rank = 1; // Private
                            let skillBonus = key === 'special_ops' ? 15 : 10;
                            state.skills[mos.statBonus] += skillBonus;
                            if (key === 'special_ops') {
                                state.military.combatXP += 10;
                                return { icon: mos.icon, text: `You're selected for Special Forces training. The hardest path. The most elite.`, stats: `+${skillBonus} ${mos.statBonus}, +10 XP, SF Candidate` };
                            }
                            return { icon: mos.icon, text: `You're now ${mos.name}. ${mos.desc}. This defines your service.`, stats: `+${skillBonus} ${mos.statBonus.charAt(0).toUpperCase() + mos.statBonus.slice(1)}, Now: Private (PVT)` };
                        }
                    }))
                }];
            }
            
            // Default boot camp week
            return [{
                category: "Boot Camp",
                title: `Week ${week + 1} Training`,
                desc: "PT, drills, classes. The grind continues. Your body adapts. Your mind sharpens.",
                choices: [
                    {
                        text: "Give it 100%",
                        effect: () => {
                            state.skills.physical += 2;
                            state.skills.technical += 1;
                            state.energy -= 20;
                            return { icon: "üí™", text: "Another week down. Getting stronger.", stats: "+2 Physical, +1 Technical" };
                        }
                    },
                    {
                        text: "Pace yourself",
                        effect: () => {
                            state.skills.physical += 1;
                            state.energy -= 10;
                            state.stress -= 5;
                            return { icon: "üéñÔ∏è", text: "Conserving energy. Smart.", stats: "+1 Physical, -5 Stress" };
                        }
                    }
                ]
            }];
        }

        function getMilitaryServiceEvents() {
            let events = [];
            let mos = MOS_OPTIONS[state.military.mos] || MOS_OPTIONS.infantry;
            let rank = getMilitaryRank();
            let week = state.phaseWeek;
            
            // Check for deployment cycles (deploy every ~26 weeks for 12 weeks)
            let deploymentCycle = Math.floor(week / 26);
            let weekInCycle = week % 26;
            
            // Start deployment - give player agency
            if (weekInCycle === 0 && deploymentCycle > 0 && !state.military.deployed) {
                let hasPartner = state.hasPartner && state.partnerName;
                let volunteerAvailable = !state.military.lastVolunteerWeek || (week - state.military.lastVolunteerWeek) > 26;
                
                return [{
                    category: "Orders",
                    title: "Deployment Orders",
                    desc: `${rank.abbr}, the orders are read. Your unit is slated for deployment.${hasPartner ? ` ${state.partnerName}'s face goes pale.` : ''} You have 48 hours.`,
                    choices: [
                        {
                            text: "Accept orders - do your duty",
                            effect: () => {
                                state.military.deployed = true;
                                state.military.deploymentWeek = 0;
                                state.stress += 20;
                                state.money += 200;
                                if (hasPartner) state.partnerStats.supportiveness -= 5;
                                addLog("Deployed overseas");
                                return { icon: "‚úàÔ∏è", text: `Deployment #${deploymentCycle}. The plane lifts off. Home shrinks below.`, stats: "+$200 bonus, +20 Stress" };
                            }
                        },
                        {
                            text: "Volunteer eagerly - lead from the front",
                            condition: () => volunteerAvailable,
                            effect: () => {
                                state.military.deployed = true;
                                state.military.deploymentWeek = 0;
                                state.stress += 15;
                                state.money += 350; // Extra volunteer bonus
                                state.military.combatXP += 5;
                                state.military.lastVolunteerWeek = week;
                                if (hasPartner) state.partnerStats.supportiveness -= 10;
                                addLog("Volunteered for deployment");
                                return { icon: "ü¶Ö", text: `"I'll go." NCOs notice the enthusiasm. Better assignments, better pay.${hasPartner ? ` ${state.partnerName} says nothing.` : ''}`, stats: "+$350 bonus, +5 XP, +Leadership rep" };
                            }
                        },
                        {
                            text: "Request deferment - personal reasons",
                            condition: () => hasPartner || state.characterTraits?.familyWealth <= 3,
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 14);
                                
                                if (check.success) {
                                    state.military.combatXP -= 5;
                                    state.stress -= 10;
                                    if (hasPartner) state.partnerStats.supportiveness += 15;
                                    return { icon: "üìã", text: `[Rolled ${check.total} vs DC 14] Request approved. You stay stateside this rotation. Some look at you differently now.`, stats: "Deployment deferred, -5 XP, Reputation cost" };
                                }
                                state.military.deployed = true;
                                state.military.deploymentWeek = 0;
                                state.stress += 30;
                                state.money += 200;
                                return { icon: "‚ùå", text: `[Rolled ${check.total}] Request denied. "We need bodies, ${rank.abbr}." You're going anyway, and now they're watching you.`, stats: "+$200, +30 Stress, Under scrutiny" };
                            }
                        },
                        {
                            text: "Talk to the chaplain first",
                            effect: () => {
                                state.stress -= 5;
                                state.military.deployed = true;
                                state.military.deploymentWeek = 0;
                                state.money += 200;
                                state.happiness += 5;
                                return { icon: "üôè", text: "An hour with the chaplain. Whatever your beliefs, the conversation helps. You're ready.", stats: "+$200, -5 Stress, +5 Happy" };
                            }
                        }
                    ]
                }];
            }
            
            // During deployment
            if (state.military.deployed) {
                state.military.deploymentWeek++;
                
                // End deployment after 12 weeks
                if (state.military.deploymentWeek >= 12) {
                    let hasPartner = state.hasPartner && state.partnerName;
                    let lostBuddy = state.military.buddyName && !state.military.buddyAlive;
                    let wasWounded = state.military.wounded;
                    
                    let descText = `12 weeks. ${state.military.missionsCompleted} missions. `;
                    if (lostBuddy) descText += `You lost ${state.military.buddyName}. `;
                    if (wasWounded) descText += `You carry new scars. `;
                    descText += `The plane touches down. How do you handle coming home?`;
                    
                    return [{
                        category: "Homecoming",
                        title: "Coming Home",
                        desc: descText,
                        choices: [
                            {
                                text: "Celebrate with the squad - you earned it",
                                effect: () => {
                                    state.military.deployed = false;
                                    state.military.deploymentWeek = 0;
                                    state.happiness += 35;
                                    state.stress -= 15;
                                    state.money -= 200;
                                    state.military.squadMorale += 15;
                                    state.skills.social += 2;
                                    
                                    if (state.military.combatXP >= 50 && state.military.rank < 5) {
                                        state.military.rank++;
                                        state.military.combatXP = 0;
                                        let newRank = getMilitaryRank();
                                        return { icon: "üéâ", text: `Party with the unit. Stories, drinks, brotherhood. Oh - and you made ${newRank.name}.`, stats: "-$200, +35 Happy, PROMOTED!" };
                                    }
                                    
                                    return { icon: "üéâ", text: "Bars, stories, laughing until it hurts. These are your people.", stats: "-$200, +35 Happy, +Squad Bond" };
                                }
                            },
                            {
                                text: hasPartner ? `Go straight to ${state.partnerName}` : "Take leave - see family",
                                effect: () => {
                                    state.military.deployed = false;
                                    state.military.deploymentWeek = 0;
                                    state.happiness += 30;
                                    state.stress -= 25;
                                    
                                    if (hasPartner) {
                                        state.partnerStats.supportiveness += 20;
                                        state.neglect.relationship = 0;
                                    }
                                    
                                    if (state.military.combatXP >= 50 && state.military.rank < 5) {
                                        state.military.rank++;
                                        state.military.combatXP = 0;
                                        let newRank = getMilitaryRank();
                                        return { icon: "üíï", text: `${hasPartner ? state.partnerName + " is waiting." : "Family embraces you."} Best feeling. Also: ${newRank.name} now.`, stats: "-25 Stress, PROMOTED!" };
                                    }
                                    
                                    return { icon: "üíï", text: hasPartner ? `${state.partnerName} holds you and doesn't let go. You're home.` : "Family. Real food. Your own bed. Home.", stats: "+30 Happy, -25 Stress" };
                                }
                            },
                            {
                                text: lostBuddy || wasWounded ? "Seek counseling - talk to someone" : "Decompress alone - need space",
                                effect: () => {
                                    state.military.deployed = false;
                                    state.military.deploymentWeek = 0;
                                    
                                    if (lostBuddy || wasWounded) {
                                        state.stress -= 30;
                                        state.happiness += 15;
                                        state.health += 5;
                                        return { icon: "üß†", text: "The counselor doesn't judge. They've heard it all. Talking helps more than you expected.", stats: "-30 Stress, +15 Happy, Processing trauma" };
                                    }
                                    
                                    state.happiness += 20;
                                    state.stress -= 10;
                                    state.energy += 30;
                                    return { icon: "üè†", text: "Quiet. Space. Time to process. The silence feels strange after months of chaos.", stats: "+20 Happy, +30 Energy" };
                                }
                            },
                            {
                                text: "Volunteer for another deployment immediately",
                                effect: () => {
                                    state.military.deployed = false;
                                    state.military.deploymentWeek = 0;
                                    state.military.combatXP += 10;
                                    state.stress += 10;
                                    
                                    if (hasPartner) {
                                        state.partnerStats.supportiveness -= 25;
                                    }
                                    
                                    if (state.military.combatXP >= 50 && state.military.rank < 5) {
                                        state.military.rank++;
                                        state.military.combatXP = 0;
                                        let newRank = getMilitaryRank();
                                        return { icon: "ü¶Ö", text: `"Send me back." Command respects the commitment. Promoted to ${newRank.name}. ${hasPartner ? state.partnerName + " is devastated." : ""}`, stats: "+10 XP, PROMOTED, Fast-tracked" };
                                    }
                                    
                                    return { icon: "ü¶Ö", text: `"I'll go again." Some call it brave. Some call it running.${hasPartner ? " " + state.partnerName + " calls it abandonment." : ""}`, stats: "+10 XP, +10 Stress" };
                                }
                            }
                        ]
                    }];
                }
                
                // Combat mission chance based on MOS
                let combatRoll = Math.random();
                
                if (combatRoll < mos.combatChance) {
                    return [getMissionEvent()];
                } else {
                    return [getBaseEvent()];
                }
            }
            
            // Garrison duty (not deployed)
            let roll = Math.random();
            
            // RE-ENLISTMENT DECISION (near end of contract)
            if (week >= 140 && week <= 145 && !state.military.reEnlistmentOffered) {
                state.military.reEnlistmentOffered = true;
                let hasPartner = state.hasPartner && state.partnerName;
                let bonus = 5000 + (state.military.rank * 2000);
                
                return [{
                    category: "‚öñÔ∏è Career Decision",
                    title: "Re-Enlistment Decision",
                    desc: `Your contract is up in ${156 - week} weeks. The Army wants you back. $${bonus.toLocaleString()} signing bonus on the table.${hasPartner ? ` ${state.partnerName} has opinions about this.` : ''}`,
                    choices: [
                        {
                            text: "Re-enlist - this is my life now",
                            effect: () => {
                                state.phaseTarget += 156; // Another 3 years
                                state.money += bonus;
                                state.military.combatXP += 10;
                                state.happiness += 10;
                                if (hasPartner) state.partnerStats.supportiveness -= 15;
                                addLog("Re-enlisted in the Army");
                                return { icon: "ü¶Ö", text: `Signed for another 3 years. The bonus hits your account. ${hasPartner ? state.partnerName + " sighs but supports you." : "No regrets."}`, stats: `+$${bonus.toLocaleString()}, +10 XP` };
                            }
                        },
                        {
                            text: "Take a bigger bonus - 6 year commitment",
                            effect: () => {
                                let bigBonus = bonus * 2.5;
                                state.phaseTarget += 312; // 6 years
                                state.money += bigBonus;
                                state.military.combatXP += 20;
                                if (hasPartner) state.partnerStats.supportiveness -= 30;
                                addLog("Re-enlisted for 6 years");
                                return { icon: "üí∞", text: `Go big. $${bigBonus.toLocaleString()} bonus. Six more years. ${hasPartner ? state.partnerName + " is NOT happy." : "Long road ahead."}`, stats: `+$${bigBonus.toLocaleString()}, +20 XP` };
                            }
                        },
                        {
                            text: "Get out - time for civilian life",
                            effect: () => {
                                // Will transition to job hunting when contract ends
                                state.military.gettingOut = true;
                                if (hasPartner) state.partnerStats.supportiveness += 20;
                                state.stress -= 10;
                                return { icon: "üö™", text: `Decision made. When the contract ends, you're out. ${hasPartner ? state.partnerName + " is relieved." : "New chapter ahead."}`, stats: "-10 Stress, Transitioning soon" };
                            }
                        },
                        {
                            text: "Ask for time to think about it",
                            effect: () => {
                                state.military.reEnlistmentOffered = false; // Will ask again
                                state.stress += 5;
                                return { icon: "ü§î", text: "You have a few weeks. The recruiter will be back.", stats: "+5 Stress, Decision delayed" };
                            }
                        }
                    ]
                }];
            }
            
            // SPECIALTY SCHOOL OPPORTUNITY (if performing well)
            if (roll < 0.08 && state.military.rank >= 2 && state.military.combatXP >= 40 && !state.military.specialtySchool) {
                let schools = [
                    { name: "Airborne School", icon: "ü™Ç", stat: "physical", dc: 14, bonus: "Airborne qualified, +$50/week jump pay" },
                    { name: "Ranger School", icon: "‚öîÔ∏è", stat: "physical", dc: 17, bonus: "Ranger Tab, elite status" },
                    { name: "Sniper School", icon: "üéØ", stat: "technical", dc: 16, bonus: "Scout Sniper qualified" },
                    { name: "Leadership Course", icon: "üìã", stat: "social", dc: 13, bonus: "Fast track to NCO" }
                ];
                let school = schools[Math.floor(Math.random() * schools.length)];
                
                return [{
                    category: "üéì Opportunity",
                    title: `${school.name} Slot Available`,
                    desc: `A slot opened up for ${school.name}. Tough course, but it'll advance your career. Do you want it?`,
                    choices: [
                        {
                            text: `Accept the challenge`,
                            effect: () => {
                                let check = rollWithModifier(state.skills[school.stat], school.dc);
                                state.energy -= 30;
                                
                                if (check.nat20) {
                                    state.military.specialtySchool = school.name;
                                    state.military.combatXP += 25;
                                    state.skills[school.stat] += 10;
                                    state.military.medals.push(school.name + " Graduate");
                                    return { icon: "üåü", text: `[NAT 20!] Honor Graduate! Top of your class at ${school.name}. ${school.bonus}.`, stats: `+25 XP, +10 ${school.stat}, Elite status!` };
                                }
                                if (check.success) {
                                    state.military.specialtySchool = school.name;
                                    state.military.combatXP += 15;
                                    state.skills[school.stat] += 5;
                                    return { icon: "‚úì", text: `[Rolled ${check.total} vs DC ${school.dc}] Graduated ${school.name}. ${school.bonus}.`, stats: `+15 XP, +5 ${school.stat}` };
                                }
                                state.stress += 20;
                                state.happiness -= 10;
                                return { icon: "‚ùå", text: `[Rolled ${check.total}] Washed out of ${school.name}. Sent back to your unit. Humiliating.`, stats: "+20 Stress, -10 Happy" };
                            }
                        },
                        {
                            text: "Decline - not ready yet",
                            effect: () => {
                                return { icon: "ü§∑", text: "You pass on the opportunity. Maybe next time.", stats: "Slot given to someone else" };
                            }
                        }
                    ]
                }];
            }
            
            if (roll < 0.2 && state.military.rank < 5 && state.military.combatXP >= 30) {
                // Promotion board - now with choices
                return [{
                    category: "Career",
                    title: "Promotion Board",
                    desc: `You've been recommended for ${RANKS[state.military.rank + 1].name}. Time to face the board. How do you approach it?`,
                    choices: [
                        {
                            text: "Present yourself with confidence",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 13);
                                
                                if (check.success) {
                                    state.military.rank++;
                                    state.military.combatXP = 0;
                                    let newRank = getMilitaryRank();
                                    state.happiness += 20;
                                    addLog(`Promoted to ${newRank.name}`);
                                    return { icon: "‚¨ÜÔ∏è", text: `[Rolled ${check.total} vs DC 13] "Congratulations, ${newRank.name}." Pay: $${newRank.pay}/week`, stats: `PROMOTED to ${newRank.name}!` };
                                }
                                state.stress += 10;
                                return { icon: "üòî", text: `[Rolled ${check.total} vs DC 13] Not this time. "We'll see you next quarter."`, stats: "+10 Stress" };
                            }
                        },
                        {
                            text: "Let your record speak for itself",
                            effect: () => {
                                let check = rollWithModifier(state.military.combatXP, 25);
                                
                                if (check.success) {
                                    state.military.rank++;
                                    state.military.combatXP = 0;
                                    let newRank = getMilitaryRank();
                                    state.happiness += 25;
                                    addLog(`Promoted to ${newRank.name}`);
                                    return { icon: "‚¨ÜÔ∏è", text: `[XP Check passed] Your service record says it all. Promoted to ${newRank.name}.`, stats: `PROMOTED to ${newRank.name}!` };
                                }
                                state.stress += 5;
                                return { icon: "üìã", text: "The board wanted to see more initiative. Keep building that record.", stats: "+5 Stress" };
                            }
                        },
                        {
                            text: "Decline the board - not ready",
                            effect: () => {
                                state.military.combatXP += 5; // Keep building
                                return { icon: "ü§ö", text: "You request to wait for the next board. Some respect the humility, others wonder why.", stats: "+5 XP (keep building)" };
                            }
                        }
                    ]
                }];
            }
            
            if (roll < 0.35 && state.military.buddyName && state.military.buddyAlive) {
                // Buddy hangout
                return [{
                    category: "Downtime",
                    title: `Liberty with ${state.military.buddyName}`,
                    desc: `Weekend pass. ${state.military.buddyName} wants to hit the town.`,
                    choices: [
                        {
                            text: "Hit the bars",
                            effect: () => {
                                state.happiness += 15;
                                state.money -= 100;
                                state.military.squadMorale += 5;
                                state.skills.social += 2;
                                if (Math.random() < 0.1) {
                                    state.health -= 5;
                                    return { icon: "üç∫", text: `Great night. ${state.military.buddyName} had to carry you back. Worth it.`, stats: "+15 Happiness, -$100, -5 Health" };
                                }
                                return { icon: "üç∫", text: `Good times with ${state.military.buddyName}. "I got your back out there, you know."`, stats: "+15 Happiness, -$100, +2 Social" };
                            }
                        },
                        {
                            text: "Stay on base, save money",
                            effect: () => {
                                state.energy += 20;
                                state.money += 50;
                                return { icon: "üí§", text: "Rest and relaxation. Boring but responsible.", stats: "+20 Energy, +$50 saved" };
                            }
                        }
                    ]
                }];
            }
            
            // Regular garrison duty
            return [{
                category: "Garrison",
                title: "Base Duty",
                desc: `Another week on base. PT, maintenance, training exercises. The routine of peacetime service.`,
                choices: [
                    {
                        text: "Excel at your duties",
                        effect: () => {
                            state.skills[mos.statBonus] += 2;
                            state.military.combatXP += 3;
                            state.energy -= 15;
                            return { icon: "‚≠ê", text: "Good week. NCOs are noticing your performance.", stats: `+2 ${mos.statBonus}, +3 XP` };
                        }
                    },
                    {
                        text: "Volunteer for extra training",
                        effect: () => {
                            state.skills.physical += 2;
                            state.skills.technical += 2;
                            state.military.combatXP += 5;
                            state.energy -= 25;
                            return { icon: "üí™", text: "Additional range time, PT, classes. Making yourself better.", stats: "+2 Physical, +2 Technical, +5 XP" };
                        }
                    },
                    {
                        text: "Coast through",
                        effect: () => {
                            state.energy += 10;
                            state.stress -= 5;
                            return { icon: "üòé", text: "Did the minimum. Saved your energy.", stats: "+10 Energy, -5 Stress" };
                        }
                    }
                ]
            }];
        }

        function getMissionEvent() {
            let mos = MOS_OPTIONS[state.military.mos] || MOS_OPTIONS.infantry;
            let missionRoll = Math.random();
            
            // Different mission types based on MOS
            if (state.military.mos === 'medic') {
                return getMedicMission();
            } else if (state.military.mos === 'engineer') {
                return getEngineerMission();
            } else if (state.military.mos === 'intel') {
                return getIntelMission();
            } else {
                return getCombatMission();
            }
        }

        function getCombatMission() {
            let missionTypes = [
                { name: "Patrol", dc: 12, desc: "Routine patrol through hostile territory. Stay alert." },
                { name: "Convoy Escort", dc: 13, desc: "Protect the supply convoy. Ambush likely." },
                { name: "Building Clearance", dc: 15, desc: "Clear a suspected enemy position room by room." },
                { name: "QRF Response", dc: 16, desc: "Quick Reaction Force. Another unit is pinned down. Go NOW." },
                { name: "Night Raid", dc: 17, desc: "High-value target. Strike fast, extract faster." }
            ];
            
            let mission = missionTypes[Math.floor(Math.random() * missionTypes.length)];
            
            return {
                category: "‚öîÔ∏è MISSION",
                title: mission.name,
                desc: `${mission.desc} How do you approach?`,
                choices: [
                    {
                        text: "Aggressive - move fast, hit hard",
                        effect: () => {
                            let dc = mission.dc - 1; // Slightly easier to succeed
                            let combatStat = state.skills.physical + Math.floor(state.skills.technical / 2);
                            let check = rollWithModifier(combatStat, dc);
                            
                            return resolveCombat(check, mission, 'aggressive');
                        }
                    },
                    {
                        text: "By the book - standard tactics",
                        effect: () => {
                            let combatStat = state.skills.physical + Math.floor(state.skills.technical / 2);
                            let check = rollWithModifier(combatStat, mission.dc);
                            
                            return resolveCombat(check, mission, 'standard');
                        }
                    },
                    {
                        text: "Cautious - protect the squad first",
                        effect: () => {
                            let dc = mission.dc + 2; // Harder to achieve objective
                            let combatStat = state.skills.physical + Math.floor(state.skills.technical / 2);
                            let check = rollWithModifier(combatStat, dc);
                            
                            return resolveCombat(check, mission, 'cautious');
                        }
                    },
                    {
                        text: "Creative - try something unexpected",
                        effect: () => {
                            let dc = mission.dc;
                            let combatStat = state.skills.technical + state.skills.creativity; // Different stats
                            let check = rollWithModifier(combatStat, dc);
                            
                            return resolveCombat(check, mission, 'creative');
                        }
                    }
                ]
            };
        }
        
        function resolveCombat(check, mission, approach) {
            let xpMultiplier = approach === 'aggressive' ? 1.5 : approach === 'cautious' ? 0.7 : approach === 'creative' ? 1.3 : 1;
            let injuryRisk = approach === 'aggressive' ? 0.5 : approach === 'cautious' ? 0.2 : 0.35;
            let buddyRisk = approach === 'aggressive' ? 0.4 : approach === 'cautious' ? 0.1 : 0.25;
                            
                            // Natural 20 - Heroic success
                            if (check.nat20) {
                let xp = Math.floor(20 * xpMultiplier);
                state.military.combatXP += xp;
                                state.military.missionsCompleted++;
                                state.military.killCount += Math.floor(Math.random() * 3) + 2;
                                state.happiness += 10;
                                
                if (approach === 'creative' && Math.random() < 0.4) {
                    state.military.medals.push("Commendation Medal");
                    return { icon: "üåü", text: `[NAT 20!] Your unconventional approach worked brilliantly. Commended for tactical innovation.`, stats: `+${xp} XP, Commendation Medal!` };
                }
                                if (Math.random() < 0.3) {
                                    state.military.medals.push("Bronze Star");
                                    addLog("Awarded Bronze Star");
                    return { icon: "üåü", text: `[NAT 20!] HEROIC ACTION! Lives saved. Bronze Star recommended.`, stats: `+${xp} XP, Bronze Star!` };
                                }
                return { icon: "üí•", text: `[NAT 20!] Flawless execution. Mission complete, zero friendly casualties.`, stats: `+${xp} XP, +10 Happy` };
                            }
                            
            // Natural 1 - Disaster (approach affects severity)
                            if (check.nat1) {
                                state.military.missionsCompleted++;
                                let disaster = Math.random();
                                
                if (disaster < buddyRisk && state.military.buddyAlive && state.military.buddyName) {
                                    state.military.buddyAlive = false;
                                    state.happiness -= 40;
                                    state.stress += 40;
                                    addLog(`${state.military.buddyName} KIA`);
                    return { icon: "üíÄ", text: `[NAT 1!] Everything went wrong. ${state.military.buddyName} didn't make it.`, stats: "-40 Happy, +40 Stress, BUDDY KIA" };
                                }
                                
                if (disaster < injuryRisk) {
                                    state.health -= 25;
                                    state.military.wounded = true;
                                    state.military.medals.push("Purple Heart");
                    addLog("Wounded in action");
                    return { icon: "üíú", text: `[NAT 1!] ${approach === 'aggressive' ? 'Pushed too hard.' : 'Wrong place, wrong time.'} Field hospital. Purple Heart.`, stats: "-25 Health, Purple Heart" };
                                }
                                
                                state.stress += 30;
                                state.happiness -= 20;
                return { icon: "üí•", text: `[NAT 1!] ${approach === 'cautious' ? 'Despite caution, ambushed.' : 'Chaos. Mission failed.'} Debrief will be brutal.`, stats: "+30 Stress, -20 Happy" };
                            }
                            
                            // Success
                            if (check.success) {
                let xp = Math.floor(10 * xpMultiplier);
                state.military.combatXP += xp;
                                state.military.missionsCompleted++;
                                state.military.killCount += Math.floor(Math.random() * 2);
                                
                let successMsg = {
                    'aggressive': "Fast and violent. Objective secured before they knew what hit them.",
                    'standard': "Textbook operation. Mission accomplished.",
                    'cautious': "Slow and methodical. Everyone made it back.",
                    'creative': "They never saw it coming. Your plan worked perfectly."
                };
                
                return { icon: "‚úì", text: `[Rolled ${check.total}] ${successMsg[approach]}`, stats: `+${xp} XP` };
            }
            
            // Failure (but not nat 1) - cautious approach reduces consequences
            let failXp = Math.floor(3 * xpMultiplier);
            state.military.combatXP += failXp;
                            state.military.missionsCompleted++;
            state.stress += approach === 'cautious' ? 10 : 15;
            
            if (Math.random() < (approach === 'cautious' ? 0.15 : 0.3)) {
                state.health -= approach === 'cautious' ? 5 : 10;
                return { icon: "ü©π", text: `[Rolled ${check.total}] ${approach === 'cautious' ? 'Withdrew safely, minor scrapes.' : 'Objective not achieved. Minor injuries.'}`, stats: `+${failXp} XP, -Health` };
            }
            
            return { icon: "üò§", text: `[Rolled ${check.total}] ${approach === 'aggressive' ? 'Pushed too hard, had to pull back.' : 'Had to fall back. The enemy got away.'}`, stats: `+${failXp} XP, +Stress` };
        }

        function getMedicMission() {
            let scenarios = [
                { title: "Mass Casualty Event", desc: "Multiple wounded. Triage fast. Save who you can.", dc: 14 },
                { title: "Under Fire Rescue", desc: "Wounded soldier in the open. Bullets flying. Your move.", dc: 16 },
                { title: "Field Surgery", desc: "No medevac available. You have to operate here. Now.", dc: 17 }
            ];
            
            let scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                category: "üè• MEDICAL",
                title: scenario.title,
                desc: scenario.desc,
                choices: [
                    {
                        text: "üé≤ Save them (Technical check)",
                        effect: () => {
                            let check = rollWithModifier(state.skills.technical, scenario.dc);
                            
                            if (check.nat20) {
                                state.military.combatXP += 25;
                                state.military.missionsCompleted++;
                                state.happiness += 20;
                                if (Math.random() < 0.4) {
                                    state.military.medals.push("Combat Medical Badge");
                                    return { icon: "‚≠ê", text: `[NAT 20!] MIRACLE SAVE! Against all odds, everyone lived. Combat Medical Badge awarded.`, stats: "+25 XP, +20 Happiness, Combat Medical Badge!" };
                                }
                                return { icon: "‚ù§Ô∏è", text: `[NAT 20!] Perfect triage. Perfect care. Everyone who could be saved, was saved.`, stats: "+25 XP, +20 Happiness" };
                            }
                            
                            if (check.nat1) {
                                state.military.missionsCompleted++;
                                state.stress += 35;
                                state.happiness -= 25;
                                return { icon: "üíÄ", text: `[NAT 1!] You did everything right but they died anyway. You'll see their faces forever.`, stats: "+35 Stress, -25 Happiness" };
                            }
                            
                            if (check.success) {
                                state.military.combatXP += 12;
                                state.military.missionsCompleted++;
                                state.skills.technical += 3;
                                return { icon: "üè•", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Lives saved. This is why you're here.`, stats: "+12 XP, +3 Technical" };
                            }
                            
                            state.military.combatXP += 5;
                            state.military.missionsCompleted++;
                            state.stress += 20;
                            return { icon: "üòî", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Lost one. Did your best. Sometimes that's not enough.`, stats: "+5 XP, +20 Stress" };
                        }
                    }
                ]
            };
        }

        function getEngineerMission() {
            let scenarios = [
                { title: "IED Disposal", desc: "Roadside bomb. Everyone's watching. Steady hands.", dc: 15 },
                { title: "Breach Operation", desc: "Blow the door. Don't kill the guys behind you.", dc: 13 },
                { title: "Bridge Under Fire", desc: "Build a crossing while they shoot at you.", dc: 16 }
            ];
            
            let scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                category: "üí£ ENGINEERING",
                title: scenario.title,
                desc: scenario.desc,
                choices: [
                    {
                        text: "üé≤ Execute (Technical check)",
                        effect: () => {
                            let check = rollWithModifier(state.skills.technical, scenario.dc);
                            
                            if (check.nat20) {
                                state.military.combatXP += 20;
                                state.military.missionsCompleted++;
                                state.skills.technical += 5;
                                return { icon: "üí•", text: `[NAT 20!] Perfect execution. Textbook will be rewritten based on this.`, stats: "+20 XP, +5 Technical" };
                            }
                            
                            if (check.nat1) {
                                state.military.missionsCompleted++;
                                let result = Math.random();
                                if (result < 0.4) {
                                    state.health -= 30;
                                    state.military.medals.push("Purple Heart");
                                    return { icon: "üíú", text: `[NAT 1!] Premature detonation. You're alive but badly wounded. Purple Heart.`, stats: "-30 Health, Purple Heart" };
                                }
                                state.stress += 30;
                                return { icon: "üò±", text: `[NAT 1!] Wire snapped. Timer started. You ran. Barely made it.`, stats: "+30 Stress" };
                            }
                            
                            if (check.success) {
                                state.military.combatXP += 12;
                                state.military.missionsCompleted++;
                                return { icon: "‚úÇÔ∏è", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Clean work. Device neutralized.`, stats: "+12 XP" };
                            }
                            
                            state.military.combatXP += 4;
                            state.stress += 15;
                            return { icon: "üò∞", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Had to fall back. EOD robot took over.`, stats: "+4 XP, +15 Stress" };
                        }
                    }
                ]
            };
        }

        function getIntelMission() {
            let scenarios = [
                { title: "Interrogation", desc: "Captured insurgent. Time-sensitive intel. Clock is ticking.", dc: 14 },
                { title: "Signal Intercept", desc: "Enemy communications. Find the pattern.", dc: 13 },
                { title: "Asset Meeting", desc: "Your informant is nervous. Build trust fast.", dc: 15 }
            ];
            
            let scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                category: "üîç INTEL",
                title: scenario.title,
                desc: scenario.desc,
                choices: [
                    {
                        text: "üé≤ Work the problem (Technical + Social)",
                        effect: () => {
                            let stat = Math.floor((state.skills.technical + state.skills.social) / 2);
                            let check = rollWithModifier(stat, scenario.dc);
                            
                            if (check.nat20) {
                                state.military.combatXP += 25;
                                state.military.missionsCompleted++;
                                state.skills.technical += 3;
                                state.skills.social += 3;
                                return { icon: "üéØ", text: `[NAT 20!] JACKPOT! Intel leads to high-value target capture. Command is thrilled.`, stats: "+25 XP, +3 Technical, +3 Social" };
                            }
                            
                            if (check.nat1) {
                                state.military.missionsCompleted++;
                                state.stress += 25;
                                if (Math.random() < 0.3) {
                                    state.happiness -= 20;
                                    return { icon: "üíÄ", text: `[NAT 1!] Your asset was compromised. They found the body. This is on you.`, stats: "+25 Stress, -20 Happiness" };
                                }
                                return { icon: "üò¨", text: `[NAT 1!] Bad intel. The raid hit a civilian wedding. International incident.`, stats: "+25 Stress" };
                            }
                            
                            if (check.success) {
                                state.military.combatXP += 15;
                                state.military.missionsCompleted++;
                                return { icon: "üìã", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Good intel extracted. Lives will be saved.`, stats: "+15 XP" };
                            }
                            
                            state.military.combatXP += 5;
                            return { icon: "ü§∑", text: `[Rolled ${check.total} vs DC ${scenario.dc}] Inconclusive. Back to the drawing board.`, stats: "+5 XP" };
                        }
                    }
                ]
            };
        }

        function getBaseEvent() {
            let events = [
                {
                    title: "Care Package",
                    desc: "Mail call. Your name is on a box.",
                    effect: () => {
                        state.happiness += 15;
                        state.stress -= 10;
                        return { icon: "üì¶", text: "Cookies from home. Letters. Feels like a lifeline.", stats: "+15 Happiness, -10 Stress" };
                    }
                },
                {
                    title: "FOB Maintenance",
                    desc: "Filling sandbags. Building walls. Endless.",
                    effect: () => {
                        state.skills.physical += 2;
                        state.energy -= 15;
                        return { icon: "üèóÔ∏è", text: "Grunt work, but the base is stronger.", stats: "+2 Physical" };
                    }
                },
                {
                    title: "Downtime",
                    desc: "Few hours off. What do you do?",
                    choices: [
                        { text: "Call home", effect: () => { state.happiness += 10; state.stress -= 15; return { icon: "üì±", text: "Hearing familiar voices helps.", stats: "+10 Happiness, -15 Stress" }; }},
                        { text: "Work out", effect: () => { state.skills.physical += 3; state.energy -= 10; return { icon: "üí™", text: "Iron therapy.", stats: "+3 Physical" }; }},
                        { text: "Play cards with the squad", effect: () => { state.military.squadMorale += 5; state.happiness += 8; return { icon: "üÉè", text: "Laughing with your squad. Best medicine.", stats: "+8 Happiness" }; }}
                    ]
                },
                {
                    title: "Mortar Attack",
                    desc: "INCOMING! Sirens blare. Get to the bunker!",
                    effect: () => {
                        let check = rollWithModifier(state.skills.physical, 10);
                        if (check.nat1) {
                            state.health -= 15;
                            state.military.medals.push("Purple Heart");
                            return { icon: "üíú", text: `[NAT 1!] Shrapnel caught you before you made cover. Purple Heart.`, stats: "-15 Health, Purple Heart" };
                        }
                        state.stress += 20;
                        return { icon: "üí•", text: `[Rolled ${check.total}] Made it to the bunker. That was close.`, stats: "+20 Stress" };
                    }
                }
            ];
            
            let event = events[Math.floor(Math.random() * events.length)];
            
            if (event.choices) {
                return {
                    category: "Deployment",
                    title: event.title,
                    desc: event.desc,
                    choices: event.choices.map(c => ({ text: c.text, effect: c.effect }))
                };
            }
            
            return {
                category: "Deployment",
                title: event.title,
                desc: event.desc,
                choices: [{ text: "Continue", effect: event.effect }]
            };
        }

        function getRoutineEducationEvent() {
            let type = state.educationType;
            let week = state.phaseWeek + 1;
            let total = state.phaseTarget;
            
            return {
                category: "Education",
                title: `Week ${week} of ${total}`,
                desc: type === 'university' ? "Lectures, assignments, the rhythm of college life." :
                      type === 'community_college' ? "Classes and studying. Staying focused." :
                      type === 'trade_school' ? "Learning the craft. Hands-on and theory." :
                      "Training continues.",
                choices: [
                    {
                        text: "Study hard",
                        effect: () => {
                            state.energy -= 15;
                            state.skills.technical += 1;
                            if (type === 'university' || type === 'community_college') {
                                state.gpa = Math.min(4.0, state.gpa + 0.02);
                            }
                            return { icon: "üìö", text: "Productive week.", stats: "+1 Technical" };
                        }
                    },
                    {
                        text: "Coast through",
                        effect: () => {
                            state.energy += 5;
                            state.happiness += 3;
                            return { icon: "üòé", text: "Taking it easy.", stats: "+3 Happiness" };
                        }
                    },
                    {
                        text: "Socialize more",
                        effect: () => {
                            state.skills.social += 2;
                            state.happiness += 5;
                            state.energy -= 10;
                            return { icon: "üë•", text: "Making connections.", stats: "+2 Social, +5 Happiness" };
                        }
                    }
                ]
            };
        }

        function getGraduationEvent() {
            let type = state.educationType;
            
            if (type === 'military_training') {
                return {
                    category: "Military",
                    title: "Boot Camp Complete!",
                    desc: "You made it through. Now the real service begins.",
                    choices: [
                        {
                            text: "Begin active duty",
                            effect: () => {
                                state.education = 'military';
                                state.educationType = 'military_service';
                                state.phaseTarget = EDUCATION_DURATION.military_service;
                                state.phaseWeek = 0;
                                state.employed = true;
                                state.job = 'military';
                                state.jobTitle = 'Military Service';
                                state.traits.push('Veteran');
                                addLog("Completed boot camp");
                                return { icon: "üéñÔ∏è", text: "Private First Class. Your service begins.", stats: "Now in active duty" };
                            }
                        }
                    ]
                };
            }
            
            if (type === 'military_service') {
                return {
                    category: "Military",
                    title: "Service Complete",
                    desc: "Your commitment is fulfilled. The GI Bill is yours.",
                    choices: [
                        {
                            text: "Use GI Bill for college (free)",
                            effect: () => {
                                state.phase = 'education';
                                state.educationType = 'university';
                                state.phaseTarget = EDUCATION_DURATION.university;
                                state.phaseWeek = 0;
                                state.employed = false;
                                state.job = null;
                                state.home = 'room';
                                state.achievements.push('GI Bill');
                                addLog("Started university on GI Bill");
                                return { icon: "üéì", text: "Free education. You earned it.", stats: "Starting university (free)" };
                            }
                        },
                        {
                            text: "Enter civilian workforce",
                            effect: () => {
                                state.phase = 'job_hunting';
                                state.education = 'military';
                                state.employed = false;
                                state.job = null;
                                state.achievements.push('Honorable Discharge');
                                addLog("Honorably discharged");
                                return { icon: "üè†", text: "Back to civilian life. Time to find work.", stats: "Now job hunting" };
                            }
                        }
                    ]
                };
            }
            
            // College/trade school graduation
            let eduName = type === 'university' ? 'University' : 
                          type === 'community_college' ? 'Community College' : 'Trade School';
            
            // Calculate graduation honors for university
            let honors = '';
            let bonusStats = '';
            if (type === 'university') {
                if (state.gpa >= 3.9) {
                    honors = ' Summa Cum Laude';
                    state.career.networkContacts += 20;
                    bonusStats = ', +20 Network (Summa Cum Laude)';
                } else if (state.gpa >= 3.7) {
                    honors = ' Magna Cum Laude';
                    state.career.networkContacts += 15;
                    bonusStats = ', +15 Network (Magna Cum Laude)';
                } else if (state.gpa >= 3.5) {
                    honors = ' Cum Laude';
                    state.career.networkContacts += 10;
                    bonusStats = ', +10 Network (Cum Laude)';
                }
            }
            
            let majorName = state.university.major ? MAJORS[state.university.major].name : 'General Studies';
            
            // Career prospects based on GPA
            let careerProspects = "";
            if (type === 'university') {
                if (state.gpa >= 3.7) {
                    careerProspects = " Top firms are recruiting you. Prestigious positions await!";
                } else if (state.gpa >= 3.5) {
                    careerProspects = " Your grades open doors to great opportunities.";
                } else if (state.gpa >= 3.0) {
                    careerProspects = " Solid grades - you'll find something good.";
                } else if (state.gpa >= 2.5) {
                    careerProspects = " Your grades are... fine. The job hunt may be tougher.";
                } else {
                    careerProspects = " Your transcript isn't doing you any favors. Better lean on skills and networking.";
                }
            }
            
            return {
                category: "üéì Milestone",
                title: `Graduation Day!${honors}`,
                desc: type === 'university' ? 
                    `Four years of ${majorName}. GPA: ${state.gpa.toFixed(2)}. ${state.university.thesisProgress >= 100 ? 'Thesis complete. ' : ''}${state.university.internshipCompleted ? 'Internship done. ' : ''}${careerProspects}` :
                    `${type === 'community_college' ? 'Two years' : 'One and a half years'} of work. You did it. ${eduName} graduate.`,
                choices: [
                    {
                        text: "Time to find a real job",
                        effect: () => {
                            state.education = type;
                            state.phase = 'job_hunting';
                            state.phaseWeek = 0;
                            state.employed = false;
                            state.job = null;
                            
                            // Add achievements
                            state.achievements.push(`${eduName} Graduate${honors}`);
                            if (type === 'university' && state.university.major) {
                                state.achievements.push(`${majorName} Degree`);
                            }
                            if (state.university.studyAbroadDone) state.achievements.push('World Traveler');
                            if (state.university.thesisProgress >= 100) state.achievements.push('Thesis Completed');
                            
                            // GPA salary modifier note
                            let salaryMod = getGPASalaryModifier();
                            let salaryNote = salaryMod > 1.0 ? ` (+${Math.round((salaryMod-1)*100)}% starting salary)` : 
                                            salaryMod < 1.0 ? ` (${Math.round((salaryMod-1)*100)}% starting salary)` : '';
                            
                            addLog(`Graduated from ${eduName.toLowerCase()}${honors} (GPA: ${state.gpa.toFixed(2)})`);
                            return { icon: "üéì", text: `You're officially a ${eduName.toLowerCase()} graduate!${honors ? ` ${honors}!` : ''}${salaryNote}`, stats: `Now job hunting${bonusStats}` };
                        }
                    }
                ]
            };
        }

        function getJobHuntingEvents() {
            let events = [];
            let available = getAvailableJobs();
            
            // Check if we have an interview scheduled
            if (state.interviews > 0) {
                let jobOptions = available.slice(0, 2);
                let bestJob = jobOptions[0];
                let job = JOBS[bestJob];
                
                // Attractiveness can help in interviews
                let attrBonus = Math.floor(((state.currentAttractiveness || 5) - 5) * 2);
                let attrNote = attrBonus > 0 ? " (Your appearance helps)" : attrBonus < -2 ? " (First impressions are tough)" : "";
                
                // GPA affects hiring for college grads
                let gpaBonus = getGPAHiringModifier();
                let gpaSalaryMod = getGPASalaryModifier();
                let gpaNote = "";
                if (state.education === 'university' || state.education === 'community_college') {
                    if (gpaBonus >= 4) gpaNote = ` Your ${state.gpa.toFixed(2)} GPA impresses them.`;
                    else if (gpaBonus >= 2) gpaNote = ` Your academic record helps.`;
                    else if (gpaBonus <= -3) gpaNote = ` They noticed your poor grades...`;
                    else if (gpaBonus <= -1) gpaNote = ` Your GPA isn't doing you favors.`;
                }
                
                // Calculate adjusted salary based on GPA
                let adjustedSalary = Math.round(job.salary * gpaSalaryMod);
                let salaryNote = gpaSalaryMod > 1.0 ? ` (GPA bonus: +${Math.round((gpaSalaryMod-1)*100)}%)` : 
                                gpaSalaryMod < 1.0 ? ` (GPA penalty: ${Math.round((gpaSalaryMod-1)*100)}%)` : '';
                
                // Prestigious jobs are harder to get
                let baseDC = job.prestigious ? 16 : 14;
                
                return [{
                    category: "Interview",
                    title: `Interview: ${job.title}`,
                    desc: `Big day. Interview for ${job.title}.${attrNote}${gpaNote}${job.prestigious ? ' This is a competitive position.' : ''}`,
                    choices: [
                        {
                            text: "Just be yourself. Confidence is key.",
                            effect: () => {
                                state.interviews--;
                                let totalBonus = state.skills.social + attrBonus + gpaBonus;
                                let check = rollWithModifier(totalBonus, baseDC);
                                
                                if (check.nat20) {
                                    state.employed = true;
                                    state.job = bestJob;
                                    state.jobTitle = job.title;
                                    state.phase = 'employed';
                                    state.performance = 60;
                                    state.weeksAtJob = 0;
                                    state.happiness += 25;
                                    state.career.bossRelationship = 60;
                                    state.baseSalary = adjustedSalary;
                                    addLog(`Got hired as ${job.title}`);
                                    return { icon: "üåü", text: `[NAT 20!] Crushed it! They loved your authenticity.`, stats: `Hired! +$${adjustedSalary}/wk${salaryNote}` };
                                }
                                if (check.success) {
                                    state.employed = true;
                                    state.job = bestJob;
                                    state.jobTitle = job.title;
                                    state.phase = 'employed';
                                    state.performance = 50;
                                    state.weeksAtJob = 0;
                                    state.happiness += 20;
                                    state.baseSalary = adjustedSalary;
                                    addLog(`Got hired as ${job.title}`);
                                    return { icon: "üéâ", text: `[Rolled ${check.total} vs DC ${baseDC}] You got the job!`, stats: `Hired! +$${adjustedSalary}/wk${salaryNote}` };
                                }
                                state.happiness -= 10;
                                state.jobApplications++;
                                return { icon: "üòî", text: `[Rolled ${check.total} vs DC ${baseDC}] Too casual. They went with someone else.`, stats: "-10 Happiness" };
                            }
                        },
                        {
                            text: "Stay up all night researching the company.",
                            effect: () => {
                                state.interviews--;
                                state.energy -= 20;
                                state.health -= 5;
                                let totalBonus = state.skills.social + 5 + gpaBonus;
                                let check = rollWithModifier(totalBonus, baseDC - 4);
                                
                                if (check.success) {
                                    state.employed = true;
                                    state.job = bestJob;
                                    state.jobTitle = job.title;
                                    state.phase = 'employed';
                                    state.performance = 55;
                                    state.weeksAtJob = 0;
                                    state.happiness += 20;
                                    state.baseSalary = adjustedSalary;
                                    addLog(`Got hired as ${job.title}`);
                                    return { icon: "üéâ", text: `[Rolled ${check.total} vs DC ${baseDC - 4}] Preparation paid off!`, stats: `Hired! +$${adjustedSalary}/wk${salaryNote}` };
                                }
                                state.happiness -= 8;
                                return { icon: "üò¥", text: `[Rolled ${check.total}] Exhausted and it showed. No offer.`, stats: "-20 Energy, -5 Health, -8 Happy" };
                            }
                        },
                        {
                            text: "Hire an interview coach. Worth the investment?",
                            condition: () => state.money >= 200,
                            effect: () => {
                                state.interviews--;
                                state.money -= 200;
                                let totalBonus = state.skills.social + 10 + gpaBonus;
                                let check = rollWithModifier(totalBonus, baseDC - 6);
                                
                                if (check.success) {
                                    state.employed = true;
                                    state.job = bestJob;
                                    state.jobTitle = job.title;
                                    state.phase = 'employed';
                                    state.performance = 55;
                                    state.weeksAtJob = 0;
                                    state.happiness += 20;
                                    state.skills.social += 2;
                                    state.baseSalary = adjustedSalary;
                                    addLog(`Got hired as ${job.title}`);
                                    return { icon: "üéâ", text: `[Rolled ${check.total} vs DC ${baseDC - 6}] Coach knew exactly what they'd ask!`, stats: `Hired! +$${adjustedSalary}/wk${salaryNote}` };
                                }
                                state.happiness -= 5;
                                state.skills.social += 1;
                                return { icon: "üòê", text: `[Rolled ${check.total}] Coaching helped but wasn't enough.`, stats: "-$200, +1 Social (learned something)" };
                            }
                        },
                        {
                            text: "Call in a favor. Someone you know might have inside info.",
                            condition: () => state.career.networkContacts >= 5,
                            effect: () => {
                                state.interviews--;
                                state.career.networkContacts -= 2;
                                let totalBonus = state.skills.social + 8 + gpaBonus;
                                let check = rollWithModifier(totalBonus, baseDC - 5);
                                
                                if (check.success) {
                                    state.employed = true;
                                    state.job = bestJob;
                                    state.jobTitle = job.title;
                                    state.phase = 'employed';
                                    state.performance = 55;
                                    state.weeksAtJob = 0;
                                    state.happiness += 22;
                                    state.baseSalary = adjustedSalary;
                                    addLog(`Got hired as ${job.title}`);
                                    return { icon: "üéâ", text: `[Rolled ${check.total} vs DC ${baseDC - 5}] Your contact's tips were gold!`, stats: `Hired! +$${adjustedSalary}/wk${salaryNote}` };
                                }
                                return { icon: "ü§∑", text: `[Rolled ${check.total}] Inside info wasn't enough.`, stats: "-2 Network contacts" };
                            }
                        }
                    ]
                }];
            }
            
            // Build GPA note for job hunting
            let gpaHuntingNote = "";
            if (state.education === 'university' || state.education === 'community_college') {
                let gpa = state.gpa || 2.5;
                if (gpa >= 3.7) gpaHuntingNote = ` Your stellar ${gpa.toFixed(2)} GPA opens doors.`;
                else if (gpa >= 3.3) gpaHuntingNote = ` Your ${gpa.toFixed(2)} GPA is a solid selling point.`;
                else if (gpa < 2.5) gpaHuntingNote = ` Your ${gpa.toFixed(2)} GPA is making this harder.`;
            }
            
            // Job hunting activities
            events.push({
                category: "Job Hunt",
                title: "Another Week of Searching",
                desc: `Week ${state.phaseWeek + 1} of job hunting. ${state.jobApplications} applications sent so far.${gpaHuntingNote}`,
                choices: [
                    {
                        text: "Send out applications",
                        effect: () => {
                            state.jobApplications += 3;
                            state.energy -= 10;
                            // GPA affects callback rate for college grads
                            let baseRate = 0.3 + state.jobApplications * 0.03;
                            let gpaBonus = getGPAHiringModifier();
                            let callbackRate = baseRate + (gpaBonus * 0.03); // Each GPA point = +3% callback rate
                            
                            if (Math.random() < callbackRate) {
                                state.interviews++;
                                let gpaText = gpaBonus >= 3 ? " Your resume stands out!" : gpaBonus <= -2 ? " Despite your grades, you got a shot." : "";
                                return { icon: "üìß", text: `Got a callback! Interview scheduled.${gpaText}`, stats: "+3 applications, Interview scheduled!" };
                            }
                            return { icon: "üìß", text: "Applications sent. Waiting to hear back.", stats: "+3 applications" };
                        }
                    },
                    {
                        text: "Network and reach out",
                        effect: () => {
                            state.skills.social += 2;
                            state.money -= 20;
                            if (Math.random() < 0.25) {
                                state.interviews++;
                                return { icon: "ü§ù", text: "A contact came through! Interview lined up.", stats: "+2 Social, -$20, Interview scheduled!" };
                            }
                            return { icon: "ü§ù", text: "Making connections. Something might come of it.", stats: "+2 Social, -$20" };
                        }
                    },
                    {
                        text: "Take a break",
                        effect: () => {
                            state.energy += 20;
                            state.happiness += 5;
                            state.stress -= 10;
                            return { icon: "‚òï", text: "Job hunting is exhausting. You needed this.", stats: "+20 Energy, +5 Happiness" };
                        }
                    }
                ]
            });
            
            return events;
        }

        function getEmployedEvents() {
            let events = [];
            let job = JOBS[state.job];
            if (!job) return getRandomLifeEvents();
            let roll = Math.random();
            
            // Determine job category
            let jobCategory = null;
            for (let [cat, data] of Object.entries(JOB_CATEGORIES)) {
                if (data.jobs.includes(state.job)) {
                    jobCategory = cat;
                    break;
                }
            }
            
            // COWORKER ASSIGNMENT (First few weeks at job)
            if (!state.career.coworkerAlly && state.weeksAtJob >= 2 && state.weeksAtJob < 6) {
                let allyName = COWORKER_NAMES[Math.floor(Math.random() * COWORKER_NAMES.length)];
                return [{
                    category: "Workplace",
                    title: "Making Friends at Work",
                    desc: `${allyName} from your department seems friendly. They offer to show you the ropes.`,
                    choices: [
                        {
                            text: `Befriend ${allyName}`,
                            effect: () => {
                                state.career.coworkerAlly = allyName;
                                state.skills.social += 3;
                                return { icon: "ü§ù", text: `${allyName} becomes your work buddy. Good to have allies.`, stats: "+3 Social, Work ally gained" };
                            }
                        },
                        {
                            text: "Keep it professional",
                            effect: () => {
                                state.performance += 2;
                                return { icon: "üíº", text: "Focus on work, not friendships.", stats: "+2 Performance" };
                            }
                        }
                    ]
                }];
            }
            
            // RIVAL EMERGENCE (After week 10)
            if (!state.career.coworkerRival && state.weeksAtJob >= 10 && roll < 0.1) {
                let rivalName = COWORKER_NAMES.filter(n => n !== state.career.coworkerAlly)[Math.floor(Math.random() * (COWORKER_NAMES.length - 1))];
                return [{
                    category: "Office Politics",
                    title: "Competition Emerges",
                    desc: `${rivalName} seems to be gunning for the same opportunities as you. They've been talking to your boss a lot lately.`,
                    choices: [
                        {
                            text: "Challenge accepted",
                            effect: () => {
                                state.career.coworkerRival = rivalName;
                                state.stress += 10;
                                state.performance += 5;
                                return { icon: "‚öîÔ∏è", text: `${rivalName} wants competition? They'll get it.`, stats: "+10 Stress, +5 Performance, Rival gained" };
                            }
                        },
                        {
                            text: "Try to make peace",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 13);
                                if (check.success) {
                                    state.skills.social += 3;
                                    return { icon: "‚òÆÔ∏è", text: `[Rolled ${check.total}] You extend an olive branch. ${rivalName} seems to back off.`, stats: "+3 Social" };
                                }
                                state.career.coworkerRival = rivalName;
                                return { icon: "üòí", text: `[Rolled ${check.total}] ${rivalName} sees it as weakness. You've made an enemy.`, stats: "Rival gained" };
                            }
                        }
                    ]
                }];
            }
            
            // PROJECT ASSIGNMENT (Periodic)
            if (!state.career.projectActive && state.weeksAtJob >= 8 && roll < 0.15 && jobCategory) {
                let projectKeys = JOB_CATEGORIES[jobCategory].projects;
                let projectKey = projectKeys[Math.floor(Math.random() * projectKeys.length)];
                let project = PROJECT_TYPES[projectKey] || PROJECT_TYPES.quarterly_report;
                
                return [{
                    category: "üéØ Assignment",
                    title: `New Project: ${project.name}`,
                    desc: `Boss assigns you to ${project.name}. It'll take about ${project.duration} weeks. Big visibility.`,
                    choices: [
                        {
                            text: "Take the lead",
                            effect: () => {
                                state.career.projectActive = true;
                                state.career.projectWeek = 0;
                                state.career.projectSuccess = 50;
                                state.career.currentProject = projectKey;
                                state.stress += 10;
                                return { icon: "üìã", text: `You're on ${project.name}. Time to deliver.`, stats: "+10 Stress, Project started" };
                            }
                        },
                        {
                            text: "Suggest someone else",
                            effect: () => {
                                state.career.bossRelationship -= 10;
                                state.stress -= 5;
                                return { icon: "ü§∑", text: "Not your time, you say. Boss doesn't seem pleased.", stats: "-10 Boss relationship, -5 Stress" };
                            }
                        }
                    ]
                }];
            }
            
            // PROJECT PROGRESS EVENTS
            if (state.career.projectActive) {
                state.career.projectWeek++;
                let project = PROJECT_TYPES[state.career.currentProject] || PROJECT_TYPES.quarterly_report;
                
                // Project completion check
                if (state.career.projectWeek >= project.duration) {
                    return [{
                        category: "üìä Deadline",
                        title: `${project.name} Due!`,
                        desc: `Time's up. Success probability: ${state.career.projectSuccess}%`,
                        choices: [
                            {
                                text: "üé≤ Submit your work",
                                effect: () => {
                                    let check = rollWithModifier(state.career.projectSuccess - 50 + state.skills.technical, project.difficulty);
                                    state.career.projectActive = false;
                                    state.career.projectWeek = 0;
                                    
                                    if (check.nat20) {
                                        let bonus = Math.floor(job.salary * project.reward * 2);
                                        state.money += bonus;
                                        state.performance += 20;
                                        state.career.bossRelationship += 15;
                                        state.happiness += 15;
                                        addLog(`Stellar work on ${project.name}`);
                                        return { icon: "üåü", text: `[NAT 20!] EXCEPTIONAL WORK! Everyone's talking about it.`, stats: `+$${bonus} bonus, +20 Performance, +15 Boss rel` };
                                    }
                                    if (check.success) {
                                        let bonus = Math.floor(job.salary * project.reward);
                                        state.money += bonus;
                                        state.performance += 10;
                                        state.career.bossRelationship += 5;
                                        return { icon: "‚úÖ", text: `[Rolled ${check.total} vs DC ${project.difficulty}] Project delivered successfully.`, stats: `+$${bonus} bonus, +10 Performance` };
                                    }
                                    if (check.nat1) {
                                        state.performance -= 15;
                                        state.career.bossRelationship -= 15;
                                        state.stress += 20;
                                        state.career.promotionsDenied++;
                                        addLog(`Failed ${project.name} project`);
                                        return { icon: "üíÄ", text: `[NAT 1!] DISASTER. Major mistakes found. Blame falls on you.`, stats: "-15 Performance, -15 Boss rel, +20 Stress" };
                                    }
                                    state.performance -= 5;
                                    state.career.bossRelationship -= 5;
                                    return { icon: "üòî", text: `[Rolled ${check.total} vs DC ${project.difficulty}] Didn't meet expectations.`, stats: "-5 Performance, -5 Boss relationship" };
                                }
                            }
                        ]
                    }];
                }
                
                // Mid-project events
                if (roll < 0.4) {
                    return [{
                        category: "Project",
                        title: `${project.name} Progress`,
                        desc: `Week ${state.career.projectWeek}/${project.duration}. Current progress: ${state.career.projectSuccess}%`,
                        choices: [
                            {
                                text: "üé≤ Put in extra effort",
                                effect: () => {
                                    let check = rollWithModifier(state.skills.technical, 12);
                                    state.energy -= 20;
                                    
                                    if (check.nat20) {
                                        state.career.projectSuccess += 30;
                                        state.skills.technical += 3;
                                        return { icon: "üí°", text: "[NAT 20!] Breakthrough! Everything clicks.", stats: "+30% Success, +3 Technical" };
                                    }
                                    if (check.success) {
                                        state.career.projectSuccess += 15;
                                        return { icon: "üìà", text: `[Rolled ${check.total}] Good progress this week.`, stats: "+15% Success" };
                                    }
                                    state.career.projectSuccess += 5;
                                    state.stress += 10;
                                    return { icon: "üòì", text: `[Rolled ${check.total}] Struggling, but moving forward.`, stats: "+5% Success, +10 Stress" };
                                }
                            },
                            {
                                text: "Ask ally for help",
                                condition: () => state.career.coworkerAlly,
                                effect: () => {
                                    state.career.projectSuccess += 12;
                                    state.skills.social += 1;
                                    return { icon: "ü§ù", text: `${state.career.coworkerAlly} helps out. Teamwork.`, stats: "+12% Success, +1 Social" };
                                }
                            },
                            {
                                text: "Standard effort",
                                effect: () => {
                                    state.career.projectSuccess += 8;
                                    return { icon: "üíº", text: "Steady work. On track.", stats: "+8% Success" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // RIVAL INTERFERENCE
            if (state.career.coworkerRival && roll < 0.12) {
                return [{
                    category: "Office Politics",
                    title: `${state.career.coworkerRival}'s Move`,
                    desc: `${state.career.coworkerRival} is spreading rumors about your work quality to the boss.`,
                    choices: [
                        {
                            text: "üé≤ Confront them directly",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 13);
                                
                                if (check.nat20) {
                                    state.career.coworkerRival = null;
                                    state.career.bossRelationship += 10;
                                    return { icon: "üëä", text: `[NAT 20!] You expose their scheme publicly. ${state.career.coworkerRival} is humiliated. They back off.`, stats: "+10 Boss rel, Rival neutralized" };
                                }
                                if (check.success) {
                                    state.career.bossRelationship += 5;
                                    state.stress += 10;
                                    return { icon: "üò§", text: `[Rolled ${check.total}] You call them out. Tension, but the truth is known.`, stats: "+5 Boss rel, +10 Stress" };
                                }
                                state.career.bossRelationship -= 10;
                                state.stress += 15;
                                return { icon: "üò†", text: `[Rolled ${check.total}] You look petty. Boss doesn't want drama.`, stats: "-10 Boss rel, +15 Stress" };
                            }
                        },
                        {
                            text: "Let your work speak",
                            effect: () => {
                                state.performance += 5;
                                state.stress += 10;
                                return { icon: "üí™", text: "Rise above. Double down on excellence.", stats: "+5 Performance, +10 Stress" };
                            }
                        },
                        {
                            text: "Report to HR",
                            effect: () => {
                                if (Math.random() > 0.4) {
                                    state.career.coworkerRival = null;
                                    return { icon: "üìã", text: "HR investigates. The behavior stops.", stats: "Rival neutralized" };
                                }
                                state.skills.social -= 5;
                                return { icon: "üò¨", text: "HR finds 'no evidence.' You look like a tattletale.", stats: "-5 Social" };
                            }
                        }
                    ]
                }];
            }
            
            // ALLY SUPPORT EVENT
            if (state.career.coworkerAlly && roll < 0.18) {
                return [{
                    category: "Workplace",
                    title: `${state.career.coworkerAlly} Has Your Back`,
                    desc: `${state.career.coworkerAlly} wants to grab lunch and chat about a opportunity.`,
                    choices: [
                        {
                            text: "Join them",
                            effect: () => {
                                state.happiness += 8;
                                state.career.networkContacts += 3;
                                state.money -= 15;
                                if (Math.random() < 0.3) {
                                    state.career.bossRelationship += 5;
                                    return { icon: "üí°", text: `${state.career.coworkerAlly} shares insider info about what the boss values.`, stats: "+8 Happiness, +5 Boss rel, +3 Network" };
                                }
                                return { icon: "üçú", text: "Good lunch. Good talk. Workplace feels friendlier.", stats: "+8 Happiness, +3 Network, -$15" };
                            }
                        },
                        {
                            text: "Too busy",
                            effect: () => {
                                state.performance += 2;
                                return { icon: "üíº", text: "Work comes first.", stats: "+2 Performance" };
                            }
                        }
                    ]
                }];
            }
            
            // SIDE HUSTLE OPPORTUNITY
            if (!state.career.sideHustle && state.weeksAtJob >= 20 && roll < 0.08) {
                let availableHustles = Object.entries(SIDE_HUSTLES).filter(([k, h]) => 
                    !h.skillReq || state.skills[h.skillReq] >= h.minSkill
                );
                if (availableHustles.length > 0) {
                    let [hustleKey, hustle] = availableHustles[Math.floor(Math.random() * availableHustles.length)];
                    return [{
                        category: "Opportunity",
                        title: "Side Hustle Idea",
                        desc: `You've been thinking about ${hustle.name.toLowerCase()} on the side. Extra income, but it'll take time.`,
                        choices: [
                            {
                                text: `Start ${hustle.name} (${hustle.icon} ~$${hustle.income}/week)`,
                                effect: () => {
                                    state.career.sideHustle = hustleKey;
                                    state.energy -= 10;
                                    addLog(`Started ${hustle.name} side hustle`);
                                    return { icon: hustle.icon, text: `You start ${hustle.name.toLowerCase()}. The grind begins.`, stats: `Side hustle active, +~$${hustle.income}/week, -${hustle.timeReq} Energy/week` };
                                }
                            },
                            {
                                text: "Focus on main job",
                                effect: () => {
                                    state.performance += 3;
                                    return { icon: "üíº", text: "One job is enough stress.", stats: "+3 Performance" };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // LAYOFF/RECESSION EVENT (Random, rare)
            if (roll < 0.02 && state.weeksAtJob >= 26) {
                return [{
                    category: "‚ö†Ô∏è Crisis",
                    title: "Company Downsizing",
                    desc: "Economy's rough. Your department is being 'restructured.' Your job is on the line.",
                    choices: [
                        {
                            text: "üé≤ Fight for your position",
                            effect: () => {
                                let check = rollWithModifier(state.performance + state.career.bossRelationship - 50, 14);
                                
                                if (check.success) {
                                    state.stress += 20;
                                    state.career.bossRelationship += 10;
                                    return { icon: "üí™", text: `[Rolled ${check.total} vs DC 14] You made the cut. Survivors guilt hits different.`, stats: "+20 Stress, +10 Boss rel, Still employed" };
                                }
                                state.employed = false;
                                state.job = null;
                                state.phase = 'job_hunting';
                                state.money += job.salary * 4; // Severance
                                state.happiness -= 20;
                                state.career.companiesWorked++;
                                addLog("Laid off in downsizing");
                                return { icon: "üì¶", text: `[Rolled ${check.total} vs DC 14] You're let go. Severance helps, but still stings.`, stats: `+$${job.salary * 4} severance, -20 Happiness` };
                            }
                        },
                        {
                            text: "Take voluntary severance",
                            effect: () => {
                                state.employed = false;
                                state.job = null;
                                state.phase = 'job_hunting';
                                state.money += job.salary * 8; // Better severance for volunteers
                                state.career.companiesWorked++;
                                addLog("Took voluntary severance");
                                return { icon: "üí∞", text: "Better package for going quietly. Time for something new.", stats: `+$${job.salary * 8} severance` };
                            }
                        }
                    ]
                }];
            }
            
            // Promotion check
            if (state.performance > 80 && state.weeksAtJob > 52 && roll < 0.12) {
                events.push(getPromotionEvent());
                return events;
            }
            
            // Standard work events
            if (roll < 0.18) {
                events.push({
                    category: "Work",
                    title: "Crunch Time",
                    desc: "Big deadline. The boss is watching. Everyone's stressed.",
                    choices: [
                        {
                            text: "Work overtime",
                            effect: () => {
                                state.performance = Math.min(100, state.performance + 10);
                                state.energy -= 25;
                                state.stress += 15;
                                state.money += Math.floor(job.salary * 0.3);
                                state.career.bossRelationship += 5;
                                return { icon: "üí™", text: "Crushed it. Boss noticed the dedication.", stats: `+10 Perf, +30% bonus, +5 Boss rel` };
                            }
                        },
                        {
                            text: "Do your part, go home on time",
                            effect: () => {
                                state.performance = Math.min(100, state.performance + 3);
                                return { icon: "‚è∞", text: "Did the job. Nothing more.", stats: "+3 Performance" };
                            }
                        },
                        {
                            text: "Coast through it",
                            effect: () => {
                                state.performance = Math.max(0, state.performance - 5);
                                state.energy += 10;
                                if (state.career.coworkerRival) state.career.bossRelationship -= 3;
                                return { icon: "üòé", text: "Not your problem. Others pick up the slack.", stats: "-5 Performance, +10 Energy" };
                            }
                        }
                    ]
                });
            } else if (roll < 0.28 && state.performance < 30) {
                events.push({
                    category: "Work",
                    title: "Performance Review",
                    desc: "HR wants to see you. This doesn't look good.",
                    choices: [
                        {
                            text: "üé≤ Promise to do better",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 12);
                                if (check.success) {
                                    state.stress += 20;
                                    state.performance += 10;
                                    return { icon: "üò∞", text: `[Rolled ${check.total}] Final warning. You're on a PIP. Shape up.`, stats: "+20 Stress, +10 Performance (pressure)" };
                                }
                                state.employed = false;
                                state.job = null;
                                state.phase = 'job_hunting';
                                state.happiness -= 25;
                                state.career.companiesWorked++;
                                addLog("Got fired");
                                return { icon: "üì¶", text: `[Rolled ${check.total}] You're terminated. Pack your things.`, stats: "-25 Happiness, Job lost" };
                            }
                        }
                    ]
                });
            } else {
                events.push(getRoutineWorkEvent());
            }
            
            // Process side hustle income
            if (state.career.sideHustle) {
                let hustle = SIDE_HUSTLES[state.career.sideHustle];
                let income = hustle.income + (hustle.variance ? Math.floor(Math.random() * hustle.variance) - hustle.variance/2 : 0);
                state.money += Math.max(0, income);
                state.energy -= hustle.timeReq;
            }
            
            // Random life events can happen while employed
            let lifeEvent = getRandomLifeEvent();
            if (lifeEvent && Math.random() < 0.25) {
                events.push(lifeEvent);
            }
            
            return events;
        }

        function getRoutineWorkEvent() {
            let job = JOBS[state.job];
            if (!job) return { category: "Life", title: "Taking It Easy", desc: "No job, no stress.", choices: [{ text: "Continue", effect: () => ({ icon: "ü§∑", text: "Another day.", stats: "" }) }] };
            
            let jobCategory = null;
            for (let [cat, data] of Object.entries(JOB_CATEGORIES)) {
                if (data.jobs.includes(state.job)) {
                    jobCategory = cat;
                    break;
                }
            }
            
            // Job-specific routine events
            let routineText = jobCategory === 'retail' ? "Customers, inventory, the usual retail grind." :
                             jobCategory === 'tech' ? "Meetings, code, tickets, standup. Tech life." :
                             jobCategory === 'office' ? "Emails, meetings, spreadsheets. Corporate life." :
                             jobCategory === 'trades' ? "Tools, clients, physical work. Blue collar life." :
                             `Another week at ${state.jobTitle}.`;
            
            return {
                category: "Work",
                title: "Work Week",
                desc: routineText,
                choices: [
                    {
                        text: "üé≤ Work hard",
                        effect: () => {
                            let check = rollWithModifier(state.skills.technical, 10);
                            state.energy -= 15;
                            
                            if (check.nat20) {
                                state.performance = Math.min(100, state.performance + 8);
                                state.career.bossRelationship += 5;
                                state.skills.technical += 2;
                                return { icon: "‚≠ê", text: "[NAT 20!] Outstanding week. Boss mentions it.", stats: "+8 Perf, +5 Boss rel, +2 Technical" };
                            }
                            if (check.success) {
                                state.performance = Math.min(100, state.performance + 4);
                            state.skills.technical += 1;
                                return { icon: "üíº", text: `[Rolled ${check.total}] Solid work. Building reputation.`, stats: "+4 Perf, +1 Technical" };
                            }
                            state.performance = Math.min(100, state.performance + 2);
                            return { icon: "üìä", text: `[Rolled ${check.total}] Average week.`, stats: "+2 Performance" };
                        }
                    },
                    {
                        text: "Just get by",
                        effect: () => {
                            state.performance = Math.max(0, state.performance - 1);
                            state.energy += 5;
                            return { icon: "üòê", text: "Paycheck earned.", stats: "-1 Perf, +5 Energy" };
                        }
                    },
                    {
                        text: "Focus on networking",
                        effect: () => {
                            state.skills.social += 2;
                            state.career.networkContacts += 2;
                            state.energy -= 10;
                            return { icon: "ü§ù", text: "Making connections.", stats: "+2 Social, +2 Network" };
                        }
                    }
                ]
            };
        }

        function getPromotionEvent() {
            let job = JOBS[state.job];
            let allyHelp = state.career.coworkerAlly ? 5 : 0;
            let rivalPenalty = state.career.coworkerRival ? -5 : 0;
            
            return {
                category: "üéâ Career",
                title: "Promotion Opportunity!",
                desc: `Your performance (${state.performance}%) and boss relationship (${state.career.bossRelationship}%) have been noticed. Position opening up.`,
                choices: [
                    {
                        text: "üé≤ Go for the promotion",
                        effect: () => {
                            let bonus = Math.floor((state.performance - 50) / 5) + Math.floor((state.career.bossRelationship - 50) / 5) + allyHelp + rivalPenalty;
                            let check = rollWithModifier(state.skills.social + bonus, 13);
                            
                            if (check.nat20 || check.success) {
                                let currentSalary = job.salary;
                                let better = Object.entries(JOBS).find(([k, j]) => 
                                    j.salary > currentSalary && meetsRequirements(k)
                                );
                                if (better) {
                                    state.job = better[0];
                                    state.jobTitle = better[1].title;
                                    state.performance = 50;
                                    state.weeksAtJob = 0;
                                    state.happiness += check.nat20 ? 35 : 25;
                                    state.career.companiesWorked;
                                    state.career.bossRelationship = 50;
                                    addLog(`Promoted to ${better[1].title}`);
                                    let raise = better[1].salary - currentSalary;
                                    return { icon: check.nat20 ? "üåü" : "üéâ", text: `${check.nat20 ? '[NAT 20!] ' : ''}Promoted to ${better[1].title}!`, stats: `+$${raise}/week, +${check.nat20 ? 35 : 25} Happiness` };
                                }
                            }
                            if (check.nat1) {
                                state.happiness -= 15;
                                state.career.promotionsDenied++;
                                state.career.bossRelationship -= 10;
                                return { icon: "üíÄ", text: "[NAT 1!] You bombed the interview. Embarrassing.", stats: "-15 Happiness, -10 Boss rel" };
                            }
                            state.happiness -= 10;
                            state.career.promotionsDenied++;
                            return { icon: "üòî", text: `[Rolled ${check.total} vs DC 13] Passed over. ${state.career.coworkerRival ? state.career.coworkerRival + ' got it.' : 'Not your time.'}`, stats: "-10 Happiness" };
                        }
                    },
                    {
                        text: "Negotiate a raise instead",
                        effect: () => {
                            let check = rollWithModifier(state.skills.social, 11);
                            if (check.success) {
                                let raise = Math.floor(job.salary * 0.15);
                                state.weeklyIncome += raise;
                                state.career.bossRelationship -= 3;
                                return { icon: "üíµ", text: `[Rolled ${check.total}] Raise negotiated!`, stats: `+$${raise}/week ongoing` };
                            }
                            return { icon: "ü§∑", text: `[Rolled ${check.total}] "Budget's tight." No raise.`, stats: "" };
                        }
                    }
                ]
            };
        }

        function getRandomLifeEvent() {
            let roll = Math.random();
            
            // ============ FAMILY HELP (when broke with wealthy family) ============
            if (state.money < 200 && Math.random() < 0.3) {
                let familyHelp = getFamilyHelpEvent();
                if (familyHelp) return familyHelp;
            }
            
            // ============ ATTRACTIVENESS "DOORS OPEN" EVENTS ============
            let attractiveness = state.currentAttractiveness || state.characterTraits?.attractiveness || 5;
            if (attractiveness >= 8 && Math.random() < 0.08) {
                return getAttractivenessBonusEvent();
            }
            
            // ============ RELATIONSHIP EVENTS ============
            
            // Meeting someone new (when single) - chance increases with social skills, attractiveness, and socializing
            let meetChance = 0.08; // Base 8% chance
            meetChance += (state.skills.social / 200); // +0-50% from social skills (up to +25% at 50 social)
            meetChance += ((state.currentAttractiveness || 5) - 5) * 0.02; // +/- up to 10% from attractiveness
            meetChance += (state.freeTimeMeetingBonus || 0); // Bonus from socializing in free time
            if (state.subscriptions.dating) meetChance += 0.05; // Dating apps premium bonus
            meetChance = Math.max(0.05, Math.min(0.50, meetChance)); // Clamp between 5% and 50%
            
            if (!state.hasPartner && roll < meetChance) {
                // Different meeting scenarios based on social level
                let meetingScenarios = [
                    { place: "at a coffee shop", social: 0 },
                    { place: "at the grocery store", social: 0 },
                    { place: "at a friend's party", social: 30 },
                    { place: "at a networking event", social: 40 },
                    { place: "through mutual friends", social: 35 },
                    { place: "at the gym", social: 20, req: () => state.fitness.gymMember },
                    { place: "at a work event", social: 25, req: () => state.employed },
                    { place: "at a bar with friends", social: 30 }
                ];
                
                let availableScenarios = meetingScenarios.filter(s => 
                    state.skills.social >= s.social && (!s.req || s.req())
                );
                let scenario = availableScenarios[Math.floor(Math.random() * availableScenarios.length)];
                
                return {
                    category: "Social",
                    title: "Someone Catches Your Eye",
                    desc: `You're ${scenario.place}‚Äîand you notice someone. They notice you back.`,
                    choices: [
                        {
                            text: "üé≤ Say hello",
                            effect: () => {
                                let partner = generatePartner();
                                let check = rollWithModifier(state.skills.social + calculateAppeal(), 12);
                                
                                if (check.nat20) {
                                    state.hasPartner = true;
                                    state.partnerName = partner.name;
                                    state.partnerStats = partner;
                                    state.partnerStats.quality += 15;
                                    state.relationshipWeeks = 0;
                                    state.happiness += 20;
                                    state.relationship.datesCount = 0;
                                    addLog(`Started dating ${partner.name}`);
                                    return { icon: "üíò", text: `[NAT 20!] Instant connection with ${partner.name}. This feels different.`, stats: "+20 Happiness, Great partner!" };
                                }
                                if (check.success) {
                                    state.hasPartner = true;
                                    state.partnerName = partner.name;
                                    state.partnerStats = partner;
                                    state.relationshipWeeks = 0;
                                    state.happiness += 15;
                                    state.relationship.datesCount = 0;
                                    addLog(`Started dating ${partner.name}`);
                                    return { icon: "üíï", text: `[Rolled ${check.total}] You exchange numbers with ${partner.name}.`, stats: "+15 Happiness" };
                                }
                                if (check.nat1) {
                                    state.happiness -= 5;
                                    state.skills.social -= 1;
                                    return { icon: "üò∞", text: "[NAT 1!] You trip, spill coffee on them. Mortifying.", stats: "-5 Happiness, -1 Social" };
                                }
                                return { icon: "üòÖ", text: `[Rolled ${check.total}] Awkward. They were just looking at their phone.`, stats: "" };
                            }
                        },
                        {
                            text: "Keep to yourself",
                            effect: () => {
                                return { icon: "üò∂", text: "The moment passes. Maybe next time.", stats: "" };
                            }
                        }
                    ]
                };
            }
            
            // DATE NIGHT (When dating, not recently dated)
            if (state.hasPartner && state.totalWeeks - state.relationship.lastDateWeek >= 3 && roll < 0.2) {
                let availableDates = Object.entries(DATE_ACTIVITIES).filter(([k, d]) => state.money >= d.cost);
                if (availableDates.length > 0) {
                    return {
                        category: "üíï Romance",
                        title: "Date Night",
                        desc: `${state.partnerName} wants to spend quality time together. What should you do?`,
                        choices: availableDates.slice(0, 4).map(([key, date]) => ({
                            text: `${date.icon} ${date.name} ($${date.cost})`,
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, date.dc);
                                state.money -= date.cost;
                                state.relationship.lastDateWeek = state.totalWeeks;
                                state.relationship.datesCount++;
                                
                                if (check.nat20) {
                                    state.partnerStats.supportiveness = Math.min(100, state.partnerStats.supportiveness + date.bondGain * 2);
                                    state.happiness += date.happinessGain * 1.5;
                                    return { icon: "üíò", text: `[NAT 20!] Perfect ${date.name.toLowerCase()}! ${state.partnerName} says it's the best date ever.`, stats: `+${date.bondGain * 2} Bond, +${Math.floor(date.happinessGain * 1.5)} Happiness` };
                                }
                                if (check.success) {
                                    state.partnerStats.supportiveness = Math.min(100, state.partnerStats.supportiveness + date.bondGain);
                                    state.happiness += date.happinessGain;
                                    return { icon: date.icon, text: `[Rolled ${check.total}] Great ${date.name.toLowerCase()} with ${state.partnerName}.`, stats: `+${date.bondGain} Bond, +${date.happinessGain} Happiness` };
                                }
                                if (check.nat1) {
                                    state.partnerStats.supportiveness = Math.max(0, state.partnerStats.supportiveness - 5);
                                    state.relationship.arguments++;
                                    return { icon: "üò¨", text: `[NAT 1!] Everything went wrong. ${state.partnerName} seems frustrated.`, stats: "-5 Bond, Argument" };
                                }
                                state.partnerStats.supportiveness = Math.min(100, state.partnerStats.supportiveness + Math.floor(date.bondGain / 2));
                                state.happiness += Math.floor(date.happinessGain / 2);
                                return { icon: "üôÇ", text: `[Rolled ${check.total}] Decent date. Could've been better.`, stats: `+${Math.floor(date.bondGain / 2)} Bond` };
                            }
                        }))
                    };
                }
            }
            
            // MEET THE FAMILY (After 6 months dating)
            if (state.hasPartner && !state.relationship.metFamily && state.relationshipWeeks >= 26 && roll < 0.15) {
                return {
                    category: "Milestone",
                    title: "Meet the Parents",
                    desc: `${state.partnerName} wants you to meet their family. This is big.`,
                    choices: [
                        {
                            text: "üé≤ Make a good impression",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social, 13);
                                state.relationship.metFamily = true;
                                state.stress += 10;
                                
                                if (check.nat20) {
                                    state.relationship.familyApproval = 90;
                                    state.partnerStats.supportiveness += 15;
                                    state.happiness += 15;
                                    return { icon: "üåü", text: `[NAT 20!] They LOVE you. "${state.partnerName} found a keeper."`, stats: "+90 Family approval, +15 Bond" };
                                }
                                if (check.success) {
                                    state.relationship.familyApproval = 70;
                                    state.partnerStats.supportiveness += 8;
                                    state.happiness += 10;
                                    return { icon: "üòä", text: `[Rolled ${check.total}] Dinner went well. They seem to like you.`, stats: "+70 Family approval, +8 Bond" };
                                }
                                if (check.nat1) {
                                    state.relationship.familyApproval = 20;
                                    state.partnerStats.supportiveness -= 5;
                                    state.happiness -= 10;
                                    return { icon: "üíÄ", text: `[NAT 1!] You spilled wine, told a bad joke, and called their mom by the wrong name.`, stats: "+20 Family approval (ouch), -5 Bond" };
                                }
                                state.relationship.familyApproval = 50;
                                return { icon: "üòê", text: `[Rolled ${check.total}] Mixed reactions. They're "reserving judgment."`, stats: "+50 Family approval" };
                            }
                        },
                        {
                            text: "Not ready for this",
                            effect: () => {
                                state.partnerStats.supportiveness -= 8;
                                state.stress -= 10;
                                return { icon: "üò¨", text: `${state.partnerName} is disappointed but understands.`, stats: "-8 Bond" };
                            }
                        }
                    ]
                };
            }
            
            // MOVE IN TOGETHER (After 1 year, not living together)
            if (state.hasPartner && !state.relationship.livingTogether && state.relationshipWeeks >= 52 && roll < 0.12) {
                return {
                    category: "üíï Milestone",
                    title: "Move In Together?",
                    desc: `${state.partnerName} suggests getting a place together. Split rent, share space, take the plunge.`,
                    choices: [
                        {
                            text: "Yes, let's do it!",
                            effect: () => {
                                state.relationship.livingTogether = true;
                                state.home = 'apartment';
                                state.weeklyExpenses -= 75; // Shared costs
                                state.partnerStats.supportiveness += 15;
                                state.happiness += 20;
                                addLog(`Moved in with ${state.partnerName}`);
                                return { icon: "üè†", text: `You and ${state.partnerName} find a place. New chapter begins.`, stats: "+15 Bond, +20 Happiness, -$75/week expenses" };
                            }
                        },
                        {
                            text: "Too soon",
                            effect: () => {
                                state.partnerStats.supportiveness -= 10;
                                return { icon: "ü§î", text: `${state.partnerName} tries to hide their disappointment.`, stats: "-10 Bond" };
                            }
                        }
                    ]
                };
            }
            
            // RELATIONSHIP CRISIS (Random when in relationship)
            if (state.hasPartner && state.relationshipWeeks >= 20 && roll < 0.05) {
                let crisis = RELATIONSHIP_CRISES[Math.floor(Math.random() * RELATIONSHIP_CRISES.length)];
                return {
                    category: "üíî Crisis",
                    title: crisis.name,
                    desc: crisis.desc,
                    choices: [
                        {
                            text: "üé≤ Work through it together",
                            effect: () => {
                                let check = rollWithModifier(state.skills.social + Math.floor(state.partnerStats.supportiveness / 5), crisis.dc);
                                
                                if (check.nat20) {
                                    state.partnerStats.supportiveness += 10;
                                    state.happiness += 10;
                                    state.relationship.arguments++;
                                    return { icon: "üí™", text: `[NAT 20!] You both come out stronger. This was a turning point.`, stats: "+10 Bond, +10 Happiness" };
                                }
                                if (check.success) {
                                    state.partnerStats.supportiveness -= Math.floor(crisis.bondLoss / 3);
                                    state.stress += 10;
                                    state.relationship.arguments++;
                                    return { icon: "ü§ù", text: `[Rolled ${check.total} vs DC ${crisis.dc}] You talked it out. Things are better.`, stats: `-${Math.floor(crisis.bondLoss / 3)} Bond, +10 Stress` };
                                }
                                if (check.nat1) {
                                    if (state.partnerStats.supportiveness < 30) {
                                        state.hasPartner = false;
                                        state.partnerName = null;
                                        state.happiness -= 35;
                                        addLog("Relationship ended in crisis");
                                        return { icon: "üíî", text: `[NAT 1!] The fight escalated. They're gone.`, stats: "Relationship ended, -35 Happiness" };
                                    }
                                    state.partnerStats.supportiveness -= crisis.bondLoss * 1.5;
                                    state.stress += 25;
                                    return { icon: "üò¢", text: `[NAT 1!] Made it worse. Things are really bad now.`, stats: `-${Math.floor(crisis.bondLoss * 1.5)} Bond, +25 Stress` };
                                }
                                state.partnerStats.supportiveness -= crisis.bondLoss;
                                state.stress += 15;
                                state.relationship.arguments++;
                                return { icon: "üòî", text: `[Rolled ${check.total} vs DC ${crisis.dc}] Unresolved tension. This might come up again.`, stats: `-${crisis.bondLoss} Bond, +15 Stress` };
                            }
                        },
                        {
                            text: "Suggest couples counseling ($200)",
                            condition: () => state.money >= 200,
                            effect: () => {
                                state.money -= 200;
                                state.partnerStats.supportiveness += 5;
                                state.stress -= 10;
                                state.relationship.arguments++;
                                return { icon: "üõãÔ∏è", text: "Professional help. Smart move. Things improve gradually.", stats: "-$200, +5 Bond, -10 Stress" };
                            }
                        }
                    ]
                };
            }
            
            // PROPOSAL EVENT (After 1.5 years, not married)
            if (state.hasPartner && !state.married && state.relationshipWeeks >= 78 && roll < 0.1) {
                let bondLevel = state.partnerStats.supportiveness;
                return {
                    category: "üíç Romance",
                        title: "Getting Serious",
                    desc: `You and ${state.partnerName} have been together ${Math.floor(state.relationshipWeeks / 52)} years. Maybe it's time?`,
                        choices: [
                            {
                            text: "üíç Propose! ($2,000 ring)",
                                condition: () => state.money >= 2000,
                                effect: () => {
                                    state.money -= 2000;
                                let successChance = bondLevel / 100 + (state.relationship.familyApproval > 60 ? 0.1 : 0);
                                
                                if (Math.random() < successChance) {
                                        state.married = true;
                                    state.happiness += 35;
                                    state.partnerStats.supportiveness += 20;
                                        state.achievements.push('Married');
                                        addLog(`Married ${state.partnerName}`);
                                    return { icon: "üíí", text: `${state.partnerName} said YES! Wedding planning begins!`, stats: "-$2,000, +35 Happiness, +20 Bond, MARRIED!" };
                                }
                                state.partnerStats.supportiveness -= 25;
                                state.happiness -= 25;
                                return { icon: "üíî", text: `They said no. "I'm not ready." Devastating.`, stats: "-$2,000, -25 Bond, -25 Happiness" };
                            }
                        },
                        {
                            text: "üíé Propose big ($5,000 ring)",
                            condition: () => state.money >= 5000,
                            effect: () => {
                                state.money -= 5000;
                                let successChance = Math.min(0.95, bondLevel / 100 + 0.2);
                                
                                if (Math.random() < successChance) {
                                    state.married = true;
                                    state.happiness += 40;
                                    state.partnerStats.supportiveness += 25;
                                    state.achievements.push('Married');
                                    addLog(`Married ${state.partnerName}`);
                                    return { icon: "üíí", text: `${state.partnerName} is overwhelmed! YES! The ring is perfect!`, stats: "-$5,000, +40 Happiness, MARRIED!" };
                                }
                                state.partnerStats.supportiveness -= 20;
                                    state.happiness -= 30;
                                return { icon: "üíî", text: `Even the big ring wasn't enough. "I need time."`, stats: "-$5,000, -20 Bond, -30 Happiness" };
                                }
                            },
                            {
                            text: "Not yet",
                                effect: () => {
                                return { icon: "ü§î", text: "No rush. When it's right, it's right.", stats: "" };
                                }
                            }
                        ]
                    };
                }
            
            // HAVING CHILDREN (Married, no kids or wanting more)
            if (state.married && state.relationship.children < 3 && getAge() >= 25 && getAge() <= 42 && roll < 0.08) {
                return {
                    category: "üë∂ Family",
                    title: state.relationship.children === 0 ? "Starting a Family?" : "Another Child?",
                    desc: state.relationship.children === 0 ? 
                        `${state.partnerName} brings up having kids. "Are we ready?"` :
                        `${state.partnerName} mentions giving your ${state.relationship.children === 1 ? 'child' : 'kids'} a sibling.`,
                    choices: [
                        {
                            text: "Let's try!",
                            effect: () => {
                                if (Math.random() < 0.7) {
                                    let childName = CHILD_NAMES[Math.floor(Math.random() * CHILD_NAMES.length)];
                                    state.relationship.children++;
                                    state.relationship.childrenAges.push(0);
                                    state.happiness += 30;
                                    state.stress += 20;
                                    state.weeklyExpenses += 100; // Child costs
                                    state.partnerStats.supportiveness += 15;
                                    addLog(`Baby ${childName} born!`);
                                    state.achievements.push(state.relationship.children === 1 ? 'Parent' : `Parent of ${state.relationship.children}`);
                                    return { icon: "üë∂", text: `Months later... Baby ${childName} arrives! Everything changes.`, stats: `+30 Happiness, +20 Stress, +$100/week expenses, +15 Bond` };
                                }
                                state.stress += 10;
                                return { icon: "üòî", text: "Tried for a while. Not this time. You'll keep trying.", stats: "+10 Stress" };
                            }
                        },
                        {
                            text: "Not now",
                            effect: () => {
                                if (state.relationship.children === 0) {
                                    state.partnerStats.supportiveness -= 5;
                                }
                                return { icon: "ü§î", text: "Maybe later. Focus on other things for now.", stats: state.relationship.children === 0 ? "-5 Bond" : "" };
                            }
                        }
                    ]
                };
            }
            
            // PARENTING EVENTS (When have children)
            if (state.relationship.children > 0 && roll < 0.12) {
                // Age up children annually
                state.relationship.childrenAges = state.relationship.childrenAges.map(age => {
                    if (state.totalWeeks % 52 === 0) return age + 1;
                    return age;
                });
                
                // Find applicable parenting event
                let childAge = state.relationship.childrenAges[0] || 0;
                let events = PARENTING_EVENTS.filter(e => childAge >= e.age && childAge < e.age + 3);
                
                if (events.length > 0) {
                    let event = events[Math.floor(Math.random() * events.length)];
                    return {
                        category: "üë®‚Äçüë©‚Äçüëß Parenting",
                        title: event.title,
                        desc: event.desc,
                        choices: [
                            {
                                text: "Be fully present. Put everything else aside.",
                                effect: () => {
                                    state.energy += event.energy;
                                    state.stress += event.stress;
                                    state.happiness += event.happiness + 5;
                                    if (state.partnerStats) state.partnerStats.supportiveness += event.bond + 3;
                                    state.neglect.relationship = 0;
                                    
                                    return { icon: "‚ù§Ô∏è", text: `You're there. Really there. These moments matter.`, stats: `+${event.happiness + 5} Happiness` };
                                }
                            },
                            {
                                text: "Be there, but keep one eye on your phone.",
                                effect: () => {
                                    state.energy += Math.floor(event.energy / 2);
                                    state.stress += Math.floor(event.stress / 2);
                                    state.happiness += Math.floor(event.happiness / 2);
                                    if (state.partnerStats) state.partnerStats.supportiveness += Math.floor(event.bond / 2);
                                    
                                    return { icon: "üì±", text: `You were there... mostly. Phone in hand.`, stats: `` };
                                }
                            },
                            {
                                text: `Let ${state.partnerName || 'your partner'} handle this one.`,
                                condition: () => state.hasPartner,
                                effect: () => {
                                    state.energy += 15;
                                    state.partnerStats.supportiveness -= 8;
                                    state.stress -= 5;
                                    state.neglect.relationship += 1;
                                    
                                    return { icon: "üö™", text: `${state.partnerName} gives you a look. "I've got it. Again."`, stats: `` };
                                }
                            },
                            {
                                text: "Throw some money at the problem.",
                                condition: () => state.money >= 100,
                                effect: () => {
                                    state.money -= 100;
                                    state.energy += event.energy + 10;
                                    state.stress += Math.max(0, event.stress - 10);
                                    state.happiness += event.happiness;
                                    if (state.partnerStats) state.partnerStats.supportiveness += event.bond;
                                    
                                    return { icon: "üí≥", text: `Hired help, bought the thing, made it easier.`, stats: `-$100` };
                                }
                            }
                        ]
                    };
                }
            }
            
            // ============ OTHER LIFE EVENTS ============
            
            // Health events
            if (roll < 0.35 && state.health < 70) {
                return {
                    category: "Health",
                    title: "Feeling Run Down",
                    desc: "Your body is telling you to slow down. Headaches, fatigue, the works.",
                    choices: [
                        {
                            text: "See a doctor ($100)",
                            condition: () => state.money >= 100,
                            effect: () => {
                                state.money -= 100;
                                state.health = Math.min(100, state.health + 15);
                                return { icon: "üè•", text: "Doctor says rest and vitamins. You feel better.", stats: "-$100, +15 Health" };
                            }
                        },
                        {
                            text: "Push through it",
                            effect: () => {
                                state.health -= 5;
                                return { icon: "üò§", text: "No time to be sick. You'll be fine.", stats: "-5 Health" };
                            }
                        },
                        {
                            text: "Take a sick day",
                            effect: () => {
                                state.health += 10;
                                state.energy += 20;
                                if (state.employed) state.performance -= 3;
                                return { icon: "üõèÔ∏è", text: "Rest does wonders.", stats: "+10 Health, +20 Energy" };
                            }
                        }
                    ]
                };
            }
            
            // Housing upgrade
            if (roll < 0.4 && state.home === 'parents' && (state.employed || getAge() > 22)) {
                return {
                    category: "Independence",
                    title: "Time to Move Out?",
                    desc: "Living at home has its perks, but maybe it's time for your own space.",
                    choices: [
                        {
                            text: "Rent a room ($100/week)",
                            condition: () => state.money >= 400,
                            effect: () => {
                                state.money -= 400;
                                state.home = 'room';
                                state.happiness += 10;
                                addLog("Moved out of parents' house");
                                return { icon: "üö™", text: "Small room, but it's YOURS.", stats: "-$400, +10 Happiness" };
                            }
                        },
                        {
                            text: "Get an apartment ($200/week)",
                            condition: () => state.money >= 1000 && state.weeklyIncome >= 400,
                            effect: () => {
                                state.money -= 1000;
                                state.home = 'apartment';
                                state.happiness += 20;
                                addLog("Got own apartment");
                                return { icon: "üè¢", text: "Your own apartment! Real adult stuff.", stats: "-$1,000, +20 Happiness" };
                            }
                        },
                        {
                            text: "Stay home a bit longer",
                            effect: () => {
                                state.happiness -= 3;
                                return { icon: "üè†", text: "Saving money is smart. Even if it's embarrassing.", stats: "-3 Happiness" };
                            }
                        }
                    ]
                };
            }
            
            // ============ FISHING OPPORTUNITY ============
            if (Math.random() < 0.06) {
                return {
                    category: "üå≥ Recreation",
                    title: "Perfect Day for Fishing",
                    desc: "The weather is beautiful - ideal for a relaxing fishing trip. Where would you like to go?",
                    choices: [
                        {
                            text: "üèûÔ∏è Local Pond (Free)",
                            effect: () => {
                                goFishing('pond');
                                return null;
                            }
                        },
                        {
                            text: "üåä Lake ($10)",
                            condition: () => state.money >= 10,
                            effect: () => {
                                goFishing('lake');
                                return null;
                            }
                        },
                        {
                            text: "üèûÔ∏è River ($15)",
                            condition: () => state.money >= 15,
                            effect: () => {
                                goFishing('river');
                                return null;
                            }
                        },
                        {
                            text: "Maybe another time",
                            effect: () => {
                                return { icon: "ü§∑", text: "There's always next weekend.", stats: "" };
                            }
                        }
                    ]
                };
            }
            
            return null;
        }

        function getRandomLifeEvents() {
            let event = getRandomLifeEvent();
            if (event) return [event];
            
            let roll = Math.random();
            
            // GYM MEMBERSHIP OPPORTUNITY
            if (!state.fitness.gymMember && roll < 0.05) {
                return [{
                    category: "üí™ Self-Improvement",
                    title: "Gym Membership Offer",
                    desc: "A new gym opened nearby with a special offer. $50/week gets you full access.",
                    choices: [
                        {
                            text: "Sign up for the gym",
                            condition: () => state.money >= 50,
                            effect: () => {
                                state.fitness.gymMember = true;
                                state.weeklyExpenses += 50;
                                state.stress += 10; // Starting is hard
                                state.happiness += 5;
                                return { icon: "üèãÔ∏è", text: "New gym member! The first few weeks will be tough, but it'll pay off.", stats: "+$50/week expense, +10 Stress (temporary)" };
                            }
                        },
                        {
                            text: "Not right now",
                            effect: () => {
                                return { icon: "ü§∑", text: "Maybe someday. Just not today.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // CANCEL GYM (if paying but not going)
            if (state.fitness.gymMember && state.fitness.workoutStreak < 2 && roll < 0.03) {
                return [{
                    category: "üí™ Fitness",
                    title: "Gym Review",
                    desc: "You've been paying for the gym but haven't really been going. Keep the membership?",
                    choices: [
                        {
                            text: "Keep it, recommit to going",
                            effect: () => {
                                state.stress += 5;
                                return { icon: "üí™", text: "Renewed commitment. This time you'll stick with it.", stats: "+5 Stress (guilt)" };
                            }
                        },
                        {
                            text: "Cancel the membership",
                            effect: () => {
                                state.fitness.gymMember = false;
                                state.weeklyExpenses -= 50;
                                state.money += 50; // Refund for this week
                                return { icon: "üö™", text: "Cancelled. At least you're not wasting money anymore.", stats: "-$50/week expense" };
                            }
                        }
                    ]
                }];
            }
            
            // HEALTHY EATING OPPORTUNITY
            if (!state.fitness.healthyEating && roll < 0.04) {
                return [{
                    category: "ü•ó Self-Improvement",
                    title: "Clean Eating Challenge",
                    desc: "A friend is doing a 'clean eating' challenge. Meal prep, no junk food, the works. Join them? Costs about $30 extra per week for better groceries.",
                    choices: [
                        {
                            text: "Start eating healthier",
                            effect: () => {
                                state.fitness.healthyEating = true;
                                state.weeklyExpenses += 30;
                                state.health += 3;
                                return { icon: "ü•¨", text: "Week one: kale smoothies and lean proteins. This better be worth it.", stats: "+$30/week expense, +3 Health" };
                            }
                        },
                        {
                            text: "Pizza is a vegetable, right?",
                            effect: () => {
                                state.happiness += 3;
                                return { icon: "üçï", text: "Life's too short for sad salads.", stats: "+3 Happy" };
                            }
                        }
                    ]
                }];
            }
            
            // QUIT HEALTHY EATING
            if (state.fitness.healthyEating && Math.random() < 0.03) {
                return [{
                    category: "üçî Temptation",
                    title: "Craving Junk Food",
                    desc: "The smell of fresh pizza, burgers, fries... Your healthy eating streak is being tested.",
                    choices: [
                        {
                            text: "Stay strong. Eat the salad.",
                            effect: () => {
                                state.health += 2;
                                state.stress += 3;
                                return { icon: "üí™", text: "Discipline. The cravings will pass.", stats: "+2 Health, +3 Stress" };
                            }
                        },
                        {
                            text: "Give in just this once",
                            effect: () => {
                                state.happiness += 8;
                                state.health -= 2;
                                return { icon: "üçî", text: "SO good. Worth it? Maybe. Probably.", stats: "+8 Happy, -2 Health" };
                            }
                        },
                        {
                            text: "Quit healthy eating entirely",
                            effect: () => {
                                state.fitness.healthyEating = false;
                                state.weeklyExpenses -= 30;
                                state.happiness += 5;
                                return { icon: "üéâ", text: "Freedom! Back to normal food.", stats: "-$30/week expense, +5 Happy" };
                            }
                        }
                    ]
                }];
            }
            
            // GYM SESSION EVENT (when member)
            if (state.fitness.gymMember && Math.random() < 0.15) {
                return [{
                    category: "üèãÔ∏è Fitness",
                    title: "Gym Time",
                    desc: state.fitness.routineEstablished 
                        ? "Time for your regular workout. It's become part of your routine now."
                        : "Time to hit the gym. It's still hard to motivate yourself.",
                    choices: [
                        {
                            text: "Get a solid workout in",
                            effect: () => {
                                state.energy -= 15;
                                state.skills.physical += 1;
                                state.health += 2;
                                if (state.fitness.routineEstablished) {
                                    state.stress -= 5;
                                    state.happiness += 3;
                                    return { icon: "üí™", text: "Great session! Working out feels good now.", stats: "+1 Physical, +2 Health, -5 Stress" };
                                } else {
                                    state.stress += 3;
                                    return { icon: "üò§", text: "Ugh. Done. Everything hurts.", stats: "+1 Physical, +2 Health, +3 Stress" };
                                }
                            }
                        },
                        {
                            text: "Skip it today",
                            effect: () => {
                                state.fitness.workoutStreak = Math.max(0, state.fitness.workoutStreak - 1);
                                state.energy += 10;
                                if (state.fitness.workoutStreak === 0) {
                                    return { icon: "üõãÔ∏è", text: "Rest day. Again. The streak is broken.", stats: "+10 Energy, Lost workout streak" };
                                }
                                return { icon: "üõãÔ∏è", text: "Taking it easy today.", stats: "+10 Energy" };
                            }
                        }
                    ]
                }];
            }
            
            // ============ CREDIT CARD EVENTS ============
            
            // CREDIT CARD OFFER (when you don't have one)
            if (!state.finances.hasCreditCard && state.employed && Math.random() < 0.06) {
                // APR based on credit score (higher score = lower rate)
                let apr = getCreditCardAPR(state.finances.creditScore);
                let limit = getCreditCardLimit(state.finances.creditScore, state.weeklyIncome || 0);
                let aprPercent = (apr * 100).toFixed(1);
                
                let cardQuality = state.finances.creditScore >= 750 ? "Premium" : 
                                 state.finances.creditScore >= 650 ? "Standard" : "Basic";
                
                return [{
                    category: "üí≥ Finance",
                    title: "Credit Card Offer",
                    desc: `You've been pre-approved for a ${cardQuality} credit card! Limit: $${limit.toLocaleString()}, APR: ${aprPercent}%.`,
                    choices: [
                        {
                            text: "Accept the card - could be useful",
                            effect: () => {
                                state.finances.hasCreditCard = true;
                                state.finances.creditLimit = limit;
                                state.finances.creditAPR = apr;
                                state.finances.creditBalance = 0;
                                addLog(`Got credit card: $${limit} limit at ${aprPercent}% APR`);
                                return { icon: "üí≥", text: `New credit card! $${limit.toLocaleString()} limit. Use wisely‚Äîthat ${aprPercent}% APR adds up fast.`, stats: `Credit Limit: $${limit.toLocaleString()}` };
                            }
                        },
                        {
                            text: "No thanks - too risky",
                            effect: () => {
                                return { icon: "‚úã", text: "Credit cards can be a trap. Better to stick with what you have.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // USE CREDIT CARD (when broke but have a card)
            if (state.finances.hasCreditCard && state.money < 50 && state.finances.creditBalance < state.finances.creditLimit * 0.9 && Math.random() < 0.25) {
                let availableCredit = state.finances.creditLimit - state.finances.creditBalance;
                let suggestedAmount = Math.min(availableCredit, 500);
                
                return [{
                    category: "üí≥ Finance",
                    title: "Running Low on Cash",
                    desc: `Your wallet is nearly empty, but you have $${availableCredit.toLocaleString()} available on your credit card. The ${(state.finances.creditAPR * 100).toFixed(1)}% interest rate looms...`,
                    choices: [
                        {
                            text: "Put some expenses on the card ($200)",
                            condition: () => availableCredit >= 200,
                            effect: () => {
                                state.finances.creditBalance += 200;
                                state.money += 200;
                                state.stress -= 5;
                                return { icon: "üí≥", text: "Swiped. That's future-you's problem.", stats: "+$200 cash, +$200 credit card debt, -5 Stress" };
                            }
                        },
                        {
                            text: "Max it out - desperate times ($" + Math.min(500, availableCredit) + ")",
                            condition: () => availableCredit >= 300,
                            effect: () => {
                                let amount = Math.min(500, availableCredit);
                                state.finances.creditBalance += amount;
                                state.money += amount;
                                state.stress -= 8;
                                return { icon: "üí≥", text: "Big swipe. The interest is going to hurt later.", stats: `+$${amount} cash, +$${amount} credit card debt, -8 Stress` };
                            }
                        },
                        {
                            text: "Resist the temptation",
                            effect: () => {
                                state.stress += 5;
                                return { icon: "üò§", text: "Stay disciplined. Don't dig deeper into debt.", stats: "+5 Stress" };
                            }
                        }
                    ]
                }];
            }
            
            // CREDIT CARD PAYMENT DUE (monthly when you have a balance)
            if (state.finances.hasCreditCard && state.finances.creditBalance > 0 && state.totalWeeks % 4 === 0 && Math.random() < 0.8) {
                let balance = state.finances.creditBalance;
                let minPayment = Math.max(25, Math.ceil(balance * 0.02));
                let apr = (state.finances.creditAPR * 100).toFixed(1);
                
                return [{
                    category: "üí≥ Finance",
                    title: "Credit Card Statement",
                    desc: `Your credit card bill arrived. Balance: $${balance.toLocaleString()}. Minimum payment: $${minPayment}. APR: ${apr}%`,
                    choices: [
                        {
                            text: `Pay in full ($${balance.toLocaleString()})`,
                            condition: () => state.money >= balance,
                            effect: () => {
                                state.money -= balance;
                                state.finances.creditBalance = 0;
                                state.finances.missedPayments = 0;
                                state.finances.creditScore = Math.min(850, state.finances.creditScore + 2);
                                return { icon: "‚úÖ", text: "Paid in full! No interest this month. Your credit score improves.", stats: `-$${balance.toLocaleString()}, +2 Credit Score` };
                            }
                        },
                        {
                            text: `Pay half ($${Math.ceil(balance/2).toLocaleString()})`,
                            condition: () => state.money >= Math.ceil(balance/2) && balance > 100,
                            effect: () => {
                                let payment = Math.ceil(balance/2);
                                state.money -= payment;
                                state.finances.creditBalance -= payment;
                                state.finances.missedPayments = 0;
                                return { icon: "üíµ", text: `Paid $${payment}. Still carrying a balance‚Äîinterest will accrue.`, stats: `-$${payment}` };
                            }
                        },
                        {
                            text: `Minimum payment only ($${minPayment})`,
                            condition: () => state.money >= minPayment,
                            effect: () => {
                                state.money -= minPayment;
                                state.finances.creditBalance -= minPayment;
                                state.finances.missedPayments = 0;
                                let monthlyInterest = Math.ceil(state.finances.creditBalance * (state.finances.creditAPR / 12));
                                return { icon: "üò¨", text: `Minimum payment made. You'll pay about $${monthlyInterest} in interest this month. The debt trap deepens.`, stats: `-$${minPayment}` };
                            }
                        },
                        {
                            text: "Skip payment this month",
                            effect: () => {
                                state.finances.missedPayments++;
                                state.finances.creditScore = Math.max(300, state.finances.creditScore - 25);
                                state.stress += 15;
                                let lateFee = 35;
                                state.finances.creditBalance += lateFee;
                                return { icon: "‚ùå", text: `Payment missed! $${lateFee} late fee added. Your credit score tanks.`, stats: `-25 Credit Score, +$${lateFee} late fee, +15 Stress` };
                            }
                        }
                    ]
                }];
            }
            
            // CRISIS EVENTS (Rare but impactful)
            if (roll < 0.02) {
                let availableCrises = CRISIS_EVENTS.filter(c => c.condition());
                if (availableCrises.length > 0) {
                    let crisis = availableCrises[Math.floor(Math.random() * availableCrises.length)];
                    return [{
                        category: "‚ö†Ô∏è CRISIS",
                        title: crisis.title,
                        desc: crisis.desc,
                        choices: [
                            {
                                text: "Handle it yourself. You've got this.",
                                effect: () => {
                                    let outcome;
                                    let dc = crisis.dc || 12;
                                    let check = rollWithModifier(state.skills.physical, dc);
                                    if (check.nat1) {
                                        outcome = crisis.critFailOutcome;
                                    } else if (check.success) {
                                        outcome = crisis.successOutcome;
                                    } else {
                                        outcome = crisis.failOutcome;
                                    }
                                    
                                    if (outcome.health) state.health += outcome.health;
                                    if (outcome.stress) state.stress += outcome.stress;
                                    if (outcome.money) state.money += outcome.money;
                                    if (outcome.happiness) state.happiness += outcome.happiness;
                                    
                                    addLog(crisis.title);
                                    
                                    let statsList = [];
                                    if (outcome.health) statsList.push(`${outcome.health > 0 ? '+' : ''}${outcome.health} Health`);
                                    if (outcome.money) statsList.push(`${outcome.money > 0 ? '+' : ''}$${Math.abs(outcome.money)}`);
                                    if (outcome.stress) statsList.push(`+${outcome.stress} Stress`);
                                    
                                    return { icon: outcome.health < -30 ? "üö®" : "üò∞", text: `[Rolled ${check.total} vs DC ${dc}] ${outcome.text}`, stats: statsList.join(', ') };
                                }
                            },
                            {
                                text: "Throw money at the problem. Pay for professionals.",
                                condition: () => state.money >= Math.abs(crisis.failOutcome.money || 1000) * 1.5,
                                effect: () => {
                                    let cost = Math.abs(crisis.failOutcome.money || 1000) * 1.5;
                                    state.money -= cost;
                                    state.stress += 10;
                                    addLog(`${crisis.title} - paid to resolve`);
                                    return { icon: "üí∏", text: `Money solves problems. Crisis handled professionally.`, stats: `-$${cost.toLocaleString()}, +10 Stress` };
                                }
                            },
                            {
                                text: "üí≥ Put it on the credit card",
                                condition: () => {
                                    if (!state.finances.hasCreditCard) return false;
                                    let cost = Math.abs(crisis.failOutcome.money || 1000) * 1.5;
                                    let available = state.finances.creditLimit - state.finances.creditBalance;
                                    return available >= cost;
                                },
                                effect: () => {
                                    let cost = Math.abs(crisis.failOutcome.money || 1000) * 1.5;
                                    state.finances.creditBalance += cost;
                                    state.stress += 15;
                                    addLog(`${crisis.title} - charged to credit card`);
                                    return { icon: "üí≥", text: `Swiped. That's $${cost.toLocaleString()} in high-interest debt now. But the crisis is handled.`, stats: `+$${cost.toLocaleString()} credit card debt, +15 Stress` };
                                }
                            },
                            {
                                text: "Call someone for help. You don't have to do this alone.",
                                effect: () => {
                                    let cost = Math.floor(Math.abs(crisis.successOutcome.money || 500) * 0.8);
                                    state.money -= cost;
                                    state.stress += 10;
                                    if (crisis.successOutcome.health) state.health += Math.floor(crisis.successOutcome.health * 0.5);
                                    addLog(crisis.title);
                                    return { icon: "üì±", text: `Help arrived. Could have been worse.`, stats: `-$${cost}, +10 Stress` };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // PAY OFF CREDIT CARD PROMPT (when you have money and a balance)
            if (state.finances.hasCreditCard && state.finances.creditBalance > 100 && state.money > state.finances.creditBalance + 500 && Math.random() < 0.08) {
                let balance = state.finances.creditBalance;
                let apr = (state.finances.creditAPR * 100).toFixed(1);
                
                return [{
                    category: "üí≥ Finance",
                    title: "Extra Cash on Hand",
                    desc: `You have some extra money. That $${balance.toLocaleString()} credit card balance at ${apr}% is eating away at you. Pay it off?`,
                    choices: [
                        {
                            text: `Pay it all off ($${balance.toLocaleString()})`,
                            effect: () => {
                                state.money -= balance;
                                state.finances.creditBalance = 0;
                                state.stress -= 10;
                                state.finances.creditScore = Math.min(850, state.finances.creditScore + 3);
                                return { icon: "üéâ", text: "Debt-free on the card! That's a weight off your shoulders.", stats: `-$${balance.toLocaleString()}, -10 Stress, +3 Credit Score` };
                            }
                        },
                        {
                            text: `Pay half ($${Math.ceil(balance/2).toLocaleString()})`,
                            effect: () => {
                                let payment = Math.ceil(balance/2);
                                state.money -= payment;
                                state.finances.creditBalance -= payment;
                                state.stress -= 5;
                                return { icon: "üíµ", text: "Halfway there. Every bit helps against that interest.", stats: `-$${payment.toLocaleString()}, -5 Stress` };
                            }
                        },
                        {
                            text: "Keep the cash - might need it",
                            effect: () => {
                                return { icon: "ü§î", text: "Cash on hand is important too. You'll deal with the card later.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // WINDFALL EVENTS (Lucky breaks)
            if (roll < 0.04) {
                let availableWindfalls = WINDFALL_EVENTS.filter(w => w.condition() && Math.random() < w.rarity * 10);
                if (availableWindfalls.length > 0) {
                    let windfall = availableWindfalls[Math.floor(Math.random() * availableWindfalls.length)];
                    let amount = Math.floor(Math.random() * (windfall.maxAmount - windfall.minAmount)) + windfall.minAmount;
                    
                    return [{
                        category: "üéâ Lucky Break",
                        title: windfall.title,
                        desc: `${windfall.desc} You've got $${amount.toLocaleString()} coming your way.`,
                        choices: [
                            {
                                text: "Treat yourself! You've earned some fun.",
                                effect: () => {
                                    let kept = Math.floor(amount * 0.3);
                                    state.money += kept;
                                    state.happiness += 25;
                                    addLog(`${windfall.title}: spent most, kept $${kept.toLocaleString()}`);
                                    return { icon: "üéâ", text: `You splurge a bit. Life's short!`, stats: `+$${kept.toLocaleString()}` };
                                }
                            },
                            {
                                text: "Save every penny. Be responsible.",
                                effect: () => {
                                    state.money += amount;
                                    state.happiness += 5;
                                    state.finances.emergencyFund += Math.floor(amount * 0.2);
                                    addLog(`${windfall.title}: +$${amount.toLocaleString()}`);
                                    return { icon: "üè¶", text: `Straight to savings. Responsible.`, stats: `+$${amount.toLocaleString()}` };
                                }
                            },
                            {
                                text: "Invest it. Make money work for you.",
                                condition: () => state.finances.investmentType || amount >= 1000,
                                effect: () => {
                                    if (state.finances.investmentType) {
                                        state.finances.investments += amount;
                                    } else {
                                        state.finances.investmentType = 'moderate';
                                        state.finances.investments = amount;
                                    }
                                    state.happiness += 8;
                                    addLog(`${windfall.title}: invested $${amount.toLocaleString()}`);
                                    return { icon: "üìà", text: `Put it to work. Let's see it grow.`, stats: `Invested $${amount.toLocaleString()}` };
                                }
                            },
                            {
                                text: "Share the wealth with people you care about.",
                                condition: () => state.hasPartner || getAge() >= 25,
                                effect: () => {
                                    let kept = Math.floor(amount * 0.5);
                                    state.money += kept;
                                    state.happiness += 15;
                                    if (state.hasPartner) state.partnerStats.supportiveness += 10;
                                    state.neglect.relationship = 0;
                                    addLog(`${windfall.title}: shared, kept $${kept.toLocaleString()}`);
                                    return { icon: "üíï", text: `Generosity strengthens bonds.`, stats: `+$${kept.toLocaleString()}` };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // FAMILY EVENTS
            if (roll < 0.08) {
                let availableFamily = FAMILY_EVENTS.filter(f => f.condition());
                if (availableFamily.length > 0) {
                    let familyEvent = availableFamily[Math.floor(Math.random() * availableFamily.length)];
                    
                    if (familyEvent.choices) {
                        // Events with choices
                        if (familyEvent.title === "Parent Health Scare") {
                            return [{
                                category: "üë®‚Äçüë©‚Äçüëß Family",
                                title: familyEvent.title,
                                desc: familyEvent.desc,
                                choices: [
                                    {
                                        text: "Rush to be there",
                                        effect: () => {
                                            state.stress += 30;
                                            state.happiness -= 15;
                                            state.money -= 500;
                                            if (state.employed) state.performance -= 5;
                                            addLog("Parent hospitalized");
                                            return { icon: "üè•", text: "You drop everything. Family first. They pull through.", stats: "+30 Stress, -15 Happiness, -$500" };
                                        }
                                    },
                                    {
                                        text: "Send support, can't go",
                                        effect: () => {
                                            state.stress += 20;
                                            state.happiness -= 25;
                                            state.money -= 200;
                                            return { icon: "üòî", text: "You can't be there in person. The guilt is real.", stats: "+20 Stress, -25 Happiness, -$200" };
                                        }
                                    }
                                ]
                            }];
                        }
                        if (familyEvent.title === "Parent Needs Help") {
                            return [{
                                category: "üë®‚Äçüë©‚Äçüëß Family",
                                title: familyEvent.title,
                                desc: familyEvent.desc,
                                choices: [
                                    {
                                        text: "Provide financial help ($500/month)",
                                        condition: () => state.weeklyIncome >= 300,
                                        effect: () => {
                                            state.weeklyExpenses += 125; // $500/month
                                            state.happiness += 5;
                                            state.stress += 10;
                                            return { icon: "üíµ", text: "You start sending money monthly. It's the right thing.", stats: "+$125/week expenses, +5 Happiness" };
                                        }
                                    },
                                    {
                                        text: "Help with time, not money",
                                        effect: () => {
                                            state.energy -= 15;
                                            state.stress += 15;
                                            state.happiness += 10;
                                            if (state.employed) state.performance -= 3;
                                            return { icon: "ü§ù", text: "Weekly visits. Help with errands. It's exhausting but important.", stats: "-15 Energy, +10 Happiness" };
                                        }
                                    },
                                    {
                                        text: "Can't help right now",
                                        effect: () => {
                                            state.happiness -= 20;
                                            state.stress += 15;
                                            return { icon: "üòî", text: "You feel terrible, but you're barely keeping yourself afloat.", stats: "-20 Happiness, +15 Stress (guilt)" };
                                        }
                                    }
                                ]
                            }];
                        }
                    }
                    
                    // Events with meaningful choices about how to engage
                    let effects = familyEvent.effects;
                    return [{
                        category: "üë®‚Äçüë©‚Äçüëß Family",
                        title: familyEvent.title,
                        desc: familyEvent.desc,
                        choices: [
                            {
                                text: "Go all in. Family matters.",
                                effect: () => {
                                    if (effects.stress) state.stress += effects.stress;
                                    state.happiness += (effects.happiness || 0) + 5;
                                    state.money -= Math.abs(effects.money || 100);
                                    if (effects.social) state.skills.social += effects.social + 2;
                                    state.neglect.relationship = Math.max(0, state.neglect.relationship - 2);
                                    
                                    return { icon: "üë®‚Äçüë©‚Äçüëß", text: `You're fully present. Family bonds strengthen.`, stats: `` };
                                }
                            },
                            {
                                text: "Make an appearance, but don't overcommit.",
                                effect: () => {
                                    if (effects.stress) state.stress += Math.floor(effects.stress / 2);
                                    if (effects.happiness) state.happiness += Math.floor(effects.happiness / 2);
                                    state.money -= Math.floor(Math.abs(effects.money || 50) / 2);
                                    
                                    return { icon: "üòê", text: `You were there, but not really there.`, stats: `` };
                                }
                            },
                            {
                                text: "Send your regrets. You've got too much going on.",
                                condition: () => familyEvent.title !== "Parent Health Scare",
                                effect: () => {
                                    state.energy += 15;
                                    state.happiness -= 10;
                                    state.neglect.relationship += 2;
                                    if (state.hasPartner) state.partnerStats.supportiveness -= 5;
                                    
                                    return { icon: "üìµ", text: `You sent your regrets. Family is disappointed.`, stats: `` };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // INVESTMENT OPPORTUNITY
            if (roll < 0.12 && !state.finances.investmentType && state.money > 2000 && state.employed) {
                return [{
                    category: "üí∞ Finance",
                    title: "Investment Opportunity",
                    desc: "You've saved some money. Time to make it work for you?",
                    choices: Object.entries(INVESTMENT_TYPES).map(([key, inv]) => ({
                        text: `${inv.icon} ${inv.name} (Start with $1,000)`,
                        condition: () => state.money >= 1000,
                        effect: () => {
                            state.finances.investmentType = key;
                            state.finances.investments = 1000;
                            state.money -= 1000;
                            addLog(`Started ${inv.name} investing`);
                            return { icon: inv.icon, text: `You open a ${inv.name.toLowerCase()} investment account. Let's see how it grows.`, stats: "-$1,000 (invested)" };
                        }
                    })).concat([{
                        text: "Not interested in investing",
                        effect: () => {
                            return { icon: "ü§∑", text: "Keeping it liquid for now.", stats: "" };
                        }
                    }])
                }];
            }
            
            // ADD TO INVESTMENTS
            if (roll < 0.1 && state.finances.investmentType && state.money > 500) {
                let inv = INVESTMENT_TYPES[state.finances.investmentType];
                return [{
                    category: "üí∞ Finance",
                    title: "Add to Investments?",
                    desc: `Your ${inv.name.toLowerCase()} portfolio is at $${state.finances.investments.toLocaleString()}. Add more?`,
                    choices: [
                        {
                            text: "Add $500",
                            condition: () => state.money >= 500,
                            effect: () => {
                                state.finances.investments += 500;
                                state.money -= 500;
                                return { icon: "üìà", text: "Consistent investing builds wealth.", stats: "-$500 (invested)" };
                            }
                        },
                        {
                            text: "Add $1,000",
                            condition: () => state.money >= 1000,
                            effect: () => {
                                state.finances.investments += 1000;
                                state.money -= 1000;
                                return { icon: "üìà", text: "Bigger investments, bigger potential.", stats: "-$1,000 (invested)" };
                            }
                        },
                        {
                            text: "Withdraw everything",
                            effect: () => {
                                let amount = state.finances.investments;
                                state.money += amount;
                                state.finances.investments = 0;
                                state.finances.investmentType = null;
                                return { icon: "üíµ", text: `Cashed out $${amount.toLocaleString()}.`, stats: `+$${amount.toLocaleString()}` };
                            }
                        },
                        {
                            text: "Leave it alone",
                            effect: () => {
                                return { icon: "üìä", text: "Let it grow.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // HOME PURCHASE OPPORTUNITY
            if (roll < 0.08 && !state.finances.homeOwned && state.employed && state.weeklyIncome >= 500 && state.money >= 10000) {
                let creditTier = getCreditTier();
                let affordableHomes = Object.entries(HOMES_FOR_SALE).filter(([k, h]) => 
                    state.money >= h.downPayment * 0.5 && state.weeklyIncome >= h.mortgage * 0.4
                );
                
                if (affordableHomes.length > 0) {
                    return [{
                        category: "üè† Real Estate",
                        title: "Ready to Buy a Home?",
                        desc: `Your credit score (${state.finances.creditScore}) qualifies you for a mortgage. Down payment required.`,
                        choices: affordableHomes.slice(0, 3).map(([key, home]) => {
                            let adjustedMortgage = Math.floor(home.mortgage * creditTier.loanMultiplier);
                            return {
                                text: `${home.icon} ${home.name} - $${home.downPayment.toLocaleString()} down, $${adjustedMortgage}/week`,
                                condition: () => state.money >= home.downPayment,
                                effect: () => {
                                    state.money -= home.downPayment;
                                    state.finances.homeOwned = true;
                                    state.finances.homeValue = home.price;
                                    state.finances.mortgage = adjustedMortgage;
                                    state.home = 'house';
                                    state.weeklyExpenses += adjustedMortgage - HOUSING.house.rent;
                                    state.happiness += home.happiness;
                                    state.finances.creditScore += 20;
                                    addLog(`Bought ${home.name}`);
                                    state.achievements.push('Homeowner');
                                    return { icon: "üè†", text: `You're a homeowner! ${home.name} is yours.`, stats: `-$${home.downPayment.toLocaleString()}, +${home.happiness} Happiness, Building equity!` };
                                }
                            };
                        }).concat([{
                            text: "Keep renting",
                            effect: () => {
                                return { icon: "üè¢", text: "Not ready to commit to a mortgage.", stats: "" };
                            }
                        }])
                    }];
                }
            }
            
            // CAR PURCHASE OPPORTUNITY
            if (roll < 0.1 && (state.car === 'bus' || state.car === 'walk' || state.car === 'beater') && state.employed && state.money >= 5000) {
                let creditTier = getCreditTier();
                let affordableCars = Object.entries(CARS_FOR_SALE).filter(([k, c]) => 
                    state.money >= c.price * 0.2 || state.money >= c.price
                );
                
                if (affordableCars.length > 0) {
                    return [{
                        category: "üöó Transportation",
                        title: "Time for a New Car?",
                        desc: `Your current transport (${TRANSPORT[state.car].name}) is limiting. Upgrade?`,
                        choices: affordableCars.slice(0, 3).map(([key, car]) => {
                            let canPayCash = state.money >= car.price;
                            let loanPayment = Math.floor(car.loan * creditTier.loanMultiplier);
                            return {
                                text: canPayCash ? 
                                    `${car.icon} ${car.name} - Pay cash $${car.price.toLocaleString()}` :
                                    `${car.icon} ${car.name} - $${Math.floor(car.price * 0.2).toLocaleString()} down + $${loanPayment}/week`,
                                condition: () => state.money >= (canPayCash ? car.price : car.price * 0.2),
                                effect: () => {
                                    if (canPayCash) {
                                        state.money -= car.price;
                                        state.finances.carOwned = key;
                                        state.finances.carValue = car.price;
                                        state.finances.carPayment = 0;
                                    } else {
                                        state.money -= Math.floor(car.price * 0.2);
                                        state.finances.carOwned = key;
                                        state.finances.carValue = car.price;
                                        state.finances.carPayment = loanPayment;
                                        state.weeklyExpenses += loanPayment;
                                    }
                                    state.car = 'car';
                                    state.happiness += 10;
                                    state.finances.creditScore += 10;
                                    addLog(`Bought ${car.name}`);
                                    return { icon: car.icon, text: `New ${car.name}! Freedom on wheels.`, stats: canPayCash ? `-$${car.price.toLocaleString()}` : `Down payment + $${loanPayment}/week loan` };
                                }
                            };
                        }).concat([{
                            text: "Not now",
                            effect: () => {
                                return { icon: "üöå", text: "Current transport is fine for now.", stats: "" };
                            }
                        }])
                    }];
                }
            }
            
            // CREDIT SCORE EVENT
            if (roll < 0.05 && state.employed) {
                let change = Math.random() > 0.6 ? Math.floor(Math.random() * 20) + 5 : -(Math.floor(Math.random() * 15) + 5);
                let reason = change > 0 ? 
                    (Math.random() > 0.5 ? "On-time payments reported." : "Credit utilization improved.") :
                    (Math.random() > 0.5 ? "Hard inquiry on your credit." : "Slight increase in debt ratio.");
                
                // Credit events should have choices about how to respond
                if (change < 0) {
                    return [{
                        category: "üìä Credit",
                        title: "Credit Score Dropped",
                        desc: `Your credit score decreased. ${reason} How do you respond?`,
                        choices: [
                            {
                                text: `Pay down debt aggressively [-$300, +15 Credit]`,
                                condition: () => state.money >= 300,
                                effect: () => {
                                    state.money -= 300;
                                    state.finances.creditScore = Math.min(850, state.finances.creditScore + 15);
                                    state.debt = Math.max(0, state.debt - 300);
                                    return { icon: "üìà", text: `Aggressive debt paydown. Credit recovering.`, stats: `-$300, +15 Credit Score` };
                                }
                            },
                            {
                                text: `Dispute the report [50% chance to reverse, costs time]`,
                                effect: () => {
                                    state.energy -= 15;
                                    if (Math.random() > 0.5) {
                                        return { icon: "‚úÖ", text: `Dispute successful! Score unchanged.`, stats: `-15 Energy` };
                                    }
                                    state.finances.creditScore = Math.max(300, state.finances.creditScore + change);
                                    return { icon: "‚ùå", text: `Dispute rejected. Score drops.`, stats: `${change} Credit Score, -15 Energy` };
                                }
                            },
                            {
                                text: `Accept it and move on`,
                                effect: () => {
                                    state.finances.creditScore = Math.max(300, state.finances.creditScore + change);
                                    return { icon: "üìâ", text: `Credit score now: ${state.finances.creditScore}`, stats: `${change} Credit Score` };
                                }
                            }
                        ]
                    }];
                } else {
                    // Positive change - choice of how to leverage it
                    return [{
                        category: "üìä Credit",
                        title: "Credit Score Improved!",
                        desc: `Your credit score increased! ${reason} Take advantage?`,
                        choices: [
                            {
                                text: `Apply for better credit card [+Rewards, Risk of hard inquiry]`,
                                effect: () => {
                                    state.finances.creditScore = Math.min(850, state.finances.creditScore + change);
                                    if (Math.random() > 0.3) {
                                        state.weeklyIncome += 10; // Cashback rewards
                                        return { icon: "üí≥", text: `Approved! Better rewards card. +$10/week cashback.`, stats: `+${change} Credit, +$10/week` };
                                    }
                                    state.finances.creditScore -= 5; // Hard inquiry
                                    return { icon: "‚ùå", text: `Denied. Hard inquiry hurts score slightly.`, stats: `+${change - 5} Credit net` };
                                }
                            },
                            {
                                text: `Keep building steadily`,
                                effect: () => {
                                    state.finances.creditScore = Math.min(850, state.finances.creditScore + change + 3);
                                    return { icon: "üìà", text: `Playing it safe. Steady growth.`, stats: `+${change + 3} Credit Score` };
                                }
                            }
                        ]
                    }];
                }
            }
            
            // RETIREMENT CONTRIBUTION PROMPT (periodically)
            if (roll < 0.06 && state.employed && state.totalWeeks % 26 === 0) {
                return [{
                    category: "üí∞ Finance",
                    title: "401k Contribution",
                    desc: "Open enrollment. How much should go to retirement?",
                    choices: [
                        {
                            text: "Contribute 3% of salary",
                            effect: () => {
                                let contribution = Math.floor(state.weeklyIncome * 0.03 * 26);
                                state.finances.retirementAccount += contribution;
                                state.money -= contribution;
                                return { icon: "üë¥", text: "Building for the future.", stats: `+$${contribution} to 401k` };
                            }
                        },
                        {
                            text: "Max it out (10%)",
                            condition: () => state.weeklyIncome >= 400,
                            effect: () => {
                                let contribution = Math.floor(state.weeklyIncome * 0.10 * 26);
                                state.finances.retirementAccount += contribution;
                                state.money -= contribution;
                                return { icon: "üí∞", text: "Aggressive retirement saving. Future you thanks you.", stats: `+$${contribution} to 401k` };
                            }
                        },
                        {
                            text: "Skip for now",
                            effect: () => {
                                return { icon: "ü§∑", text: "Need the cash now.", stats: "" };
                            }
                        }
                    ]
                }];
            }
            
            // Ordinary week fallback
            return [{
                category: "Life",
                title: "An Ordinary Week",
                desc: "Sometimes life is just... life. Nothing dramatic. And that's okay.",
                choices: [
                    {
                        text: "Relax and recharge",
                        effect: () => {
                            state.energy = Math.min(100, state.energy + 20);
                            state.stress = Math.max(0, state.stress - 10);
                            return { icon: "üòå", text: "Some quiet time.", stats: "+20 Energy, -10 Stress" };
                        }
                    },
                    {
                        text: "Work on yourself",
                        effect: () => {
                            state.skills.physical += 2;
                            state.health = Math.min(100, state.health + 5);
                            return { icon: "üèÉ", text: "Hit the gym. Feeling good.", stats: "+2 Physical, +5 Health" };
                        }
                    },
                    {
                        text: "Be social",
                        effect: () => {
                            state.skills.social += 2;
                            state.happiness += 5;
                            state.money -= 30;
                            return { icon: "üë•", text: "Hung out with friends.", stats: "+2 Social, +5 Happiness, -$30" };
                        }
                    },
                    {
                        text: "Manage finances",
                        effect: () => {
                            state.finances.emergencyFund += 50;
                            state.stress -= 5;
                            return { icon: "üí∞", text: "Budgeting, planning. Responsible adult stuff.", stats: "+$50 emergency fund, -5 Stress" };
                        }
                    }
                ]
            }];
        }

        // ============ CORE GAME LOOP ============
        function advanceWeek() {
            state.totalWeeks++;
            state.week++;
            state.phaseWeek++;
            if (state.hasPartner) state.relationshipWeeks++;
            if (state.employed) state.weeksAtJob++;
            
            // Naturally drift toward neglect over time (player choices will counter this)
            if (state.employed && Math.random() < 0.3) state.neglect.work++;
            if (Math.random() < 0.25) state.neglect.health++;
            if (state.hasPartner && Math.random() < 0.35) state.neglect.relationship++;
            if (Math.random() < 0.2) state.neglect.fun++;
            
            // Validate free time allocation (in case circumstances changed)
            validateFreeTimeAllocation();
            
            // Weekly finances
            let net = calculateWeeklyFinances();
            state.money += net;
            
            // Pay down debt slowly
            if (state.debt > 0 && state.money > 0) {
                let payment = Math.min(state.debt, Math.ceil(state.debt / 200));
                // Debt payment already in expenses
            }
            
            // INVESTMENT RETURNS (Weekly)
            if (state.finances.investments > 0 && state.finances.investmentType) {
                let inv = INVESTMENT_TYPES[state.finances.investmentType];
                let randomFactor = Math.random();
                let returnRate;
                
                if (randomFactor < inv.risk) {
                    // Bad week - loss
                    returnRate = inv.minLoss * (Math.random() * 0.5 + 0.5);
                } else if (randomFactor > 0.95) {
                    // Great week - big gain
                    returnRate = inv.maxGain * (Math.random() * 0.5 + 0.5);
                } else {
                    // Normal week - average return
                    returnRate = inv.weeklyReturn * (Math.random() * 2);
                }
                
                let returnAmount = Math.floor(state.finances.investments * returnRate);
                state.finances.investments = Math.max(0, state.finances.investments + returnAmount);
                
                // Clear investment if it crashes to zero
                if (state.finances.investments <= 0) {
                    state.finances.investmentType = null;
                }
            }
            
            // HOME EQUITY GROWTH (Annually)
            if (state.finances.homeOwned && state.totalWeeks % 52 === 0) {
                let appreciation = state.finances.homeValue * (0.02 + Math.random() * 0.03); // 2-5% annual
                state.finances.homeValue += appreciation;
            }
            
            // CAR DEPRECIATION (Annually)
            if (state.finances.carOwned && state.totalWeeks % 52 === 0) {
                state.finances.carValue = Math.floor(state.finances.carValue * 0.85); // 15% annual depreciation
            }
            
            // CREDIT SCORE MAINTENANCE
            if (state.totalWeeks % 4 === 0) { // Monthly
                // Positive factors
                if (state.employed) state.finances.creditScore = Math.min(850, state.finances.creditScore + 1);
                if (state.debt < 1000) state.finances.creditScore = Math.min(850, state.finances.creditScore + 1);
                if (state.finances.homeOwned) state.finances.creditScore = Math.min(850, state.finances.creditScore + 0.5);
                // Good credit card behavior
                if (state.finances.hasCreditCard && state.finances.creditBalance === 0) {
                    state.finances.creditScore = Math.min(850, state.finances.creditScore + 1);
                }
                
                // Negative factors
                if (state.debt > 20000) state.finances.creditScore = Math.max(300, state.finances.creditScore - 2);
                if (state.money < 0) state.finances.creditScore = Math.max(300, state.finances.creditScore - 5);
                // High credit utilization hurts score
                if (state.finances.hasCreditCard && state.finances.creditBalance > state.finances.creditLimit * 0.3) {
                    state.finances.creditScore = Math.max(300, state.finances.creditScore - 2);
                }
                // Missed credit card payments tank score
                if (state.finances.missedPayments > 0) {
                    state.finances.creditScore = Math.max(300, state.finances.creditScore - (state.finances.missedPayments * 10));
                }
            }
            
            // CREDIT CARD INTEREST (Monthly)
            if (state.finances.hasCreditCard && state.finances.creditBalance > 0 && state.totalWeeks % 4 === 0) {
                // Apply monthly interest (APR / 12)
                let monthlyRate = state.finances.creditAPR / 12;
                let interest = Math.ceil(state.finances.creditBalance * monthlyRate);
                state.finances.creditBalance += interest;
                
                // Calculate minimum payment (usually 2% of balance or $25, whichever is greater)
                state.finances.minPaymentDue = Math.max(25, Math.ceil(state.finances.creditBalance * 0.02));
                
                // Cap balance at limit (over-limit fees simplified)
                if (state.finances.creditBalance > state.finances.creditLimit) {
                    state.finances.creditBalance = Math.ceil(state.finances.creditLimit * 1.1); // 10% over-limit allowed
                    state.stress += 5;
                }
            }
            
            // LOW MONEY STRESS
            if (state.money < 0) {
                state.stress += 8; // Severe stress when in the red
                state.happiness -= 3;
            } else if (state.money < 100) {
                state.stress += 5; // High stress when almost broke
                state.happiness -= 1;
            } else if (state.money < 300) {
                state.stress += 2; // Moderate stress when tight
            }
            
            // Credit card debt stress
            if (state.finances.creditBalance > 1000) {
                state.stress += Math.floor(state.finances.creditBalance / 2000); // +1 stress per $2000 in CC debt
            }
            
            // LIFESTYLE STRESS (from housing and transport)
            let housingStress = HOUSING[state.home]?.stress || 0;
            let transportStress = TRANSPORT[state.car]?.stress || 0;
            
            // Apply lifestyle stress (weekly, so divide by 4 for monthly-ish effect)
            if (state.totalWeeks % 2 === 0) { // Every 2 weeks
                state.stress += Math.max(0, housingStress);
                state.stress += Math.max(0, transportStress);
                
                // Nice housing/transport can REDUCE stress
                if (housingStress < 0) state.stress = Math.max(0, state.stress + housingStress);
                if (transportStress < 0) state.stress = Math.max(0, state.stress + transportStress);
            }
            
            // Exhaustion collapse check
            if (state.energy <= 0) {
                state.exhaustionCollapse = true;
            }
            
            // SUBSCRIPTION EFFECTS (weekly)
            processSubscriptionEffects();
            
            // HABIT EFFECTS (weekly)
            processHabitEffects();
            
            // Check for bad habit development from poor stat management
            checkBadHabitDevelopment();
            
            // Update willpower
            state.maxWillpower = calculateMaxWillpower();
            state.willpower = Math.max(0, state.maxWillpower - getTotalHabitCost());
            
            // FREE TIME EFFECTS (weekly)
            let freeTimeEffects = calculateFreeTimeEffects(state.freeTime);
            
            // Apply skill gains
            if (freeTimeEffects.physical) state.skills.physical = Math.min(100, state.skills.physical + freeTimeEffects.physical);
            if (freeTimeEffects.social) state.skills.social = Math.min(100, state.skills.social + freeTimeEffects.social);
            if (freeTimeEffects.technical) state.skills.technical = Math.min(100, state.skills.technical + freeTimeEffects.technical);
            if (freeTimeEffects.creativity) state.skills.creativity = Math.min(100, state.skills.creativity + freeTimeEffects.creativity);
            
            // Apply stat changes
            if (freeTimeEffects.stress) state.stress = Math.max(0, state.stress + freeTimeEffects.stress);
            if (freeTimeEffects.energy) state.energy = Math.min(100, state.energy + freeTimeEffects.energy);
            if (freeTimeEffects.happiness) state.happiness = Math.min(100, state.happiness + freeTimeEffects.happiness);
            if (freeTimeEffects.health) state.health = Math.min(100, state.health + freeTimeEffects.health);
            
            // Career XP from overtime
            if (freeTimeEffects.careerXP && state.employed) {
                state.career.performanceRating = Math.min(100, (state.career.performanceRating || 50) + freeTimeEffects.careerXP);
            }
            
            // GPA bonus from studying (if in education)
            if (freeTimeEffects.gpaBonus && state.phase === 'education') {
                state.gpa = Math.min(4.0, (state.gpa || 2.5) + freeTimeEffects.gpaBonus);
            }
            
            // Attractiveness from gym (gradual improvement)
            if (freeTimeEffects.attractiveness) {
                let baseAttr = state.characterTraits?.attractiveness || 5;
                let maxBonus = 2; // Max +2 from fitness
                let currentBonus = (state.currentAttractiveness || baseAttr) - baseAttr;
                let newBonus = Math.min(maxBonus, currentBonus + freeTimeEffects.attractiveness);
                state.currentAttractiveness = baseAttr + newBonus;
            }
            
            // Age-based attractiveness decline (annually)
            if (state.totalWeeks % 52 === 0) {
                let age = getAge();
                let baseAttr = state.characterTraits?.attractiveness || 5;
                let currentAttr = state.currentAttractiveness || baseAttr;
                let gymHours = state.freeTime.gym || 0;
                
                if (age >= 30) {
                    // After 30, attractiveness slowly declines without maintenance
                    let decline = 0.1; // Base annual decline
                    if (age >= 40) decline = 0.15;
                    if (age >= 50) decline = 0.2;
                    
                    // Gym time can offset the decline
                    let gymOffset = gymHours * 0.03; // Each gym hour offsets some decline
                    let netDecline = Math.max(0, decline - gymOffset);
                    
                    state.currentAttractiveness = Math.max(baseAttr - 2, currentAttr - netDecline);
                }
            }
            
            // Store meeting bonus for dating calculations
            state.freeTimeMeetingBonus = freeTimeEffects.meetingBonus || 0;
            state.freeTimeNetworkBonus = freeTimeEffects.networkBonus || 0;
            
            // Natural stat changes
            state.energy = Math.min(100, state.energy + 5);
            state.stress = Math.max(0, state.stress - 2);
            if (state.stress > 70) state.happiness -= 1;
            if (state.energy < 30) state.health -= 1;
            
            // Relationship maintenance
            if (state.hasPartner) {
                // Neglect penalty if not spending time
                if (Math.random() < 0.1) {
                    state.partnerStats.supportiveness -= 2;
                    if (state.partnerStats.supportiveness < 20) {
                        state.hasPartner = false;
                        state.partnerName = null;
                        state.partnerStats = null;
                        state.happiness -= 20;
                        addLog("Relationship ended");
                    }
                }
            }
            
            // Age-related health decline (after 40)
            if (getAge() > 40 && state.totalWeeks % 52 === 0) {
                state.health -= 2;
            }
            
            // Death checks
            if (state.health <= 0) {
                endGame("health");
                return false;
            }
            if (state.happiness <= 0) {
                endGame("despair");
                return false;
            }
            if (getAge() > 85 && Math.random() < 0.02) {
                endGame("age");
                return false;
            }
            
            // Clamp stats
            state.health = Math.max(0, Math.min(100, state.health));
            state.energy = Math.max(0, Math.min(100, state.energy));
            state.happiness = Math.max(0, Math.min(100, state.happiness));
            state.stress = Math.max(0, Math.min(100, state.stress));
            
            return true;
        }

        function getExhaustionCollapseEvent() {
            return {
                category: "‚ö†Ô∏è Collapse",
                title: "You've Hit the Wall",
                desc: "Your body simply refused to go any further. You collapsed from exhaustion.",
                choices: [
                    {
                        text: "Sleep it off at home (lose a week)",
                        effect: () => {
                            state.energy = 40;
                            state.health -= 10;
                            state.stress += 15;
                            if (state.employed) state.performance -= 15;
                            addLog("Collapsed from exhaustion");
                            return { icon: "üò¥", text: "You sleep for two days straight. Your body needed it desperately.", stats: "Energy restored, -10 Health" };
                        }
                    },
                    {
                        text: "Go to the hospital (costs money but safer)",
                        condition: () => state.money >= 500,
                        effect: () => {
                            state.money -= 500;
                            state.energy = 60;
                            state.health -= 5;
                            state.stress += 10;
                            if (state.employed) state.performance -= 10;
                            addLog("Hospitalized for exhaustion");
                            return { icon: "üè•", text: "IV fluids, rest, and stern warnings from doctors about self-care.", stats: "-$500, Energy restored, -5 Health" };
                        }
                    },
                    {
                        text: "Push through anyway (dangerous)",
                        effect: () => {
                            state.energy = 15;
                            state.health -= 25;
                            state.stress += 25;
                            let chance = Math.random();
                            if (chance < 0.3) {
                                state.health -= 15;
                                addLog("Collapsed and hit head");
                                return { icon: "üö®", text: "You tried to stand up and blacked out. Hit your head on the way down.", stats: "-40 Health total, Critical!" };
                            }
                            return { icon: "üò§", text: "Somehow you're still moving. But your body won't forget this.", stats: "-25 Health, +25 Stress" };
                        }
                    }
                ]
            };
        }

        function nextEvent() {
            // Skip week advancement during character creation
            if (state.phase !== 'character_creation') {
            if (!advanceWeek()) return;
                
                // Check for exhaustion collapse first
                if (state.exhaustionCollapse) {
                    state.exhaustionCollapse = false;
                    displayEvent(getExhaustionCollapseEvent());
                    updateUI();
                    return;
                }
                
                // Check for neglect warnings (consequences of your choices)
                if (Math.random() < 0.15) {
                    let neglectWarning = getNeglectWarningEvent();
                    if (neglectWarning) {
                        displayEvent(neglectWarning);
                        updateUI();
                        return;
                    }
                }
                
                // Process fitness benefits
                if (state.fitness.gymMember || state.fitness.healthyEating) {
                    processFitnessWeek();
                }
            }
            
            let events = getPhaseEvents();
            let event = events[Math.floor(Math.random() * events.length)];
            
            displayEvent(event);
            updateUI();
        }

        function displayEvent(event) {
            document.getElementById('eventCategory').innerText = event.category;
            document.getElementById('eventTitle').innerText = typeof event.title === 'function' ? event.title() : event.title;
            document.getElementById('eventDesc').innerText = typeof event.desc === 'function' ? event.desc() : event.desc;
            document.getElementById('eventDate').innerText = `Age ${getAge()}, Month ${getMonth()}`;
            
            let container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            
            event.choices.forEach(choice => {
                let btn = document.createElement('button');
                btn.className = 'choice-btn w-full text-left px-4 py-3 rounded-lg text-sm';
                btn.innerText = typeof choice.text === 'function' ? choice.text() : choice.text;
                
                if (choice.condition && !choice.condition()) {
                    btn.disabled = true;
                }
                
                btn.onclick = () => {
                    if (!btn.disabled) makeChoice(choice);
                };
                container.appendChild(btn);
            });
        }

        async function makeChoice(choice) {
            // Clear any previous roll data
            lastRollData = null;
            
            let outcome = choice.effect();
            
            // If a roll was made, show the dice animation first
            if (lastRollData) {
                await showDiceRoll(lastRollData);
                lastRollData = null;
            }
            
            // Show outcome
            document.getElementById('outcomeIcon').innerText = outcome.icon;
            document.getElementById('outcomeText').innerText = outcome.text;
            document.getElementById('outcomeStats').innerText = outcome.stats || '';
            document.getElementById('outcomeDisplay').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('outcomeDisplay').classList.add('hidden');
                nextEvent();
            }, 1500);
        }

        function updateUI() {
            // Stats
            document.getElementById('healthBar').style.width = state.health + '%';
            document.getElementById('healthVal').innerText = Math.floor(state.health);
            
            // Energy with penalty indicator
            document.getElementById('energyBar').style.width = state.energy + '%';
            let energyPenalty = 0;
            if (state.energy <= 20) energyPenalty = -2;
            else if (state.energy <= 40) energyPenalty = -1;
            
            let energyText = Math.floor(state.energy);
            if (energyPenalty !== 0) {
                energyText += ` (${energyPenalty})`;
                document.getElementById('energyVal').className = 'text-xs text-red-400';
            } else {
                document.getElementById('energyVal').className = 'text-xs text-gray-500';
            }
            document.getElementById('energyVal').innerText = energyText;
            document.getElementById('energyVal').title = energyPenalty !== 0 ? `${energyPenalty} penalty to all rolls` : 'No roll penalty';
            
            document.getElementById('happyBar').style.width = state.happiness + '%';
            document.getElementById('happyVal').innerText = Math.floor(state.happiness);
            document.getElementById('stressBar').style.width = Math.min(100, state.stress) + '%';
            // Show stress value with penalty indicator
            let stressPenalty = 0;
            if (state.stress >= 80) stressPenalty = -4;
            else if (state.stress >= 60) stressPenalty = -2;
            else if (state.stress >= 40) stressPenalty = -1;
            
            let stressText = Math.floor(state.stress);
            if (stressPenalty !== 0) {
                stressText += ` (${stressPenalty})`;
            }
            document.getElementById('stressVal').innerText = stressText;
            document.getElementById('stressVal').title = stressPenalty !== 0 ? `${stressPenalty} penalty to all rolls` : 'No roll penalty';
            
            // Color stress bar based on level
            let stressBar = document.getElementById('stressBar');
            if (state.stress >= 80) {
                stressBar.className = 'stat-fill h-full bg-red-500 rounded-full animate-pulse';
                document.getElementById('stressVal').className = 'text-xs text-red-400';
            } else if (state.stress >= 60) {
                stressBar.className = 'stat-fill h-full bg-orange-500 rounded-full';
                document.getElementById('stressVal').className = 'text-xs text-orange-400';
            } else if (state.stress >= 40) {
                stressBar.className = 'stat-fill h-full bg-yellow-500 rounded-full';
                document.getElementById('stressVal').className = 'text-xs text-yellow-400';
            } else {
                stressBar.className = 'stat-fill h-full bg-purple-500 rounded-full';
                document.getElementById('stressVal').className = 'text-xs text-gray-500';
            }
            
            // Time
            document.getElementById('ageDisplay').innerText = getAge();
            document.getElementById('monthDisplay').innerText = getMonth();
            
            // Money
            let moneyEl = document.getElementById('moneyDisplay');
            moneyEl.innerText = '$' + state.money.toLocaleString();
            
            // Visual stress indicator for money levels
            moneyEl.classList.remove('text-red-400', 'text-orange-400', 'text-yellow-400', 'animate-pulse');
            
            if (state.money < 0) {
                moneyEl.classList.add('text-red-400', 'animate-pulse');
                moneyEl.innerText = '$' + state.money.toLocaleString() + ' ‚ö†Ô∏è';
            } else if (state.money < 100) {
                moneyEl.classList.add('text-red-400');
                moneyEl.innerText = '$' + state.money.toLocaleString() + ' (BROKE)';
            } else if (state.money < 300) {
                moneyEl.classList.add('text-orange-400');
                moneyEl.innerText = '$' + state.money.toLocaleString() + ' (tight)';
            } else if (state.money < 500) {
                moneyEl.classList.add('text-yellow-400');
            }
            
            if (state.debt > 0) {
                document.getElementById('debtDisplay').classList.remove('hidden');
                document.getElementById('debtDisplay').innerText = `Debt: $${state.debt.toLocaleString()}`;
            } else {
                document.getElementById('debtDisplay').classList.add('hidden');
            }
            
            // Phase
            let phaseText = {
                'character_creation': 'Creating Character',
                'deciding': 'Deciding Future',
                'education': state.educationType === 'university' ? 'University' :
                             state.educationType === 'community_college' ? 'Community College' :
                             state.educationType === 'trade_school' ? 'Trade School' :
                             state.educationType === 'military_training' ? 'Boot Camp' :
                             state.educationType === 'military_service' ? 'Military Service' : 'Education',
                'job_hunting': 'Job Hunting',
                'employed': 'Employed',
                'retired': 'Retired'
            };
            document.getElementById('phaseBadge').innerText = phaseText[state.phase] || state.phase;
            
            // Phase progress
            if (state.phaseTarget > 0) {
                let progress = (state.phaseWeek / state.phaseTarget) * 100;
                document.getElementById('phaseProgress').style.width = progress + '%';
                document.getElementById('phaseLabel').innerText = `Week ${state.phaseWeek}`;
                document.getElementById('phaseTarget').innerText = `of ${state.phaseTarget}`;
            } else {
                document.getElementById('phaseProgress').style.width = '0%';
                document.getElementById('phaseLabel').innerText = `Week ${state.totalWeeks}`;
                document.getElementById('phaseTarget').innerText = '';
            }
            
            // Status - handle military specially
            if (state.job === 'military' && state.military.mos) {
                let rank = getMilitaryRank();
                let mos = MOS_OPTIONS[state.military.mos];
                document.getElementById('statusIcon').innerText = mos.icon;
                document.getElementById('statusTitle').innerText = `${rank.abbr} - ${mos.name.split(' ')[0]}`;
                document.getElementById('statusDesc').innerText = state.military.deployed ? 
                    `DEPLOYED (Week ${state.military.deploymentWeek}/12)` : 
                    `Garrison | ${state.military.missionsCompleted} missions`;
            } else {
                document.getElementById('statusIcon').innerText = state.employed ? 'üíº' : 
                    state.phase === 'education' ? 'üìö' : 
                    state.phase === 'job_hunting' ? 'üîç' : '‚ùì';
                document.getElementById('statusTitle').innerText = state.employed ? state.jobTitle :
                    state.phase === 'education' ? (state.educationType || 'Student').replace(/_/g, ' ') :
                    state.phase === 'job_hunting' ? 'Job Hunting' : 'Figuring it out';
                document.getElementById('statusDesc').innerText = state.employed ? `Week ${state.weeksAtJob}` :
                    state.phase === 'education' ? `Week ${state.phaseWeek} of ${state.phaseTarget}` :
                    state.phase === 'job_hunting' ? `${state.jobApplications} applications sent` : '';
            }
            
            // GPA display on status card (during education)
            let gpaDisplay = document.getElementById('gpaDisplay');
            let statusViewIcon = document.getElementById('statusViewIcon');
            if (state.phase === 'education' && (state.educationType === 'university' || state.educationType === 'community_college')) {
                gpaDisplay.classList.remove('hidden');
                let gpa = state.gpa || 0;
                let gpaColor = gpa >= 3.5 ? 'text-green-400' : gpa >= 3.0 ? 'text-cyan-400' : gpa >= 2.5 ? 'text-yellow-400' : gpa >= 2.0 ? 'text-orange-400' : 'text-red-400';
                document.getElementById('gpaValue').innerText = gpa.toFixed(2);
                document.getElementById('gpaValue').className = gpaColor;
                document.getElementById('gpaBar').style.width = (gpa / 4 * 100) + '%';
                document.getElementById('gpaBar').className = `h-full rounded-full ${gpa >= 3.5 ? 'bg-green-500' : gpa >= 3.0 ? 'bg-cyan-500' : gpa >= 2.5 ? 'bg-yellow-500' : gpa >= 2.0 ? 'bg-orange-500' : 'bg-red-500'}`;
                statusViewIcon.style.display = '';
            } else {
                gpaDisplay.classList.add('hidden');
                // Still show view icon for employed/job hunting phases
                statusViewIcon.style.display = state.phase === 'employed' || state.phase === 'job_hunting' || state.phase === 'education' ? '' : 'none';
            }
            
            // Housing
            let home = HOUSING[state.home];
            document.getElementById('homeIcon').innerText = home.icon;
            document.getElementById('homeName').innerText = home.name;
            let homeStressIndicator = home.stress > 0 ? ` üò∞+${home.stress}` : home.stress < 0 ? ` üòå${home.stress}` : '';
            let homeAppealIndicator = (state.gender === 'male' && home.appeal !== 0) ? ` üíï${home.appeal > 0 ? '+' : ''}${home.appeal}` : '';
            document.getElementById('homeDesc').innerText = home.desc + homeStressIndicator + homeAppealIndicator;
            
            // Transport
            let car = TRANSPORT[state.car];
            document.getElementById('carIcon').innerText = car.icon;
            document.getElementById('carName').innerText = car.name;
            let carStressIndicator = car.stress > 0 ? ` üò∞+${car.stress}` : car.stress < 0 ? ` üòå${car.stress}` : '';
            let carAppealIndicator = (state.gender === 'male' && car.appeal !== 0) ? ` üíï${car.appeal > 0 ? '+' : ''}${car.appeal}` : '';
            document.getElementById('carDesc').innerText = car.desc + carStressIndicator + carAppealIndicator;
            
            // Job
            if (state.employed && state.job) {
                document.getElementById('jobCard').style.display = 'block';
                
                if (state.job === 'military' && state.military.mos) {
                    let rank = getMilitaryRank();
                    let mos = MOS_OPTIONS[state.military.mos];
                    document.getElementById('jobIcon').innerText = 'üéñÔ∏è';
                    document.getElementById('jobName').innerText = `${rank.name}`;
                    let pay = rank.pay + (state.military.deployed ? 150 : 0);
                    document.getElementById('jobPay').innerText = `$${pay}/week${state.military.deployed ? ' (combat)' : ''}`;
                    document.getElementById('jobPerfVal').innerText = `${state.military.combatXP} XP`;
                    document.getElementById('jobPerfBar').style.width = Math.min(100, state.military.combatXP * 2) + '%';
                } else if (state.job === 'part_time') {
                    document.getElementById('jobIcon').innerText = '‚òï';
                    document.getElementById('jobName').innerText = state.jobTitle || 'Part-Time';
                    document.getElementById('jobPay').innerText = `$${state.weeklyIncome || 150}/week`;
                    document.getElementById('jobPerfVal').innerText = 'Student';
                    document.getElementById('jobPerfBar').style.width = '100%';
                } else if (JOBS[state.job]) {
                    document.getElementById('jobIcon').innerText = JOBS[state.job].icon;
                    document.getElementById('jobName').innerText = state.jobTitle;
                    document.getElementById('jobPay').innerText = `$${JOBS[state.job].salary}/week`;
                    document.getElementById('jobPerfVal').innerText = state.performance + '%';
                    document.getElementById('jobPerfBar').style.width = state.performance + '%';
                }
            } else {
                document.getElementById('jobCard').style.display = 'none';
            }
            
            // Partner
            if (state.hasPartner) {
                document.getElementById('partnerCard').style.display = 'block';
                document.getElementById('partnerName').innerText = state.partnerName;
                document.getElementById('partnerStatus').innerText = state.married ? 'Married' : 'Dating';
                document.getElementById('partnerBondVal').innerText = (state.partnerStats?.supportiveness || 50) + '%';
                document.getElementById('partnerBondBar').style.width = (state.partnerStats?.supportiveness || 50) + '%';
            } else {
                document.getElementById('partnerCard').style.display = 'none';
            }
            
            // Update relationships summary
            updateRelationshipsSummary();
            
            // Character Traits display
            if (state.gender && state.characterTraits) {
                document.getElementById('traitsCard').style.display = 'block';
                let traits = state.characterTraits;
                document.getElementById('traitHeight').innerText = `${traits.height}/10 ${TRAIT_DESCRIPTORS.height[traits.height]}`;
                document.getElementById('traitWealth').innerText = `${traits.familyWealth}/10 ${TRAIT_DESCRIPTORS.familyWealth[traits.familyWealth]}`;
                document.getElementById('traitIntel').innerText = `${traits.intelligence}/10 ${TRAIT_DESCRIPTORS.intelligence[traits.intelligence]}`;
                
                let attrVal = state.currentAttractiveness || traits.attractiveness;
                let attrDisplay = Math.round(attrVal * 10) / 10;
                let baseAttr = traits.attractiveness;
                let bonus = attrVal > baseAttr ? ` (+${(attrVal - baseAttr).toFixed(1)})` : '';
                document.getElementById('traitAttr').innerText = `${attrDisplay}/10 ${TRAIT_DESCRIPTORS.attractiveness[Math.round(attrVal)]}${bonus}`;
                
                // Self-control
                let selfCtrl = traits.selfControl || 5;
                document.getElementById('traitSelfControl').innerText = `${selfCtrl}/10 ${TRAIT_DESCRIPTORS.selfControl[selfCtrl]}`;
                
                // Dating appeal breakdown
                let appeal = calculateAppeal();
                let appealEl = document.getElementById('datingAppeal');
                appealEl.innerText = Math.round(appeal);
                
                // Color based on appeal level
                if (appeal >= 60) appealEl.className = 'text-green-400';
                else if (appeal >= 45) appealEl.className = 'text-cyan-400';
                else if (appeal >= 30) appealEl.className = 'text-yellow-400';
                else appealEl.className = 'text-red-400';
            }
            
            // Fitness display
            if (state.fitness.gymMember || state.fitness.healthyEating) {
                document.getElementById('fitnessCard').style.display = 'block';
                document.getElementById('fitnessGym').innerText = state.fitness.gymMember ? 'üèãÔ∏è Gym Member' : 'No gym';
                document.getElementById('fitnessGym').className = state.fitness.gymMember ? 'text-green-400' : 'text-gray-500';
                document.getElementById('fitnessEating').innerText = state.fitness.healthyEating ? 'ü•ó Eating Healthy' : 'Normal diet';
                document.getElementById('fitnessEating').className = state.fitness.healthyEating ? 'text-green-400' : 'text-gray-500';
                if (state.fitness.workoutStreak > 0) {
                    document.getElementById('fitnessStreak').innerText = state.fitness.routineEstablished 
                        ? `‚ú® ${state.fitness.workoutStreak} week streak!`
                        : `${state.fitness.workoutStreak}/8 weeks to routine`;
                } else {
                    document.getElementById('fitnessStreak').innerText = '';
                }
            } else {
                document.getElementById('fitnessCard').style.display = 'none';
            }
            
            // Free Time display
            let maxFreeTime = getAvailableFreeTime();
            let usedFreeTime = Object.values(state.freeTime).reduce((a, b) => a + b, 0);
            document.getElementById('freeTimeUsed').innerText = `${usedFreeTime}/${maxFreeTime} hrs`;
            
            let freeTimeCost = state.freeTimeExpenses || 0;
            let overtimeEarnings = state.overtimeEarnings || 0;
            let netCost = freeTimeCost - overtimeEarnings;
            document.getElementById('freeTimeCost').innerText = netCost >= 0 ? `$${netCost}` : `+$${Math.abs(netCost)}`;
            document.getElementById('freeTimeCost').className = netCost > 0 ? 'text-yellow-400' : netCost < 0 ? 'text-green-400' : 'text-gray-400';
            
            // Summary of activities
            let summaryParts = [];
            Object.keys(state.freeTime).forEach(key => {
                let hours = state.freeTime[key] || 0;
                if (hours > 0) {
                    summaryParts.push(`${FREE_TIME_ACTIVITIES[key].icon}${hours}h`);
                }
            });
            document.getElementById('freeTimeSummary').innerText = summaryParts.length > 0 ? summaryParts.join(' ') : 'Click to allocate time';
            
            // Subscriptions display
            let activeSubsCount = Object.keys(state.subscriptions).filter(k => state.subscriptions[k]).length;
            let subsCost = 0;
            let subsIcons = [];
            Object.keys(state.subscriptions).forEach(key => {
                if (state.subscriptions[key] && SUBSCRIPTIONS[key]) {
                    subsCost += SUBSCRIPTIONS[key].cost;
                    subsIcons.push(SUBSCRIPTIONS[key].icon);
                }
            });
            document.getElementById('subsCount').innerText = activeSubsCount;
            document.getElementById('subsCost').innerText = `$${subsCost}/week`;
            document.getElementById('subsCost').className = subsCost > 0 ? 'text-yellow-400' : 'text-gray-400';
            document.getElementById('subsSummary').innerText = subsIcons.length > 0 ? subsIcons.join(' ') : 'Click to subscribe';
            
            // Habits display
            let maxWP = calculateMaxWillpower();
            let habitWPCost = getTotalHabitCost();
            let availableWP = maxWP - habitWPCost;
            
            document.getElementById('willpowerDisplay').innerText = `${Math.max(0, availableWP)}/${maxWP}`;
            document.getElementById('willpowerDisplay').className = availableWP < 0 ? 'text-red-400 animate-pulse' : 
                                                                    availableWP < maxWP * 0.3 ? 'text-orange-400' : 'text-purple-400';
            document.getElementById('habitCostDisplay').innerText = habitWPCost > 0 ? habitWPCost : habitWPCost < 0 ? `+${Math.abs(habitWPCost)}` : '0';
            document.getElementById('habitCostDisplay').className = habitWPCost > 0 ? 'text-cyan-400' : habitWPCost < 0 ? 'text-green-400' : 'text-gray-400';
            
            let habitIcons = [];
            Object.keys(state.habits || {}).forEach(key => {
                if (state.habits[key]?.active && HABITS[key]) {
                    habitIcons.push(HABITS[key].icon);
                }
            });
            document.getElementById('habitsSummary').innerText = habitIcons.length > 0 ? habitIcons.join(' ') : 'Click to set habits';
            
            // Skill bars
            document.getElementById('techBar').style.width = state.skills.technical + '%';
            document.getElementById('techVal').innerText = Math.floor(state.skills.technical);
            document.getElementById('socialBar').style.width = state.skills.social + '%';
            document.getElementById('socialVal').innerText = Math.floor(state.skills.social);
            document.getElementById('physicalBar').style.width = state.skills.physical + '%';
            document.getElementById('physicalVal').innerText = Math.floor(state.skills.physical);
            document.getElementById('creativeBar').style.width = state.skills.creativity + '%';
            document.getElementById('creativeVal').innerText = Math.floor(state.skills.creativity);
            
            // Network & connections
            document.getElementById('networkContacts').innerText = state.career.networkContacts || 0;
            document.getElementById('creditScoreDisplay').innerText = state.finances.creditScore || 650;
            
            // Color the credit score based on value
            let creditScoreEl = document.getElementById('creditScoreDisplay');
            if (state.finances.creditScore >= 750) {
                creditScoreEl.className = 'text-green-400';
            } else if (state.finances.creditScore >= 650) {
                creditScoreEl.className = 'text-yellow-400';
            } else if (state.finances.creditScore >= 550) {
                creditScoreEl.className = 'text-orange-400';
            } else {
                creditScoreEl.className = 'text-red-400';
            }
            
            // Credit Card display
            let creditCardCard = document.getElementById('creditCardCard');
            if (state.finances.hasCreditCard) {
                creditCardCard.style.display = 'block';
                document.getElementById('creditBalance').innerText = '$' + (state.finances.creditBalance || 0).toLocaleString();
                document.getElementById('creditLimit').innerText = '$' + (state.finances.creditLimit || 0).toLocaleString();
                document.getElementById('creditAPR').innerText = ((state.finances.creditAPR || 0) * 100).toFixed(1) + '%';
                document.getElementById('creditAvailable').innerText = '$' + Math.max(0, (state.finances.creditLimit - state.finances.creditBalance)).toLocaleString();
                
                // Color balance based on utilization
                let utilization = state.finances.creditBalance / state.finances.creditLimit;
                let balanceEl = document.getElementById('creditBalance');
                if (utilization === 0) {
                    balanceEl.className = 'text-green-400';
                } else if (utilization < 0.3) {
                    balanceEl.className = 'text-yellow-400';
                } else if (utilization < 0.7) {
                    balanceEl.className = 'text-orange-400';
                } else {
                    balanceEl.className = 'text-red-400';
                }
            } else {
                creditCardCard.style.display = 'none';
            }
            
            // Education & Traits
            let traits = [];
            if (state.education === 'university') traits.push('üéì Bachelor\'s Degree');
            else if (state.education === 'community_college') traits.push('üìö Associate\'s Degree');
            else if (state.education === 'trade_school') traits.push('üîß Trade Certificate');
            else if (state.education === 'military') traits.push('üéñÔ∏è Military Training');
            else if (state.education === 'high_school') traits.push('üìú High School Diploma');
            else traits.push('üìñ High School (in progress)');
            
            // Add major if applicable
            if (state.university && state.university.major && MAJORS[state.university.major]) {
                traits.push(MAJORS[state.university.major].icon + ' ' + MAJORS[state.university.major].name);
            }
            
            // Add trade if applicable
            if (state.tradeSchool && state.tradeSchool.trade && TRADES[state.tradeSchool.trade]) {
                let cert = TRADE_CERT_LEVELS[state.tradeSchool.certLevel];
                traits.push(TRADES[state.tradeSchool.trade].icon + ' ' + cert.name + ' ' + TRADES[state.tradeSchool.trade].name);
            }
            
            // Personality traits from choices
            if (state.skills.technical >= 60) traits.push('üß† Tech-Savvy');
            if (state.skills.social >= 60) traits.push('üó£Ô∏è People Person');
            if (state.skills.physical >= 60) traits.push('üí™ Fit');
            if (state.skills.creativity >= 60) traits.push('üé® Creative');
            
            // Life achievements
            if (state.finances.homeOwned) traits.push('üè† Homeowner');
            if (state.relationship.children > 0) traits.push('üë∂ Parent');
            if (state.finances.investments > 10000) traits.push('üìà Investor');
            
            // Military medals
            if (state.military.medals && state.military.medals.length > 0) {
                state.military.medals.forEach(m => traits.push('üèÖ ' + m));
            }
            
            document.getElementById('skillsList').innerText = traits.join('\n');
            
            // Weekly budget
            calculateWeeklyFinances();
            document.getElementById('weeklyIncome').innerText = '+$' + state.weeklyIncome;
            document.getElementById('weeklyExpenses').innerText = '-$' + state.weeklyExpenses;
            let net = state.weeklyIncome - state.weeklyExpenses;
            document.getElementById('weeklyNet').innerText = (net >= 0 ? '+' : '') + '$' + net;
            document.getElementById('weeklyNet').className = net >= 0 ? 'text-green-400' : 'text-red-400';
        }

        function endGame(cause) {
            document.getElementById('gameOverScreen').classList.remove('hidden');
            
            let icon, title, desc;
            switch(cause) {
                case "health": icon = "üíî"; title = "Health Failed"; desc = "Your body gave out."; break;
                case "despair": icon = "üåë"; title = "Lost Hope"; desc = "The weight was too much."; break;
                case "early": icon = "üìñ"; title = "Chapter Closed"; desc = "You decided to see how your story turned out."; break;
                default: icon = "üåÖ"; title = "A Full Life"; desc = "You lived to a ripe old age.";
            }
            
            // Calculate total net worth
            let netWorth = state.money - state.debt;
            netWorth += state.finances.investments || 0;
            netWorth += state.finances.homeOwned ? (state.finances.homeValue - (state.finances.homeValue * 0.3)) : 0;
            netWorth += state.finances.carValue || 0;
            netWorth += state.finances.retirementAccount || 0;
            netWorth += state.finances.emergencyFund || 0;
            
            document.getElementById('endIcon').innerText = icon;
            document.getElementById('endTitle').innerText = title;
            document.getElementById('endDesc').innerText = desc;
            document.getElementById('finalAge').innerText = getAge() + ' years';
            document.getElementById('finalCareer').innerText = state.jobTitle || 'Never employed';
            document.getElementById('finalWealth').innerText = '$' + Math.floor(netWorth).toLocaleString();
            
            // Family status
            let familyStatus = state.married ? `Married to ${state.partnerName}` : 
                                                               state.hasPartner ? `Dating ${state.partnerName}` : 'Single';
            if (state.relationship.children > 0) {
                familyStatus += `, ${state.relationship.children} ${state.relationship.children === 1 ? 'child' : 'children'}`;
            }
            document.getElementById('finalFamily').innerText = familyStatus;
            
            // Calculate life score and tier
            let lifeAssessment = calculateLifeAssessment(cause, netWorth);
            
            // Set life tier banner
            let tierBanner = document.getElementById('lifeTierBanner');
            tierBanner.className = `mb-6 py-4 px-6 rounded-xl border-2 ${lifeAssessment.tierClass}`;
            document.getElementById('lifeTierLabel').innerText = 'Life Assessment';
            document.getElementById('lifeTierTitle').innerText = lifeAssessment.tierTitle;
            document.getElementById('lifeTierSubtitle').innerText = lifeAssessment.tierSubtitle;
            
            // Generate obituary
            let obituary = generateObituary(cause, netWorth, lifeAssessment);
            document.getElementById('obituaryText').innerHTML = obituary;
            
            // Build achievements list
            let achievements = [];
            if (state.achievements.length > 0) achievements.push(...state.achievements.slice(0, 5));
            if (state.finances.homeOwned) achievements.push('üè† Homeowner');
            if (netWorth > 100000) achievements.push('üíé Wealthy');
            else if (netWorth > 50000) achievements.push('üí∞ Comfortable');
            if (state.career.promotions > 3) achievements.push('üìà Career Climber');
            if (state.relationship.children >= 3) achievements.push('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Big Family');
            if (state.married && state.relationshipWeeks > 520) achievements.push('üíç Lasting Marriage');
            if (state.university && state.university.studyAbroadDone) achievements.push('üåç World Traveler');
            if (state.military.medals && state.military.medals.length > 0) achievements.push('üéñÔ∏è Decorated Veteran');
            if (state.skills.technical >= 80) achievements.push('üß† Technical Master');
            if (state.skills.social >= 80) achievements.push('ü§ù Social Butterfly');
            if (state.skills.physical >= 80) achievements.push('üí™ Peak Fitness');
            if (state.skills.creativity >= 80) achievements.push('üé® Creative Soul');
            if (state.education === 'university' && state.gpa >= 3.5) achievements.push('üéì Honors Graduate');
            if (state.finances.creditScore >= 800) achievements.push('üìä Perfect Credit');
            if (getAge() >= 80) achievements.push('üéÇ Long Life');
            
            document.getElementById('finalEpitaph').innerText = achievements.length > 0 ? achievements.join(' ‚Ä¢ ') : 'Lived quietly';
        }
        
        function calculateLifeAssessment(cause, netWorth) {
            let score = 0;
            
            // Longevity (0-20 points)
            let age = getAge();
            if (age >= 85) score += 20;
            else if (age >= 75) score += 15;
            else if (age >= 65) score += 10;
            else if (age >= 50) score += 5;
            else if (age < 30) score -= 10;
            
            // Cause of death modifier
            if (cause === 'health') score -= 5;
            if (cause === 'despair') score -= 15;
            
            // Relationships (0-25 points)
            if (state.married) score += 10;
            else if (state.hasPartner) score += 5;
            if (state.relationship.children > 0) score += 5;
            if (state.relationship.children >= 2) score += 3;
            if (state.relationshipWeeks > 260) score += 5; // 5+ year relationship
            if (state.relationship.marriageWeeks > 520) score += 7; // 10+ year marriage
            
            // Wealth (0-20 points)
            if (netWorth > 500000) score += 20;
            else if (netWorth > 200000) score += 15;
            else if (netWorth > 100000) score += 10;
            else if (netWorth > 50000) score += 5;
            else if (netWorth < 0) score -= 10;
            
            // Career (0-15 points)
            if (state.jobTitle) score += 5;
            if (state.career.promotions > 2) score += 5;
            if (state.career.promotions > 5) score += 5;
            
            // Skills & Growth (0-10 points)
            let avgSkill = (state.skills.technical + state.skills.social + state.skills.physical + state.skills.creativity) / 4;
            if (avgSkill >= 60) score += 5;
            if (avgSkill >= 80) score += 5;
            
            // Final happiness matters (0-10 points)
            if (state.happiness >= 80) score += 10;
            else if (state.happiness >= 60) score += 5;
            else if (state.happiness < 30) score -= 5;
            
            // Determine tier
            let tierTitle, tierSubtitle, tierClass;
            
            if (score >= 80) {
                tierTitle = "üåü An Extraordinary Life";
                tierSubtitle = "A life of purpose, love, and remarkable achievement";
                tierClass = "border-yellow-500 bg-yellow-900/30 text-yellow-300";
            } else if (score >= 65) {
                tierTitle = "‚ú® A Wonderful Life";
                tierSubtitle = "Blessed with happiness, success, and meaningful connections";
                tierClass = "border-green-500 bg-green-900/30 text-green-300";
            } else if (score >= 50) {
                tierTitle = "‚òÄÔ∏è A Good Life";
                tierSubtitle = "A solid life with its share of joy and accomplishment";
                tierClass = "border-cyan-500 bg-cyan-900/30 text-cyan-300";
            } else if (score >= 35) {
                tierTitle = "üå§Ô∏è An Ordinary Life";
                tierSubtitle = "A modest existence with ups and downs";
                tierClass = "border-gray-500 bg-gray-900/30 text-gray-300";
            } else if (score >= 20) {
                tierTitle = "üåßÔ∏è A Difficult Life";
                tierSubtitle = "Marked by struggle and hardship";
                tierClass = "border-orange-500 bg-orange-900/30 text-orange-300";
            } else if (score >= 5) {
                tierTitle = "‚õàÔ∏è A Hard Life";
                tierSubtitle = "A life filled with challenge and disappointment";
                tierClass = "border-red-500 bg-red-900/30 text-red-300";
            } else {
                tierTitle = "üåë A Tragic Life";
                tierSubtitle = "Cut short, unfulfilled, and full of sorrow";
                tierClass = "border-gray-700 bg-gray-900/50 text-gray-400";
            }
            
            return { score, tierTitle, tierSubtitle, tierClass };
        }
        
        function generateObituary(cause, netWorth, assessment) {
            let name = state.gender === 'male' ? 'He' : 'She';
            let name2 = state.gender === 'male' ? 'his' : 'her';
            let age = getAge();
            
            let parts = [];
            
            // Opening based on cause
            if (cause === 'despair') {
                parts.push(`${name} departed this world too soon, at the age of ${age}, leaving behind unfinished dreams.`);
            } else if (cause === 'health') {
                parts.push(`${name} passed away at ${age} years of age, ${name2} body finally giving out.`);
            } else {
                parts.push(`${name} lived a full ${age} years before peacefully passing on.`);
            }
            
            // Education
            if (state.education === 'university') {
                parts.push(`${name} graduated from university${state.gpa >= 3.5 ? ' with honors' : ''}.`);
            } else if (state.education === 'military') {
                parts.push(`${name} served ${name2} country proudly in the military.`);
            } else if (state.education === 'trade_school') {
                parts.push(`${name} learned a valuable trade and built things with ${name2} hands.`);
            }
            
            // Career
            if (state.jobTitle) {
                if (state.career.promotions > 3) {
                    parts.push(`${name} had a successful career, rising through the ranks to become a ${state.jobTitle}.`);
                } else {
                    parts.push(`${name} worked as a ${state.jobTitle}.`);
                }
            }
            
            // Family
            if (state.married && state.relationship.children > 0) {
                let years = Math.floor((state.relationship.marriageWeeks || 0) / 52);
                parts.push(`${name} was married to ${state.partnerName}${years > 5 ? ` for ${years} wonderful years` : ''} and raised ${state.relationship.children} ${state.relationship.children === 1 ? 'child' : 'children'}.`);
            } else if (state.married) {
                parts.push(`${name} found love and was married to ${state.partnerName}.`);
            } else if (state.relationship.children > 0) {
                parts.push(`${name} raised ${state.relationship.children} ${state.relationship.children === 1 ? 'child' : 'children'}.`);
            } else if (cause !== 'despair') {
                parts.push(`${name} walked ${name2} own path in life.`);
            }
            
            // Wealth summary
            if (netWorth > 200000) {
                parts.push(`${name} built considerable wealth, leaving behind a legacy of financial security.`);
            } else if (netWorth < 0) {
                parts.push(`${name} struggled financially throughout life.`);
            }
            
            // Special achievements
            if (state.military.medals && state.military.medals.length > 0) {
                parts.push(`${name} was decorated for ${name2} military service.`);
            }
            if (state.finances.homeOwned) {
                parts.push(`${name} achieved the dream of homeownership.`);
            }
            
            // Closing based on assessment
            if (assessment.score >= 65) {
                parts.push(`${name} will be remembered fondly by all who knew ${name2 === 'his' ? 'him' : 'her'}.`);
            } else if (assessment.score >= 35) {
                parts.push(`${name} lived ${name2} life on ${name2} own terms.`);
            } else if (assessment.score >= 10) {
                parts.push(`Despite the hardships, ${name.toLowerCase()} persevered.`);
            } else {
                parts.push(`May ${name.toLowerCase()} find peace at last.`);
            }
            
            return parts.join(' ');
        }

        // ============ HOUSING & TRANSPORT MODALS ============
        function openHousingModal() {
            let modal = document.getElementById('housingModal');
            let optionsDiv = document.getElementById('housingOptions');
            optionsDiv.innerHTML = '';
            
            let currentIndex = HOUSING_ORDER.indexOf(state.home);
            
            HOUSING_ORDER.forEach((key, index) => {
                let housing = HOUSING[key];
                let isCurrent = key === state.home;
                let canAfford = state.money >= housing.rent * 4; // Need 4 weeks rent
                let meetsCredit = !housing.upgradeReq?.creditScore || state.finances.creditScore >= housing.upgradeReq.creditScore;
                let isDowngrade = index < currentIndex;
                let isUpgrade = index > currentIndex;
                
                let statusText = '';
                let canSelect = false;
                
                if (isCurrent) {
                    statusText = '<span class="text-cyan-400">‚úì Current</span>';
                } else if (isUpgrade) {
                    if (!canAfford) {
                        statusText = `<span class="text-red-400">Need $${(housing.rent * 4).toLocaleString()}</span>`;
                    } else if (!meetsCredit) {
                        statusText = `<span class="text-red-400">Need ${housing.upgradeReq.creditScore} credit</span>`;
                    } else {
                        statusText = '<span class="text-green-400">Available</span>';
                        canSelect = true;
                    }
                } else if (isDowngrade) {
                    statusText = '<span class="text-yellow-400">Downgrade</span>';
                    canSelect = true;
                }
                
                // Appeal display (for males)
                let appealText = '';
                if (state.gender === 'male') {
                    let appealDiff = housing.appeal - HOUSING[state.home].appeal;
                    if (appealDiff > 0) appealText = `<span class="text-pink-400">+${appealDiff} dating appeal</span>`;
                    else if (appealDiff < 0) appealText = `<span class="text-gray-500">${appealDiff} dating appeal</span>`;
                }
                
                let stressDiff = housing.stress - HOUSING[state.home].stress;
                let stressText = stressDiff < 0 ? `<span class="text-green-400">${stressDiff} stress</span>` : 
                                 stressDiff > 0 ? `<span class="text-red-400">+${stressDiff} stress</span>` : '';
                
                let div = document.createElement('div');
                div.className = `p-3 rounded border ${isCurrent ? 'border-cyan-500 bg-cyan-900/20' : canSelect ? 'border-gray-600 hover:border-gray-500 cursor-pointer' : 'border-gray-700 opacity-50'} transition-colors`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${housing.icon}</span>
                            <div>
                                <div class="text-white font-medium">${housing.name}</div>
                                <div class="text-xs text-gray-400">${housing.desc}</div>
                            </div>
                        </div>
                        <div class="text-right text-xs">
                            ${statusText}
                            ${stressText ? '<br>' + stressText : ''}
                            ${appealText ? '<br>' + appealText : ''}
                        </div>
                    </div>
                `;
                
                if (canSelect) {
                    div.onclick = () => changeHousing(key, isUpgrade);
                }
                
                optionsDiv.appendChild(div);
            });
            
            modal.classList.remove('hidden');
        }
        
        function closeHousingModal() {
            document.getElementById('housingModal').classList.add('hidden');
        }
        
        function changeHousing(newHousing, isUpgrade) {
            let oldHousing = HOUSING[state.home];
            let newHousingData = HOUSING[newHousing];
            
            // Moving costs
            let movingCost = isUpgrade ? newHousingData.rent * 4 : newHousingData.rent * 2;
            
            if (state.money < movingCost) {
                alert(`Not enough money! Need $${movingCost} for moving costs.`);
                return;
            }
            
            state.money -= movingCost;
            state.home = newHousing;
            state.weeklyExpenses = state.weeklyExpenses - oldHousing.rent + newHousingData.rent;
            
            addLog(`Moved to ${newHousingData.name}`);
            closeHousingModal();
            updateUI();
        }
        
        function openTransportModal() {
            let modal = document.getElementById('transportModal');
            let optionsDiv = document.getElementById('transportOptions');
            optionsDiv.innerHTML = '';
            
            let currentIndex = TRANSPORT_ORDER.indexOf(state.car);
            
            TRANSPORT_ORDER.forEach((key, index) => {
                let transport = TRANSPORT[key];
                let isCurrent = key === state.car;
                let isDowngrade = index < currentIndex;
                let isUpgrade = index > currentIndex;
                
                // Upfront costs for vehicles
                let upfrontCost = 0;
                if (key === 'bike') upfrontCost = 200;
                else if (key === 'beater') upfrontCost = 2000;
                else if (key === 'car') upfrontCost = 8000;
                
                let canAfford = state.money >= upfrontCost;
                let meetsCredit = !transport.upgradeReq?.creditScore || state.finances.creditScore >= transport.upgradeReq.creditScore;
                
                let statusText = '';
                let canSelect = false;
                
                if (isCurrent) {
                    statusText = '<span class="text-cyan-400">‚úì Current</span>';
                } else if (isUpgrade) {
                    if (upfrontCost > 0 && !canAfford) {
                        statusText = `<span class="text-red-400">Need $${upfrontCost.toLocaleString()}</span>`;
                    } else if (!meetsCredit) {
                        statusText = `<span class="text-red-400">Need ${transport.upgradeReq.creditScore} credit</span>`;
                    } else {
                        statusText = upfrontCost > 0 ? `<span class="text-green-400">$${upfrontCost.toLocaleString()}</span>` : '<span class="text-green-400">Available</span>';
                        canSelect = true;
                    }
                } else if (isDowngrade) {
                    // Can sell vehicle when downgrading
                    let sellValue = 0;
                    if (state.car === 'bike') sellValue = 50;
                    else if (state.car === 'beater') sellValue = 500;
                    else if (state.car === 'car') sellValue = 3000;
                    statusText = sellValue > 0 ? `<span class="text-yellow-400">Sell +$${sellValue}</span>` : '<span class="text-yellow-400">Downgrade</span>';
                    canSelect = true;
                }
                
                // Appeal display (for males)
                let appealText = '';
                if (state.gender === 'male') {
                    let appealDiff = transport.appeal - TRANSPORT[state.car].appeal;
                    if (appealDiff > 0) appealText = `<span class="text-pink-400">+${appealDiff} dating appeal</span>`;
                    else if (appealDiff < 0) appealText = `<span class="text-gray-500">${appealDiff} dating appeal</span>`;
                }
                
                let stressDiff = transport.stress - TRANSPORT[state.car].stress;
                let stressText = stressDiff < 0 ? `<span class="text-green-400">${stressDiff} stress</span>` : 
                                 stressDiff > 0 ? `<span class="text-red-400">+${stressDiff} stress</span>` : '';
                
                let div = document.createElement('div');
                div.className = `p-3 rounded border ${isCurrent ? 'border-cyan-500 bg-cyan-900/20' : canSelect ? 'border-gray-600 hover:border-gray-500 cursor-pointer' : 'border-gray-700 opacity-50'} transition-colors`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${transport.icon}</span>
                            <div>
                                <div class="text-white font-medium">${transport.name}</div>
                                <div class="text-xs text-gray-400">${transport.desc}</div>
                            </div>
                        </div>
                        <div class="text-right text-xs">
                            ${statusText}
                            ${stressText ? '<br>' + stressText : ''}
                            ${appealText ? '<br>' + appealText : ''}
                        </div>
                    </div>
                `;
                
                if (canSelect) {
                    div.onclick = () => changeTransport(key, isUpgrade);
                }
                
                optionsDiv.appendChild(div);
            });
            
            modal.classList.remove('hidden');
        }
        
        function closeTransportModal() {
            document.getElementById('transportModal').classList.add('hidden');
        }
        
        function changeTransport(newTransport, isUpgrade) {
            let oldTransport = TRANSPORT[state.car];
            let newTransportData = TRANSPORT[newTransport];
            
            // Calculate costs/gains
            let cost = 0;
            if (isUpgrade) {
                if (newTransport === 'bike') cost = 200;
                else if (newTransport === 'beater') cost = 2000;
                else if (newTransport === 'car') cost = 8000;
            } else {
                // Selling current vehicle
                if (state.car === 'bike') cost = -50;
                else if (state.car === 'beater') cost = -500;
                else if (state.car === 'car') cost = -3000;
            }
            
            if (cost > 0 && state.money < cost) {
                alert(`Not enough money! Need $${cost}.`);
                return;
            }
            
            state.money -= cost;
            state.car = newTransport;
            state.weeklyExpenses = state.weeklyExpenses - oldTransport.cost + newTransportData.cost;
            
            addLog(`${cost > 0 ? 'Bought' : cost < 0 ? 'Sold vehicle, now using' : 'Switched to'} ${newTransportData.name}`);
            closeTransportModal();
            updateUI();
        }
        
        // ============ TUTORIAL SYSTEM ============
        let tutorialStep = 0;
        const TUTORIAL_STEPS = [
            {
                icon: "üéÆ",
                title: "Welcome to Life Game!",
                content: `
                    <p>You're about to live an entire life - from 18 to whatever fate has in store.</p>
                    <p class="mt-2">Every week, you'll face <span class="text-cyan-400">choices</span> that shape your character's future.</p>
                    <p class="mt-2">Let's show you around the interface!</p>
                `
            },
            {
                icon: "üìä",
                title: "Your Stats",
                content: `
                    <p>At the top, you'll see your vital stats:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><span class="text-red-400">‚ù§Ô∏è Health</span> - Hit 0 and it's game over</li>
                        <li><span class="text-yellow-400">‚ö° Energy</span> - Low energy = penalties on dice rolls</li>
                        <li><span class="text-blue-400">‚ò∫Ô∏è Happiness</span> - Keep it up to avoid despair</li>
                        <li><span class="text-purple-400">üò∞ Stress</span> - High stress hurts your dice rolls!</li>
                    </ul>
                    <p class="mt-2 text-gray-400">Hover over the numbers to see any roll penalties.</p>
                `
            },
            {
                icon: "‚è∞",
                title: "Weekly Schedule",
                content: `
                    <p>Click the <span class="text-cyan-400">‚è∞ Weekly Schedule</span> card on the left to allocate your free time.</p>
                    <p class="mt-2">You have limited hours to spend on:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>üèãÔ∏è <span class="text-cyan-400">Gym</span> - Build fitness & looks (needs membership)</li>
                        <li>üçª <span class="text-cyan-400">Socialize</span> - Meet people, reduce stress</li>
                        <li>üíº <span class="text-cyan-400">Overtime</span> - Extra money but more stress</li>
                        <li>üìö <span class="text-cyan-400">Study</span> - Boost skills (free in school!)</li>
                    </ul>
                    <p class="mt-2 text-yellow-400">Your transport & situation affect how much free time you have!</p>
                `
            },
            {
                icon: "üè†",
                title: "Living Situation & Transport",
                content: `
                    <p>Click <span class="text-cyan-400">Living Situation</span> or <span class="text-cyan-400">Transportation</span> to upgrade or downgrade.</p>
                    <p class="mt-2">These affect:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>üíµ <span class="text-yellow-400">Weekly costs</span></li>
                        <li>üò∞ <span class="text-purple-400">Stress levels</span> (nice apartment = less stress)</li>
                        <li>üíï <span class="text-pink-400">Dating appeal</span> (especially for guys)</li>
                        <li>‚è∞ <span class="text-cyan-400">Free time</span> (walking everywhere takes time!)</li>
                    </ul>
                `
            },
            {
                icon: "üì±",
                title: "Subscriptions",
                content: `
                    <p>Click <span class="text-cyan-400">üì± Subscriptions</span> to sign up for services like:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>üèãÔ∏è Gym membership (enables gym workouts)</li>
                        <li>üì∫ Streaming (happiness boost)</li>
                        <li>üßò Meditation app (stress relief)</li>
                        <li>üíï Dating apps (better chance to meet someone)</li>
                    </ul>
                    <p class="mt-2 text-yellow-400">Each has a weekly cost - don't overcommit!</p>
                `
            },
            {
                icon: "üß†",
                title: "Habits & Willpower",
                content: `
                    <p>Click <span class="text-cyan-400">üß† Habits</span> to manage your habits.</p>
                    <p class="mt-2"><span class="text-purple-400">Willpower</span> is your budget for maintaining habits:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><span class="text-green-400">Good habits</span> (exercise, reading) cost willpower to maintain</li>
                        <li><span class="text-red-400">Bad habits</span> give willpower but hurt your stats</li>
                        <li><span class="text-cyan-400">Streaks</span> make habits easier over time</li>
                    </ul>
                    <p class="mt-2 text-red-400">‚ö†Ô∏è Watch out! If stress, unhappiness, or exhaustion get too high, you may develop bad habits automatically!</p>
                    <p class="mt-1 text-gray-400 text-sm">High Self-Control helps resist these urges.</p>
                `
            },
            {
                icon: "üë•",
                title: "Relationships",
                content: `
                    <p>Click <span class="text-cyan-400">üë• People in Your Life</span> to see your relationships.</p>
                    <p class="mt-2">You'll build connections with:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><span class="text-pink-400">üíï Romantic partners</span> - Dating, marriage, family</li>
                        <li><span class="text-cyan-400">üìö Study buddies</span> - Boost your education</li>
                        <li><span class="text-blue-400">üéì Mentors</span> - Professors & career guides</li>
                        <li><span class="text-purple-400">üíº Professional network</span> - Career opportunities</li>
                        <li><span class="text-yellow-400">üè† Family</span> - Always there for you</li>
                    </ul>
                    <p class="mt-2 text-gray-400">Strong relationships help in tough times!</p>
                `
            },
            {
                icon: "üé£",
                title: "Recreation & Minigames",
                content: `
                    <p>Sometimes you'll get chances to relax with fun activities!</p>
                    <p class="mt-2">Look out for events like:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><span class="text-blue-400">üé£ Fishing</span> - Catch fish for money & stress relief</li>
                        <li><span class="text-green-400">üå≥ Outdoor activities</span> - Nature is healing</li>
                        <li><span class="text-yellow-400">üéÆ Games & hobbies</span> - Build skills & unwind</li>
                    </ul>
                    <p class="mt-2 text-cyan-400">Balance work and play for a happy life!</p>
                `
            },
            {
                icon: "üé≤",
                title: "Dice Rolls & Choices",
                content: `
                    <p>Many choices involve <span class="text-cyan-400">dice rolls</span> (D20 system).</p>
                    <p class="mt-2">Your roll is modified by:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><span class="text-cyan-400">+ Skills</span> (relevant to the task)</li>
                        <li><span class="text-purple-400">- Stress</span> (high stress = penalty)</li>
                        <li><span class="text-yellow-400">- Fatigue</span> (low energy = penalty)</li>
                        <li><span class="text-blue-400">+ Intelligence</span> (for academic tasks)</li>
                    </ul>
                    <p class="mt-2"><span class="text-yellow-400">NAT 20</span> = Critical success! <span class="text-red-400">NAT 1</span> = Critical fail!</p>
                `
            },
            {
                icon: "üåü",
                title: "You're Ready!",
                content: `
                    <p>Remember:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Every choice has <span class="text-yellow-400">tradeoffs</span></li>
                        <li>Balance work, health, relationships, and fun</li>
                        <li>Your traits affect what paths are available</li>
                        <li>Use the <span class="text-gray-400">‚öôÔ∏è</span> menu to save your game</li>
                    </ul>
                    <p class="mt-3 text-cyan-400 font-bold">Good luck living your best life!</p>
                `
            }
        ];
        
        function showTutorial() {
            tutorialStep = 0;
            closeGameMenu();
            updateTutorialDisplay();
            document.getElementById('tutorialModal').classList.remove('hidden');
        }
        
        function updateTutorialDisplay() {
            let step = TUTORIAL_STEPS[tutorialStep];
            document.getElementById('tutorialIcon').innerText = step.icon;
            document.getElementById('tutorialTitle').innerText = step.title;
            document.getElementById('tutorialContent').innerHTML = step.content;
            document.getElementById('tutorialProgress').innerText = `Step ${tutorialStep + 1} of ${TUTORIAL_STEPS.length}`;
            document.getElementById('tutorialNextBtn').innerText = tutorialStep === TUTORIAL_STEPS.length - 1 ? "Let's Go! üéÆ" : "Next ‚Üí";
        }
        
        function nextTutorialStep() {
            tutorialStep++;
            if (tutorialStep >= TUTORIAL_STEPS.length) {
                closeTutorial();
                return;
            }
            updateTutorialDisplay();
        }
        
        function skipTutorial() {
            closeTutorial();
        }
        
        function closeTutorial() {
            document.getElementById('tutorialModal').classList.add('hidden');
            state.tutorialComplete = true;
        }
        
        // ============ GAME MENU ============
        function openGameMenu() {
            document.getElementById('gameMenuModal').classList.remove('hidden');
        }
        
        function closeGameMenu() {
            document.getElementById('gameMenuModal').classList.add('hidden');
        }
        
        function saveGame() {
            try {
                let saveData = JSON.stringify(state);
                localStorage.setItem('lifeGameSave', saveData);
                localStorage.setItem('lifeGameSaveDate', new Date().toISOString());
                closeGameMenu();
                alert('Game saved! ‚úÖ');
            } catch (e) {
                alert('Failed to save game: ' + e.message);
            }
        }
        
        function loadGame() {
            try {
                let saveData = localStorage.getItem('lifeGameSave');
                if (!saveData) {
                    alert('No saved game found!');
                    return;
                }
                
                let loadedState = JSON.parse(saveData);
                let saveDate = localStorage.getItem('lifeGameSaveDate');
                let dateStr = saveDate ? new Date(saveDate).toLocaleDateString() : 'Unknown';
                
                if (confirm(`Load saved game from ${dateStr}?\n(Age: ${Math.floor(18 + loadedState.totalWeeks / 52)}, $${loadedState.money?.toLocaleString() || 0})\n\nThis will overwrite your current game!`)) {
                    Object.assign(state, loadedState);
                    closeGameMenu();
                    updateUI();
                    nextEvent();
                    alert('Game loaded! ‚úÖ');
                }
            } catch (e) {
                alert('Failed to load game: ' + e.message);
            }
        }
        
        function confirmEndGame() {
            closeGameMenu();
            document.getElementById('confirmEndModal').classList.remove('hidden');
        }
        
        function closeConfirmEnd() {
            document.getElementById('confirmEndModal').classList.add('hidden');
        }
        
        function endGameEarly() {
            closeConfirmEnd();
            endGame('early');
        }
        
        // Auto-trigger tutorial after character creation
        function checkTutorial() {
            if (!state.tutorialComplete && state.phase === 'deciding') {
                showTutorial();
            }
        }

        // ============ RELATIONSHIPS SYSTEM ============
        function openRelationshipsModal() {
            let modal = document.getElementById('relationshipsModal');
            let listDiv = document.getElementById('relationshipsList');
            listDiv.innerHTML = '';
            
            let relationships = [];
            
            // Partner
            if (state.hasPartner && state.partnerName) {
                let bond = state.partnerStats?.supportiveness || 50;
                let status = state.married ? 'üíç Married' : 'üíï Dating';
                let weeks = state.relationshipWeeks || 0;
                let years = Math.floor(weeks / 52);
                let timeStr = years > 0 ? `${years}+ years` : `${weeks} weeks`;
                relationships.push({
                    name: state.partnerName,
                    icon: 'üíï',
                    type: status,
                    bond: bond,
                    details: `Together ${timeStr}`,
                    color: 'pink'
                });
            }
            
            // Family
            let familyBond = 50 + (state.characterTraits?.familyWealth || 5) * 3;
            if (state.money > 10000) familyBond += 10; // Success impresses family
            relationships.push({
                name: 'Family',
                icon: 'üë®‚Äçüë©‚Äçüëß',
                type: 'Family',
                bond: Math.min(100, familyBond),
                details: state.characterTraits?.familyWealth >= 7 ? 'Wealthy & supportive' : 
                         state.characterTraits?.familyWealth <= 3 ? 'Struggling but loving' : 'Close',
                color: 'yellow'
            });
            
            // Children
            if (state.relationship?.children > 0) {
                relationships.push({
                    name: `Your ${state.relationship.children === 1 ? 'Child' : 'Children'}`,
                    icon: 'üë∂',
                    type: `${state.relationship.children} ${state.relationship.children === 1 ? 'kid' : 'kids'}`,
                    bond: 100,
                    details: 'The light of your life',
                    color: 'blue'
                });
            }
            
            // Study buddy (university)
            if (state.university?.studyBuddy) {
                let bond = state.university.studyBuddyRelationship || 50;
                relationships.push({
                    name: state.university.studyBuddy,
                    icon: 'üìö',
                    type: 'Study Buddy',
                    bond: bond,
                    details: bond > 70 ? 'Close friend' : bond > 40 ? 'Good study partner' : 'Acquaintance',
                    color: 'cyan'
                });
            }
            
            // Professor mentor
            if (state.university?.professorMentor) {
                let bond = state.university.professorRelationship || 50;
                relationships.push({
                    name: state.university.professorMentor.name,
                    icon: 'üéì',
                    type: 'Professor Mentor',
                    bond: bond,
                    details: state.university.professorMentor.field || 'Academic mentor',
                    color: 'purple'
                });
            }
            
            // Trade school mentor
            if (state.tradeSchool?.mentorName) {
                let bond = state.tradeSchool.mentorRelationship || 50;
                relationships.push({
                    name: state.tradeSchool.mentorName,
                    icon: 'üîß',
                    type: 'Trade Mentor',
                    bond: bond,
                    details: bond > 60 ? 'Respects your work' : 'Teaching you the trade',
                    color: 'orange'
                });
            }
            
            // Military relationships
            if (state.military?.squad) {
                relationships.push({
                    name: 'Your Squad',
                    icon: 'üéñÔ∏è',
                    type: 'Battle Brothers/Sisters',
                    bond: 70 + (state.military.combatXP || 0) / 5,
                    details: `${state.military.missionsCompleted || 0} missions together`,
                    color: 'green'
                });
            }
            
            // Boss (if employed)
            if (state.employed && state.job !== 'military') {
                let perf = state.career?.performanceRating || 50;
                relationships.push({
                    name: 'Your Boss',
                    icon: 'üíº',
                    type: 'Employer',
                    bond: perf,
                    details: perf > 70 ? 'Values you highly' : perf > 40 ? 'Professional relationship' : 'On thin ice',
                    color: 'gray'
                });
            }
            
            // Network contacts
            if (state.career?.networkContacts > 5) {
                relationships.push({
                    name: 'Professional Network',
                    icon: 'ü§ù',
                    type: `${state.career.networkContacts} contacts`,
                    bond: Math.min(100, state.career.networkContacts * 2),
                    details: 'Career connections',
                    color: 'blue'
                });
            }
            
            // Render relationships
            if (relationships.length === 0) {
                listDiv.innerHTML = '<div class="text-gray-500 text-center py-4">No close relationships yet. Get out there!</div>';
            } else {
                relationships.forEach(rel => {
                    let div = document.createElement('div');
                    div.className = `p-3 rounded border border-${rel.color}-500/30 bg-${rel.color}-900/10`;
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${rel.icon}</span>
                                <div>
                                    <div class="text-white font-medium">${rel.name}</div>
                                    <div class="text-xs text-gray-400">${rel.type}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-${rel.color}-400">${Math.round(rel.bond)}%</div>
                                <div class="text-xs text-gray-500">${rel.details}</div>
                            </div>
                        </div>
                        <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                            <div class="h-full bg-${rel.color}-500 rounded-full" style="width: ${rel.bond}%"></div>
                        </div>
                    `;
                    listDiv.appendChild(div);
                });
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeRelationshipsModal() {
            document.getElementById('relationshipsModal').classList.add('hidden');
        }
        
        // ============ EDUCATION MODAL ============
        function openEducationModal() {
            let modal = document.getElementById('educationModal');
            let content = document.getElementById('educationContent');
            let title = document.getElementById('eduModalTitle');
            
            content.innerHTML = '';
            
            // Different content based on phase
            if (state.phase === 'education') {
                title.innerText = 'üìö Academic Progress';
                
                let eduType = state.educationType;
                let eduName = eduType === 'university' ? 'University' : 
                             eduType === 'community_college' ? 'Community College' : 
                             eduType === 'trade_school' ? 'Trade School' : 
                             eduType === 'military_training' ? 'Boot Camp' : 'Education';
                
                let progress = Math.round((state.phaseWeek / state.phaseTarget) * 100);
                let weeksLeft = state.phaseTarget - state.phaseWeek;
                let yearsLeft = Math.floor(weeksLeft / 52);
                let monthsLeft = Math.floor((weeksLeft % 52) / 4);
                let timeLeft = yearsLeft > 0 ? `${yearsLeft} year${yearsLeft > 1 ? 's' : ''} ${monthsLeft} months` : `${monthsLeft} months`;
                
                // GPA color based on performance
                let gpa = state.gpa || 0;
                let gpaColor = gpa >= 3.5 ? 'text-green-400' : gpa >= 3.0 ? 'text-cyan-400' : gpa >= 2.5 ? 'text-yellow-400' : gpa >= 2.0 ? 'text-orange-400' : 'text-red-400';
                let gpaStatus = gpa >= 3.9 ? 'Summa Cum Laude track!' : gpa >= 3.7 ? 'Magna Cum Laude track!' : gpa >= 3.5 ? "Dean's List!" : gpa >= 3.0 ? 'Solid performance' : gpa >= 2.5 ? 'Room for improvement' : gpa >= 2.0 ? '‚ö†Ô∏è Struggling' : 'üö® Academic probation risk!';
                
                // Career prospects preview
                let careerProspects = "";
                if (eduType === 'university') {
                    if (gpa >= 3.7) careerProspects = "üè¶ Prestigious positions available (Investment Banking, Big Tech, Consulting)";
                    else if (gpa >= 3.5) careerProspects = "üìä Good career options with salary bonuses";
                    else if (gpa >= 3.0) careerProspects = "üíº Standard career path";
                    else if (gpa >= 2.5) careerProspects = "üìâ Limited options, -5% starting salary";
                    else careerProspects = "‚ö†Ô∏è Very limited options, -10% starting salary";
                }
                
                content.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-3xl mb-2">üéì</div>
                        <div class="text-xl text-white">${eduName}</div>
                        ${state.university?.major ? `<div class="text-sm text-gray-400">${MAJORS[state.university.major]?.name || 'Undeclared'}</div>` : ''}
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-400">Current GPA</span>
                            <span class="${gpaColor} text-xl font-bold">${gpa.toFixed(2)}</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full" style="width: ${(gpa / 4) * 100}%"></div>
                        </div>
                        <div class="text-xs text-center mt-1 ${gpaColor}">${gpaStatus}</div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg mt-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-400">Progress to Graduation</span>
                            <span class="text-cyan-400">${progress}%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-500 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Week ${state.phaseWeek} of ${state.phaseTarget} ‚Ä¢ ~${timeLeft} remaining</div>
                    </div>
                    
                    ${careerProspects ? `
                    <div class="p-3 bg-gray-800 rounded-lg mt-3">
                        <div class="text-gray-400 text-sm mb-1">Career Prospects</div>
                        <div class="text-white text-sm">${careerProspects}</div>
                    </div>
                    ` : ''}
                    
                    ${state.university ? `
                    <div class="p-3 bg-gray-800 rounded-lg mt-3">
                        <div class="text-gray-400 text-sm mb-2">Academic Stats</div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">On Probation:</span><span class="${state.university.onProbation ? 'text-red-400' : 'text-green-400'}">${state.university.onProbation ? 'Yes ‚ö†Ô∏è' : 'No ‚úì'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Dean's List:</span><span class="${state.university.honorsList ? 'text-yellow-400' : 'text-gray-400'}">${state.university.honorsList ? 'Yes ‚≠ê' : 'No'}</span></div>
                            ${state.university.studyBuddy ? `<div class="flex justify-between"><span class="text-gray-500">Study Buddy:</span><span class="text-cyan-400">${state.university.studyBuddy.split(' ')[0]}</span></div>` : ''}
                            ${state.university.professorMentor ? `<div class="flex justify-between"><span class="text-gray-500">Mentor:</span><span class="text-purple-400">${state.university.professorMentor.name?.split(' ')[0] || 'Professor'}</span></div>` : ''}
                            <div class="flex justify-between"><span class="text-gray-500">All-Nighters:</span><span class="text-orange-400">${state.university.allNighters || 0}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Internship:</span><span class="${state.university.internshipCompleted ? 'text-green-400' : 'text-gray-400'}">${state.university.internshipCompleted ? 'Done ‚úì' : 'Not yet'}</span></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="mt-4 p-3 bg-blue-900/30 border border-blue-500/30 rounded-lg">
                        <div class="text-blue-400 text-sm font-medium">üí° GPA Tips</div>
                        <ul class="text-xs text-gray-400 mt-1 space-y-1">
                            <li>‚Ä¢ Study hard for exams - failed rolls hurt your GPA</li>
                            <li>‚Ä¢ Find a study buddy for easier assignments</li>
                            <li>‚Ä¢ 3.5+ GPA = honors and better job prospects</li>
                            <li>‚Ä¢ Below 2.0 = academic probation risk!</li>
                        </ul>
                    </div>
                `;
            } else if (state.phase === 'employed' || state.phase === 'job_hunting') {
                // Show job/career info instead
                title.innerText = state.employed ? 'üíº Career Status' : 'üîç Job Search';
                
                if (state.employed) {
                    let job = JOBS[state.job];
                    let perf = state.performance || 50;
                    let perfColor = perf >= 80 ? 'text-green-400' : perf >= 60 ? 'text-cyan-400' : perf >= 40 ? 'text-yellow-400' : 'text-red-400';
                    let perfStatus = perf >= 80 ? 'Excellent - Promotion likely!' : perf >= 60 ? 'Good standing' : perf >= 40 ? 'Needs improvement' : 'At risk of termination';
                    
                    content.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="text-3xl mb-2">${job?.icon || 'üíº'}</div>
                            <div class="text-xl text-white">${state.jobTitle}</div>
                            <div class="text-sm text-gray-400">Week ${state.weeksAtJob} on the job</div>
                        </div>
                        
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-400">Performance</span>
                                <span class="${perfColor}">${Math.round(perf)}%</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full ${perf >= 60 ? 'bg-green-500' : perf >= 40 ? 'bg-yellow-500' : 'bg-red-500'} rounded-full" style="width: ${perf}%"></div>
                            </div>
                            <div class="text-xs text-center mt-1 ${perfColor}">${perfStatus}</div>
                        </div>
                        
                        <div class="p-3 bg-gray-800 rounded-lg mt-3">
                            <div class="text-gray-400 text-sm mb-2">Compensation</div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Base Salary:</span>
                                <span class="text-green-400">$${job?.salary || 0}/week</span>
                            </div>
                            ${state.baseSalary && state.baseSalary !== job?.salary ? `
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Your Salary:</span>
                                <span class="text-green-400">$${state.baseSalary}/week</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${state.education ? `
                        <div class="p-3 bg-gray-800 rounded-lg mt-3">
                            <div class="text-gray-400 text-sm mb-1">Education</div>
                            <div class="text-white">${state.education.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                            ${state.gpa ? `<div class="text-sm text-gray-400">Graduated with ${state.gpa.toFixed(2)} GPA</div>` : ''}
                        </div>
                        ` : ''}
                    `;
                } else {
                    // Job hunting
                    let gpaBonus = getGPAHiringModifier();
                    let gpaSalaryMod = getGPASalaryModifier();
                    
                    content.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="text-3xl mb-2">üîç</div>
                            <div class="text-xl text-white">Job Hunting</div>
                            <div class="text-sm text-gray-400">Week ${state.phaseWeek + 1}</div>
                        </div>
                        
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-500">Applications Sent:</span>
                                <span class="text-cyan-400">${state.jobApplications || 0}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Interviews Pending:</span>
                                <span class="text-green-400">${state.interviews || 0}</span>
                            </div>
                        </div>
                        
                        ${state.education === 'university' || state.education === 'community_college' ? `
                        <div class="p-3 bg-gray-800 rounded-lg mt-3">
                            <div class="text-gray-400 text-sm mb-2">GPA Impact on Job Hunt</div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-500">Your GPA:</span>
                                <span class="${state.gpa >= 3.5 ? 'text-green-400' : state.gpa >= 3.0 ? 'text-cyan-400' : state.gpa >= 2.5 ? 'text-yellow-400' : 'text-red-400'}">${state.gpa?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-500">Interview Bonus:</span>
                                <span class="${gpaBonus >= 0 ? 'text-green-400' : 'text-red-400'}">${gpaBonus >= 0 ? '+' : ''}${gpaBonus}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Salary Modifier:</span>
                                <span class="${gpaSalaryMod >= 1 ? 'text-green-400' : 'text-red-400'}">${gpaSalaryMod >= 1 ? '+' : ''}${Math.round((gpaSalaryMod - 1) * 100)}%</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="p-3 bg-gray-800 rounded-lg mt-3">
                            <div class="text-gray-400 text-sm mb-1">Available Positions: ${getAvailableJobs().length}</div>
                            <div class="text-xs text-gray-500">Based on your education, skills, and GPA</div>
                        </div>
                    `;
                }
            } else {
                // Generic status for other phases
                title.innerText = 'üìã Current Status';
                content.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-3xl mb-2">${state.phase === 'deciding' ? 'ü§î' : '‚ùì'}</div>
                        <div class="text-white">${state.phase === 'deciding' ? 'Deciding Your Future' : 'In Transition'}</div>
                        <div class="text-sm text-gray-400 mt-2">Make choices to shape your path!</div>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeEducationModal() {
            document.getElementById('educationModal').classList.add('hidden');
        }
        
        function updateRelationshipsSummary() {
            let summary = [];
            
            // Primary relationships first
            if (state.hasPartner) summary.push(`üíï ${state.partnerName}`);
            if (state.relationship?.children > 0) {
                summary.push(`üë∂ ${state.relationship.children} ${state.relationship.children === 1 ? 'child' : 'children'}`);
            }
            
            // Education/career mentors
            if (state.university?.studyBuddy) summary.push(`üìö ${state.university.studyBuddy.split(' ')[0]}`);
            if (state.university?.professorMentor) summary.push(`üéì ${state.university.professorMentor.name?.split(' ')[0] || 'Professor'}`);
            if (state.tradeSchool?.mentorName) summary.push(`üîß ${state.tradeSchool.mentorName.split(' ')[0]}`);
            if (state.military?.squadMates > 0) summary.push(`üéñÔ∏è ${state.military.squadMates} squad mates`);
            
            // Network
            if (state.career?.networkContacts > 0) summary.push(`üíº ${state.career.networkContacts} contacts`);
            
            // Always show family (everyone has one)
            let familyWealth = state.characterTraits?.familyWealth || 5;
            let familyStatus = familyWealth >= 7 ? 'Supportive' : familyWealth >= 4 ? 'Close' : 'Distant';
            summary.push(`üè† Family (${familyStatus})`);
            
            let el = document.getElementById('relationshipsSummary');
            el.innerHTML = summary.slice(0, 4).map(s => `<div class="text-gray-300">${s}</div>`).join('');
            if (summary.length > 4) {
                el.innerHTML += `<div class="text-gray-500 cursor-pointer hover:text-cyan-400">+${summary.length - 4} more...</div>`;
            }
        }

        // ============ FISHING MINI-GAME ============
        let fishingState = {
            location: null,
            casting: false,
            caught: null
        };
        
        function goFishing(locationKey) {
            let location = FISHING_LOCATIONS[locationKey];
            if (!location) return;
            
            // Check if can afford
            if (state.money < location.cost) {
                alert(`Not enough money! Need $${location.cost} for ${location.name}`);
                return;
            }
            
            // Check if secret spot is unlocked
            if (location.unlock && state.skills.fishing < location.unlock) {
                alert(`Need ${location.unlock} fishing skill to access this spot!`);
                return;
            }
            
            state.money -= location.cost;
            fishingState.location = locationKey;
            fishingState.casting = false;
            fishingState.caught = null;
            
            showFishingScreen();
        }
        
        function showFishingScreen() {
            let modal = document.getElementById('fishingModal');
            let location = FISHING_LOCATIONS[fishingState.location];
            
            document.getElementById('fishingIcon').innerText = 'üé£';
            document.getElementById('fishingTitle').innerText = `Fishing at ${location.name}`;
            document.getElementById('fishingContent').innerHTML = `
                <p>Your fishing skill: <span class="text-cyan-400">${state.skills.fishing}</span></p>
                <p class="text-xs text-gray-500 mt-1">Higher skill = better catches!</p>
            `;
            document.getElementById('fishingWater').innerText = 'üåä';
            
            document.getElementById('fishingActions').innerHTML = `
                <button onclick="castLine()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors text-lg">
                    üé£ Cast Your Line
                </button>
                <button onclick="closeFishing()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors mt-2">
                    Pack Up & Leave
                </button>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function castLine() {
            let location = FISHING_LOCATIONS[fishingState.location];
            
            document.getElementById('fishingWater').innerText = 'üé£';
            document.getElementById('fishingContent').innerHTML = '<p class="text-lg">Waiting for a bite...</p>';
            document.getElementById('fishingActions').innerHTML = '<p class="text-gray-500 animate-pulse">...</p>';
            
            // Random wait time
            let waitTime = 1000 + Math.random() * 2000;
            
            setTimeout(() => {
                // Determine what's on the line
                let fishPool = location.fish;
                let caughtKey = fishPool[Math.floor(Math.random() * fishPool.length)];
                let fish = FISH_TYPES[caughtKey];
                
                // Is it junk?
                if (fish.rarity === 'junk') {
                    document.getElementById('fishingWater').innerText = fish.icon;
                    document.getElementById('fishingContent').innerHTML = `
                        <p class="text-lg">You caught... a ${fish.name}.</p>
                        <p class="text-gray-500 text-sm">Well, that's disappointing.</p>
                    `;
                    document.getElementById('fishingActions').innerHTML = `
                        <button onclick="castLine()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors">
                            üé£ Cast Again
                        </button>
                        <button onclick="closeFishing()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors mt-2">
                            Pack Up
                        </button>
                    `;
                    return;
                }
                
                // Something's biting!
                document.getElementById('fishingWater').innerText = '‚ùó';
                document.getElementById('fishingContent').innerHTML = `
                    <p class="text-lg text-yellow-400 animate-pulse">Something's on the line!</p>
                    <p class="text-gray-400">Quick, reel it in!</p>
                `;
                
                fishingState.caught = caughtKey;
                
                document.getElementById('fishingActions').innerHTML = `
                    <button onclick="reelIn()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-colors text-xl animate-pulse">
                        üé£ REEL IT IN!
                    </button>
                `;
            }, waitTime);
        }
        
        function reelIn() {
            let fish = FISH_TYPES[fishingState.caught];
            let location = FISHING_LOCATIONS[fishingState.location];
            
            // Roll to catch
            let skillBonus = Math.floor(state.skills.fishing / 5);
            let locationBonus = location.bonus;
            let dc = fish.dc;
            
            let roll = Math.floor(Math.random() * 20) + 1;
            let total = roll + skillBonus + locationBonus;
            let success = total >= dc || roll === 20;
            let critSuccess = roll === 20;
            let critFail = roll === 1;
            
            document.getElementById('fishingWater').innerText = 'üé≤';
            
            if (critFail) {
                // Line snaps!
                document.getElementById('fishingContent').innerHTML = `
                    <p class="text-red-400 text-lg">SNAP! Your line broke!</p>
                    <p class="text-gray-500">Rolled: ${roll} (Critical Fail)</p>
                    <p class="text-gray-400 mt-2">The ${fish.name} got away...</p>
                `;
                state.stress += 5;
            } else if (success) {
                // Caught it!
                let value = critSuccess ? fish.value * 2 : fish.value;
                let xp = critSuccess ? fish.xp * 2 : fish.xp;
                
                state.money += value;
                state.skills.fishing = Math.min(100, state.skills.fishing + xp);
                state.fishing.totalCatches++;
                state.fishing.fishingTrips++;
                state.stress = Math.max(0, state.stress - 3);
                state.happiness = Math.min(100, state.happiness + 2);
                
                // Track best catch
                if (!state.fishing.bestCatch || fish.value > FISH_TYPES[state.fishing.bestCatch]?.value) {
                    state.fishing.bestCatch = fishingState.caught;
                }
                
                // Track legendary catches
                if ((fish.rarity === 'legendary' || fish.rarity === 'mythical') && !state.fishing.legendsCaught.includes(fishingState.caught)) {
                    state.fishing.legendsCaught.push(fishingState.caught);
                    state.achievements.push(`Caught ${fish.name}`);
                }
                
                let rarityColor = fish.rarity === 'legendary' ? 'text-yellow-400' : 
                                  fish.rarity === 'mythical' ? 'text-purple-400' :
                                  fish.rarity === 'rare' ? 'text-blue-400' :
                                  fish.rarity === 'uncommon' ? 'text-green-400' : 'text-gray-300';
                
                document.getElementById('fishingWater').innerText = fish.icon;
                document.getElementById('fishingContent').innerHTML = `
                    <p class="${rarityColor} text-lg font-bold">${critSuccess ? 'üåü PERFECT CATCH! üåü' : 'You caught it!'}</p>
                    <p class="text-2xl mt-2">${fish.icon} ${fish.name}</p>
                    <p class="text-gray-500">Rolled: ${roll} + ${skillBonus + locationBonus} = ${total} vs DC ${dc}</p>
                    <div class="mt-3 space-y-1 text-sm">
                        <p class="text-green-400">+$${value}</p>
                        <p class="text-cyan-400">+${xp} Fishing XP</p>
                        <p class="text-purple-400">-3 Stress</p>
                    </div>
                `;
            } else {
                // Got away
                document.getElementById('fishingContent').innerHTML = `
                    <p class="text-orange-400 text-lg">It got away!</p>
                    <p class="text-gray-500">Rolled: ${roll} + ${skillBonus + locationBonus} = ${total} vs DC ${dc}</p>
                    <p class="text-gray-400 mt-2">The ${fish.name} was too strong...</p>
                `;
                state.skills.fishing = Math.min(100, state.skills.fishing + 0.5); // Small XP for trying
            }
            
            document.getElementById('fishingActions').innerHTML = `
                <button onclick="castLine()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors">
                    üé£ Cast Again
                </button>
                <button onclick="closeFishing()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors mt-2">
                    Pack Up & Leave
                </button>
            `;
            
            updateUI();
        }
        
        function closeFishing() {
            document.getElementById('fishingModal').classList.add('hidden');
            fishingState.location = null;
        }
        
        function getFishingEvent() {
            // Random fishing opportunity
            return {
                category: "üé£ Recreation",
                title: "Perfect Day for Fishing",
                desc: "The weather's nice. You could go fishing to relax and maybe catch something valuable.",
                choices: Object.keys(FISHING_LOCATIONS).map(key => {
                    let loc = FISHING_LOCATIONS[key];
                    let canAccess = !loc.unlock || state.skills.fishing >= loc.unlock;
                    return {
                        text: `${loc.icon} ${loc.name}${loc.cost > 0 ? ` ($${loc.cost})` : ' (Free)'}${!canAccess ? ' üîí' : ''}`,
                        condition: () => canAccess && state.money >= loc.cost,
                        effect: () => {
                            goFishing(key);
                            return { icon: "üé£", text: `Heading to ${loc.name}...`, stats: loc.cost > 0 ? `-$${loc.cost}` : "Free!" };
                        }
                    };
                }).concat([{
                    text: "Not today",
                    effect: () => {
                        return { icon: "ü§∑", text: "Maybe next time.", stats: "" };
                    }
                }])
            };
        }

        // ============ HABITS SYSTEM ============
        function calculateMaxWillpower() {
            // Base willpower from self-control trait
            let selfControl = state.characterTraits?.selfControl || 5;
            let base = 30 + (selfControl * 5); // 35-80 base range
            
            // Stress reduces max willpower significantly
            let stressPenalty = Math.floor(state.stress / 5); // -0 to -20
            
            // Energy boosts willpower
            let energyBonus = Math.floor((state.energy - 50) / 10); // -5 to +5
            
            // Rest free time activity gives bonus
            let restBonus = (state.freeTime?.rest || 0) * 1; // +1 per rest hour
            
            // Meditation habit boosts willpower regen
            let meditationBonus = 0;
            if (state.habits?.meditation?.active) {
                meditationBonus = 5 + Math.floor(state.habits.meditation.weeksActive / 4);
            }
            
            return Math.max(20, base - stressPenalty + energyBonus + restBonus + meditationBonus);
        }
        
        function calculateHabitCost(habitKey) {
            let habit = HABITS[habitKey];
            if (!habit || habit.type !== 'good') return 0;
            
            let baseCost = habit.baseCost;
            let weeksActive = state.habits[habitKey]?.weeksActive || 0;
            
            // Habits get easier to maintain over time
            // After 4 weeks: -20%, 8 weeks: -35%, 12 weeks: -50%, 20+ weeks: -60%
            let reduction = 0;
            if (weeksActive >= 20) reduction = 0.60;
            else if (weeksActive >= 12) reduction = 0.50;
            else if (weeksActive >= 8) reduction = 0.35;
            else if (weeksActive >= 4) reduction = 0.20;
            
            return Math.ceil(baseCost * (1 - reduction));
        }
        
        function getTotalHabitCost() {
            let totalCost = 0;
            let totalGain = 0;
            
            Object.keys(state.habits || {}).forEach(key => {
                if (state.habits[key]?.active && HABITS[key]) {
                    if (HABITS[key].type === 'good') {
                        totalCost += calculateHabitCost(key);
                    } else {
                        totalGain += HABITS[key].willpowerGain || 0;
                    }
                }
            });
            
            return totalCost - totalGain;
        }
        
        function openHabitsModal() {
            let modal = document.getElementById('habitsModal');
            
            // Update willpower display
            let maxWP = calculateMaxWillpower();
            let habitCost = getTotalHabitCost();
            let availableWP = maxWP - habitCost;
            
            document.getElementById('habitsWillpowerText').innerText = `${Math.max(0, availableWP)}/${maxWP}`;
            document.getElementById('habitsWillpowerBar').style.width = Math.max(0, (availableWP / maxWP) * 100) + '%';
            
            // Color the bar
            let bar = document.getElementById('habitsWillpowerBar');
            if (availableWP < 0) {
                bar.className = 'h-full bg-red-500 rounded-full transition-all animate-pulse';
            } else if (availableWP < maxWP * 0.3) {
                bar.className = 'h-full bg-orange-500 rounded-full transition-all';
            } else {
                bar.className = 'h-full bg-purple-500 rounded-full transition-all';
            }
            
            // Willpower factors breakdown
            let selfControl = state.characterTraits?.selfControl || 5;
            let factors = [];
            factors.push(`Base (Self-Control ${selfControl}): ${30 + selfControl * 5}`);
            if (state.stress > 0) factors.push(`Stress: -${Math.floor(state.stress / 5)}`);
            if (state.energy !== 50) factors.push(`Energy: ${state.energy > 50 ? '+' : ''}${Math.floor((state.energy - 50) / 10)}`);
            document.getElementById('willpowerFactors').innerHTML = factors.join(' | ');
            
            // Build good habits list
            let goodHabitsDiv = document.getElementById('goodHabitsList');
            goodHabitsDiv.innerHTML = '';
            
            Object.keys(HABITS).filter(k => HABITS[k].type === 'good').forEach(key => {
                let habit = HABITS[key];
                let isActive = state.habits[key]?.active || false;
                let weeksActive = state.habits[key]?.weeksActive || 0;
                let cost = calculateHabitCost(key);
                let canAfford = (availableWP + (isActive ? cost : 0)) >= cost;
                
                let streakText = '';
                if (isActive && weeksActive > 0) {
                    let reduction = Math.round((1 - cost / habit.baseCost) * 100);
                    streakText = `<span class="text-green-400">${weeksActive}wk streak${reduction > 0 ? ` (-${reduction}%)` : ''}</span>`;
                }
                
                let div = document.createElement('div');
                div.className = `p-2 rounded border ${isActive ? 'border-green-500 bg-green-900/20' : 'border-gray-600'} ${!canAfford && !isActive ? 'opacity-50' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${habit.icon}</span>
                            <div>
                                <div class="text-white text-sm">${habit.name}</div>
                                <div class="text-xs text-gray-400">${habit.effects.desc}</div>
                                ${habit.moneyCost ? `<div class="text-xs text-yellow-400">$${habit.moneyCost}/week</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-purple-400 text-sm">${cost} WP</div>
                            ${streakText}
                            <button onclick="toggleHabit('${key}')" class="mt-1 px-2 py-1 text-xs rounded ${isActive ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500'} text-white" ${!canAfford && !isActive ? 'disabled' : ''}>
                                ${isActive ? 'Stop' : 'Start'}
                            </button>
                        </div>
                    </div>
                `;
                goodHabitsDiv.appendChild(div);
            });
            
            // Build bad habits list
            let badHabitsDiv = document.getElementById('badHabitsList');
            badHabitsDiv.innerHTML = '';
            
            Object.keys(HABITS).filter(k => HABITS[k].type === 'bad').forEach(key => {
                let habit = HABITS[key];
                let isActive = state.habits[key]?.active || false;
                let weeksActive = state.habits[key]?.weeksActive || 0;
                
                let div = document.createElement('div');
                div.className = `p-2 rounded border ${isActive ? 'border-red-500 bg-red-900/20' : 'border-gray-600'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${habit.icon}</span>
                            <div>
                                <div class="text-white text-sm">${habit.name}</div>
                                <div class="text-xs text-gray-400">${habit.effects.desc}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-green-400 text-sm">+${habit.willpowerGain} WP</div>
                            ${isActive ? `<span class="text-xs text-red-400">${weeksActive}wk</span>` : ''}
                            <button onclick="toggleHabit('${key}')" class="mt-1 px-2 py-1 text-xs rounded ${isActive ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'} text-white">
                                ${isActive ? 'Quit' : 'Pick Up'}
                            </button>
                        </div>
                    </div>
                `;
                badHabitsDiv.appendChild(div);
            });
            
            modal.classList.remove('hidden');
        }
        
        function closeHabitsModal() {
            document.getElementById('habitsModal').classList.add('hidden');
        }
        
        function toggleHabit(key) {
            let habit = HABITS[key];
            if (!habit) return;
            
            if (!state.habits[key]) {
                state.habits[key] = { active: false, weeksActive: 0 };
            }
            
            if (state.habits[key].active) {
                // Stopping habit
                state.habits[key].active = false;
                state.habits[key].weeksActive = 0;
                addLog(`${habit.type === 'bad' ? 'Quit' : 'Stopped'} ${habit.name}`);
            } else {
                // Starting habit
                let maxWP = calculateMaxWillpower();
                let currentCost = getTotalHabitCost();
                let newCost = habit.type === 'good' ? calculateHabitCost(key) : -(habit.willpowerGain || 0);
                
                if (maxWP - currentCost - newCost < 0 && habit.type === 'good') {
                    alert('Not enough willpower! Reduce stress, get more rest, or drop another habit.');
                    return;
                }
                
                state.habits[key].active = true;
                state.habits[key].weeksActive = 0;
                addLog(`${habit.type === 'bad' ? 'Picked up' : 'Started'} ${habit.name}`);
            }
            
            openHabitsModal(); // Refresh
            updateUI();
        }
        
        function processHabitEffects() {
            let totalMoneyCost = 0;
            
            Object.keys(state.habits || {}).forEach(key => {
                if (!state.habits[key]?.active || !HABITS[key]) return;
                
                let habit = HABITS[key];
                state.habits[key].weeksActive++;
                
                // Apply effects
                let effects = habit.effects;
                if (effects.health) state.health = Math.max(0, Math.min(100, state.health + effects.health));
                if (effects.energy) state.energy = Math.max(0, Math.min(100, state.energy + effects.energy));
                if (effects.stress) state.stress = Math.max(0, Math.min(100, state.stress + effects.stress));
                if (effects.happiness) state.happiness = Math.max(0, Math.min(100, state.happiness + effects.happiness));
                if (effects.physical) state.skills.physical = Math.min(100, state.skills.physical + effects.physical);
                if (effects.technical) state.skills.technical = Math.min(100, state.skills.technical + effects.technical);
                if (effects.creativity) state.skills.creativity = Math.min(100, state.skills.creativity + effects.creativity);
                if (effects.social) state.skills.social = Math.min(100, state.skills.social + effects.social);
                if (effects.attractiveness) {
                    let base = state.characterTraits?.attractiveness || 5;
                    state.currentAttractiveness = Math.max(1, Math.min(10, (state.currentAttractiveness || base) + effects.attractiveness));
                }
                
                // Money costs
                if (habit.moneyCost) totalMoneyCost += habit.moneyCost;
                
                // Gambling risk
                if (effects.moneyRisk && Math.random() < 0.3) {
                    let loss = Math.floor(Math.random() * 200) + 50;
                    state.money -= loss;
                    if (Math.random() < 0.1) {
                        let win = Math.floor(Math.random() * 500) + 100;
                        state.money += win;
                    }
                }
            });
            
            state.habitMoneyCost = totalMoneyCost;
            
            // Check if willpower budget is exceeded (habits start failing)
            let maxWP = calculateMaxWillpower();
            let habitCost = getTotalHabitCost();
            
            if (habitCost > maxWP) {
                // Random good habit fails when over budget
                let goodHabits = Object.keys(state.habits).filter(k => 
                    state.habits[k]?.active && HABITS[k]?.type === 'good'
                );
                
                if (goodHabits.length > 0 && Math.random() < 0.4) {
                    let failedHabit = goodHabits[Math.floor(Math.random() * goodHabits.length)];
                    state.habits[failedHabit].active = false;
                    state.habits[failedHabit].weeksActive = 0;
                    state.stress += 10;
                    addLog(`Willpower depleted - ${HABITS[failedHabit].name} habit broken`);
                }
            }
        }
        
        // ============ BAD HABIT DEVELOPMENT ============
        // Check if player is at risk of developing bad habits
        let pendingBadHabitEvent = null;
        
        function checkBadHabitDevelopment() {
            // Don't trigger if already have a pending event
            if (pendingBadHabitEvent) return;
            
            // Only check once per few weeks
            if (state.totalWeeks % 2 !== 0) return;
            
            let triggers = [];
            
            // HIGH STRESS triggers
            if (state.stress >= 70 && Math.random() < 0.15) {
                if (!state.habits?.smoking?.active) {
                    triggers.push({
                        habit: 'smoking',
                        trigger: 'stress',
                        title: "üò∞ Stress is Getting to You",
                        desc: `Your stress has been dangerously high (${Math.round(state.stress)}%). You find yourself craving something to take the edge off. A coworker offers you a cigarette...`,
                        acceptText: "üö¨ Just this once...",
                        resistText: "No thanks, I'll manage",
                        resistDC: 12 + Math.floor(state.stress / 15)
                    });
                }
                if (!state.habits?.drinking?.active && Math.random() < 0.5) {
                    triggers.push({
                        habit: 'drinking',
                        trigger: 'stress',
                        title: "üò∞ Need to Unwind",
                        desc: `The stress (${Math.round(state.stress)}%) is overwhelming. You keep finding yourself reaching for a drink after work. It's becoming a pattern...`,
                        acceptText: "üç∫ I deserve this",
                        resistText: "I should cut back",
                        resistDC: 11 + Math.floor(state.stress / 20)
                    });
                }
            }
            
            // LOW HAPPINESS triggers
            if (state.happiness <= 30 && Math.random() < 0.12) {
                if (!state.habits?.junkFood?.active) {
                    triggers.push({
                        habit: 'junkFood',
                        trigger: 'happiness',
                        title: "üòî Comfort Eating",
                        desc: `You've been feeling down lately (happiness: ${Math.round(state.happiness)}%). Fast food and snacks are becoming your main source of comfort...`,
                        acceptText: "üçî Food makes me feel better",
                        resistText: "I need healthier coping",
                        resistDC: 10 + Math.floor((30 - state.happiness) / 5)
                    });
                }
                if (!state.habits?.doomScrolling?.active && Math.random() < 0.5) {
                    triggers.push({
                        habit: 'doomScrolling',
                        trigger: 'happiness',
                        title: "üòî Endless Scrolling",
                        desc: `Feeling low (happiness: ${Math.round(state.happiness)}%), you've been spending hours mindlessly scrolling through social media...`,
                        acceptText: "üì± Just a bit more...",
                        resistText: "Put the phone down",
                        resistDC: 9 + Math.floor((30 - state.happiness) / 6)
                    });
                }
            }
            
            // LOW ENERGY triggers
            if (state.energy <= 35 && Math.random() < 0.10) {
                if (!state.habits?.lateSleeper?.active) {
                    triggers.push({
                        habit: 'lateSleeper',
                        trigger: 'energy',
                        title: "ü¶â Can't Sleep",
                        desc: `Despite being exhausted (energy: ${Math.round(state.energy)}%), you keep staying up late. Your sleep schedule is getting worse...`,
                        acceptText: "üåô Just one more hour",
                        resistText: "I really need to sleep",
                        resistDC: 10 + Math.floor((35 - state.energy) / 5)
                    });
                }
                if (!state.habits?.procrastination?.active && Math.random() < 0.5) {
                    triggers.push({
                        habit: 'procrastination',
                        trigger: 'energy',
                        title: "‚è∞ Too Tired to Start",
                        desc: `You're so drained (energy: ${Math.round(state.energy)}%) that you keep putting things off until the last minute...`,
                        acceptText: "I'll do it tomorrow...",
                        resistText: "Just get it done",
                        resistDC: 9 + Math.floor((35 - state.energy) / 5)
                    });
                }
            }
            
            // FINANCIAL DESPERATION triggers
            if (state.money < -500 && !state.habits?.gambling?.active && Math.random() < 0.08) {
                triggers.push({
                    habit: 'gambling',
                    trigger: 'money',
                    title: "üí∏ Desperate Times",
                    desc: `You're deep in debt ($${Math.abs(Math.round(state.money))}). Someone mentions a "sure thing" bet that could turn things around...`,
                    acceptText: "üé∞ Could be my lucky day",
                    resistText: "That's not how this works",
                    resistDC: 14
                });
            }
            
            // Multiple stressors compound - if 2+ issues, higher chance
            if (state.stress >= 60 && state.happiness <= 40 && state.energy <= 40 && Math.random() < 0.1) {
                if (!state.habits?.drinking?.active) {
                    triggers.push({
                        habit: 'drinking',
                        trigger: 'compound',
                        title: "üå™Ô∏è Everything's Too Much",
                        desc: "Stressed, unhappy, and exhausted - you feel like you're drowning. A few drinks seem like the only escape...",
                        acceptText: "üç∫ I need something...",
                        resistText: "I'll find another way",
                        resistDC: 15
                    });
                }
            }
            
            // Pick one trigger randomly if multiple
            if (triggers.length > 0) {
                pendingBadHabitEvent = triggers[Math.floor(Math.random() * triggers.length)];
            }
        }
        
        function showBadHabitEvent() {
            if (!pendingBadHabitEvent) return null;
            
            let event = pendingBadHabitEvent;
            let habit = HABITS[event.habit];
            
            return {
                category: "‚ö†Ô∏è Warning",
                title: event.title,
                desc: event.desc,
                choices: [
                    {
                        text: event.acceptText,
                        effect: () => {
                            // Start the bad habit
                            state.habits = state.habits || {};
                            state.habits[event.habit] = {
                                active: true,
                                weeksActive: 0
                            };
                            pendingBadHabitEvent = null;
                            addLog(`Started bad habit: ${habit.name}`);
                            return { 
                                icon: habit.icon, 
                                text: `You've picked up a bad habit: ${habit.name}. It'll be hard to quit.`, 
                                stats: habit.effects.desc 
                            };
                        }
                    },
                    {
                        text: `${event.resistText} (Will DC ${event.resistDC})`,
                        effect: () => {
                            // Try to resist
                            let selfControl = state.characterTraits?.selfControl || 5;
                            let bonus = Math.floor(selfControl / 2) - 2; // -2 to +3
                            let roll = Math.floor(Math.random() * 20) + 1;
                            let total = roll + bonus;
                            let success = total >= event.resistDC || roll === 20;
                            let critFail = roll === 1;
                            
                            pendingBadHabitEvent = null;
                            
                            if (critFail) {
                                // Critical fail - start the habit anyway
                                state.habits = state.habits || {};
                                state.habits[event.habit] = {
                                    active: true,
                                    weeksActive: 0
                                };
                                addLog(`Failed to resist: ${habit.name}`);
                                return { 
                                    icon: "üíÄ", 
                                    text: `Critical Fail! (rolled 1) Despite your best efforts, you couldn't resist. ${habit.name} becomes a habit.`, 
                                    stats: habit.effects.desc 
                                };
                            } else if (success) {
                                state.willpower = Math.max(0, (state.willpower || 0) - 5);
                                state.stress += 3;
                                return { 
                                    icon: "üí™", 
                                    text: `You resisted! (${roll}+${bonus}=${total} vs DC ${event.resistDC}) It took willpower, but you stayed strong.`, 
                                    stats: "-5 Willpower, +3 Stress" 
                                };
                            } else {
                                // Failed - start the habit
                                state.habits = state.habits || {};
                                state.habits[event.habit] = {
                                    active: true,
                                    weeksActive: 0
                                };
                                addLog(`Failed to resist: ${habit.name}`);
                                return { 
                                    icon: habit.icon, 
                                    text: `Failed! (${roll}+${bonus}=${total} vs DC ${event.resistDC}) You gave in. ${habit.name} is now a habit.`, 
                                    stats: habit.effects.desc 
                                };
                            }
                        }
                    }
                ]
            };
        }

        // ============ SUBSCRIPTIONS MODAL ============
        function openSubscriptionsModal() {
            let modal = document.getElementById('subscriptionsModal');
            let listDiv = document.getElementById('subscriptionsList');
            listDiv.innerHTML = '';
            
            Object.keys(SUBSCRIPTIONS).forEach(key => {
                let sub = SUBSCRIPTIONS[key];
                let isActive = state.subscriptions[key] || false;
                
                // Check if subscription has a condition (e.g., dating apps not available if married)
                let available = !sub.effects.condition || sub.effects.condition();
                
                let div = document.createElement('div');
                div.className = `p-3 rounded border ${isActive ? 'border-cyan-500 bg-cyan-900/20' : 'border-gray-600'} ${!available ? 'opacity-50' : ''} transition-colors`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${sub.icon}</span>
                            <div>
                                <div class="text-white font-medium">${sub.name}</div>
                                <div class="text-xs text-gray-400">${sub.desc}</div>
                                <div class="text-xs text-cyan-400 mt-1">${sub.effects.desc}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-yellow-400 font-bold">$${sub.cost}/wk</div>
                            ${available ? `
                            <button onclick="toggleSubscription('${key}')" class="mt-1 px-3 py-1 text-xs rounded ${isActive ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500'} text-white transition-colors">
                                ${isActive ? 'Cancel' : 'Subscribe'}
                            </button>
                            ` : '<div class="text-xs text-gray-500">Not available</div>'}
                        </div>
                    </div>
                `;
                listDiv.appendChild(div);
            });
            
            updateSubscriptionsCost();
            modal.classList.remove('hidden');
        }
        
        function closeSubscriptionsModal() {
            document.getElementById('subscriptionsModal').classList.add('hidden');
        }
        
        function toggleSubscription(key) {
            let sub = SUBSCRIPTIONS[key];
            
            if (state.subscriptions[key]) {
                // Cancel subscription
                state.subscriptions[key] = false;
                if (sub.effects.onCancel) sub.effects.onCancel();
                addLog(`Cancelled ${sub.name}`);
            } else {
                // Subscribe
                state.subscriptions[key] = true;
                if (sub.effects.onSubscribe) sub.effects.onSubscribe();
                addLog(`Subscribed to ${sub.name}`);
            }
            
            updateSubscriptionsCost();
            openSubscriptionsModal(); // Refresh the modal
            updateUI();
        }
        
        function updateSubscriptionsCost() {
            let total = 0;
            Object.keys(state.subscriptions).forEach(key => {
                if (state.subscriptions[key] && SUBSCRIPTIONS[key]) {
                    total += SUBSCRIPTIONS[key].cost;
                }
            });
            state.subscriptionCost = total;
            document.getElementById('subsModalCost').innerText = '$' + total;
        }
        
        function processSubscriptionEffects() {
            Object.keys(state.subscriptions).forEach(key => {
                if (state.subscriptions[key] && SUBSCRIPTIONS[key] && SUBSCRIPTIONS[key].effects.weekly) {
                    SUBSCRIPTIONS[key].effects.weekly();
                }
            });
        }

        // ============ FREE TIME MODAL ============
        let tempFreeTime = {}; // Temporary allocation while editing
        
        function openFreeTimeModal() {
            let modal = document.getElementById('freeTimeModal');
            let activitiesDiv = document.getElementById('freeTimeActivities');
            activitiesDiv.innerHTML = '';
            
            // Copy current allocation to temp
            tempFreeTime = { ...state.freeTime };
            
            let maxTime = getAvailableFreeTime();
            
            // Show time breakdown
            let breakdownHtml = '<div class="text-xs text-gray-500 mb-3 p-2 bg-gray-800/50 rounded">';
            breakdownHtml += `<div class="font-medium text-gray-400 mb-1">Time Budget Breakdown:</div>`;
            breakdownHtml += `<div class="grid grid-cols-2 gap-x-4">`;
            breakdownHtml += `<div>Base time: <span class="text-cyan-400">${BASE_FREE_TIME} hrs</span></div>`;
            
            let transportMod = TIME_MODIFIERS.transport[state.car] || 0;
            if (transportMod !== 0) {
                breakdownHtml += `<div>Transport (${TRANSPORT[state.car].name}): <span class="${transportMod < 0 ? 'text-red-400' : 'text-green-400'}">${transportMod > 0 ? '+' : ''}${transportMod} hrs</span></div>`;
            }
            
            if (state.employed) {
                let jobMod = TIME_MODIFIERS.job[state.job] || 0;
                if (jobMod !== 0) {
                    breakdownHtml += `<div>Job: <span class="text-red-400">${jobMod} hrs</span></div>`;
                }
            }
            
            if (state.phase === 'education' || state.phase === 'military_training') {
                let eduType = state.educationType || state.phase;
                let eduMod = TIME_MODIFIERS.education[eduType] || 0;
                if (eduMod !== 0) {
                    breakdownHtml += `<div>Education: <span class="text-red-400">${eduMod} hrs</span></div>`;
                }
            }
            
            if (state.home === 'parents') {
                breakdownHtml += `<div>Living at home: <span class="text-green-400">+2 hrs</span></div>`;
            }
            
            if (state.relationship.children > 0) {
                breakdownHtml += `<div>Children (${state.relationship.children}): <span class="text-red-400">-${state.relationship.children * 3} hrs</span></div>`;
            }
            
            breakdownHtml += `</div>`;
            breakdownHtml += `<div class="mt-1 pt-1 border-t border-gray-700 font-medium">Total Available: <span class="text-cyan-400">${maxTime} hrs/week</span></div>`;
            breakdownHtml += '</div>';
            
            activitiesDiv.innerHTML = breakdownHtml;
            
            // Create activity controls
            Object.keys(FREE_TIME_ACTIVITIES).forEach(key => {
                let activity = FREE_TIME_ACTIVITIES[key];
                let available = activity.requires();
                let currentHours = tempFreeTime[key] || 0;
                
                let costPerHour = typeof activity.costPerHour === 'function' ? activity.costPerHour() : activity.costPerHour;
                let earningsPerHour = activity.earningsPerHour ? activity.earningsPerHour() : 0;
                let desc = typeof activity.desc === 'function' ? activity.desc() : activity.desc;
                
                let div = document.createElement('div');
                div.className = `p-3 rounded border ${available ? 'border-gray-600' : 'border-gray-700 opacity-50'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${activity.icon}</span>
                            <div>
                                <div class="text-white font-medium">${activity.name}</div>
                                <div class="text-xs text-gray-400">${desc}</div>
                            </div>
                        </div>
                        <div class="text-right text-xs">
                            ${earningsPerHour > 0 ? `<span class="text-green-400">+$${earningsPerHour}/hr</span>` : 
                              costPerHour > 0 ? `<span class="text-yellow-400">$${costPerHour}/hr</span>` : 
                              `<span class="text-gray-500">Free</span>`}
                            ${!available ? `<br><span class="text-red-400">${activity.requiresText || 'Unavailable'}</span>` : ''}
                        </div>
                    </div>
                    ${available ? `
                    <div class="flex items-center gap-2">
                        <button onclick="adjustFreeTime('${key}', -1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold">-</button>
                        <div class="flex-1 bg-gray-800 rounded-full h-2 relative">
                            <div id="bar-${key}" class="bg-cyan-500 h-full rounded-full transition-all" style="width: ${(currentHours / maxTime) * 100}%"></div>
                        </div>
                        <span id="hours-${key}" class="text-cyan-400 font-mono w-12 text-center">${currentHours} hrs</span>
                        <button onclick="adjustFreeTime('${key}', 1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 text-white font-bold">+</button>
                    </div>
                    ` : ''}
                `;
                
                activitiesDiv.appendChild(div);
            });
            
            updateFreeTimePreview();
            modal.classList.remove('hidden');
        }
        
        function adjustFreeTime(activity, delta) {
            let maxTime = getAvailableFreeTime();
            let currentTotal = Object.values(tempFreeTime).reduce((a, b) => a + b, 0);
            let currentHours = tempFreeTime[activity] || 0;
            
            let newHours = currentHours + delta;
            
            // Constraints
            if (newHours < 0) newHours = 0;
            if (newHours > 10) newHours = 10; // Max 10 hours per activity
            if (delta > 0 && currentTotal >= maxTime) return; // Can't exceed max
            
            tempFreeTime[activity] = newHours;
            
            // Update UI
            document.getElementById(`hours-${activity}`).innerText = newHours + ' hrs';
            document.getElementById(`bar-${activity}`).style.width = (newHours / maxTime) * 100 + '%';
            
            updateFreeTimePreview();
        }
        
        function updateFreeTimePreview() {
            let maxTime = getAvailableFreeTime();
            let total = Object.values(tempFreeTime).reduce((a, b) => a + b, 0);
            let remaining = maxTime - total;
            
            document.getElementById('freeTimeRemaining').innerText = remaining;
            document.getElementById('freeTimeRemaining').className = remaining > 0 ? 'text-cyan-400' : 'text-green-400';
            
            // Calculate total cost
            let totalCost = 0;
            let totalEarnings = 0;
            Object.keys(tempFreeTime).forEach(key => {
                let hours = tempFreeTime[key] || 0;
                let activity = FREE_TIME_ACTIVITIES[key];
                let costPerHour = typeof activity.costPerHour === 'function' ? activity.costPerHour() : activity.costPerHour;
                totalCost += hours * costPerHour;
                if (activity.earningsPerHour) {
                    totalEarnings += hours * activity.earningsPerHour();
                }
            });
            
            let netCost = totalCost - totalEarnings;
            document.getElementById('freeTimeModalCost').innerText = netCost >= 0 ? `$${netCost}` : `+$${Math.abs(netCost)}`;
            document.getElementById('freeTimeModalCost').className = netCost > 0 ? 'text-yellow-400' : 'text-green-400';
            
            // Effects preview
            let effects = calculateFreeTimeEffects(tempFreeTime);
            let previewDiv = document.getElementById('freeTimeEffectsPreview');
            let previewHtml = '';
            
            if (effects.physical) previewHtml += `<div>üí™ Physical: <span class="text-cyan-400">+${effects.physical.toFixed(1)}</span></div>`;
            if (effects.social) previewHtml += `<div>üó£Ô∏è Social: <span class="text-cyan-400">+${effects.social.toFixed(1)}</span></div>`;
            if (effects.technical) previewHtml += `<div>üîß Technical: <span class="text-cyan-400">+${effects.technical.toFixed(1)}</span></div>`;
            if (effects.creativity) previewHtml += `<div>üé® Creativity: <span class="text-cyan-400">+${effects.creativity.toFixed(1)}</span></div>`;
            if (effects.stress) previewHtml += `<div>üò∞ Stress: <span class="${effects.stress < 0 ? 'text-green-400' : 'text-red-400'}">${effects.stress > 0 ? '+' : ''}${effects.stress.toFixed(1)}</span></div>`;
            if (effects.energy) previewHtml += `<div>‚ö° Energy: <span class="${effects.energy > 0 ? 'text-green-400' : 'text-red-400'}">${effects.energy > 0 ? '+' : ''}${effects.energy.toFixed(1)}</span></div>`;
            if (effects.happiness) previewHtml += `<div>‚ò∫Ô∏è Happiness: <span class="${effects.happiness > 0 ? 'text-green-400' : 'text-red-400'}">${effects.happiness > 0 ? '+' : ''}${effects.happiness.toFixed(1)}</span></div>`;
            if (effects.health) previewHtml += `<div>‚ù§Ô∏è Health: <span class="text-green-400">+${effects.health.toFixed(1)}</span></div>`;
            if (effects.attractiveness) previewHtml += `<div>üíï Looks: <span class="text-pink-400">+${effects.attractiveness.toFixed(2)}</span></div>`;
            if (effects.meetingBonus) previewHtml += `<div>üíò Meeting chance: <span class="text-pink-400">+${(effects.meetingBonus * 100).toFixed(0)}%</span></div>`;
            if (effects.careerXP) previewHtml += `<div>üìà Career XP: <span class="text-cyan-400">+${effects.careerXP.toFixed(1)}</span></div>`;
            if (effects.gpaBonus && state.phase === 'education') previewHtml += `<div>üìö GPA Bonus: <span class="text-cyan-400">+${effects.gpaBonus.toFixed(2)}</span></div>`;
            if (totalEarnings > 0) previewHtml += `<div>üíµ Overtime: <span class="text-green-400">+$${totalEarnings}/week</span></div>`;
            
            previewDiv.innerHTML = previewHtml || '<div class="text-gray-500">No activities selected</div>';
        }
        
        function calculateFreeTimeEffects(allocation) {
            let effects = {};
            
            Object.keys(allocation).forEach(key => {
                let hours = allocation[key] || 0;
                if (hours === 0) return;
                
                let activity = FREE_TIME_ACTIVITIES[key];
                Object.keys(activity.effects).forEach(effect => {
                    let value = activity.effects[effect] * hours;
                    effects[effect] = (effects[effect] || 0) + value;
                });
            });
            
            return effects;
        }
        
        function saveFreeTimeAllocation() {
            state.freeTime = { ...tempFreeTime };
            
            // Update weekly expenses for free time activities
            let totalCost = 0;
            Object.keys(state.freeTime).forEach(key => {
                let hours = state.freeTime[key] || 0;
                let activity = FREE_TIME_ACTIVITIES[key];
                let costPerHour = typeof activity.costPerHour === 'function' ? activity.costPerHour() : activity.costPerHour;
                totalCost += hours * costPerHour;
            });
            
            state.freeTimeExpenses = totalCost;
            
            addLog(`Updated weekly schedule`);
            closeFreeTimeModal();
            updateUI();
        }
        
        function closeFreeTimeModal() {
            document.getElementById('freeTimeModal').classList.add('hidden');
        }
        
        // Adjust free time allocation if max time changes
        function validateFreeTimeAllocation() {
            let maxTime = getAvailableFreeTime();
            let currentTotal = Object.values(state.freeTime).reduce((a, b) => a + b, 0);
            
            // If we're over the limit, proportionally reduce all activities
            if (currentTotal > maxTime) {
                let ratio = maxTime / currentTotal;
                Object.keys(state.freeTime).forEach(key => {
                    state.freeTime[key] = Math.floor((state.freeTime[key] || 0) * ratio);
                });
                
                // Notify player
                addLog(`Schedule adjusted - less free time available (${maxTime} hrs)`);
            }
            
            // Disable activities that are no longer available
            if (!state.fitness.gymMember && state.freeTime.gym > 0) {
                state.freeTime.gym = 0;
            }
            if (!state.employed && state.freeTime.overtime > 0) {
                state.freeTime.overtime = 0;
            }
        }

        // ============ INIT ============
        function createParticles() {
            let container = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                let p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                container.appendChild(p);
            }
        }

        function init() {
            createParticles();
            let events = getPhaseEvents();
            displayEvent(events[0]);
            updateUI();
        }

        init();
    </script>
</body>
</html>
</html>